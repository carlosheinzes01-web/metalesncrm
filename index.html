<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Export CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --bg: #f8fafc;
            --sidebar-bg: #0f172a;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --text: #1e293b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --sidebar-width: 240px;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            --info: #3b82f6;
            --input-bg: #ffffff;
            --surface: #ffffff;
            --hover-bg: #f8fafc;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --sidebar-bg: #020617;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --text: #f1f5f9;
            --border: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            --input-bg: #1e293b;
            --surface: #1e293b;
            --hover-bg: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            overflow: hidden;
        }

        #root { display: flex; height: 100vh; width: 100vw; }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover, .nav-item.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: 70px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            flex-shrink: 0;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .global-search {
            position: relative;
            width: 350px;
        }

        .global-search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.875rem;
            background: #f8fafc;
            transition: all 0.2s;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .global-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .global-search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
        }

        .search-result-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .search-result-item:hover { background: #f8fafc; }
        .search-result-item:last-child { border-bottom: none; }

        .search-result-title { font-weight: 600; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .search-result-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 0.75rem; }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f8fafc;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notification-bell:hover { background: white; border-color: var(--primary); }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .notification-panel {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 380px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border);
            z-index: 1000;
            overflow: hidden;
        }

        .notification-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-list { max-height: 400px; overflow-y: auto; }

        .notification-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            gap: 0.875rem;
        }

        .notification-item:hover { background: #f8fafc; }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon.danger { background: #fef2f2; color: var(--danger); }
        .notification-icon.warning { background: #fffbeb; color: var(--warning); }
        .notification-icon.info { background: #eff6ff; color: var(--info); }

        .notification-content { flex: 1; }
        .notification-title { font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.25rem; }
        .notification-message { font-size: 0.75rem; color: var(--text-muted); }

        .notification-empty { padding: 3rem 1.5rem; text-align: center; color: var(--text-muted); }

        .content-scroll { flex: 1; overflow-y: auto; padding: 2rem; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kpi-card:hover { box-shadow: var(--shadow); transform: translateY(-4px); border-color: var(--primary); }
        .kpi-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; }

        .alert-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .alert-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            border-left: 4px solid;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
        }

        .alert-card:hover { box-shadow: var(--shadow); }
        .alert-card.danger { border-left-color: var(--danger); }
        .alert-card.warning { border-left-color: var(--warning); }
        .alert-card.info { border-left-color: var(--info); }

        .alert-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .alert-card-count { font-size: 1.5rem; font-weight: 800; }
        .alert-card.danger .alert-card-count { color: var(--danger); }
        .alert-card.warning .alert-card-count { color: var(--warning); }
        .alert-card.info .alert-card-count { color: var(--info); }
        .alert-card-title { font-weight: 600; font-size: 0.8125rem; }
        .alert-card-subtitle { font-size: 0.7rem; color: var(--text-muted); }

        .alert-banner {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .alert-banner.danger {
            background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%);
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .table-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        th { background: #f8fafc; padding: 0.875rem 1rem; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap; }
        td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }

        /* Columnas fijas (sticky) para scroll horizontal */
        .sticky-col-1 { position: sticky; left: 0; z-index: 2; background: inherit; }
        .sticky-col-2 { position: sticky; left: 75px; z-index: 2; background: inherit; }
        thead .sticky-col-1, thead .sticky-col-2 { background: #f8fafc; z-index: 3; }
        tbody tr .sticky-col-1, tbody tr .sticky-col-2 { background: var(--card-bg); }
        tbody tr:hover .sticky-col-1, tbody tr:hover .sticky-col-2 { background: #f8fafc; }
        .sticky-col-1::after, .sticky-col-2::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 1px; background: var(--border); }

        .badge { padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.6875rem; font-weight: 600; white-space: nowrap; }
        .bg-blue { background: #dbeafe; color: #1e40af; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-orange { background: #ffedd5; color: #9a3412; }
        .bg-red { background: #fef2f2; color: #dc2626; }
        .bg-gray { background: #f1f5f9; color: #475569; }
        .bg-purple { background: #f3e8ff; color: #7c3aed; }
        .bg-cyan { background: #ecfeff; color: #0e7490; }

        .btn-primary { background: var(--primary); color: white; padding: 0.625rem 1.25rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: var(--hover-bg); color: var(--text-main); padding: 0.625rem 1.25rem; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-secondary:hover { background: var(--card-bg); border-color: var(--primary); transform: translateY(-1px); }
        .btn-danger { background: #fef2f2; color: #dc2626; padding: 0.625rem 1.25rem; border-radius: 8px; border: 1px solid #fecaca; font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-danger:hover { background: #fee2e2; transform: translateY(-1px); }
        .btn-success { background: var(--success); color: white; padding: 0.625rem 1.25rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-success:hover { background: #16a34a; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            animation: fadeInOverlay 0.2s ease;
        }

        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }

        .modal-card {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUpModal 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUpModal { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 { font-size: 1.125rem; font-weight: 700; }
        .modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background: #fafafa;
        }

        /* Form */
        .form-section { margin-bottom: 2rem; }
        .form-section-title {
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .form-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.375rem; }
        .form-group.span-2 { grid-column: span 2; }
        .form-group.span-3 { grid-column: span 3; }
        .form-group label { font-size: 0.6875rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea {
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--input-bg);
            color: var(--text-main);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-group textarea { resize: vertical; min-height: 80px; }

        /* Estilos para campos con error */
        .form-group.has-error input, .form-group.has-error select {
            border-color: #dc2626;
            background: #fef2f2;
        }
        .form-group.has-error input:focus, .form-group.has-error select:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        .form-error {
            font-size: 0.6875rem;
            color: #dc2626;
            margin-top: 0.25rem;
        }
        .form-hint {
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .verde-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background: #dcfce7;
            color: #166534;
            padding: 0.5rem 0.875rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .pending-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 0.875rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        /* Import Modal */
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .import-zone:hover { border-color: var(--primary); background: #faf5ff; }
        .import-zone.dragging { border-color: var(--primary); background: #f0f9ff; }

        .import-preview { margin-top: 1.5rem; }
        .import-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .import-stat { background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center; }
        .import-stat-value { font-size: 1.5rem; font-weight: 800; }
        .import-stat-label { font-size: 0.75rem; color: var(--text-muted); }

        /* Calendar */
        .apple-calendar { background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .cal-day-label { padding: 0.75rem; text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); background: #f8fafc; border-bottom: 1px solid var(--border); }
        .cal-cell { height: 100px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0.5rem; overflow: hidden; }
        .cal-cell:nth-child(7n) { border-right: none; }
        .cal-num { font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.375rem; display: inline-flex; width: 24px; height: 24px; align-items: center; justify-content: center; border-radius: 50%; }
        .cal-num.today { background: var(--primary); color: white; }
        .evt { padding: 0.15rem 0.35rem; border-radius: 4px; font-size: 0.6rem; font-weight: 600; margin-bottom: 0.125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .evt-fecha { background: #f0fdf4; color: #16a34a; border-left: 2px solid #16a34a; }
        .evt-embarque { background: #eff6ff; color: #3b82f6; border-left: 2px solid #3b82f6; }
        .evt-arribo { background: #fff7ed; color: #f97316; border-left: 2px solid #f97316; }

        /* Calendario móvil compacto */
        @media (max-width: 768px) {
            .apple-calendar {
                font-size: 0.75rem;
            }
            .cal-day-label {
                padding: 0.5rem 0.25rem;
                font-size: 0.625rem;
            }
            .cal-cell {
                height: 55px;
                padding: 0.25rem;
                overflow: hidden;
            }
            .cal-num {
                font-size: 0.6875rem;
                width: 20px;
                height: 20px;
                margin-bottom: 0.125rem;
            }
            .evt {
                padding: 0.1rem 0.2rem;
                font-size: 0.5rem;
                margin-bottom: 0.1rem;
            }
            .apple-calendar > div:first-child {
                padding: 0.75rem;
            }
            .apple-calendar button {
                padding: 0.375rem;
            }
            .apple-calendar h2 {
                font-size: 1rem;
            }
        }

        /* Connection */
        .connection-badge { display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .connection-badge.online { background: #dcfce7; color: #166534; }
        .connection-badge.offline { background: #fef3c7; color: #92400e; }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .connection-badge.online .connection-dot { background: #22c55e; }
        .connection-badge.offline .connection-dot { background: #f59e0b; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .sync-indicator { position: fixed; bottom: 20px; right: 20px; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 0.75rem; z-index: 9999; }
        .sync-spinner { width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--hover-bg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--card-bg); border-color: var(--primary); }

        /* Dark mode table */
        [data-theme="dark"] th { background: #1e293b; }
        [data-theme="dark"] tr:hover { background-color: #334155; }
        [data-theme="dark"] .global-search-input { background: #1e293b; color: var(--text-main); }
        [data-theme="dark"] .global-search-input:focus { background: #1e293b; }
        [data-theme="dark"] .modal-footer { background: #0f172a; }
        [data-theme="dark"] .flatpickr-calendar { background: #1e293b; border-color: #334155; }
        [data-theme="dark"] .flatpickr-day { color: #f1f5f9; }
        [data-theme="dark"] .flatpickr-day:hover { background: #334155; }

        /* Date Range Picker */
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--hover-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .date-range-picker:hover { border-color: var(--primary); background: var(--card-bg); }
        .date-range-text { font-size: 0.8125rem; font-weight: 500; color: var(--text-main); }

        /* Kanban Board */
        .kanban-board { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .kanban-column {
            min-width: 280px;
            max-width: 320px;
            background: var(--hover-bg);
            border-radius: var(--radius);
            padding: 1rem;
            flex-shrink: 0;
        }
        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        .kanban-title { font-weight: 700; font-size: 0.875rem; }
        .kanban-count {
            background: var(--card-bg);
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .kanban-cards { display: flex; flex-direction: column; gap: 0.75rem; }
        .kanban-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .kanban-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); border-color: var(--primary); }
        .kanban-card-title { font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .kanban-card-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 0.25rem; }

        /* PDF Upload */
        .pdf-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--hover-bg);
        }
        .pdf-upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .pdf-upload-zone.dragging { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .pdf-result { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1.5rem; margin-top: 1rem; }
        .pdf-result-value { font-size: 2rem; font-weight: 800; color: var(--success); }

        /* Document Checklist */
        .doc-card {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s;
            background: var(--card-bg);
        }
        .doc-card.uploaded {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }
        .doc-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        .doc-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .doc-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--hover-bg);
        }
        .doc-card.uploaded .doc-card-icon {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }
        .doc-card-title {
            font-weight: 600;
            font-size: 0.8125rem;
            flex: 1;
        }
        .doc-card-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .doc-card.uploaded .doc-card-status {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .doc-upload-mini {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: all 0.2s;
            min-height: 60px;
        }
        .doc-upload-mini:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .doc-file-info {
            background: var(--hover-bg);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }
        .doc-file-name {
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        .doc-file-date {
            color: var(--text-muted);
            font-size: 0.6875rem;
        }
        .doc-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        .doc-action-btn {
            padding: 0.375rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .doc-action-btn.view { background: #eff6ff; color: var(--info); }
        .doc-action-btn.view:hover { background: #dbeafe; }
        .doc-action-btn.download { background: #f0fdf4; color: var(--success); }
        .doc-action-btn.download:hover { background: #dcfce7; }
        .doc-action-btn.delete { background: #fef2f2; color: var(--danger); }
        .doc-action-btn.delete:hover { background: #fee2e2; }
        .docs-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .docs-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .docs-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Auth */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .auth-card { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 400px; }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h1 { font-family: 'Outfit'; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .auth-header p { color: var(--text-muted); font-size: 0.875rem; }
        .auth-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-input-group { display: flex; flex-direction: column; gap: 0.375rem; }
        .auth-input-group label { font-size: 0.75rem; font-weight: 600; }
        .auth-input-group input { padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 10px; font-size: 0.875rem; }
        .auth-btn { background: var(--primary); color: white; padding: 0.875rem; border: none; border-radius: 10px; font-size: 0.9375rem; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
        .auth-btn:hover { background: var(--primary-light); }
        .auth-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .auth-switch { text-align: center; margin-top: 1.5rem; font-size: 0.8125rem; color: var(--text-muted); }
        .auth-switch a { color: var(--primary); font-weight: 600; cursor: pointer; }
        .auth-error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem; border-radius: 8px; font-size: 0.8125rem; text-align: center; margin-bottom: 1rem; }

        /* Skeleton Loaders */
        .skeleton {
            background: linear-gradient(90deg, var(--card-bg) 25%, var(--hover-bg) 50%, var(--card-bg) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text { height: 1rem; margin-bottom: 0.5rem; }
        .skeleton-title { height: 1.5rem; width: 60%; margin-bottom: 1rem; }
        .skeleton-card { height: 120px; border-radius: 16px; }
        .skeleton-row { height: 3.5rem; margin-bottom: 0.5rem; border-radius: 8px; }
        .skeleton-kpi { height: 110px; border-radius: 16px; }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .sidebar { width: 70px; padding: 1rem 0.5rem; }
            .sidebar .logo span, .sidebar .nav-item span, .sidebar .connection-badge span { display: none; }
            .sidebar .logo, .sidebar .nav-item { justify-content: center; }
            .global-search { width: 250px; }
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            .form-group.span-3 { grid-column: span 2; }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            /* Layout principal */
            .app-layout { flex-direction: column; }

            /* Main content - espacio para barra inferior */
            .main-content {
                margin-left: 0;
                padding-bottom: 80px;
            }

            /* Content scroll */
            .content-scroll { padding: 1rem; }

            /* Dashboard */
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .kpi-card { padding: 1rem; }
            .kpi-value { font-size: 1.25rem; }
            .kpi-label { font-size: 0.6875rem; }
            .alert-cards-grid { grid-template-columns: 1fr; }

            /* Tablas */
            .table-container {
                overflow-x: auto;
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            table { min-width: 600px; font-size: 0.75rem; }
            th, td { padding: 0.5rem 0.75rem; }

            /* Forms */
            .form-grid, .form-grid-2 { grid-template-columns: 1fr; }
            .form-group.span-2, .form-group.span-3 { grid-column: span 1; }

            /* Modal */
            .modal-overlay { padding: 0; align-items: flex-end; }
            .modal-card {
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }
            .modal-header { padding: 1rem; }
            .modal-header h3 { font-size: 1rem; }
            .modal-body { padding: 1rem; }
            .modal-footer {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }
            .modal-footer > div {
                width: 100%;
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }

            /* Tabs del modal */
            .modal-card > div:nth-child(2) {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .modal-card > div:nth-child(2) button {
                padding: 0.75rem 1rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            /* Documentos grid */
            .docs-grid { grid-template-columns: 1fr !important; }
            .doc-card { padding: 0.75rem; }

            /* Notifications */
            .notification-panel {
                width: calc(100vw - 2rem);
                right: -1rem;
                max-height: 60vh;
            }

            /* Import stats */
            .import-stats { grid-template-columns: 1fr; }

            /* Kanban */
            .kanban-board {
                flex-direction: column;
                gap: 1rem;
            }
            .kanban-column {
                min-width: 100%;
                max-height: 300px;
            }

            /* Calendar */
            .fc { font-size: 0.75rem; }
            .fc-toolbar { flex-direction: column; gap: 0.5rem; }
            .fc-toolbar-title { font-size: 1rem !important; }
        }

        /* Extra small phones */
        @media (max-width: 480px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .kpi-card { padding: 0.875rem; }
            .header h1 { font-size: 1rem; }
            .header-actions .btn-primary,
            .header-actions .btn-secondary {
                padding: 0.4rem 0.6rem;
            }
        }

        /* ================================================
           VISTA MÓVIL - Tarjetas en lugar de tabla
           ================================================ */

        /* Ocultar tabla en móvil, mostrar cards */
        @media (max-width: 768px) {
            .desktop-table { display: none !important; }
            .mobile-cards { display: block !important; }
        }
        @media (min-width: 769px) {
            .desktop-table { display: block !important; }
            .mobile-cards { display: none !important; }
        }

        /* ========================================
           VISTA MÓVIL MEJORADA 2025
           ======================================== */

        /* Contenedor de tarjetas */
        .mobile-cards {
            padding: 0.5rem 0;
        }

        /* Barra de búsqueda móvil */
        .mobile-search {
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 0.75rem 0;
            margin-bottom: 0.5rem;
            z-index: 10;
        }
        .mobile-search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .mobile-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .mobile-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Tarjeta móvil moderna */
        .mobile-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
        }
        .mobile-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        /* Indicador de status lateral */
        .mobile-card-status-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }
        .mobile-card-status-bar.programacion { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
        .mobile-card-status-bar.ingresados { background: linear-gradient(180deg, #f59e0b, #fbbf24); }
        .mobile-card-status-bar.altamar { background: linear-gradient(180deg, #06b6d4, #22d3ee); }
        .mobile-card-status-bar.pago10 { background: linear-gradient(180deg, #8b5cf6, #a78bfa); }
        .mobile-card-status-bar.cerrado { background: linear-gradient(180deg, #22c55e, #4ade80); }

        /* Contenido de la tarjeta */
        .mobile-card-content {
            padding: 1rem 1rem 1rem 1.25rem;
        }

        /* Header de tarjeta */
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.875rem;
            gap: 0.75rem;
        }
        .mobile-card-title {
            font-weight: 700;
            font-size: 1.0625rem;
            color: var(--text-main);
            margin: 0;
            line-height: 1.3;
            flex: 1;
        }
        .mobile-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Badge de status mejorado */
        .mobile-status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .mobile-status-badge.programacion { background: #dbeafe; color: #1e40af; }
        .mobile-status-badge.ingresados { background: #fef3c7; color: #92400e; }
        .mobile-status-badge.altamar { background: #cffafe; color: #0e7490; }
        .mobile-status-badge.pago10 { background: #ede9fe; color: #6d28d9; }
        .mobile-status-badge.cerrado { background: #dcfce7; color: #166534; }

        /* Info grid - 2 columnas */
        .mobile-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem 1rem;
        }

        /* Cada campo de info */
        .mobile-card-row {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        .mobile-card-label {
            font-size: 0.625rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        .mobile-card-value {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-main);
        }
        .mobile-card-value.empty {
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Sección de fechas destacada */
        .mobile-card-dates {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
        }
        .mobile-date-item {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.625rem;
            background: var(--hover-bg);
            border-radius: 10px;
        }
        .mobile-date-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .mobile-date-icon.embarque {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        .mobile-date-icon.arribo {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        .mobile-date-info {
            display: flex;
            flex-direction: column;
        }
        .mobile-date-label {
            font-size: 0.5625rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .mobile-date-value {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-main);
        }

        /* Footer de tarjeta */
        .mobile-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.875rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        /* Indicador de documentos mejorado */
        .mobile-docs-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--hover-bg);
            border-radius: 10px;
            transition: background 0.2s;
        }
        .mobile-docs-indicator:active {
            background: var(--border);
        }
        .mobile-docs-progress {
            display: flex;
            gap: 3px;
        }
        .mobile-docs-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }
        .mobile-docs-dot.filled {
            background: var(--success);
        }
        .mobile-docs-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        .mobile-docs-text.complete {
            color: var(--success);
        }

        /* Botones de acción */
        .mobile-card-actions {
            display: flex;
            gap: 0.5rem;
        }
        .mobile-card-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        .mobile-card-btn:active {
            transform: scale(0.92);
        }
        .mobile-card-btn-primary {
            background: var(--primary);
            color: white;
        }
        .mobile-card-btn-danger {
            background: rgba(239, 68, 68, 0.08);
            color: var(--danger);
        }
        .mobile-card-btn-danger:active {
            background: rgba(239, 68, 68, 0.15);
        }

        /* Estado vacío */
        .mobile-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }
        .mobile-empty-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--hover-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            color: var(--text-muted);
        }
        .mobile-empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }
        .mobile-empty-text {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* ========================================
           HEADER MÓVIL MEJORADO
           ======================================== */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.875rem 1rem;
                background: var(--card-bg);
                border-bottom: 1px solid var(--border);
            }
            .header h1 {
                font-size: 1.25rem;
                font-weight: 700;
                flex: 1;
                margin: 0;
            }
            .header-right {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .global-search {
                display: none;
            }
            /* Selector de fechas compacto en móvil */
            .date-range-picker {
                display: flex;
                font-size: 0.75rem;
                padding: 0.375rem 0.625rem;
                gap: 0.375rem;
            }
            .date-range-picker .date-range-text {
                font-size: 0.6875rem;
            }
            /* Tablas en Dashboard más compactas en móvil */
            .table-card table {
                font-size: 0.7rem;
            }
            .table-card th, .table-card td {
                padding: 0.5rem 0.4rem;
            }
            /* Ocultar columnas menos importantes en móvil */
            .table-card th:nth-child(n+4):not(:last-child),
            .table-card td:nth-child(n+4):not(:last-child) {
                display: none;
            }
            /* Botones compactos y modernos */
            .btn-primary, .btn-secondary {
                padding: 0.625rem 0.875rem;
                font-size: 0.8125rem;
                border-radius: 10px;
            }
            .btn-primary span, .btn-secondary span {
                display: none;
            }
            /* Indicador de conexión mejorado */
            .connection-indicator {
                display: flex;
                align-items: center;
                gap: 0.375rem;
                padding: 0.375rem 0.625rem;
                border-radius: 20px;
                font-size: 0.6875rem;
                font-weight: 600;
            }
            .connection-indicator.online {
                background: #dcfce7;
                color: #166534;
            }
            .connection-indicator.offline {
                background: #fef2f2;
                color: #991b1b;
            }
            .connection-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
            }
            .connection-dot.online { background: #22c55e; }
            .connection-dot.offline { background: #ef4444; }
        }

        /* ========================================
           BOTÓN FLOTANTE MEJORADO (FAB)
           ======================================== */
        @media (max-width: 768px) {
            .mobile-fab {
                position: fixed;
                bottom: 85px;
                right: 20px;
                width: 60px;
                height: 60px;
                border-radius: 18px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
                color: white;
                border: none;
                box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4), 0 2px 8px rgba(99, 102, 241, 0.2);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100;
                transition: all 0.2s ease;
            }
            .mobile-fab:active {
                transform: scale(0.92);
                box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
            }
            .mobile-fab svg {
                width: 28px;
                height: 28px;
            }
        }
        @media (min-width: 769px) {
            .mobile-fab { display: none; }
        }

        /* ========================================
           FILTROS DE VIAJES RESPONSIVE
           ======================================== */
        .viajes-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .viajes-search-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        .viajes-search-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }
        .viajes-search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 2.75rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.9375rem;
            background: var(--card-bg);
            color: var(--text-main);
            transition: all 0.2s;
        }
        .viajes-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .viajes-search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--hover-bg);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
        }
        .viajes-status-select {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 0.9375rem;
            min-width: 140px;
        }
        .viajes-mobile-count {
            display: none;
        }

        @media (max-width: 768px) {
            .viajes-header-desktop {
                display: none !important;
            }
            .viajes-filters {
                flex-direction: column;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            .viajes-search-wrapper {
                width: 100%;
            }
            .viajes-search-input {
                padding: 1rem 2.5rem 1rem 3rem;
                font-size: 1rem;
                border-radius: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            }
            .viajes-status-filter {
                width: 100%;
            }
            .viajes-status-select {
                width: 100%;
                padding: 0.875rem 1rem;
                font-size: 1rem;
                border-radius: 12px;
            }
            .viajes-mobile-count {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 1rem;
                padding: 0 0.25rem;
            }
            .viajes-mobile-count > span:first-child {
                font-size: 0.875rem;
                color: var(--text-muted);
                font-weight: 500;
            }
            .viajes-filter-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.375rem;
                background: var(--primary);
                color: white;
                padding: 0.375rem 0.75rem;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 600;
                cursor: pointer;
            }
        }

        /* ========================================
           SIDEBAR - ESTILOS BASE
           ======================================== */
        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 1.5rem;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-user-info {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        /* ========================================
           NAVEGACIÓN INFERIOR MÓVIL
           ======================================== */
        @media (max-width: 768px) {
            /* Ocultar elementos solo para desktop */
            .sidebar-desktop-only {
                display: none !important;
            }

            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: 100%;
                height: auto;
                min-height: 60px;
                flex-direction: row;
                padding: 0;
                padding-bottom: env(safe-area-inset-bottom, 0);
                border-right: none;
                border-top: 1px solid var(--border);
                background: var(--card-bg);
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            }

            .sidebar nav {
                display: flex;
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
                align-items: stretch;
                padding: 0;
                gap: 0;
                margin: 0;
            }

            .sidebar .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                flex: 1;
                padding: 0.5rem 0.25rem;
                gap: 0.25rem;
                border-radius: 0;
                color: var(--text-muted);
                transition: color 0.2s;
                position: relative;
                background: transparent;
                margin: 0;
            }

            .sidebar .nav-item:hover {
                background: transparent;
            }

            .sidebar .nav-item.active {
                color: var(--primary);
                background: transparent;
            }

            .sidebar .nav-item.active::after {
                content: '';
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 32px;
                height: 3px;
                background: var(--primary);
                border-radius: 0 0 3px 3px;
            }

            .sidebar .nav-item span {
                display: block;
                font-size: 0.625rem;
                font-weight: 500;
                line-height: 1;
            }

            .sidebar .nav-item i,
            .sidebar .nav-item svg {
                width: 22px;
                height: 22px;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://cteczvfjnkhipbvbwlmx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZWN6dmZqbmtoaXBidmJ3bG14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODk1NDQsImV4cCI6MjA4NDY2NTU0NH0.sWGm3uRwQv3eioPZFPtkb2GaTvHoRBsZFx44OYzIIrY';
        const isSupabaseConfigured = SUPABASE_URL !== 'TU_SUPABASE_URL_AQUI' && SUPABASE_ANON_KEY !== 'TU_SUPABASE_ANON_KEY_AQUI';

        // =====================================================
        // CONSTANTES DE APLICACIÓN
        // =====================================================
        const CONFIG = {
            DELAYS: {
                SEARCH_DEBOUNCE: 300,      // ms - debounce en búsqueda
                ICON_INIT: 50,             // ms - inicialización de iconos Lucide
                SUPABASE_WAIT: 5000,       // ms - espera máxima para Supabase
                SYNC_INTERVAL: 30000,      // ms - intervalo de polling (30s)
                CHECK_INTERVAL: 100        // ms - intervalo de verificación Supabase
            },
            MESES: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
        };

        // Cliente de Supabase - se inicializa bajo demanda
        let _supabaseClient = null;

        // Esperar a que la librería Supabase esté disponible
        const waitForSupabase = (maxWait = CONFIG.DELAYS.SUPABASE_WAIT) => {
            return new Promise((resolve) => {
                // Si ya está disponible, resolver inmediatamente
                if (window.supabase) {
                    resolve(true);
                    return;
                }

                // Si no está configurado, no esperar
                if (!isSupabaseConfigured) {
                    resolve(false);
                    return;
                }

                const startTime = Date.now();
                const checkInterval = setInterval(() => {
                    if (window.supabase) {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (Date.now() - startTime > maxWait) {
                        clearInterval(checkInterval);
                        console.warn('⚠️ Timeout esperando librería Supabase (modo offline)');
                        resolve(false);
                    }
                }, CONFIG.DELAYS.CHECK_INTERVAL);
            });
        };

        // Función getter que SIEMPRE devuelve el cliente actualizado
        const getSupabase = () => {
            // Si ya existe, devolverlo
            if (_supabaseClient) return _supabaseClient;

            // Verificar configuración
            if (!isSupabaseConfigured) {
                return null;
            }

            // Verificar si la librería está cargada
            if (!window.supabase) {
                return null;
            }

            // Crear el cliente
            try {
                _supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return _supabaseClient;
            } catch (err) {
                console.error('❌ Error creando cliente Supabase:', err);
                return null;
            }
        };

        // Alias para compatibilidad (getter dinámico)
        Object.defineProperty(window, 'supabaseClient', { get: getSupabase });

        // =====================================================
        // DATOS INICIALES - 54 viajes pre-cargados
        // Se usan solo si no hay datos en localStorage/Supabase
        // =====================================================
        const INITIAL_VIAJES = [
          {
            "tripId": "a85051de-f438-4c4d-872a-41011360c167",
            "Nombre": "Zn 08-01-24",
            "Numero de booking": "EBKG 64594883",
            "Numero de BL": "HLCUME3240123671",
            "Fecha": "2024-01-08",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 516.741,
            "Analisis": 0.2812,
            "Flete": 41257,
            "$venta": 85701.4464,
            "$deben": 0,
            "Agencia aduanal": 131798.39
          },
          {
            "tripId": "8428d262-95e8-4210-a08c-a12b27694f6c",
            "Nombre": "Zn 22-01-24",
            "Numero de booking": "EBKG 66596668",
            "Numero de BL": "HLCUME3240150120",
            "Fecha": "2024-01-22",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 513,
            "Analisis": 0.2761,
            "Flete": 41257,
            "$venta": 88237.72,
            "$deben": 0,
            "Agencia aduanal": 131798.39
          },
          {
            "tripId": "cd285be4-23e8-4bde-93f6-ec0c1384f4dd",
            "Nombre": "Zn 12-02-24",
            "Numero de booking": "EBKG 63267054",
            "Numero de BL": "HLCUME3240213780",
            "Fecha": "2024-02-12",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 524.9769,
            "Analisis": 0.2447,
            "Flete": 41257,
            "$venta": 78222.02,
            "$deben": 0,
            "Agencia aduanal": 119038.39
          },
          {
            "tripId": "dcee8b55-0330-4622-8271-ffeadcea81e8",
            "Nombre": "ZN 08-01-26",
            "Numero de booking": "EBKG15412533",
            "Numero de BL": "MEDUXF716294",
            "Fecha": "2026-01-08",
            "Fecha de embarque": "2026-01-22",
            "Fecha de arribo": "2026-02-28",
            "Status": "Altamar",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 235.305,
            "Analisis": 0.3088,
            "Flete": 18857,
            "$venta": 60549,
            "$deben": 0,
            "Anticipos": 0
          },
          {
            "tripId": "8b60808e-a174-4a7f-8fd2-2d79fddca0db",
            "Nombre": "Zn 26-02-24",
            "Numero de booking": "EBKG 65602376",
            "Numero de BL": "HLCUME3240241360",
            "Fecha": "2024-02-26",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 514.231,
            "Analisis": 0.2956,
            "Flete": 41257,
            "$venta": 95132.55,
            "$deben": 0,
            "Agencia aduanal": 106278.39
          },
          {
            "tripId": "0223805c-7aaf-4fa6-b658-dd9af2a52040",
            "Nombre": "Zn 11-03-24",
            "Numero de booking": "EBKG 67604604",
            "Numero de BL": "HLCUME3240329407",
            "Fecha": "2024-03-11",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 20,
            "Peso": 463.988,
            "Analisis": 0.2691,
            "Flete": 37535,
            "$venta": 76558.35,
            "$deben": 0,
            "Agencia aduanal": 96725.62
          },
          {
            "tripId": "fe4ab53b-3d90-4f16-a10f-5a7f6646d41a",
            "Nombre": "Zn 19-03-24",
            "Numero de booking": "EBKG 61606323",
            "Numero de BL": "HLCUME3240331942",
            "Fecha": "2024-03-19",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 514.66,
            "Analisis": 0.2542,
            "Flete": 41257,
            "$venta": 81316.28,
            "$deben": 0,
            "Agencia aduanal": 106278.39
          },
          {
            "tripId": "a1f1f6f1-28cb-4e95-8124-67e0c4cd1771",
            "Nombre": "Zn 08-04-24",
            "Numero de booking": "EBKG 65942677",
            "Numero de BL": "HLCUME3240427297",
            "Fecha": "2024-04-08",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 513.506,
            "Analisis": 0.2512,
            "Flete": 43369,
            "$venta": 81134.58,
            "$deben": 0,
            "Agencia aduanal": 106278.39
          },
          {
            "tripId": "2a13d483-debf-4526-8fbf-96389088b75c",
            "Nombre": "Zn 16-04-24",
            "Numero de booking": "EBKG 62610617",
            "Numero de BL": "HLCUME3240443182",
            "Fecha": "2024-04-16",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 512.432,
            "Analisis": 0.2506,
            "Flete": 43369,
            "$venta": 81061.742,
            "$deben": 0,
            "Agencia aduanal": 106278.39
          },
          {
            "tripId": "cec1f45b-d085-4784-b621-580c0345dee1",
            "Nombre": "Zn 06-05-24",
            "Numero de booking": "EBKG 63613849",
            "Numero de BL": "HLCUME3240517891",
            "Fecha": "2024-05-06",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 511.506,
            "Analisis": 0.2633,
            "Flete": 43119,
            "$venta": 84398.49,
            "$deben": 0,
            "Agencia aduanal": 106278.39
          },
          {
            "tripId": "0ecd32c6-0063-4274-a084-028b4489424c",
            "Nombre": "Zn 20-05-24",
            "Numero de booking": "EBKG 69284443",
            "Numero de BL": "HLCUME3240549344",
            "Fecha": "2024-05-20",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 20,
            "Peso": 465.939,
            "Analisis": 0.2824,
            "Flete": 39205,
            "$venta": 83869.2,
            "$deben": 0,
            "Agencia aduanal": 96725.62
          },
          {
            "tripId": "3252dd2d-a94f-44a9-8a9b-f5601d4f620b",
            "Nombre": "Zn 03-06-24",
            "Numero de booking": "EBKG 65284913",
            "Numero de BL": "HLCUME3240612388",
            "Fecha": "2024-06-03",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 18,
            "Peso": 416.292,
            "Analisis": 0.3201,
            "Flete": 35291,
            "$venta": 94880.82,
            "$deben": 0,
            "Agencia aduanal": 87172.86
          },
          {
            "tripId": "6695fd4d-e1d5-46cc-90c8-1d1efc5efee9",
            "Nombre": "Zn 01-07-24",
            "Numero de booking": "EBKG 62623056",
            "Numero de BL": "HLCUME3240711858",
            "Fecha": "2024-07-01",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 22,
            "Peso": 511.408,
            "Analisis": 0.3143,
            "Flete": 49213,
            "$venta": 119766.6395,
            "$deben": 0,
            "Agencia aduanal": 109216.38
          },
          {
            "tripId": "d1e9ad33-c8e3-41d7-acd8-d744df993f75",
            "Nombre": "Zn 22-07-24",
            "Numero de booking": "EBKG 64293738",
            "Numero de BL": "HLCUME3240759157",
            "Fecha": "2024-07-22",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 18,
            "Peso": 415.776,
            "Analisis": 0.3348,
            "Flete": 40277,
            "$venta": 91587.8,
            "$deben": 0,
            "Agencia aduanal": 87172.86
          },
          {
            "tripId": "1b296b59-87ef-4d56-b043-75d4387d3b43",
            "Nombre": "Zn 05-08-24",
            "Numero de booking": "EBKG 61963557",
            "Numero de BL": "HLCUME3240814156",
            "Fecha": "2024-08-05",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 233.6,
            "Analisis": 0.3113,
            "Flete": 22405,
            "$venta": 48614.5,
            "$deben": 0,
            "Agencia aduanal": 48961.81
          },
          {
            "tripId": "87d44d97-054d-45f7-a338-485609b38024",
            "Nombre": "Zn 13-08-24",
            "Numero de booking": "EBKG 67302066",
            "Numero de BL": "HLCUME3240855100/3240828840",
            "Fecha": "2024-08-13",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 231.52,
            "Analisis": 0.3174,
            "Flete": 20171,
            "$venta": 51337.72,
            "$deben": 0,
            "Agencia aduanal": 51899.81
          },
          {
            "tripId": "31ef4519-6fb4-4246-8fae-69f1c2c3350f",
            "Nombre": "Zn 20-08-24",
            "Numero de booking": "EBKG 62966403",
            "Numero de BL": "HLCUME3240844608",
            "Fecha": "2024-08-20",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 241.029,
            "Analisis": 0.2974,
            "Flete": 22405,
            "$venta": 52126.72,
            "$deben": 0,
            "Agencia aduanal": 48961.81
          },
          {
            "tripId": "f5db33d6-01c1-429c-86e5-7c58f884c338",
            "Nombre": "Zn 03-09-24",
            "Numero de booking": "EBKG 69302216",
            "Numero de BL": "HLCUME3240909089",
            "Fecha": "2024-09-03",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 224.148,
            "Analisis": 0.3219,
            "Flete": 22405,
            "$venta": 53371.77,
            "$deben": 0,
            "Agencia aduanal": 48961.81
          },
          {
            "tripId": "f70cd681-2bce-4ffc-bb60-a1a2ac975a6b",
            "Nombre": "Zn 24-09-24",
            "Numero de booking": "EBKG 68305165",
            "Numero de BL": "HLCUME3240959175",
            "Fecha": "2024-09-24",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 231.609,
            "Analisis": 0.3168,
            "Flete": 19425,
            "$venta": 56355.34,
            "$deben": 0,
            "Agencia aduanal": 48961.81
          },
          {
            "tripId": "e51da308-9e1b-4b27-a0db-940d64486468",
            "Nombre": "Zn 30-09-24",
            "Numero de booking": "EBKG 65639350",
            "Numero de BL": "HLCUME3241003424",
            "Fecha": "2024-09-30",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.786,
            "Analisis": 0.3166,
            "Flete": 19425,
            "$venta": 56618.02,
            "$deben": 0,
            "Agencia aduanal": 48961.81
          },
          {
            "tripId": "502737ca-d3b9-414e-b7b6-358acc351435",
            "Nombre": "Zn 21-10-24",
            "Numero de booking": "EBKG10552568",
            "Numero de BL": "MEDUXF085286",
            "Fecha": "2024-10-21",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 16,
            "Peso": 378.828,
            "Analisis": 0.3382,
            "Flete": 30797,
            "$venta": 86327.32,
            "$deben": 0,
            "Agencia aduanal": 89150.36
          },
          {
            "tripId": "8840be89-49a3-4d6e-a04f-cec8c9d0fc45",
            "Nombre": "Zn 28-10-24",
            "Numero de booking": "EBKG10625994",
            "Numero de BL": "MEDUXF091250",
            "Fecha": "2024-10-28",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 236.172,
            "Analisis": 0.3046,
            "Flete": 19145,
            "$venta": 54071.81,
            "$deben": 0,
            "Agencia aduanal": 48961.81
          },
          {
            "tripId": "d7f5f7fc-b3fd-4c38-aa04-942595052932",
            "Nombre": "Zn 11-11-24",
            "Numero de booking": "EBKG10761444",
            "Numero de BL": "MEDUXF110100",
            "Fecha": "2024-11-11",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 236.258,
            "Analisis": 0.3109,
            "Flete": 19165,
            "$venta": 53925.52,
            "$deben": 0,
            "Agencia aduanal": 48602
          },
          {
            "tripId": "412b442c-dbbd-45b8-9f80-05cae7360d63",
            "Nombre": "Zn 25-11-24",
            "Numero de booking": "EBKG10897917",
            "Numero de BL": "MEDUXF130496",
            "Fecha": "2024-11-25",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 16,
            "Peso": 379.036,
            "Analisis": 0.3175,
            "Flete": 30545,
            "$venta": 84290.6,
            "$deben": 0,
            "Agencia aduanal": 79194.4
          },
          {
            "tripId": "d26931f1-391e-4cb2-a035-542744129359",
            "Nombre": "ZN 10-12-24",
            "Numero de booking": "EBKG11063431",
            "Numero de BL": "MEDUXF148134",
            "Fecha": "2024-12-10",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 282.957,
            "Analisis": 0.3067,
            "Flete": 22800,
            "$venta": 58370.64,
            "$deben": 0,
            "Agencia aduanal": 58082.8
          },
          {
            "tripId": "ef5ce9b5-6f29-4032-aacd-9f76e8ec6bbe",
            "Nombre": "ZN 21-01-25",
            "Numero de booking": "EBKG11500421",
            "Numero de BL": "MEDUXF195838",
            "Fecha": "2025-01-21",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 236.248,
            "Analisis": 0.2765,
            "Flete": 19223,
            "$venta": 39070.85,
            "$deben": 0,
            "Agencia aduanal": 48621
          },
          {
            "tripId": "d3167006-4094-4708-8f40-110de3386886",
            "Nombre": "ZN 05-02-25",
            "Numero de booking": "EBKG11617223",
            "Numero de BL": "MEDUXF215081",
            "Fecha": "2025-02-05",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 236.462,
            "Analisis": 0.2971,
            "Flete": 19223,
            "$venta": 43794.46,
            "$deben": 0,
            "Agencia aduanal": 75278.08
          },
          {
            "tripId": "d7849cb3-e318-4929-8ca4-5f2251e581d8",
            "Nombre": "ZN 17-02-25",
            "Numero de booking": "EBKG11758098",
            "Numero de BL": "MEDUXF231245",
            "Fecha": "2025-02-17",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 235.201,
            "Analisis": 0.3403,
            "Flete": 26725,
            "$venta": 45007.32,
            "$deben": 0,
            "Agencia aduanal": 49976.56
          },
          {
            "tripId": "9f89238b-1a79-4470-aee5-f75ac29a9deb",
            "Nombre": "ZN 03-03-25",
            "Numero de booking": "EBKG11919419",
            "Numero de BL": "MEDUXF254312",
            "Fecha": "2025-03-03",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 236.176,
            "Analisis": 0.23,
            "Flete": 20042,
            "$venta": 45071.49,
            "$deben": 0,
            "Agencia aduanal": 55243.98
          },
          {
            "tripId": "3f3d47c8-627d-4639-96a0-6c16ada853cf",
            "Nombre": "ZN 11-03-25",
            "Numero de booking": "EBKG12034237",
            "Numero de BL": "MEDUXF263966",
            "Fecha": "2025-03-11",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 236.393,
            "Analisis": 0.2594,
            "Flete": 20042,
            "$venta": 45099.48,
            "$deben": 0,
            "Agencia aduanal": 48621
          },
          {
            "tripId": "9f64364f-f048-44c2-9bf6-644789b771b1",
            "Nombre": "ZN 14-04-25",
            "Numero de booking": "EBKG12429993",
            "Numero de BL": "MEDUXF316897",
            "Fecha": "2025-04-14",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.962,
            "Analisis": 0.3068,
            "Flete": 19471,
            "$venta": 40290.38,
            "$deben": 0,
            "Agencia aduanal": 48621
          },
          {
            "tripId": "d2b2c9a1-15c1-43ff-b6e8-6f4d9c7d9358",
            "Nombre": "ZN 28-04-25",
            "Numero de booking": "EBKG12566964",
            "Numero de BL": "MEDUXF331961",
            "Fecha": "2025-04-28",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 235.152,
            "Analisis": 0.291,
            "Flete": 19307,
            "$venta": 43528.9,
            "$deben": 0,
            "Agencia aduanal": 48621
          },
          {
            "tripId": "825ade22-a4d5-4449-9d2f-8c847cf92744",
            "Nombre": "ZN 12-06-25",
            "Numero de booking": "EBKG13142418",
            "Numero de BL": "MEDUXF409809",
            "Fecha": "2025-06-12",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 283.094,
            "Analisis": 0.3007,
            "Flete": 23107,
            "$venta": 54019.91,
            "$deben": 0,
            "Agencia aduanal": 59422.64
          },
          {
            "tripId": "70defaf7-a40a-4d14-b258-c96b5c373ae9",
            "Nombre": "ZN 24-06-25",
            "Numero de booking": "EBKG13142499",
            "Numero de BL": "MEDUXF429237",
            "Fecha": "2025-06-24",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 282.334,
            "Analisis": 0.2959,
            "Flete": 23107,
            "$venta": 53923.56,
            "$deben": 0,
            "Agencia aduanal": 59422.64
          },
          {
            "tripId": "21cd0c09-4486-4c5f-999d-59b87f475d93",
            "Nombre": "ZN 02-07-25",
            "Numero de booking": "EBKG13278930",
            "Numero de BL": "MEDUXF444798",
            "Fecha": "2025-07-02",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 281.024,
            "Analisis": 0.2738,
            "Flete": 23107,
            "$venta": 53721.93,
            "$deben": 0,
            "Agencia aduanal": 59422.64
          },
          {
            "tripId": "2de5b52d-4c06-46a8-b774-236ea0d93176",
            "Nombre": "ZN 04-07-25",
            "Numero de booking": "EBKG13347383",
            "Numero de BL": "MEDUXF446207",
            "Fecha": "2025-07-04",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 232.221,
            "Analisis": 0.2861,
            "Flete": 19307,
            "$venta": 44874.61,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "6424ea13-7ce3-4ea2-8c1b-cff92c6976ca",
            "Nombre": "ZN 10-07-25",
            "Numero de booking": "EBKG13491270",
            "Numero de BL": "MEDUXF454441",
            "Fecha": "2025-07-10",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 279.71,
            "Analisis": 0.2821,
            "Flete": 23107,
            "$venta": 53934.99,
            "$deben": 0,
            "Agencia aduanal": 82936.78
          },
          {
            "tripId": "ccb28ec4-5209-48ab-8b23-26fa2e39f5d6",
            "Nombre": "ZN 22-07-25",
            "Numero de booking": "EBKG13568923",
            "Numero de BL": "MEDUXF475941",
            "Fecha": "2025-07-22",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 274.12,
            "Analisis": 0.2815,
            "Flete": 23107,
            "$venta": 51860.61,
            "$deben": 0,
            "Agencia aduanal": 59422.64
          },
          {
            "tripId": "4d457907-4df2-42de-a0a0-2cab79836681",
            "Nombre": "ZN 05-08-25",
            "Numero de booking": "EBKG13769065",
            "Numero de BL": "MEDUXF497093",
            "Fecha": "2025-08-05",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.222,
            "Analisis": 0.2927,
            "Flete": 19307,
            "$venta": 43549.97,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "f270ff62-056e-4a07-952b-9960560a4cf8",
            "Nombre": "ZN 12-08-25",
            "Numero de booking": "EBKG13858408",
            "Numero de BL": "MEDUXF509947",
            "Fecha": "2025-08-12",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 235.081,
            "Analisis": 0.285,
            "Flete": 19307,
            "$venta": 44903.17,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "c60af64b-a7e2-4099-8d57-ec2db3339938",
            "Nombre": "ZN 28-08-25",
            "Numero de booking": "EBKG13976572",
            "Numero de BL": "MEDUXF539001",
            "Fecha": "2025-08-28",
            "Fecha de embarque": "2025-09-14",
            "Fecha de arribo": "2025-11-23",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.926,
            "Analisis": 0.2846,
            "Flete": 19307,
            "$venta": 45232,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "db5de731-c876-4b10-8c72-0e182c4e0a47",
            "Nombre": "ZN 09-09-25",
            "Numero de booking": "EBKG14076667",
            "Numero de BL": "MEDUXF554000",
            "Fecha": "2025-09-09",
            "Fecha de embarque": "2025-09-19",
            "Fecha de arribo": "2025-11-23",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.41,
            "Analisis": 0.3076,
            "Flete": 19307,
            "$venta": 44919.17,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "09b6fc15-3096-46e3-aedc-5f7cda9e0367",
            "Nombre": "ZN 11-09-25",
            "Numero de booking": "EBKG14142710",
            "Numero de BL": "MEDUXF560130",
            "Fecha": "2025-09-11",
            "Fecha de embarque": "2025-09-27",
            "Fecha de arribo": "2025-11-23",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.432,
            "Analisis": 0.3012,
            "Flete": 19307,
            "$venta": 44936.88,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "86df4817-0368-4694-9666-a3e965b58461",
            "Nombre": "ZN 30-09-25",
            "Numero de booking": "EBKG14291558",
            "Numero de BL": "MEDUXF585970",
            "Fecha": "2025-09-30",
            "Fecha de embarque": "2025-10-15",
            "Fecha de arribo": "2025-11-23",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 234.876,
            "Analisis": 0.2701,
            "Flete": 19307,
            "$venta": 43618.9,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "292712fc-458c-4bbc-ad4e-71832a9128c6",
            "Nombre": "ZN 07-10-25",
            "Numero de booking": "EBKG14385085",
            "Numero de BL": "MEDUXF595318",
            "Fecha": "2025-10-07",
            "Fecha de embarque": "2025-10-19",
            "Fecha de arribo": "2025-12-02",
            "Status": "Cerrado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 235.591,
            "Analisis": 0.2801,
            "Flete": 19307,
            "$venta": 45027.7,
            "$deben": 0,
            "Agencia aduanal": 49721.7
          },
          {
            "tripId": "b17144f1-92c0-4aa0-be12-e90213e88f6a",
            "Nombre": "ZN 22-10-25",
            "Numero de booking": "EBKG14539332",
            "Numero de BL": "MEDUXF617690",
            "Fecha": "2025-10-22",
            "Fecha de embarque": "2025-06-12",
            "Fecha de arribo": "2025-12-29",
            "Status": "Liberado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 282.732,
            "Analisis": 0.3125,
            "Flete": 22567,
            "$venta": 58032.74,
            "$deben": 5803.274,
            "Agencia aduanal": 59422.64
          },
          {
            "tripId": "e4256816-2c36-49ae-8869-9ef4d16f3196",
            "Nombre": "ZN 04-11-25",
            "Numero de booking": "EBKG14680396",
            "Numero de BL": "MEDUXF634695",
            "Fecha": "2025-11-04",
            "Fecha de embarque": "2025-12-12",
            "Fecha de arribo": "2026-01-04",
            "Status": "Liberado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 235.395,
            "Analisis": 0.3315,
            "Flete": 18857,
            "$venta": 49411.12,
            "$deben": 4941.112,
            "Agencia aduanal": 90985.94
          },
          {
            "tripId": "63a06afb-939b-432f-8300-4e4b6a5f02b5",
            "Nombre": "ZN 11-11-25",
            "Numero de booking": "EBKG14738459",
            "Numero de BL": "MEDUXF644314",
            "Fecha": "2025-11-11",
            "Fecha de embarque": "2025-11-26",
            "Fecha de arribo": "2026-01-12",
            "Status": "Liberado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 283.404,
            "Analisis": 0.3332,
            "Flete": 22567,
            "$venta": 59452.73,
            "$deben": 5945.273,
            "Agencia aduanal": 59422.64
          },
          {
            "tripId": "d9a98fb5-8c9a-4342-9a65-f98aa9085f77",
            "Nombre": "ZN 25-11-25",
            "Numero de booking": "EBKG14925643",
            "Numero de BL": "MEDUXF662993",
            "Fecha": "2025-11-25",
            "Fecha de embarque": "2025-09-13",
            "Fecha de arribo": "2026-01-14",
            "Status": "Liberado",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 281.357,
            "Analisis": 0.3419,
            "Flete": 22567,
            "$venta": 72076.4,
            "$deben": 7207.64,
            "Agencia aduanal": 59567.64
          },
          {
            "tripId": "24650d60-e960-4b6f-96f8-12bd048a068e",
            "Nombre": "ZN 03-12-25",
            "Numero de booking": "EBKG14956894",
            "Numero de BL": "MEDUXF674618",
            "Fecha": "2025-12-03",
            "Fecha de embarque": "2025-12-21",
            "Fecha de arribo": "2026-01-23",
            "Status": "Altamar",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 10,
            "Peso": 232.039,
            "Analisis": 0.2989,
            "Flete": 18857,
            "$venta": 49211.2,
            "$deben": 4921.12,
            "Agencia aduanal": 49735.62
          },
          {
            "tripId": "07177424-faab-40ae-8542-ca176d70c23a",
            "Nombre": "ZN 18-12-25",
            "Numero de booking": "EBKG15115740",
            "Numero de BL": "MEDUXF697270",
            "Fecha": "2025-12-18",
            "Fecha de embarque": "2026-03-02",
            "Fecha de arribo": "2026-02-11",
            "Status": "Altamar",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 12,
            "Peso": 280.027,
            "Analisis": 0.3201,
            "Flete": 22567,
            "$venta": 24560.84,
            "$deben": 2456.084,
            "Agencia aduanal": 59436.56
          },
          {
            "tripId": "7af40dbf-6860-4e42-b785-8f3b1cb48e26",
            "Nombre": "ZN 29-12-25",
            "Numero de booking": "EBKG15302982",
            "Numero de BL": "MEDUXF708150",
            "Fecha": "2025-12-29",
            "Fecha de embarque": "2026-11-02",
            "Fecha de arribo": "2026-02-18",
            "Status": "Altamar",
            "SI": "Verde",
            "Cut off": "Verde",
            "Contenedores": 8,
            "Peso": 187.819,
            "Analisis": 0.2951,
            "Flete": 14915,
            "$venta": 35933.24,
            "$deben": 28593.324,
            "Anticipos": 0,
            "Agencia aduanal": 40000
          },
          {
            "tripId": "956e86f4-20a3-4c2c-9c98-f2bb8890dd5c",
            "Nombre": "ZN 20-01-26",
            "Numero de booking": "EBKG15539379",
            "Numero de BL": "MEDUXF731863",
            "Fecha": "2026-01-20",
            "Fecha de embarque": "2026-02-01",
            "Fecha de arribo": "2026-03-12",
            "Status": "Ingresados",
            "SI": "Verde",
            "Cut off": "2026-01-28",
            "Contenedores": 10,
            "Peso": 235.356,
            "Analisis": 0,
            "Flete": 18857,
            "$venta": 0,
            "$deben": 0
          },
          {
            "tripId": "65a61f6c-8700-4ce0-a122-d48f677f6a54",
            "Nombre": "ZN 28-01-26",
            "Numero de booking": "EBKG15621546",
            "Fecha": "2026-01-28",
            "Fecha de embarque": "2026-02-07",
            "Fecha de arribo": "2026-03-26",
            "Status": "Programacion",
            "SI": "Verde",
            "Cut off": "2026-02-04",
            "Contenedores": 10,
            "Analisis": 0,
            "$venta": 0,
            "$deben": 0
          }
        ];

        // =====================================================
        // HELPER: Limpiar documentos antes de guardar en Supabase
        // Remueve base64 pesado, solo guarda metadata
        // =====================================================
        const cleanDocumentsForSupabase = (viaje) => {
            if (!viaje.documentos) return viaje;
            const docsClean = {};
            Object.keys(viaje.documentos).forEach(key => {
                const doc = viaje.documentos[key];
                docsClean[key] = {
                    uploaded: doc.uploaded || false,
                    fileName: doc.fileName || '',
                    uploadDate: doc.uploadDate || '',
                    storagePath: doc.storagePath || '',
                    storageUrl: doc.storageUrl || ''
                };
            });
            return { ...viaje, documentos: docsClean };
        };

        // =====================================================
        // MERGE INTELIGENTE - Compara timestamps para no perder cambios locales
        // =====================================================
        const mergeByTimestamp = (localViajes, supabaseViajes) => {
            if (!localViajes || localViajes.length === 0) return supabaseViajes;
            if (!supabaseViajes || supabaseViajes.length === 0) return localViajes;

            const result = [...supabaseViajes];
            const supabaseMap = new Map(supabaseViajes.map(v => [v.tripId, v]));

            for (const local of localViajes) {
                if (!local.tripId) continue;
                const supabase = supabaseMap.get(local.tripId);

                if (!supabase) {
                    // Viaje solo existe en local, agregarlo
                    result.push(local);
                } else {
                    // Comparar timestamps, mantener el más reciente
                    const localDate = new Date(local.lastModified || 0);
                    const supabaseDate = new Date(supabase.lastModified || 0);

                    if (localDate > supabaseDate) {
                        const idx = result.findIndex(v => v.tripId === local.tripId);
                        if (idx >= 0) {
                            result[idx] = local;
                            console.log(`🔄 Merge: "${local.Nombre}" - conservando versión local más reciente`);
                        }
                    }
                }
            }
            return result;
        };

        // =====================================================
        // DATABASE SERVICE - SUPABASE PRIMERO, LOCALSTORAGE COMO RESPALDO
        // =====================================================
        const DatabaseService = {
            // Obtener viajes - Supabase es la fuente principal
            async getViajes() {
                // Esperar a que Supabase esté listo antes de intentar cargar
                await waitForSupabase();

                const sb = getSupabase();
                let viajes = [];

                // Si no hay Supabase, usar localStorage
                if (!sb) {
                    const saved = localStorage.getItem('antigravity_crm_data');
                    viajes = saved ? JSON.parse(saved) : [];
                } else {
                    try {
                        const { data, error } = await sb.from('viajes').select('*').order('created_at', { ascending: false });
                        if (error) throw error;

                        // Merge inteligente: conservar cambios locales más recientes
                        const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                        viajes = mergeByTimestamp(localData, data || []);
                        localStorage.setItem('antigravity_crm_data', JSON.stringify(viajes));
                    } catch (err) {
                        console.error('❌ Error Supabase, usando localStorage:', err.message);
                        const saved = localStorage.getItem('antigravity_crm_data');
                        viajes = saved ? JSON.parse(saved) : [];
                    }
                }

                // Si no hay datos, usar los viajes iniciales pre-cargados
                if (viajes.length === 0 && typeof INITIAL_VIAJES !== 'undefined' && INITIAL_VIAJES.length > 0) {
                    viajes = [...INITIAL_VIAJES];
                    // Guardar en localStorage para futuras cargas
                    localStorage.setItem('antigravity_crm_data', JSON.stringify(viajes));
                }

                return viajes;
            },

            // Guardar viaje - Guarda en Supabase primero, luego localStorage
            async saveViaje(viaje) {
                // Esperar a que Supabase esté listo
                await waitForSupabase();
                const sb = getSupabase();

                if (!sb) {
                    console.warn('⚠️ saveViaje: Supabase NO disponible, guardando solo en localStorage');
                }

                // Preparar documento para guardar (sin base64 grandes)
                const viajeParaGuardar = cleanDocumentsForSupabase(viaje);

                // Si hay Supabase, guardar ahí primero
                if (sb) {
                    try {
                        const { data, error } = await sb.from('viajes').upsert(viajeParaGuardar, { onConflict: 'tripId' }).select();
                        if (error) {
                            console.error('❌ Supabase error:', error);
                            throw error;
                        }
                    } catch (err) {
                        console.error('❌ Error guardando en Supabase:', err.message, err);
                        // Continuar para guardar en localStorage como respaldo
                    }
                }

                // Guardar también en localStorage como respaldo
                try {
                    const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                    const idx = localData.findIndex(v => v.tripId === viajeParaGuardar.tripId);
                    if (idx >= 0) localData[idx] = viajeParaGuardar;
                    else localData.unshift(viajeParaGuardar);
                    localStorage.setItem('antigravity_crm_data', JSON.stringify(localData));
                } catch (storageErr) {
                    console.error('Error en localStorage:', storageErr);
                }

                return { success: true };
            },

            // Guardar múltiples viajes
            async saveViajesBatch(viajes) {
                const sb = getSupabase();

                // Limpiar documentos base64 para Supabase
                const viajesClean = viajes.map(cleanDocumentsForSupabase);

                if (sb) {
                    try {
                        const { error } = await sb.from('viajes').upsert(viajesClean, { onConflict: 'tripId' });
                        if (error) throw error;
                    } catch (err) {
                        console.error('❌ Error batch Supabase:', err.message);
                    }
                }

                localStorage.setItem('antigravity_crm_data', JSON.stringify(viajesClean));
                return { success: true };
            },

            // Eliminar viaje
            async deleteViaje(tripId) {
                const sb = getSupabase();

                if (sb) {
                    try {
                        const { error } = await sb.from('viajes').delete().eq('tripId', tripId);
                        if (error) throw error;
                    } catch (err) {
                        console.error('❌ Error eliminando de Supabase:', err.message);
                    }
                }

                const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                localStorage.setItem('antigravity_crm_data', JSON.stringify(localData.filter(v => v.tripId !== tripId)));
                return { success: true };
            },

            // Migrar datos de localStorage a Supabase
            async migrateToSupabase() {
                const sb = getSupabase();

                if (!sb) {
                    return { success: false, error: 'Supabase no disponible. Verifica tu conexión a internet y recarga la página.' };
                }

                const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                if (localData.length === 0) {
                    return { success: true, count: 0, message: 'No hay datos para migrar' };
                }

                // Limpiar documentos base64
                const viajesClean = localData.map(cleanDocumentsForSupabase);

                try {
                    const { error } = await sb.from('viajes').upsert(viajesClean, { onConflict: 'tripId' });
                    if (error) throw error;
                    return { success: true, count: viajesClean.length };
                } catch (err) {
                    console.error('❌ Error en migración:', err.message);
                    return { success: false, error: err.message };
                }
            },

            // Contar documentos que necesitan migración (base64 → Storage)
            async countDocsToMigrate() {
                const viajes = await this.getViajes();
                let count = 0;
                viajes.forEach(v => {
                    if (!v.documentos) return;
                    Object.values(v.documentos).forEach(doc => {
                        if (doc.base64 && !doc.storageUrl) count++;
                    });
                });
                return count;
            },

            // Migrar documentos base64 a Supabase Storage
            async migrateBase64ToStorage(onProgress) {
                const viajes = await this.getViajes();
                const toMigrate = [];

                // Encontrar docs a migrar
                viajes.forEach(v => {
                    if (!v.documentos) return;
                    Object.entries(v.documentos).forEach(([docType, doc]) => {
                        if (doc.base64 && !doc.storageUrl) {
                            toMigrate.push({ viaje: v, docType, doc });
                        }
                    });
                });

                if (toMigrate.length === 0) {
                    return { success: true, count: 0, message: 'No hay documentos para migrar' };
                }

                let migrated = 0;
                const errors = [];

                for (const { viaje, docType, doc } of toMigrate) {
                    try {
                        // Convertir base64 a blob
                        const blob = base64ToBlob(doc.base64);
                        if (!blob) throw new Error('No se pudo convertir base64');

                        // Subir a Storage
                        const path = `documentos/${viaje.tripId}/${docType}_${Date.now()}.pdf`;
                        const result = await StorageService.upload(path, blob, doc.fileName || `${docType}.pdf`);

                        if (!result.success) throw new Error(result.error);

                        // Actualizar documento (quitar base64, agregar URL)
                        viaje.documentos[docType] = {
                            uploaded: true,
                            fileName: doc.fileName || `${docType}.pdf`,
                            uploadDate: doc.uploadDate || new Date().toISOString(),
                            storagePath: path,
                            storageUrl: result.url
                            // No incluir base64
                        };

                        // Guardar viaje actualizado
                        await this.saveViaje(viaje);
                        migrated++;
                        onProgress?.(migrated, toMigrate.length);
                    } catch (err) {
                        console.error(`Error migrando ${docType} de ${viaje.Nombre}:`, err);
                        errors.push(`${viaje.Nombre} - ${docType}: ${err.message}`);
                    }
                }

                return {
                    success: errors.length === 0,
                    count: migrated,
                    total: toMigrate.length,
                    errors
                };
            }
        };

        // =====================================================
        // BACKUP SERVICE - Backup automático a Supabase Storage
        // =====================================================
        const BackupService = {
            BUCKET: 'backups',
            FOLDER: 'viajes',
            MAX_BACKUPS: 7,

            // Generar nombre de archivo con fecha
            getBackupFileName: () => {
                const date = new Date().toISOString().split('T')[0];
                return `backup_${date}.json`;
            },

            // Subir backup a Supabase Storage
            uploadBackup: async (viajes) => {
                const fileName = BackupService.getBackupFileName();
                const filePath = `${BackupService.FOLDER}/${fileName}`;
                const jsonData = JSON.stringify(viajes, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });

                const response = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/${BackupService.BUCKET}/${filePath}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'x-upsert': 'true'
                        },
                        body: blob
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error subiendo backup: ${errorText}`);
                }
                return { success: true, fileName };
            },

            // Listar backups existentes
            listBackups: async () => {
                const response = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/list/${BackupService.BUCKET}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prefix: BackupService.FOLDER })
                    }
                );

                if (!response.ok) return [];
                const files = await response.json();
                return files.sort((a, b) => b.name.localeCompare(a.name));
            },

            // Descargar un backup específico
            downloadBackup: async (fileName) => {
                const filePath = `${BackupService.FOLDER}/${fileName}`;
                const response = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/public/${BackupService.BUCKET}/${filePath}`
                );

                if (!response.ok) throw new Error('Error descargando backup');
                return await response.json();
            },

            // Limpiar backups antiguos (mantener solo últimos 7)
            cleanOldBackups: async () => {
                try {
                    const backups = await BackupService.listBackups();
                    if (backups.length <= BackupService.MAX_BACKUPS) return;

                    const toDelete = backups.slice(BackupService.MAX_BACKUPS);
                    for (const file of toDelete) {
                        await fetch(
                            `${SUPABASE_URL}/storage/v1/object/${BackupService.BUCKET}/${BackupService.FOLDER}/${file.name}`,
                            {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                            }
                        );
                    }
                } catch (err) {
                    console.warn('No se pudieron limpiar backups antiguos:', err);
                }
            },

            // Verificar si necesita backup (más de 24 horas)
            needsBackup: () => {
                const lastBackup = localStorage.getItem('antigravity_last_auto_backup');
                if (!lastBackup) return true;

                const lastDate = new Date(lastBackup);
                const now = new Date();
                const hoursDiff = (now - lastDate) / (1000 * 60 * 60);
                return hoursDiff >= 24;
            }
        };

        // =====================================================
        // =====================================================
        // SUPABASE AUTH SERVICE (no usado actualmente)
        // =====================================================
        const SupabaseAuthService = {
            async getCurrentUser() {
                const sb = getSupabase();
                if (!sb) return null;
                try { const { data: { user } } = await sb.auth.getUser(); return user; }
                catch { return null; }
            },
            async signIn(email, password) {
                const sb = getSupabase();
                if (!sb) return { success: false, error: 'No configurado' };
                try {
                    const { data, error } = await sb.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    return { success: true, data };
                } catch (err) { return { success: false, error: err.message }; }
            },
            async signUp(email, password) {
                const sb = getSupabase();
                if (!sb) return { success: false, error: 'No configurado' };
                try {
                    const { data, error } = await sb.auth.signUp({ email, password });
                    if (error) throw error;
                    return { success: true, data };
                } catch (err) { return { success: false, error: err.message }; }
            },
            async signOut() {
                const sb = getSupabase();
                if (!sb) return { success: true };
                await sb.auth.signOut();
                return { success: true };
            }
        };

        // =====================================================
        // PROFILE SERVICE - Gestión de perfiles de usuario
        // =====================================================
        const ProfileService = {
            async getProfile(userId) {
                const sb = getSupabase();
                if (!sb) return null;
                try {
                    const { data, error } = await sb.from('profiles').select('*').eq('id', userId).single();
                    if (error) throw error;
                    return data;
                } catch (e) {
                    console.warn('Error obteniendo perfil:', e);
                    return null;
                }
            },

            // Verificar si puede ver datos financieros (Venta, Anticipos, 10%)
            canSeeFinancials(profile) {
                return profile?.rol === 'admin'; // Solo admins ven finanzas
            }
        };

        // =====================================================
        // HELPERS
        // =====================================================
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val || 0);
        const formatNumber = (val) => new Intl.NumberFormat('es-MX').format(val || 0);
        const formatUSD = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
        const formatPercent = (val) => ((Number(val) || 0) * 100).toFixed(2) + '%';
        const MESES = CONFIG.MESES;

        // =====================================================
        // DOCUMENT TYPES - Checklist de documentos por viaje
        // =====================================================
        const DOCUMENT_TYPES = [
            { id: 'booking', label: 'Booking', icon: 'FileText' },
            { id: 'bl', label: 'BL', icon: 'Ship' },
            { id: 'analisis', label: 'Análisis', icon: 'FileSearch' },
            { id: 'packing', label: 'Packing List', icon: 'Package' },
            { id: 'anticipo', label: 'Comprobante de Anticipo', icon: 'Receipt' },
            { id: 'analisisCliente', label: 'Análisis Cliente', icon: 'ClipboardCheck' },
            { id: 'factura', label: 'Factura', icon: 'FileText' },
            { id: 'facturaPreliminar', label: 'Factura Preliminar', icon: 'FileClock' }
        ];

        const createEmptyDocumentos = () => {
            const docs = {};
            DOCUMENT_TYPES.forEach(dt => {
                docs[dt.id] = { uploaded: false, fileName: '', uploadDate: '', storagePath: '', storageUrl: '' };
            });
            return docs;
        };

        const countUploadedDocs = (documentos) => {
            if (!documentos) return 0;
            return Object.values(documentos).filter(d => d && d.uploaded).length;
        };

        const getDocsColor = (count) => {
            if (count === 0) return 'var(--text-muted)';
            if (count <= 3) return 'var(--danger)';
            if (count <= 5) return 'var(--warning)';
            if (count <= 7) return 'var(--info)';
            return 'var(--success)'; // 8 = completo
        };

        // =====================================================
        // SUPABASE STORAGE - Usando fetch directo (funciona sin librería)
        // =====================================================
        const StorageService = {
            bucketName: 'documentos',

            // Subir archivo a Supabase Storage usando fetch directo
            // customFileName es opcional - si se proporciona, se usa en lugar del nombre original
            async uploadFile(file, tripId, docTypeId, customFileName = null) {
                const timestamp = Date.now();
                const safeName = customFileName
                    ? customFileName.replace(/[^a-zA-Z0-9.-]/g, '_')
                    : file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const path = `${tripId}/${docTypeId}_${timestamp}_${safeName}`;

                const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${this.bucketName}/${path}`;

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': file.type || 'application/pdf',
                        'x-upsert': 'true'
                    },
                    body: file
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Error ${response.status} al subir archivo`);
                }

                // URL pública del archivo
                const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${this.bucketName}/${path}`;

                return {
                    path: path,
                    url: publicUrl
                };
            },

            // Eliminar archivo de Storage
            async deleteFile(path) {
                if (!path) return;

                try {
                    const deleteUrl = `${SUPABASE_URL}/storage/v1/object/${this.bucketName}/${path}`;
                    await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'apikey': SUPABASE_ANON_KEY
                        }
                    });
                } catch (err) {
                    console.error('Error eliminando archivo:', err);
                }
            },

            // Obtener URL pública de un archivo
            getPublicUrl(path) {
                if (!path) return null;
                return `${SUPABASE_URL}/storage/v1/object/public/${this.bucketName}/${path}`;
            }
        };

        // Funciones para manejo de PDFs (compatibles con Storage y Base64)
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB con Supabase Storage

        // Convertir base64 a Blob (para migración de docs antiguos)
        const base64ToBlob = (base64) => {
            try {
                const parts = base64.split(',');
                const byteString = atob(parts[1] || parts[0]);
                const mimeType = parts[0]?.match(/:(.*?);/)?.[1] || 'application/pdf';
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], { type: mimeType });
            } catch (err) {
                console.error('Error convirtiendo base64 a blob:', err);
                return null;
            }
        };

        // Extraer solo la primera página de un PDF usando pdf-lib
        const extractFirstPage = async (file) => {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pageCount = pdfDoc.getPageCount();

                // Si solo tiene una página, retornar el archivo original
                if (pageCount === 1) {
                    return file;
                }

                // Crear nuevo PDF con solo la primera página
                const newPdf = await PDFLib.PDFDocument.create();
                const [firstPage] = await newPdf.copyPages(pdfDoc, [0]);
                newPdf.addPage(firstPage);

                // Convertir a Blob
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                return blob;
            } catch (err) {
                console.error('Error extrayendo primera página:', err);
                // Si falla, retornar el archivo original
                return file;
            }
        };

        const downloadPdf = (doc) => {
            const url = doc.storageUrl || doc.base64;
            if (!url) return;

            const link = document.createElement('a');
            link.href = url;
            link.download = doc.fileName || 'documento.pdf';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const viewPdfInNewTab = (doc) => {
            // Soporta tanto el nuevo formato (objeto) como el viejo (string base64)
            const url = typeof doc === 'string' ? doc : (doc.storageUrl || doc.base64);
            if (!url) {
                alert('No se encontró el archivo');
                return;
            }

            // Si es URL de Supabase Storage, abrir directo
            if (url.startsWith('http')) {
                // Crear ventana con visor de PDF
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${doc.fileName || 'Documento PDF'}</title>
                            <style>
                                body { margin: 0; padding: 0; background: #525659; }
                                iframe { width: 100%; height: 100vh; border: none; }
                            </style>
                        </head>
                        <body>
                            <iframe src="${url}" type="application/pdf"></iframe>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                } else {
                    // Si el navegador bloquea popups, abrir directo
                    window.location.href = url;
                }
            } else {
                // Es base64, abrir en nueva ventana
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${doc.fileName || 'Documento PDF'}</title>
                            <style>
                                body { margin: 0; padding: 0; }
                                iframe { width: 100%; height: 100vh; border: none; }
                            </style>
                        </head>
                        <body>
                            <iframe src="${url}"></iframe>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                }
            }
        };

        const robustParseDate = (val) => {
            if (!val) return null;
            if (val instanceof Date) return isNaN(val.getTime()) ? null : new Date(val.getFullYear(), val.getMonth(), val.getDate());
            if (typeof val === 'number') {
                const d = XLSX.SSF.parse_date_code(val);
                return new Date(d.y, d.m - 1, d.d);
            }
            const str = val.toString().trim();
            if (!str || str.toLowerCase() === 'verde') return null;

            // Soporte para fechas en español: "21 Noviembre 2025" / "21 de Noviembre de 2025"
            const cleaned = str.toLowerCase().replace(/\s+/g, ' ').replace(/\bde\b/g, '').trim();
            const spanishMatch = cleaned.match(/^(\d{1,2})\s+([a-záéíóúñ]+)\s+(\d{4})$/i);
            if (spanishMatch) {
                const d = Number(spanishMatch[1]);
                const monName = spanishMatch[2].normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                const y = Number(spanishMatch[3]);
                const months = {
                    enero: 0, febrero: 1, marzo: 2, abril: 3, mayo: 4, junio: 5,
                    julio: 6, agosto: 7, septiembre: 8, setiembre: 8, octubre: 9, noviembre: 10, diciembre: 11
                };
                if (months[monName] !== undefined) return new Date(y, months[monName], d);
            }

            // ISO format: 2024-01-20, 2024-01-20T00:00:00, 2024-01-20T00:00:00.000Z
            // IMPORTANTE: Buscar YYYY-MM-DD en cualquier parte del string para evitar problemas de timezone
            const isoMatch = str.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (isoMatch) {
                return new Date(Number(isoMatch[1]), Number(isoMatch[2]) - 1, Number(isoMatch[3]));
            }

            // Otros formatos: YYYY/MM/DD o DD/MM/YYYY o DD-MM-YYYY
            const formats = [/^(\d{4})[\/](\d{1,2})[\/](\d{1,2})$/, /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/];
            for (let fmt of formats) {
                const m = str.match(fmt);
                if (m) {
                    if (fmt === formats[0]) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
                    let [_, d, mo, y] = m.map(Number);
                    if (mo > 12) [d, mo] = [mo, d];
                    return new Date(y, mo - 1, d);
                }
            }

            // Último recurso - parsear y extraer solo año/mes/día para evitar timezone
            const parsed = new Date(str);
            if (!isNaN(parsed.getTime())) {
                // IMPORTANTE: Usar getUTCFullYear/Month/Date si parece ser UTC, sino usar local
                // Si el string contiene Z o +/- timezone, es UTC
                if (str.includes('Z') || /[+-]\d{2}:\d{2}$/.test(str)) {
                    return new Date(parsed.getUTCFullYear(), parsed.getUTCMonth(), parsed.getUTCDate());
                }
                return new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
            }
            return null;
        };

        const formatDateSpanish = (val) => {
            if (val === 'Verde') return null; // No mostrar fecha para Verde
            const d = robustParseDate(val);
            if (!d) return '-';
            return `${d.getDate()} ${MESES[d.getMonth()]} ${d.getFullYear()}`;
        };

        const formatDateForInput = (val) => {
            if (!val || val === 'Verde') return '';
            const d = robustParseDate(val);
            if (!d) return '';
            // IMPORTANTE: No usar toISOString() porque convierte a UTC y puede cambiar el día
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const generateUUID = () => {
            if (crypto?.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        };

        const getDaysUntil = (val) => {
            if (val === 'Verde') return null; // Verde = completado
            const d = robustParseDate(val);
            if (!d) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return Math.ceil((d - today) / (1000 * 60 * 60 * 24));
        };

        // =====================================================
        // EXCEL EXPORT/IMPORT SERVICE
        // =====================================================
        // Columnas para Excel y Google Sheets (deben coincidir)
        // IMPORTANTE: Incluye TODOS los campos del formulario
        const EXPORT_COLUMNS = [
            'tripId', 'Nombre', 'Numero de booking', 'Numero de BL', 'Fecha',
            'Fecha de embarque', 'Fecha de arribo', 'Status', 'Cut off',
            'Contenedores', 'Peso', 'Analisis', 'Flete',
            '$venta', '$deben', '10%', 'Anticipos', 'Agencia aduanal',
            'Origen', 'Destino', 'Cliente', 'Proveedor', 'Producto', 'Notas'
        ];

        // Formatear fecha a DD/MM/YYYY para Excel
        // IMPORTANTE: Sumamos 1 día para compensar el offset de timezone de XLSX
        const formatDateExport = (dateValue) => {
            if (!dateValue) return '';
            // Si es "Verde", no formatear
            if (dateValue === 'Verde') return 'Verde';

            // Si ya es string
            if (typeof dateValue === 'string') {
                // Formato ISO: 2024-01-08 o 2024-01-08T...
                const isoMatch = dateValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (isoMatch) {
                    const [, year, month, day] = isoMatch;
                    // Crear fecha local (sin compensación de día)
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}/${m}/${y}`;
                }
                // Formato DD/MM/YYYY ya existente
                const ddmmMatch = dateValue.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (ddmmMatch) {
                    const [, day, month, year] = ddmmMatch;
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}/${m}/${y}`;
                }
                // Cualquier otro formato, devolver sin modificar
                return dateValue;
            }

            // Solo para objetos Date reales
            if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
                const date = new Date(dateValue.getTime());
                const d = String(date.getDate()).padStart(2, '0');
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const y = date.getFullYear();
                return `${d}/${m}/${y}`;
            }

            return dateValue;
        };

        const ExcelService = {
            export(data, filename = 'Antigravity_Export') {
                if (!data || data.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Ordenar por fecha de más nuevo a más antiguo
                const sortedData = [...data].sort((a, b) => {
                    const dateA = robustParseDate(a.Fecha);
                    const dateB = robustParseDate(b.Fecha);
                    if (!dateA && !dateB) return 0;
                    if (!dateA) return 1;  // Sin fecha va al final
                    if (!dateB) return -1;
                    return dateB.getTime() - dateA.getTime();  // Más nuevo primero
                });

                // Exportar solo las columnas definidas, en orden
                const cleanData = sortedData.map(row => {
                    const clean = {};
                    EXPORT_COLUMNS.forEach(col => {
                        let value = row[col] !== undefined ? row[col] : '';
                        // Formatear fechas
                        if (['Fecha', 'Fecha de embarque', 'Fecha de arribo', 'Cut off'].includes(col) && value && value !== 'Verde') {
                            value = formatDateExport(value);
                        }
                        clean[col] = value;
                    });
                    return clean;
                });

                // raw: true evita que XLSX auto-convierta fechas a números seriales de Excel
                const ws = XLSX.utils.json_to_sheet(cleanData, { header: EXPORT_COLUMNS, raw: true });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Viajes');

                // Ajustar ancho de columnas
                const colWidths = EXPORT_COLUMNS.map(key => ({
                    wch: Math.max(key.length, 15)
                }));
                ws['!cols'] = colWidths;

                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `${filename}_${date}.xlsx`);
            },

            async import(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
                            const sheetName = wb.SheetNames[0];
                            if (!sheetName) throw new Error('Excel sin hojas');

                            const data = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                            resolve(data);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });
            },

            processImport(incoming, existing) {
                const results = { nuevos: 0, actualizados: 0, omitidos: 0, errores: 0, data: [...existing] };

                // Crear mapas para busqueda rapida por multiples campos
                const blMap = new Map();
                const bookingMap = new Map();
                const nombreMap = new Map();
                const nombreFechaMap = new Map(); // Combinacion Nombre + Fecha para mayor precision

                existing.forEach((v, idx) => {
                    if (v['Numero de BL']) blMap.set(v['Numero de BL'].toLowerCase().trim(), idx);
                    if (v['Numero de booking']) bookingMap.set(v['Numero de booking'].toLowerCase().trim(), idx);
                    if (v.Nombre) nombreMap.set(v.Nombre.toLowerCase().trim(), idx);
                    // Clave compuesta: Nombre + Fecha
                    if (v.Nombre && v.Fecha) {
                        const fechaStr = robustParseDate(v.Fecha)?.toISOString().split('T')[0] || '';
                        nombreFechaMap.set(v.Nombre.toLowerCase().trim() + '|' + fechaStr, idx);
                    }
                });

                // Set para rastrear indices ya procesados en esta importacion (evitar duplicados dentro del mismo Excel)
                const processedIncoming = new Set();

                incoming.forEach((row, rowIdx) => {
                    // Validar que tenga al menos Nombre o Booking
                    if (!row.Nombre && !row['Numero de booking']) {
                        results.errores++;
                        return;
                    }

                    // Normalizar valores para busqueda
                    const bl = (row['Numero de BL'] || '').toString().toLowerCase().trim();
                    const booking = (row['Numero de booking'] || '').toString().toLowerCase().trim();
                    const nombre = (row.Nombre || '').toString().toLowerCase().trim();
                    const fechaRow = robustParseDate(row.Fecha);
                    const fechaStr = fechaRow?.toISOString().split('T')[0] || '';
                    const nombreFechaKey = nombre + '|' + fechaStr;

                    // Crear clave unica para detectar duplicados dentro del mismo Excel
                    const incomingKey = bl || booking || nombreFechaKey || nombre;
                    if (processedIncoming.has(incomingKey)) {
                        results.omitidos++;
                        return; // Ya procesamos este registro en esta importacion
                    }
                    processedIncoming.add(incomingKey);

                    let matchIdx = -1;

                    // Buscar por BL (prioridad maxima - es unico)
                    if (bl && blMap.has(bl)) {
                        matchIdx = blMap.get(bl);
                    }
                    // Buscar por Booking (segunda prioridad)
                    else if (booking && bookingMap.has(booking)) {
                        matchIdx = bookingMap.get(booking);
                    }
                    // Buscar por Nombre + Fecha (tercera prioridad - muy probable que sea el mismo viaje)
                    else if (nombre && fechaStr && nombreFechaMap.has(nombreFechaKey)) {
                        matchIdx = nombreFechaMap.get(nombreFechaKey);
                    }
                    // Buscar solo por Nombre (ultima opcion - puede haber falsos positivos)
                    else if (nombre && nombreMap.has(nombre)) {
                        matchIdx = nombreMap.get(nombre);
                    }

                    // Procesar fecha
                    const fecha = robustParseDate(row.Fecha);

                    const viaje = {
                        ...row,
                        'Numero de BL': row['Numero de BL'] || '',
                        Fecha: fecha ? fecha.toISOString() : row.Fecha,
                        tripId: matchIdx >= 0 ? results.data[matchIdx].tripId : generateUUID(),
                        lastModified: new Date().toISOString(),
                        modifiedBy: 'Excel Import'
                    };

                    if (matchIdx >= 0) {
                        // Actualizar existente - preservar documentos si existen
                        const existingDocs = results.data[matchIdx].documentos;
                        results.data[matchIdx] = { ...results.data[matchIdx], ...viaje };
                        if (existingDocs) {
                            results.data[matchIdx].documentos = existingDocs;
                        }
                        results.actualizados++;
                    } else {
                        // Nuevo registro
                        viaje.documentos = createEmptyDocumentos();
                        results.data.unshift(viaje);
                        results.nuevos++;

                        // Actualizar mapas para detectar duplicados en filas siguientes del mismo Excel
                        const newIdx = 0; // Se inserto al inicio
                        if (bl) blMap.set(bl, newIdx);
                        if (booking) bookingMap.set(booking, newIdx);
                        if (nombre) nombreMap.set(nombre, newIdx);
                        if (nombre && fechaStr) nombreFechaMap.set(nombreFechaKey, newIdx);
                    }
                });

                return results;
            }
        };

        // =====================================================
        // NOTIFICATION SERVICE
        // =====================================================
        const NotificationService = {
            generate(viajes) {
                const notifications = [];
                viajes.forEach(v => {
                    if ((v.Status || '').toLowerCase() === 'cerrado') return;

                    const daysEmb = getDaysUntil(v['Fecha de embarque']);
                    if (daysEmb !== null && daysEmb >= 0 && daysEmb <= 7) {
                        notifications.push({
                            id: `emb-${v.tripId}`, type: daysEmb <= 2 ? 'danger' : 'warning',
                            title: daysEmb === 0 ? 'Embarque HOY' : `Embarque en ${daysEmb} dias`,
                            message: `${v.Nombre} - ${v['Numero de booking'] || 'Sin booking'}`,
                            viaje: v, priority: daysEmb <= 2 ? 1 : 2
                        });
                    }

                    const daysArr = getDaysUntil(v['Fecha de arribo']);
                    if (daysArr !== null && daysArr >= 0 && daysArr <= 7) {
                        notifications.push({
                            id: `arr-${v.tripId}`, type: daysArr <= 2 ? 'warning' : 'info',
                            title: daysArr === 0 ? 'Arribo HOY' : `Arribo en ${daysArr} dias`,
                            message: `${v.Nombre}`, viaje: v, priority: daysArr <= 2 ? 2 : 3
                        });
                    }

                    const saldo = Number(v['$deben']) || 0;
                    if (saldo > 50000) {
                        notifications.push({
                            id: `saldo-${v.tripId}`, type: 'warning',
                            title: 'Saldo pendiente alto', message: `${v.Nombre} - ${formatCurrency(saldo)}`,
                            viaje: v, priority: 2
                        });
                    }
                });
                return notifications.sort((a, b) => a.priority - b.priority);
            },

            getSummary(viajes) {
                let urgentes = 0, proximos = 0, saldos = 0, totalSaldo = 0;
                const vUrgentes = [], vProximos = [], vSaldos = [];

                viajes.forEach(v => {
                    if ((v.Status || '').toLowerCase() === 'cerrado') return;

                    const daysEmb = getDaysUntil(v['Fecha de embarque']);
                    if (daysEmb !== null && daysEmb >= 0 && daysEmb <= 2) { urgentes++; vUrgentes.push(v); }
                    if ((daysEmb !== null && daysEmb >= 0 && daysEmb <= 7) || (getDaysUntil(v['Fecha de arribo']) !== null && getDaysUntil(v['Fecha de arribo']) >= 0 && getDaysUntil(v['Fecha de arribo']) <= 7)) {
                        proximos++;
                        if (!vUrgentes.includes(v)) vProximos.push(v);
                    }

                    const s = Number(v['$deben']) || 0;
                    if (s > 0) { saldos++; totalSaldo += s; vSaldos.push(v); }
                });

                return { urgentes, proximos, saldos, totalSaldo, vUrgentes, vProximos, vSaldos };
            }
        };

        // =====================================================
        // ERROR BOUNDARY MEJORADO
        // =====================================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error('ErrorBoundary caught:', error, errorInfo);
                this.setState({ errorInfo });
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', background: '#f8fafc', flexDirection: 'column', padding: '2rem', textAlign: 'center' }}>
                            <div style={{ background: 'white', padding: '3rem', borderRadius: '16px', boxShadow: '0 10px 25px rgba(0,0,0,0.1)', maxWidth: '500px' }}>
                                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>⚠️</div>
                                <h1 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem', color: '#1e293b' }}>Ocurrio un error</h1>
                                <p style={{ color: '#64748b', marginBottom: '1.5rem' }}>Algo salio mal. Por favor recarga la pagina.</p>
                                <button onClick={() => window.location.reload()} style={{ background: '#6366f1', color: 'white', border: 'none', padding: '0.75rem 1.5rem', borderRadius: '8px', fontWeight: 600, cursor: 'pointer', fontSize: '1rem' }}>
                                    Recargar
                                </button>
                                {this.state.error && (
                                    <details style={{ marginTop: '1.5rem', textAlign: 'left', background: '#fef2f2', padding: '1rem', borderRadius: '8px', fontSize: '0.75rem', color: '#991b1b' }}>
                                        <summary style={{ cursor: 'pointer', fontWeight: 600 }}>Detalles del error (debug)</summary>
                                        <pre style={{ marginTop: '0.5rem', whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>{this.state.error.toString()}</pre>
                                        {this.state.errorInfo && <pre style={{ marginTop: '0.5rem', whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>{this.state.errorInfo.componentStack}</pre>}
                                    </details>
                                )}
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Global error handlers para logging
        window.onerror = function (message, source, lineno, colno, error) {
            console.error('Global Error:', { message, source, lineno, colno, error });
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled Promise Rejection:', event.reason);
        });

        const GlobalSearch = ({ data, onSelect }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef();

            useEffect(() => {
                if (query.length < 2) { setResults([]); return; }
                const q = query.toLowerCase();
                setResults(data.filter(v => (v.Nombre || '').toLowerCase().includes(q) || (v['Numero de booking'] || '').toLowerCase().includes(q) || (v['Numero de BL'] || '').toLowerCase().includes(q)).slice(0, 6));
                setIsOpen(true);
            }, [query, data]);

            useEffect(() => {
                const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handler);
                return () => document.removeEventListener('mousedown', handler);
            }, []);

            useEffect(() => { lucide.createIcons(); }, [results]);

            return (
                <div className="global-search" ref={ref}>
                    <i data-lucide="Search" size="18" className="global-search-icon"></i>
                    <input className="global-search-input" placeholder="Buscar viajes..." value={query} onChange={(e) => setQuery(e.target.value)} onFocus={() => results.length > 0 && setIsOpen(true)} />
                    {isOpen && results.length > 0 && (
                        <div className="global-search-results">
                            {results.map((v, i) => (
                                <div key={v.tripId || i} className="search-result-item" onClick={() => { onSelect(v); setQuery(''); setIsOpen(false); }}>
                                    <div className="search-result-title">{v.Nombre || 'Sin nombre'}</div>
                                    <div className="search-result-meta">
                                        <span>Booking: {v['Numero de booking'] || '-'}</span>
                                        <span>{v.Status || 'Pendiente'}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const NotificationCenter = ({ notifications, onClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef();

            useEffect(() => {
                const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handler);
                return () => document.removeEventListener('mousedown', handler);
            }, []);

            useEffect(() => { lucide.createIcons(); }, [isOpen]);

            const getIcon = (t) => t === 'danger' ? 'AlertTriangle' : t === 'warning' ? 'Clock' : 'Ship';

            return (
                <div style={{ position: 'relative' }} ref={ref}>
                    <div className="notification-bell" onClick={() => setIsOpen(!isOpen)}>
                        <i data-lucide="Bell" size="20" color="var(--text-muted)"></i>
                        {notifications.length > 0 && <div className="notification-badge">{notifications.length > 9 ? '9+' : notifications.length}</div>}
                    </div>
                    {isOpen && (
                        <div className="notification-panel">
                            <div className="notification-header">
                                <h3 style={{ fontSize: '1rem', fontWeight: 700 }}>Notificaciones</h3>
                                <span className="badge bg-purple">{notifications.length}</span>
                            </div>
                            <div className="notification-list">
                                {notifications.length === 0 ? (
                                    <div className="notification-empty"><p>Todo en orden</p></div>
                                ) : notifications.slice(0, 8).map((n, i) => (
                                    <div key={n.id || i} className="notification-item" onClick={() => { onClick(n.viaje); setIsOpen(false); }}>
                                        <div className={`notification-icon ${n.type}`}><i data-lucide={getIcon(n.type)} size="18"></i></div>
                                        <div className="notification-content">
                                            <div className="notification-title">{n.title}</div>
                                            <div className="notification-message">{n.message}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ConnectionStatus = ({ isOnline }) => (
            <div className={`connection-badge ${isOnline ? 'online' : 'offline'}`}>
                <div className="connection-dot"></div>
                <span>{isOnline ? 'Conectado' : 'Local'}</span>
            </div>
        );

        const SyncIndicator = ({ message }) => (
            <div className="sync-indicator">
                <div className="sync-spinner"></div>
                <span style={{ fontSize: '0.875rem' }}>{message}</span>
            </div>
        );

        // Skeleton Loader para mostrar mientras cargan datos
        const SkeletonLoader = ({ type = 'card', count = 1 }) => {
            const items = Array(count).fill(null);

            if (type === 'kpi') {
                return (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', padding: '1rem' }}>
                        {items.map((_, i) => <div key={i} className="skeleton skeleton-kpi" />)}
                    </div>
                );
            }

            if (type === 'table') {
                return (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', padding: '1rem' }}>
                        {items.map((_, i) => <div key={i} className="skeleton skeleton-row" />)}
                    </div>
                );
            }

            return (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1rem', padding: '1rem' }}>
                    {items.map((_, i) => <div key={i} className="skeleton skeleton-card" />)}
                </div>
            );
        };

        const Sidebar = ({ activePage, setPage, user, onLogout, isOnline }) => {
            const items = [
                { id: 'dashboard', label: 'Inicio', icon: 'LayoutDashboard' },
                { id: 'viajes', label: 'Viajes', icon: 'Ship' },
                { id: 'status', label: 'Estatus', icon: 'Activity' },
                { id: 'calendario', label: 'Calendario', icon: 'Calendar' },
                { id: 'gestion', label: 'Docs', icon: 'FileText' },
                { id: 'historial', label: 'Historial', icon: 'History' },
            ];
            useEffect(() => { lucide.createIcons(); }, [activePage]);

            return (
                <div className="sidebar">
                    {/* Logo - solo visible en desktop */}
                    <div className="logo sidebar-desktop-only">
                        <i data-lucide="Zap" style={{ color: '#6366f1' }}></i>
                        <span>Antigravity</span>
                    </div>

                    {/* Estado de conexión - solo desktop */}
                    <div className="sidebar-desktop-only">
                        <ConnectionStatus isOnline={isOnline} />
                    </div>

                    {/* Navegación principal */}
                    <nav>
                        {items.map(item => (
                            <div
                                key={item.id}
                                className={`nav-item ${activePage === item.id ? 'active' : ''}`}
                                onClick={() => setPage(item.id)}
                            >
                                <i data-lucide={item.icon} size="20"></i>
                                <span>{item.label}</span>
                            </div>
                        ))}
                    </nav>

                    {/* Info de usuario y logout - solo desktop */}
                    <div className="sidebar-desktop-only sidebar-footer">
                        {user && (
                            <div className="sidebar-user-info">
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                    <div style={{
                                        width: '32px',
                                        height: '32px',
                                        borderRadius: '50%',
                                        background: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontWeight: 600,
                                        fontSize: '0.875rem'
                                    }}>
                                        {(user.profile?.nombre || user.email || '?')[0].toUpperCase()}
                                    </div>
                                    <div style={{ flex: 1, minWidth: 0 }}>
                                        <div style={{ fontSize: '0.8125rem', fontWeight: 600, color: 'white', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                            {user.profile?.nombre || user.email?.split('@')[0] || 'Usuario'}
                                        </div>
                                        <div style={{ fontSize: '0.6875rem', color: '#94a3b8', display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                                            <span style={{
                                                display: 'inline-block',
                                                padding: '0.125rem 0.375rem',
                                                borderRadius: '4px',
                                                fontSize: '0.625rem',
                                                fontWeight: 600,
                                                background: user.profile?.rol === 'admin' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(251, 191, 36, 0.2)',
                                                color: user.profile?.rol === 'admin' ? '#22c55e' : '#fbbf24'
                                            }}>
                                                {user.profile?.rol === 'admin' ? 'Admin' : 'Editor'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="nav-item" onClick={onLogout} title="Cerrar sesión">
                            <i data-lucide="LogOut" size="18"></i>
                            <span>Salir</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ThemeToggle = ({ theme, setTheme }) => {
            useEffect(() => { lucide.createIcons(); }, [theme]);
            return (
                <button className="theme-toggle" onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} title={theme === 'light' ? 'Modo oscuro' : 'Modo claro'}>
                    <i data-lucide={theme === 'light' ? 'Moon' : 'Sun'} size="20" color="var(--text-muted)"></i>
                </button>
            );
        };

        const DateRangePicker = ({ startDate, endDate, onChange }) => {
            const pickerRef = useRef(null);
            const fpInstance = useRef(null);

            useEffect(() => {
                if (!pickerRef.current || typeof flatpickr === 'undefined') return;
                fpInstance.current = flatpickr(pickerRef.current, {
                    mode: 'range',
                    dateFormat: 'd M Y',
                    locale: 'es',
                    defaultDate: startDate && endDate ? [startDate, endDate] : null,
                    onChange: (dates) => {
                        if (dates.length === 2) onChange(dates[0], dates[1]);
                    }
                });
                return () => { if (fpInstance.current) fpInstance.current.destroy(); };
            }, []);

            useEffect(() => { lucide.createIcons(); }, []);

            const formatRange = () => {
                if (!startDate || !endDate) return 'Todas las fechas';
                const fmt = (d) => `${d.getDate()} ${MESES[d.getMonth()].substring(0, 3)}`;
                return `${fmt(startDate)} - ${fmt(endDate)}`;
            };

            const clear = (e) => { e.stopPropagation(); onChange(null, null); if (fpInstance.current) fpInstance.current.clear(); };

            return (
                <div className="date-range-picker" onClick={() => fpInstance.current?.open()}>
                    <i data-lucide="Calendar" size="16" color="var(--text-muted)"></i>
                    <span className="date-range-text">{formatRange()}</span>
                    {startDate && <button onClick={clear} style={{ border: 'none', background: 'none', cursor: 'pointer', padding: '0.125rem' }}><i data-lucide="X" size="14" color="var(--text-muted)"></i></button>}
                    <input ref={pickerRef} type="text" style={{ position: 'absolute', opacity: 0, pointerEvents: 'none' }} />
                </div>
            );
        };

        const Header = ({ title, data, notifications, onSearch, onNotification, theme, setTheme, startDate, endDate, onDateChange, lastAutoBackup, supabaseConnected }) => {
            useEffect(() => { lucide.createIcons(); }, []);

            const formatLastBackup = (iso) => {
                if (!iso) return null;
                const d = new Date(iso);
                const now = new Date();
                const diffMs = now - d;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                if (diffMins < 1) return 'hace un momento';
                if (diffMins < 60) return `hace ${diffMins} min`;
                if (diffHours < 24) return `hace ${diffHours}h`;
                return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
            };

            return (
                <div className="header">
                    <h1 style={{ fontSize: '1.25rem', fontWeight: 700 }}>{title}</h1>
                    {/* Indicador de conexión Supabase */}
                    <span style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '0.3rem',
                        padding: '0.25rem 0.5rem',
                        borderRadius: '12px',
                        fontSize: '0.7rem',
                        fontWeight: 500,
                        background: supabaseConnected ? '#d4edda' : '#f8d7da',
                        color: supabaseConnected ? '#155724' : '#721c24',
                        marginLeft: '0.5rem'
                    }}>
                        <span style={{
                            width: '8px',
                            height: '8px',
                            borderRadius: '50%',
                            background: supabaseConnected ? '#28a745' : '#dc3545'
                        }}></span>
                        {supabaseConnected ? 'Nube' : 'Offline'}
                    </span>
                    <div className="header-right">
                        <DateRangePicker startDate={startDate} endDate={endDate} onChange={onDateChange} />

                        {/* Botón para seleccionar año actual (1 Ene - fin mes actual) */}
                        <button
                            onClick={() => {
                                const now = new Date();
                                const startOfYear = new Date(now.getFullYear(), 0, 1);
                                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                                onDateChange(startOfYear, endOfMonth);
                            }}
                            title="Ver desde 1 de Enero hasta fin del mes actual"
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.35rem',
                                padding: '0.5rem 0.75rem',
                                borderRadius: '8px',
                                border: '1px solid var(--border)',
                                background: 'var(--hover-bg)',
                                color: 'var(--text-main)',
                                fontSize: '0.8125rem',
                                fontWeight: 500,
                                cursor: 'pointer'
                            }}
                        >
                            <i data-lucide="CalendarRange" size="14"></i>
                            Año
                        </button>

                        <GlobalSearch data={data} onSelect={onSearch} />

                        {/* Indicador de backup automático a Supabase */}
                        <div
                            title={lastAutoBackup
                                ? `Backup en nube: ${new Date(lastAutoBackup).toLocaleString('es-MX')}`
                                : 'Backup automático diario pendiente'
                            }
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.35rem',
                                padding: '0.4rem 0.6rem',
                                borderRadius: '6px',
                                fontSize: '0.75rem',
                                color: lastAutoBackup ? '#22c55e' : 'var(--text-muted)',
                                background: lastAutoBackup ? 'rgba(34, 197, 94, 0.1)' : 'transparent',
                                cursor: 'default'
                            }}
                        >
                            <i data-lucide="Cloud" size="14"></i>
                            <span>{lastAutoBackup ? 'Sync' : 'Pendiente'}</span>
                        </div>

                        <ThemeToggle theme={theme} setTheme={setTheme} />
                        <NotificationCenter notifications={notifications} onClick={onNotification} />
                    </div>
                </div>
            );
        };

        const KPICard = ({ label, value, icon, onClick, clickable = false, color = null }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="kpi-card" onClick={onClick} style={{ cursor: clickable ? 'pointer' : 'default' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                        <span className="kpi-label">{label}</span>
                        <i data-lucide={icon} size="16" color={color || "#94a3b8"}></i>
                    </div>
                    <span className="kpi-value" style={color ? { color } : {}}>{value}</span>
                    {clickable && <div style={{ fontSize: '0.65rem', color: 'var(--primary)', marginTop: '0.5rem' }}>Click para ver detalle</div>}
                </div>
            );
        };

        // Modal para mostrar viajes de un KPI
        const KPIDetailModal = ({ title, viajes, onClose, onEdit }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-card" style={{ maxWidth: '800px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{title} ({viajes.length})</h3>
                            <button onClick={onClose} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                                <i data-lucide="X" size="20"></i>
                            </button>
                        </div>
                        <div className="modal-body" style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                            {viajes.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' }}>No hay viajes en esta categoria</div>
                            ) : (
                                <table>
                                    <thead>
                                        <tr><th>Nombre</th><th>Booking</th><th>Contenedores</th><th>Peso</th><th>Analisis</th><th>Venta</th><th></th></tr>
                                    </thead>
                                    <tbody>
                                        {viajes.map((v, i) => (
                                            <tr key={v.tripId || i}>
                                                <td style={{ fontWeight: 500 }}>{v.Nombre || '-'}</td>
                                                <td>{v['Numero de booking'] || '-'}</td>
                                                <td>{v.Contenedores || '-'}</td>
                                                <td>{v.Peso ? formatNumber(v.Peso) : '-'}</td>
                                                <td>{v.Analisis ? formatPercent(v.Analisis) : '-'}</td>
                                                <td style={{ fontWeight: 600, color: 'var(--success)' }}>{formatCurrency(v['$venta'])}</td>
                                                <td>
                                                    <button onClick={() => { onEdit(v); onClose(); }} style={{ border: 'none', background: '#f1f5f9', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}>
                                                        <i data-lucide="Edit2" size="14" color="var(--primary)"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div className="modal-footer">
                            <div></div>
                            <button className="btn-secondary" onClick={onClose}>Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SalesChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || data.length === 0) return;

                const monthlyData = {};
                data.forEach(v => {
                    const fecha = robustParseDate(v.Fecha);
                    if (fecha) {
                        const key = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[key]) monthlyData[key] = { venta: 0, viajes: 0 };
                        monthlyData[key].venta += Number(v['$venta']) || 0;
                        monthlyData[key].viajes += 1;
                    }
                });

                const sortedKeys = Object.keys(monthlyData).sort().slice(-6);
                const labels = sortedKeys.map(k => {
                    const [y, m] = k.split('-');
                    return `${MESES[parseInt(m) - 1].substring(0, 3)} ${y.substring(2)}`;
                });
                const ventaData = sortedKeys.map(k => monthlyData[k].venta);
                const viajesData = sortedKeys.map(k => monthlyData[k].viajes);

                if (chartInstance.current) chartInstance.current.destroy();

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Ventas (MXN)', data: ventaData, backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6, yAxisID: 'y' },
                            { label: 'Viajes', data: viajesData, backgroundColor: 'rgba(34, 197, 94, 0.8)', borderRadius: 6, yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } } },
                        scales: {
                            y: { type: 'linear', position: 'left', ticks: { callback: v => '$' + (v / 1000).toFixed(0) + 'k' }, grid: { color: '#f1f5f9' } },
                            y1: { type: 'linear', position: 'right', grid: { display: false }, ticks: { stepSize: 1 } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <canvas ref={chartRef}></canvas>;
        };

        // Grafico de pastel para distribucion de Status
        const StatusPieChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Colores más vivos y coloridos
            const STATUS_COLORS = {
                'Programacion': '#6366f1',  // Indigo vibrante
                'Altamar': '#0ea5e9',       // Azul cielo brillante
                'Ingresado': '#f97316',     // Naranja vibrante
                'Ingresados': '#fb923c',    // Naranja claro
                'Pago 10%': '#a855f7',      // Púrpura brillante
                'Liberado': '#10b981',      // Verde esmeralda
                'Sin Status': '#ec4899',    // Rosa fucsia
            };

            useEffect(() => {
                if (!chartRef.current || data.length === 0) return;

                // Filtrar viajes que NO estan cerrados (ignorando fechas - usa allData)
                const filteredData = data.filter(v => {
                    const status = (v.Status || '').toLowerCase();
                    return status !== 'cerrado';
                });

                const statusCount = {};
                filteredData.forEach(v => {
                    const status = v.Status || 'Sin Status';
                    statusCount[status] = (statusCount[status] || 0) + 1;
                });

                const labels = Object.keys(statusCount);
                const counts = Object.values(statusCount);
                const colors = labels.map(s => STATUS_COLORS[s] || '#94a3b8');

                if (chartInstance.current) chartInstance.current.destroy();

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const total = counts.reduce((a, b) => a + b, 0);
                                        const pct = ((ctx.raw / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${ctx.raw} viajes (${pct}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <canvas ref={chartRef}></canvas>;
        };

        const AlertCards = ({ summary, onClick }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="alert-cards-grid">
                    <div className="alert-card danger" onClick={() => summary.vUrgentes[0] && onClick(summary.vUrgentes[0])}>
                        <div className="alert-card-header">
                            <div className="alert-card-count">{summary.urgentes}</div>
                            <i data-lucide="AlertTriangle" size="24" color="#ef4444"></i>
                        </div>
                        <div className="alert-card-title">Embarques Urgentes</div>
                        <div className="alert-card-subtitle">Proximas 48 horas</div>
                    </div>
                    <div className="alert-card warning" onClick={() => summary.vProximos[0] && onClick(summary.vProximos[0])}>
                        <div className="alert-card-header">
                            <div className="alert-card-count">{summary.proximos}</div>
                            <i data-lucide="Calendar" size="24" color="#f59e0b"></i>
                        </div>
                        <div className="alert-card-title">Proximos 7 Dias</div>
                        <div className="alert-card-subtitle">Embarques y arribos</div>
                    </div>
                    <div className="alert-card info" onClick={() => summary.vSaldos[0] && onClick(summary.vSaldos[0])}>
                        <div className="alert-card-header">
                            <div className="alert-card-count">{summary.saldos}</div>
                            <i data-lucide="DollarSign" size="24" color="#3b82f6"></i>
                        </div>
                        <div className="alert-card-title">Saldos Pendientes</div>
                        <div className="alert-card-subtitle">{formatCurrency(summary.totalSaldo)}</div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // IMPORT MODAL
        // =====================================================
        const ImportModal = ({ onClose, onImport, existingData }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [loading, setLoading] = useState(false);
            const [dragging, setDragging] = useState(false);
            const fileInputRef = useRef();

            useEffect(() => { lucide.createIcons(); }, [preview]);

            const handleFile = async (f) => {
                if (!f || !f.name.match(/\.(xlsx|xls)$/i)) {
                    alert('Por favor selecciona un archivo Excel (.xlsx o .xls)');
                    return;
                }
                setFile(f);
                setLoading(true);

                try {
                    const data = await ExcelService.import(f);
                    const results = ExcelService.processImport(data, existingData);
                    setPreview(results);
                } catch (err) {
                    alert('Error al leer el archivo: ' + err.message);
                }
                setLoading(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragging(false);
                const f = e.dataTransfer.files[0];
                handleFile(f);
            };

            const confirmImport = () => {
                if (preview) {
                    onImport(preview.data);
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-card" style={{ maxWidth: '600px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Importar desde Excel</h3>
                            <button onClick={onClose} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                                <i data-lucide="X" size="20"></i>
                            </button>
                        </div>

                        <div className="modal-body">
                            {!preview ? (
                                <>
                                    <div
                                        className={`import-zone ${dragging ? 'dragging' : ''}`}
                                        onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
                                        onDragLeave={() => setDragging(false)}
                                        onDrop={handleDrop}
                                        onClick={() => fileInputRef.current?.click()}
                                    >
                                        <input ref={fileInputRef} type="file" accept=".xlsx,.xls" hidden onChange={(e) => handleFile(e.target.files[0])} />
                                        {loading ? (
                                            <div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto' }}></div>
                                        ) : (
                                            <>
                                                <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>📤</div>
                                                <h3 style={{ marginBottom: '0.5rem' }}>Arrastra tu archivo Excel aqui</h3>
                                                <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>o haz clic para seleccionar</p>
                                                <p style={{ color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: '1rem' }}>Formatos: .xlsx, .xls</p>
                                            </>
                                        )}
                                    </div>

                                    <div style={{ marginTop: '1.5rem', padding: '1rem', background: '#f8fafc', borderRadius: '8px', fontSize: '0.8125rem' }}>
                                        <strong>Columnas esperadas:</strong>
                                        <p style={{ color: 'var(--text-muted)', marginTop: '0.5rem' }}>
                                            Nombre, Fecha, Numero de booking, Numero de BL, Status, Contenedores, Peso, Flete, $venta, $deben, Fecha de embarque, Fecha de arribo, Cut off
                                        </p>
                                    </div>
                                </>
                            ) : (
                                <div className="import-preview">
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.5rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>✅</span>
                                        <div>
                                            <h3 style={{ fontSize: '1rem' }}>{file?.name}</h3>
                                            <p style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>Archivo procesado correctamente</p>
                                        </div>
                                    </div>

                                    <div className="import-stats">
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--success)' }}>{preview.nuevos}</div>
                                            <div className="import-stat-label">Nuevos</div>
                                        </div>
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--info)' }}>{preview.actualizados}</div>
                                            <div className="import-stat-label">Actualizados</div>
                                        </div>
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--warning)' }}>{preview.omitidos || 0}</div>
                                            <div className="import-stat-label">Duplicados</div>
                                        </div>
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--danger)' }}>{preview.errores}</div>
                                            <div className="import-stat-label">Errores</div>
                                        </div>
                                    </div>

                                    <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', borderRadius: '8px', padding: '1rem', fontSize: '0.8125rem', color: '#166534' }}>
                                        <strong>Listo para importar</strong>
                                        <p style={{ marginTop: '0.25rem' }}>
                                            Se agregaran {preview.nuevos} viajes nuevos y se actualizaran {preview.actualizados} existentes.
                                            {preview.omitidos > 0 && ` (${preview.omitidos} duplicados omitidos)`}
                                        </p>
                                    </div>

                                    {preview.omitidos > 0 && (
                                        <div style={{ background: '#fffbeb', border: '1px solid #fcd34d', borderRadius: '8px', padding: '1rem', fontSize: '0.8125rem', color: '#92400e', marginTop: '0.75rem' }}>
                                            <strong>Duplicados detectados</strong>
                                            <p style={{ marginTop: '0.25rem' }}>Se omitieron {preview.omitidos} filas duplicadas dentro del mismo archivo Excel.</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="modal-footer">
                            <button className="btn-secondary" onClick={onClose}>Cancelar</button>
                            {preview && (
                                <button className="btn-success" onClick={confirmImport}>
                                    <i data-lucide="Check" size="16"></i>
                                    Confirmar Importacion
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // DOCUMENT CARD COMPONENT (para poder usar hooks)
        // =====================================================
        const DocumentCard = ({ docType, doc, tripId, tripName, documentos, onUpdate }) => {
            const [uploading, setUploading] = useState(false);
            const [localDoc, setLocalDoc] = useState(doc);
            const inputRef = useRef(null);
            const cardRef = useRef(null);

            // Sincronizar con prop externa
            useEffect(() => {
                setLocalDoc(doc);
            }, [doc]);

            // Inicializar iconos cuando el componente monta o cuando cambia el estado uploaded
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (cardRef.current) {
                        lucide.createIcons({ nodes: [cardRef.current] });
                    }
                }, CONFIG.DELAYS.ICON_INIT);
                return () => clearTimeout(timer);
            }, [localDoc.uploaded]);

            const handleUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                // Verificar tipo de archivo (PDF o PNG)
                const isPdf = file.type.includes('pdf') || file.name.toLowerCase().endsWith('.pdf');
                const isPng = file.type.includes('png') || file.name.toLowerCase().endsWith('.png');

                if (!isPdf && !isPng) {
                    alert('Solo se permiten archivos PDF o PNG');
                    if (inputRef.current) inputRef.current.value = '';
                    return;
                }
                if (file.size > MAX_FILE_SIZE) {
                    alert('El archivo excede 50MB. Por favor usa un archivo mas pequeño.');
                    if (inputRef.current) inputRef.current.value = '';
                    return;
                }

                setUploading(true);
                try {
                    // Solo extraer primera página si es PDF
                    const processedFile = isPdf ? await extractFirstPage(file) : file;

                    // Generar nombre personalizado con la extensión correcta
                    const extension = isPdf ? 'pdf' : 'png';
                    const customFileName = `${tripName || 'Viaje'} - ${docType.id}.${extension}`;

                    // Subir con el nombre personalizado
                    const result = await StorageService.uploadFile(processedFile, tripId, docType.id, customFileName);
                    const newDocData = {
                        uploaded: true,
                        fileName: customFileName,
                        uploadDate: new Date().toISOString(),
                        storagePath: result.path,
                        storageUrl: result.url
                    };

                    // Actualizar estado local primero
                    setLocalDoc(newDocData);
                    setUploading(false);
                    if (inputRef.current) inputRef.current.value = '';

                    // Luego actualizar el padre (con info para historial)
                    const newDocs = { ...(documentos || createEmptyDocumentos()) };
                    newDocs[docType.id] = newDocData;
                    onUpdate(newDocs, docType.id, 'upload', customFileName);

                    alert('Documento subido correctamente');
                } catch (err) {
                    console.error('Error subiendo archivo:', err);
                    setUploading(false);
                    if (inputRef.current) inputRef.current.value = '';
                    alert('Error al subir: ' + err.message);
                }
            };

            const handleDelete = async () => {
                if (!confirm(`Eliminar ${docType.label}?`)) return;
                const deletedFileName = localDoc.fileName;
                if (localDoc.storagePath) {
                    await StorageService.deleteFile(localDoc.storagePath);
                }
                const emptyDoc = { uploaded: false, fileName: '', uploadDate: '', storagePath: '', storageUrl: '' };
                setLocalDoc(emptyDoc);
                const newDocs = { ...(documentos || createEmptyDocumentos()) };
                newDocs[docType.id] = emptyDoc;
                onUpdate(newDocs, docType.id, 'delete', deletedFileName);
            };

            // Estructura fija - NO usar condicionales con iconos de Lucide
            // Los iconos se renderizan una vez y se controlan con CSS
            return (
                <div ref={cardRef} className={`doc-card ${localDoc.uploaded ? 'uploaded' : ''}`}>
                    <div className="doc-card-header">
                        <div className="doc-card-icon">
                            <i data-lucide={docType.icon} size="16"></i>
                        </div>
                        <span className="doc-card-title">{docType.label}</span>
                        <div className="doc-card-status" style={{ opacity: localDoc.uploaded ? 1 : 0 }}>
                            <span style={{ color: 'var(--success)', fontWeight: 'bold' }}>✓</span>
                        </div>
                    </div>

                    {/* Sección de archivo subido */}
                    <div style={{ display: localDoc.uploaded ? 'block' : 'none' }}>
                        <div className="doc-file-info">
                            <div className="doc-file-name" title={localDoc.fileName}>{localDoc.fileName}</div>
                            <div className="doc-file-date">
                                {localDoc.uploadDate ? new Date(localDoc.uploadDate).toLocaleDateString('es-MX') : ''}
                            </div>
                        </div>
                        <div className="doc-actions">
                            <button type="button" className="doc-action-btn view" onClick={() => viewPdfInNewTab(localDoc)} title="Ver PDF">
                                <i data-lucide="Eye" size="14"></i>
                            </button>
                            <button type="button" className="doc-action-btn download" onClick={() => downloadPdf(localDoc)} title="Descargar">
                                <i data-lucide="Download" size="14"></i>
                            </button>
                            <button type="button" className="doc-action-btn delete" onClick={handleDelete} title="Eliminar">
                                <i data-lucide="Trash2" size="14"></i>
                            </button>
                        </div>
                    </div>

                    {/* Sección de subida - SIN iconos de Lucide para evitar conflicto */}
                    <div style={{ display: localDoc.uploaded ? 'none' : 'block' }}>
                        <input
                            ref={inputRef}
                            type="file"
                            accept=".pdf,.png,application/pdf,image/png"
                            style={{ display: 'none' }}
                            onChange={handleUpload}
                            disabled={uploading}
                        />
                        <div
                            onClick={() => !uploading && inputRef.current?.click()}
                            className="doc-upload-mini"
                            style={{ cursor: uploading ? 'wait' : 'pointer', opacity: uploading ? 0.6 : 1 }}
                        >
                            {uploading ? (
                                <>
                                    <div className="sync-spinner" style={{ width: 16, height: 16, marginBottom: '0.25rem' }}></div>
                                    <div>Subiendo...</div>
                                </>
                            ) : (
                                <>
                                    <span style={{ fontSize: '18px', marginBottom: '0.25rem' }}>📄</span>
                                    <div>PDF / PNG</div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // HISTORIAL DE CAMBIOS
        // =====================================================
        // Campos que se rastrean en el historial (excluyendo metadata)
        const TRACKED_FIELDS = [
            'Nombre', 'Numero de booking', 'Numero de BL', 'Fecha',
            'Fecha de embarque', 'Fecha de arribo', 'Status', 'Cut off',
            'Contenedores', 'Peso', 'Analisis', 'Flete',
            '$venta', '$deben', '10%', 'Anticipos', 'anticipoPagado', 'fechaAnticipoPagado', 'Agencia aduanal',
            'Origen', 'Destino', 'Cliente', 'Proveedor', 'Producto', 'Notas'
        ];

        // Labels legibles para los campos
        const FIELD_LABELS = {
            'Nombre': 'Nombre',
            'Numero de booking': 'Booking',
            'Numero de BL': 'BL',
            'Fecha': 'Fecha',
            'Fecha de embarque': 'Embarque',
            'Fecha de arribo': 'Arribo',
            'Status': 'Status',
            'Cut off': 'Cut Off',
            'Contenedores': 'Contenedores',
            'Peso': 'Peso',
            'Analisis': 'Análisis',
            'Flete': 'Flete',
            '$venta': 'Venta',
            '$deben': 'Deben',
            '10%': '10%',
            'Anticipos': 'Anticipos',
            'anticipoPagado': 'Anticipo Pagado',
            'fechaAnticipoPagado': 'Fecha de Pago Anticipo',
            'Agencia aduanal': 'Agencia Aduanal',
            'Origen': 'Origen',
            'Destino': 'Destino',
            'Cliente': 'Cliente',
            'Proveedor': 'Proveedor',
            'Producto': 'Producto',
            'Notas': 'Notas'
        };

        // =====================================================
        // VALIDACION DE CAMPOS NUMERICOS
        // =====================================================
        // Campos que deben ser numéricos (enteros o decimales)
        const NUMERIC_FIELDS = [
            'Contenedores',  // Entero
            'Peso',          // Decimal (toneladas)
            'Analisis',      // Decimal (porcentaje)
            'Flete',         // Decimal (dinero)
            '$venta',        // Decimal (dinero)
            '$deben',        // Decimal (dinero)
            '10%',           // Decimal (dinero)
            'Anticipos'      // Decimal (dinero)
        ];

        // Campos que solo aceptan enteros
        const INTEGER_FIELDS = ['Contenedores'];

        // Validar si un valor es numérico válido
        const isValidNumeric = (value, isInteger = false) => {
            if (value === '' || value === null || value === undefined) return true; // Vacío es válido
            const str = String(value).trim();
            if (str === '') return true;

            // Permitir números con comas como separador de miles (ej: 1,234.56)
            const cleanValue = str.replace(/,/g, '');

            if (isInteger) {
                return /^-?\d+$/.test(cleanValue);
            }
            return /^-?\d*\.?\d*$/.test(cleanValue) && cleanValue !== '.' && cleanValue !== '-';
        };

        // Limpiar valor numérico (remover caracteres no válidos)
        const cleanNumericValue = (value, isInteger = false) => {
            if (value === '' || value === null || value === undefined) return '';
            let str = String(value).trim();

            // Remover todo excepto dígitos, punto, coma y signo negativo
            str = str.replace(/[^\d.,-]/g, '');

            // Reemplazar comas por nada (asumimos formato US)
            str = str.replace(/,/g, '');

            // Si es entero, remover punto decimal
            if (isInteger) {
                str = str.replace(/\./g, '');
            }

            // Asegurar solo un punto decimal
            const parts = str.split('.');
            if (parts.length > 2) {
                str = parts[0] + '.' + parts.slice(1).join('');
            }

            return str;
        };

        // Verificar si un campo es numérico
        const isNumericField = (fieldName) => NUMERIC_FIELDS.includes(fieldName);
        const isIntegerField = (fieldName) => INTEGER_FIELDS.includes(fieldName);

        // Detectar cambios entre viaje original y modificado
        const detectChanges = (original, modified) => {
            const cambios = {};
            TRACKED_FIELDS.forEach(field => {
                const valorAntes = original[field] ?? '';
                const valorDespues = modified[field] ?? '';
                // Convertir a string para comparar
                const antes = String(valorAntes).trim();
                const despues = String(valorDespues).trim();
                if (antes !== despues) {
                    cambios[field] = { antes, despues };
                }
            });
            return cambios;
        };

        // Crear entrada de historial
        const createHistorialEntry = (accion, cambios = {}, usuario = 'local') => ({
            id: generateUUID(),
            fecha: new Date().toISOString(),
            usuario,
            accion,
            cambios
        });

        // Formatear fecha para mostrar en historial
        const formatHistorialDate = (isoDate) => {
            const d = new Date(isoDate);
            const fecha = d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
            const hora = d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
            return { fecha, hora };
        };

        // Formatear valores de cambios para mostrar en historial
        const formatChangeValue = (campo, valor) => {
            if (campo === 'anticipoPagado') {
                return valor === 'true' ? 'Pagado' : valor === 'false' ? 'Pendiente' : valor || '(vacio)';
            }
            return valor || '(vacio)';
        };

        // Componente para mostrar campo con indicador de cambio (FUERA del modal para evitar re-renders)
        const FieldWithChange = ({ label, field, children, originalField, isNew, original, form, errors }) => {
            const fieldToCheck = originalField || field;
            const origValue = original?.[fieldToCheck];
            const newValue = form?.[fieldToCheck];
            const changed = !isNew && origValue !== undefined && String(origValue || '') !== String(newValue || '');
            const hasError = errors?.[field];

            return (
                <div className={`form-group ${hasError ? 'has-error' : ''}`} style={{ position: 'relative' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                        {label}
                        {changed && <span style={{ fontSize: '0.7rem', background: 'var(--warning)', color: 'white', padding: '0.1rem 0.4rem', borderRadius: '4px' }}>Modificado</span>}
                    </label>
                    {children}
                    {hasError && <div className="form-error">{hasError}</div>}
                    {changed && origValue && !hasError && (
                        <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                            Anterior: <span style={{ textDecoration: 'line-through' }}>{origValue}</span>
                        </div>
                    )}
                </div>
            );
        };

        // =====================================================
        // EDIT VIAJE MODAL
        // =====================================================
        const EditViajeModal = ({ viaje, onClose, onSave, onDelete, isNew, originalViaje, initialTab = 'general', user }) => {
            const [form, setForm] = useState({ ...viaje });
            const [activeTab, setActiveTab] = useState(initialTab);
            const [errors, setErrors] = useState({}); // Estado para errores de validación
            // Guardar valores originales para comparar (si viene de BL update)
            const original = originalViaje || viaje;

            // Verificar si el usuario puede ver datos financieros
            const canSeeFinancials = ProfileService.canSeeFinancials(user?.profile);

            useEffect(() => { lucide.createIcons(); }, [activeTab]);

            // Setter con validación para campos numéricos
            const set = (field, value) => {
                // Validar campos numéricos (solo mostrar error, no modificar valor)
                if (isNumericField(field)) {
                    const isInteger = isIntegerField(field);

                    // Validar y mostrar error si hay caracteres no numéricos
                    if (value !== '' && !isValidNumeric(value, isInteger)) {
                        setErrors(prev => ({ ...prev, [field]: isInteger ? 'Solo numeros enteros' : 'Solo numeros' }));
                    } else {
                        setErrors(prev => {
                            const newErrors = { ...prev };
                            delete newErrors[field];
                            return newErrors;
                        });
                    }
                }
                // Guardar el valor tal como está (sin limpiar)
                setForm(prev => ({ ...prev, [field]: value }));
            };

            // Props comunes para FieldWithChange (para evitar repetir)
            const fieldProps = { isNew, original, form, errors };

            // Detectar si hay cambios sin guardar
            const hasUnsavedChanges = () => {
                // Campos importantes a comparar (excluir metadata y documentos)
                const fieldsToCompare = [
                    'Nombre', 'Numero de booking', 'Numero de BL', 'Fecha',
                    'Fecha de embarque', 'Fecha de arribo', 'Status', 'Cut off',
                    'Contenedores', 'Peso', 'Analisis', 'Flete',
                    '$venta', '$deben', '10%', 'Anticipos', 'anticipoPagado', 'Agencia aduanal',
                    'Origen', 'Destino', 'Cliente', 'Proveedor', 'Producto', 'Notas'
                ];

                for (const field of fieldsToCompare) {
                    const originalVal = String(viaje[field] || '').trim();
                    const currentVal = String(form[field] || '').trim();
                    if (originalVal !== currentVal) {
                        return true;
                    }
                }
                return false;
            };

            // Cerrar modal con confirmación si hay cambios
            const handleClose = () => {
                if (hasUnsavedChanges()) {
                    if (confirm('¿Descartar cambios sin guardar?')) {
                        onClose();
                    }
                } else {
                    onClose();
                }
            };

            // Tecla ESC cierra el modal
            useEffect(() => {
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        handleClose();
                    }
                };
                document.addEventListener('keydown', handleEsc);
                return () => document.removeEventListener('keydown', handleEsc);
            }, [form, viaje]); // Dependencias para que handleClose tenga los valores actuales

            const handleSubmit = (e) => {
                e.preventDefault();
                // Verificar si hay errores de validación
                if (Object.keys(errors).length > 0) {
                    const errorFields = Object.keys(errors).map(f => FIELD_LABELS[f] || f).join(', ');
                    alert('Por favor corrige los errores en: ' + errorFields);
                    return;
                }
                // Limpiar valores numéricos antes de guardar
                const cleanedForm = { ...form };
                NUMERIC_FIELDS.forEach(field => {
                    if (cleanedForm[field]) {
                        cleanedForm[field] = cleanNumericValue(cleanedForm[field], isIntegerField(field));
                    }
                });
                onSave(cleanedForm);
            };

            const STATUS_OPTIONS = [
                { value: '', label: 'Seleccionar...' },
                { value: 'Programacion', label: 'Programacion' },
                { value: 'Ingresados', label: 'Ingresados' },
                { value: 'Altamar', label: 'Altamar' },
                { value: 'Liberado', label: 'Liberado' },
                { value: 'Pago 10%', label: 'Pago 10%' },
                { value: 'cerrado', label: 'Cerrado' },
            ];

            // Logica para Cut off:
            // "Verde" = completado
            // "Rojo" = vencido/problema
            // Fecha = fecha limite
            const getCutoffStatus = () => {
                if (form['Cut off'] === 'Verde') return 'verde';
                if (form['Cut off'] === 'Rojo') return 'rojo';
                if (form['Cut off']) return 'fecha';
                return 'fecha'; // Por defecto mostrar campo de fecha
            };

            return (
                <div className="modal-overlay" onClick={handleClose}>
                    <div className="modal-card" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{isNew ? 'Nuevo Viaje' : `Editar: ${form.Nombre || 'Viaje'}`}</h3>
                            <button onClick={handleClose} style={{ border: 'none', background: 'none', cursor: 'pointer', padding: '0.5rem' }}>
                                <i data-lucide="X" size="20"></i>
                            </button>
                        </div>

                        <div style={{ display: 'flex', gap: '0.25rem', padding: '0 1.5rem', background: '#f8fafc', borderBottom: '1px solid var(--border)' }}>
                            {[
                                { id: 'general', label: 'General', icon: 'FileText' },
                                { id: 'logistica', label: 'Logistica', icon: 'Ship' },
                                ...(canSeeFinancials ? [{ id: 'finanzas', label: 'Finanzas', icon: 'DollarSign' }] : []),
                                { id: 'documentos', label: 'Documentos', icon: 'Folder' },
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{
                                    padding: '0.875rem 1.25rem', border: 'none',
                                    background: activeTab === tab.id ? 'white' : 'transparent',
                                    borderBottom: activeTab === tab.id ? '2px solid var(--primary)' : '2px solid transparent',
                                    cursor: 'pointer', fontWeight: activeTab === tab.id ? 600 : 500,
                                    color: activeTab === tab.id ? 'var(--primary)' : 'var(--text-muted)',
                                    display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.8125rem', marginBottom: '-1px'
                                }}>
                                    <i data-lucide={tab.icon} size="16"></i>{tab.label}
                                </button>
                            ))}
                        </div>

                        <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, overflow: 'hidden' }}>
                            <div className="modal-body" style={{ flex: 1, minHeight: 0, overflowY: 'auto' }}>
                                {activeTab === 'general' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="User" size="16"></i>Informacion Basica</div>
                                            <div className="form-grid">
                                                <div className="form-group span-2">
                                                    <label>Nombre / Cliente *</label>
                                                    <input type="text" value={form.Nombre || ''} onChange={e => set('Nombre', e.target.value)} required placeholder="Ej: Exportadora ABC" />
                                                </div>
                                                <div className="form-group">
                                                    <label>Fecha</label>
                                                    <input type="date" value={formatDateForInput(form.Fecha)} onChange={e => set('Fecha', e.target.value)} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Status</label>
                                                    <select value={form.Status || ''} onChange={e => set('Status', e.target.value)}>
                                                        {STATUS_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                                    </select>
                                                </div>
                                                <div className="form-group">
                                                    <label>Numero de Booking</label>
                                                    <input type="text" value={form['Numero de booking'] || ''} onChange={e => set('Numero de booking', e.target.value)} placeholder="EBKG..." />
                                                </div>
                                                <FieldWithChange label="Numero de BL" field="Numero de BL" {...fieldProps}>
                                                    <input type="text" value={form['Numero de BL'] || ''} onChange={e => set('Numero de BL', e.target.value)} placeholder="MEDU..." />
                                                </FieldWithChange>
                                            </div>
                                        </div>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Box" size="16"></i>Carga</div>
                                            <div className="form-grid">
                                                <FieldWithChange label="Contenedores" field="Contenedores" {...fieldProps}>
                                                    <input type="text" inputMode="numeric" value={form.Contenedores || ''} onChange={e => set('Contenedores', e.target.value)} placeholder="Ej: 2" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Peso (toneladas)" field="Peso" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Peso || ''} onChange={e => set('Peso', e.target.value)} placeholder="Ej: 25.5" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Análisis (%)" field="Analisis" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Analisis || ''} onChange={e => set('Analisis', e.target.value)} placeholder="Ej: 15.5" />
                                                </FieldWithChange>
                                            </div>
                                        </div>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="FileText" size="16"></i>Notas</div>
                                            <div className="form-group">
                                                <label>Observaciones</label>
                                                <textarea value={form.Notas || ''} onChange={e => set('Notas', e.target.value)} placeholder="Notas adicionales sobre el viaje..." />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'logistica' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Calendar" size="16"></i>Fechas de Transito</div>
                                            <div className="form-grid-2">
                                                <div className="form-group">
                                                    <label>Fecha de Embarque (ETD)</label>
                                                    <input type="date" value={formatDateForInput(form['Fecha de embarque'])} onChange={e => set('Fecha de embarque', e.target.value)} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Fecha de Arribo (ETA)</label>
                                                    <input type="date" value={formatDateForInput(form['Fecha de arribo'])} onChange={e => set('Fecha de arribo', e.target.value)} />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Clock" size="16"></i>Cut Off (VGM)</div>
                                            <div className="form-group">
                                                <select value={getCutoffStatus()} onChange={e => {
                                                    if (e.target.value === 'verde') set('Cut off', 'Verde');
                                                    else if (e.target.value === 'rojo') set('Cut off', 'Rojo');
                                                    else set('Cut off', (form['Cut off'] === 'Verde' || form['Cut off'] === 'Rojo') ? '' : form['Cut off']);
                                                }} style={{ marginBottom: '0.5rem' }}>
                                                    <option value="fecha">Fecha límite</option>
                                                    <option value="verde">Verde</option>
                                                    <option value="rojo">Rojo</option>
                                                </select>
                                                {getCutoffStatus() === 'fecha' && (
                                                    <input type="date" value={formatDateForInput(form['Cut off'])} onChange={e => set('Cut off', e.target.value)} />
                                                )}
                                                {getCutoffStatus() === 'verde' && <div className="verde-badge"><i data-lucide="CheckCircle" size="16"></i>Verde</div>}
                                                {getCutoffStatus() === 'rojo' && <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.5rem', background: '#fef2f2', borderRadius: '6px', color: '#dc2626' }}><i data-lucide="XCircle" size="16"></i>Rojo</div>}
                                            </div>
                                        </div>

                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Building" size="16"></i>Agencia y Costos</div>
                                            <div className="form-grid-2">
                                                <div className="form-group">
                                                    <label>Agencia Aduanal (MXN)</label>
                                                    <input type="text" inputMode="decimal" value={form['Agencia aduanal'] || ''} onChange={e => set('Agencia aduanal', e.target.value)} placeholder="Ej: 50000" />
                                                </div>
                                                <FieldWithChange label="Flete (USD)" field="Flete" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Flete || ''} onChange={e => set('Flete', e.target.value)} placeholder="Ej: 5000" />
                                                </FieldWithChange>
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'finanzas' && canSeeFinancials && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="TrendingUp" size="16"></i>Venta y Cobranza</div>
                                            <div className="form-grid">
                                                <FieldWithChange label="Venta Total (USD)" field="$venta" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['$venta'] || ''} onChange={e => set('$venta', e.target.value)} placeholder="Ej: 50000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Saldo Pendiente (USD)" field="$deben" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['$deben'] || ''} onChange={e => set('$deben', e.target.value)} placeholder="Ej: 10000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="10% Retencion" field="10%" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['10%'] || ''} onChange={e => set('10%', e.target.value)} placeholder="Ej: 5000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Anticipos" field="Anticipos" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Anticipos || ''} onChange={e => set('Anticipos', e.target.value)} placeholder="Ej: 20000" />
                                                </FieldWithChange>
                                                <div className="form-group">
                                                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                                                        <input
                                                            type="checkbox"
                                                            checked={form.anticipoPagado || false}
                                                            onChange={e => {
                                                                const checked = e.target.checked;
                                                                set('anticipoPagado', checked);
                                                                if (checked && !form.fechaAnticipoPagado) {
                                                                    set('fechaAnticipoPagado', new Date().toISOString().split('T')[0]);
                                                                }
                                                                if (!checked) {
                                                                    set('fechaAnticipoPagado', '');
                                                                }
                                                            }}
                                                            style={{ width: '18px', height: '18px', accentColor: 'var(--success)' }}
                                                        />
                                                        <span style={{
                                                            color: form.anticipoPagado ? 'var(--success)' : 'var(--text-muted)',
                                                            fontWeight: form.anticipoPagado ? 600 : 400
                                                        }}>
                                                            {form.anticipoPagado ? 'Anticipo Pagado' : 'Anticipo Pendiente'}
                                                        </span>
                                                    </label>
                                                    {form.anticipoPagado && (
                                                        <div style={{ marginTop: '0.5rem' }}>
                                                            <label style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>Fecha de pago</label>
                                                            <input
                                                                type="date"
                                                                value={form.fechaAnticipoPagado || ''}
                                                                onChange={e => set('fechaAnticipoPagado', e.target.value)}
                                                                style={{ width: '100%', marginTop: '0.25rem' }}
                                                            />
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '1.25rem' }}>
                                            <div style={{ fontSize: '0.75rem', fontWeight: 700, color: 'var(--text-muted)', marginBottom: '1rem', textTransform: 'uppercase' }}>Resumen</div>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem' }}>
                                                <div><div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>Venta (USD)</div><div style={{ fontSize: '1.125rem', fontWeight: 700, color: 'var(--success)' }}>{formatUSD(form['$venta'] || 0)}</div></div>
                                                <div><div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>Por Cobrar (USD)</div><div style={{ fontSize: '1.125rem', fontWeight: 700, color: Number(form['$deben']) > 0 ? 'var(--danger)' : 'var(--text-main)' }}>{formatUSD(form['$deben'] || 0)}</div></div>
                                                <div><div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>Flete (USD)</div><div style={{ fontSize: '1.125rem', fontWeight: 700, color: 'var(--info)' }}>{formatUSD(form.Flete || 0)}</div></div>
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'documentos' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title" style={{ display: 'flex', alignItems: 'center' }}>
                                                <i data-lucide="Folder" size="16"></i>
                                                <span style={{ marginLeft: '0.5rem' }}>Documentos del Viaje</span>
                                                <span className="badge" style={{
                                                    marginLeft: 'auto',
                                                    background: getDocsColor(countUploadedDocs(form.documentos)),
                                                    color: 'white'
                                                }}>
                                                    {countUploadedDocs(form.documentos)}/8
                                                </span>
                                            </div>

                                            {/* Barra de progreso */}
                                            <div className="docs-progress" style={{ marginBottom: '1.5rem' }}>
                                                <div className="docs-progress-bar">
                                                    <div
                                                        className="docs-progress-fill"
                                                        style={{
                                                            width: `${(countUploadedDocs(form.documentos) / 8) * 100}%`,
                                                            background: getDocsColor(countUploadedDocs(form.documentos))
                                                        }}
                                                    ></div>
                                                </div>
                                                <span style={{ color: 'var(--text-muted)' }}>
                                                    {countUploadedDocs(form.documentos) === 8 ? 'Completo' : `${8 - countUploadedDocs(form.documentos)} pendientes`}
                                                </span>
                                            </div>

                                            {/* Grid de documentos */}
                                            <div className="docs-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' }}>
                                                {DOCUMENT_TYPES.map(docType => (
                                                    <DocumentCard
                                                        key={docType.id}
                                                        docType={docType}
                                                        doc={form.documentos?.[docType.id] || { uploaded: false }}
                                                        tripId={form.tripId}
                                                        tripName={form.Nombre}
                                                        documentos={form.documentos}
                                                        onUpdate={(newDocs, docTypeId, action, fileName) => {
                                                            // Actualizar estado local
                                                            const updatedForm = { ...form, documentos: newDocs };

                                                            // Agregar al historial si se subio o elimino un documento
                                                            if (docTypeId && action) {
                                                                const docLabel = DOCUMENT_TYPES.find(d => d.id === docTypeId)?.label || docTypeId;
                                                                const historial = updatedForm.historial || [];
                                                                const usuario = 'local'; // Se actualizara en handleSave
                                                                if (action === 'upload') {
                                                                    historial.push(createHistorialEntry('Documento subido', { [docLabel]: { antes: '', despues: fileName || 'archivo' } }, usuario));
                                                                } else if (action === 'delete') {
                                                                    historial.push(createHistorialEntry('Documento eliminado', { [docLabel]: { antes: fileName || 'archivo', despues: '' } }, usuario));
                                                                }
                                                                updatedForm.historial = historial;
                                                            }

                                                            setForm(updatedForm);
                                                            // Guardar automáticamente el viaje
                                                            onSave(updatedForm);
                                                        }}
                                                    />
                                                ))}
                                            </div>
                                        </div>

                                        <div style={{ background: '#d1fae5', border: '1px solid #6ee7b7', borderRadius: '8px', padding: '1rem', marginTop: '1rem' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#065f46', fontSize: '0.8125rem' }}>
                                                <i data-lucide="Cloud" size="16"></i>
                                                <span><strong>Supabase Storage:</strong> Acepta PDF y PNG. Maximo 50MB por archivo.</span>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="modal-footer">
                                <div>
                                    {!isNew && onDelete && <button type="button" className="btn-danger" onClick={() => onDelete(form)}><i data-lucide="Trash2" size="14"></i>Eliminar</button>}
                                    {form.lastModified && <span style={{ fontSize: '0.6875rem', color: 'var(--text-muted)', marginLeft: '1rem' }}>Modificado: {new Date(form.lastModified).toLocaleString()}</span>}
                                </div>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <button type="button" className="btn-secondary" onClick={handleClose}>Cancelar</button>
                                    <button type="submit" className="btn-primary">{isNew ? 'Crear Viaje' : 'Guardar'}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // =====================================================
        // PAGES (con React.memo para optimizar re-renders)
        // =====================================================
        const DashboardPage = React.memo(({ data, allData, onAdd, onEdit, summary, user, loading }) => {
            const [kpiModal, setKpiModal] = useState(null);

            // Verificar si el usuario puede ver datos financieros
            const canSeeFinancials = ProfileService.canSeeFinancials(user?.profile);

            // Stats filtrados por fecha (data) excepto saldo, 10% y anticipos que usan allData
            const stats = useMemo(() => {
                const analisisValues = data.map(r => Number(r.Analisis) || 0).filter(v => v > 0);
                // 10% Cobrable: solo viajes con Status "Pago 10%"
                const diezPorciento = allData.filter(r => r.Status === 'Pago 10%').reduce((s, r) => s + (Number(r['10%']) || 0), 0);
                // Anticipos: Total de todos los viajes
                const anticiposTotal = allData.reduce((s, r) => s + (Number(r.Anticipos) || 0), 0);
                // Anticipos Pendientes: Solo los que NO estan pagados
                const anticiposPendientes = allData.filter(r => !r.anticipoPagado).reduce((s, r) => s + (Number(r.Anticipos) || 0), 0);
                // Anticipos Pagados del mes actual
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const anticiposPagados = allData.filter(r => {
                    if (!r.anticipoPagado) return false;
                    if (!r.fechaAnticipoPagado) return true; // Si no tiene fecha, mostrar igual (datos antiguos)
                    const fechaPago = new Date(r.fechaAnticipoPagado);
                    return fechaPago.getMonth() === currentMonth && fechaPago.getFullYear() === currentYear;
                }).reduce((s, r) => s + (Number(r.Anticipos) || 0), 0);
                // Saldo Pendiente = Anticipos NO PAGADOS + 10% Cobrable
                const saldo = anticiposPendientes + diezPorciento;

                const mesActual = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][now.getMonth()];

                return {
                    viajes: data.length,
                    conts: data.reduce((s, r) => s + (Number(r.Contenedores) || 0), 0),
                    peso: data.reduce((s, r) => s + (Number(r.Peso) || 0), 0),
                    promedioAnalisis: analisisValues.length > 0 ? analisisValues.reduce((a, b) => a + b, 0) / analisisValues.length : 0,
                    venta: data.reduce((s, r) => s + (Number(r['$venta']) || 0), 0),
                    // Estos usan TODOS los datos (sin filtro de fecha)
                    saldo,
                    diezPorciento,
                    anticiposTotal,
                    anticiposPendientes,
                    anticiposPagados,
                    mesActual,
                };
            }, [data, allData]);

            // Filtros para cada KPI (saldo, 10% y anticipos usan allData)
            const kpiFilters = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const mesActual = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][currentMonth];

                return {
                    viajes: { title: 'Todos los Viajes (en rango)', viajes: data },
                    contenedores: { title: 'Viajes con Contenedores', viajes: data.filter(v => Number(v.Contenedores) > 0) },
                    peso: { title: 'Viajes con Peso Registrado', viajes: data.filter(v => Number(v.Peso) > 0) },
                    analisis: { title: 'Viajes con Análisis', viajes: data.filter(v => Number(v.Analisis) > 0) },
                    venta: { title: 'Viajes con Venta', viajes: data.filter(v => Number(v['$venta']) > 0) },
                    // Estos muestran TODOS los viajes (sin filtro de fecha)
                    saldo: { title: 'Saldo Pendiente (Anticipos Pendientes + 10%)', viajes: allData.filter(v => (!v.anticipoPagado && Number(v.Anticipos) > 0) || (v.Status === 'Pago 10%' && Number(v['10%']) > 0)) },
                    diezPorciento: { title: 'Viajes con Status Pago 10%', viajes: allData.filter(v => v.Status === 'Pago 10%') },
                    anticiposPendientes: { title: 'Anticipos Pendientes', viajes: allData.filter(v => Number(v.Anticipos) > 0 && !v.anticipoPagado) },
                    anticiposPagados: { title: `Anticipos Pagados (${mesActual})`, viajes: allData.filter(v => {
                        if (Number(v.Anticipos) <= 0 || !v.anticipoPagado) return false;
                        if (!v.fechaAnticipoPagado) return true;
                        const fechaPago = new Date(v.fechaAnticipoPagado);
                        return fechaPago.getMonth() === currentMonth && fechaPago.getFullYear() === currentYear;
                    }) },
                };
            }, [data, allData]);

            useEffect(() => { lucide.createIcons(); }, [data, kpiModal]);

            const openKpiModal = (key) => setKpiModal(kpiFilters[key]);

            // Mostrar skeleton mientras carga
            if (loading) {
                return (
                    <div style={{ padding: '1.5rem' }}>
                        <SkeletonLoader type="kpi" count={4} />
                        <div style={{ marginTop: '2rem' }}>
                            <SkeletonLoader type="card" count={6} />
                        </div>
                    </div>
                );
            }

            return (
                <div style={{ animation: 'fadeIn 0.3s' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Dashboard</h2>
                        <button className="btn-primary" onClick={onAdd}><i data-lucide="Plus" size="16"></i>Nuevo Viaje</button>
                    </div>

                    <div className="dashboard-grid">
                        <KPICard label="Viajes en Rango" value={stats.viajes} icon="Ship" clickable onClick={() => openKpiModal('viajes')} />
                        <KPICard label="Contenedores" value={formatNumber(stats.conts)} icon="Box" clickable onClick={() => openKpiModal('contenedores')} />
                        <KPICard label="Peso Total (t)" value={formatNumber(stats.peso)} icon="Scale" clickable onClick={() => openKpiModal('peso')} />
                        <KPICard label="Promedio Analisis" value={formatPercent(stats.promedioAnalisis)} icon="BarChart3" clickable onClick={() => openKpiModal('analisis')} />
                        {canSeeFinancials && <KPICard label="Venta Total (USD)" value={formatUSD(stats.venta)} icon="TrendingUp" clickable onClick={() => openKpiModal('venta')} />}
                        {canSeeFinancials && <KPICard label="Saldo Pendiente (USD)" value={formatUSD(stats.saldo)} icon="Clock" clickable onClick={() => openKpiModal('saldo')} />}
                        {canSeeFinancials && <KPICard label="10% Cobrable" value={formatUSD(stats.diezPorciento)} icon="Percent" clickable onClick={() => openKpiModal('diezPorciento')} />}
                        {canSeeFinancials && <KPICard label="Anticipos Pendientes" value={formatUSD(stats.anticiposPendientes)} icon="Wallet" color="var(--warning)" clickable onClick={() => openKpiModal('anticiposPendientes')} />}
                        {canSeeFinancials && <KPICard label={`Anticipos Pagados (${stats.mesActual})`} value={formatUSD(stats.anticiposPagados)} icon="CircleCheck" color="var(--success)" clickable onClick={() => openKpiModal('anticiposPagados')} />}
                    </div>

                    {data.length > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '1.5rem', marginBottom: '1.5rem' }}>
                            {canSeeFinancials && (
                                <div className="table-card" style={{ padding: '1.5rem' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                        <span style={{ fontWeight: 600 }}>Ventas por Mes</span>
                                        <span className="badge bg-purple">Ultimos 6 meses</span>
                                    </div>
                                    <div style={{ height: '280px' }}>
                                        <SalesChart data={data} />
                                    </div>
                                </div>
                            )}
                            <div className="table-card" style={{ padding: '1.5rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <span style={{ fontWeight: 600 }}>Distribucion por Status</span>
                                    <span className="badge bg-cyan">{allData.filter(v => (v.Status || '').toLowerCase() !== 'cerrado').length} activos</span>
                                </div>
                                <div style={{ height: '280px' }}>
                                    <StatusPieChart data={allData} />
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="table-card">
                        <div style={{ padding: '1rem 1.25rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ fontWeight: 600 }}>Ultimos Viajes</span>
                        </div>
                        <div style={{ overflowX: 'auto' }}>
                            <table>
                                <thead><tr><th>Nombre</th><th>Booking</th><th>Contenedores</th><th>Peso</th><th>Analisis</th>{canSeeFinancials && <th>Venta Total</th>}{canSeeFinancials && <th>Anticipo</th>}<th></th></tr></thead>
                                <tbody>
                                    {[...data].sort((a, b) => {
                                        const dateA = robustParseDate(a.Fecha)?.getTime() || 0;
                                        const dateB = robustParseDate(b.Fecha)?.getTime() || 0;
                                        return dateB - dateA;
                                    }).slice(0, 8).map((r, i) => (
                                        <tr key={r.tripId || i}>
                                            <td style={{ fontWeight: 500 }}>{r.Nombre || '-'}</td>
                                            <td>{r['Numero de booking'] || '-'}</td>
                                            <td>{r.Contenedores || '-'}</td>
                                            <td>{r.Peso ? formatNumber(r.Peso) : '-'}</td>
                                            <td>{r.Analisis ? formatPercent(r.Analisis) : '-'}</td>
                                            {canSeeFinancials && <td style={{ fontWeight: 600, color: 'var(--success)' }}>{formatUSD(r['$venta'])}</td>}
                                            {canSeeFinancials && <td style={{ fontWeight: 500, color: 'var(--warning)' }}>{r.Anticipos ? formatUSD(r.Anticipos) : '-'}</td>}
                                            <td><button onClick={() => onEdit(r)} style={{ border: 'none', background: '#f1f5f9', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}><i data-lucide="Edit2" size="14" color="var(--primary)"></i></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {data.length === 0 && <div style={{ padding: '3rem', textAlign: 'center', color: 'var(--text-muted)' }}>No hay viajes. Importa un Excel o crea uno nuevo.</div>}
                        </div>
                    </div>

                    {kpiModal && (
                        <KPIDetailModal
                            title={kpiModal.title}
                            viajes={kpiModal.viajes}
                            onClose={() => setKpiModal(null)}
                            onEdit={onEdit}
                        />
                    )}
                </div>
            );
        });

        const ViajesPage = React.memo(({ data, onEdit, onEditDocs, onDelete, onAdd, onExport, onImport, user, loading }) => {
            const [searchInput, setSearchInput] = useState(''); // Valor inmediato del input
            const [search, setSearch] = useState(''); // Valor con debounce para filtrar
            const [filterStatus, setFilterStatus] = useState([]); // Array para multi-select
            const [showStatusDropdown, setShowStatusDropdown] = useState(false);
            const [sortConfig, setSortConfig] = useState({ key: 'Fecha', direction: 'desc' });

            // Verificar si el usuario puede ver datos financieros
            const canSeeFinancials = ProfileService.canSeeFinancials(user?.profile);

            // Debounce: actualizar búsqueda después de dejar de escribir
            useEffect(() => {
                const timer = setTimeout(() => {
                    setSearch(searchInput);
                }, CONFIG.DELAYS.SEARCH_DEBOUNCE);
                return () => clearTimeout(timer);
            }, [searchInput]);

            // Cerrar dropdown de status al hacer click fuera
            useEffect(() => {
                if (!showStatusDropdown) return;
                const handleClickOutside = (e) => {
                    if (!e.target.closest('.viajes-status-filter')) {
                        setShowStatusDropdown(false);
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [showStatusDropdown]);

            // Columnas base
            const allColumns = [
                { key: 'Fecha', label: 'Fecha', type: 'date' },
                { key: 'Nombre', label: 'Nombre', type: 'string' },
                { key: 'Numero de booking', label: 'Booking', type: 'string' },
                { key: 'Numero de BL', label: 'BL', type: 'string' },
                { key: 'Status', label: 'Status', type: 'string' },
                { key: 'Docs', label: 'Docs', type: 'docs' },
                { key: 'Contenedores', label: 'Conts', type: 'number' },
                { key: 'Peso', label: 'Peso', type: 'number' },
                { key: 'Analisis', label: 'Analisis', type: 'number' },
                { key: 'Cut off', label: 'Cut Off', type: 'date' },
                { key: 'Fecha de embarque', label: 'Embarque', type: 'date' },
                { key: 'Fecha de arribo', label: 'Arribo', type: 'date' },
                { key: 'Flete', label: 'Flete USD', type: 'number' },
                { key: '$venta', label: 'Venta', type: 'number', financial: true },
                { key: '$deben', label: 'Saldo', type: 'number', financial: true },
                { key: '10%', label: '10%', type: 'number', financial: true },
                { key: 'Anticipos', label: 'Anticipos', type: 'number', financial: true },
                { key: 'Agencia aduanal', label: 'Agencia (MXN)', type: 'number' },
            ];

            // Filtrar columnas financieras si el usuario no tiene permiso
            const columns = canSeeFinancials ? allColumns : allColumns.filter(col => !col.financial);

            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
                }));
            };

            const sorted = useMemo(() => {
                const filtered = data.filter(v => {
                    const matchSearch = !search || (v.Nombre || '').toLowerCase().includes(search.toLowerCase()) || (v['Numero de booking'] || '').toLowerCase().includes(search.toLowerCase()) || (v['Numero de BL'] || '').toLowerCase().includes(search.toLowerCase());
                    const matchStatus = filterStatus.length === 0 || filterStatus.includes(v.Status);
                    return matchSearch && matchStatus;
                });

                return [...filtered].sort((a, b) => {
                    const col = columns.find(c => c.key === sortConfig.key);
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];

                    if (col?.type === 'date') {
                        aVal = robustParseDate(aVal)?.getTime() || 0;
                        bVal = robustParseDate(bVal)?.getTime() || 0;
                    } else if (col?.type === 'number') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }

                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [data, search, filterStatus, sortConfig]);

            const statuses = useMemo(() => [...new Set(data.map(v => v.Status).filter(Boolean))], [data]);
            useEffect(() => { lucide.createIcons(); }, [sorted, sortConfig, showStatusDropdown, filterStatus]);

            const SortHeader = ({ col, index }) => {
                const stickyClass = index === 0 ? 'sticky-col-1' : index === 1 ? 'sticky-col-2' : '';
                return (
                    <th onClick={() => handleSort(col.key)} className={stickyClass} style={{ cursor: 'pointer', userSelect: 'none', whiteSpace: 'nowrap' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                            {col.label}
                            {sortConfig.key === col.key ? (
                                <i data-lucide={sortConfig.direction === 'asc' ? 'ChevronUp' : 'ChevronDown'} size="14" color="var(--primary)"></i>
                            ) : (
                                <i data-lucide="ChevronsUpDown" size="14" color="#cbd5e1"></i>
                            )}
                        </div>
                    </th>
                );
            };

            // Mostrar skeleton mientras carga
            if (loading) {
                return (
                    <div style={{ padding: '1.5rem' }}>
                        <SkeletonLoader type="table" count={10} />
                    </div>
                );
            }

            return (
                <div>
                    {/* Header - solo visible en desktop */}
                    <div className="viajes-header-desktop" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Todos los Viajes ({sorted.length})</h2>
                        <div style={{ display: 'flex', gap: '0.75rem' }}>
                            <button className="btn-secondary" onClick={onImport}><i data-lucide="Upload" size="16"></i>Importar</button>
                            <button className="btn-secondary" onClick={onExport} title="Descargar TODOS los viajes"><i data-lucide="Download" size="16"></i>Exportar Todo</button>
                            <button className="btn-primary" onClick={onAdd}><i data-lucide="Plus" size="16"></i>Nuevo</button>
                        </div>
                    </div>

                    {/* Búsqueda y filtros - adaptable a móvil */}
                    <div className="viajes-filters">
                        {/* Barra de búsqueda */}
                        <div className="viajes-search-wrapper">
                            <i data-lucide="Search" size="18" className="viajes-search-icon"></i>
                            <input
                                type="text"
                                placeholder="Buscar viaje, booking o BL..."
                                value={searchInput}
                                onChange={(e) => setSearchInput(e.target.value)}
                                className="viajes-search-input"
                            />
                            {searchInput && (
                                <button
                                    className="viajes-search-clear"
                                    onClick={() => setSearchInput('')}
                                    type="button"
                                >
                                    <i data-lucide="X" size="16"></i>
                                </button>
                            )}
                        </div>

                        {/* Filtro de status - multi-select con dropdown */}
                        <div className="viajes-status-filter" style={{ position: 'relative' }}>
                            <button
                                type="button"
                                className="viajes-status-select"
                                onClick={() => setShowStatusDropdown(!showStatusDropdown)}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    gap: '0.5rem',
                                    minWidth: '140px',
                                    cursor: 'pointer'
                                }}
                            >
                                <span>{filterStatus.length === 0 ? 'Todos' : `${filterStatus.length} seleccionado${filterStatus.length > 1 ? 's' : ''}`}</span>
                                <i data-lucide={showStatusDropdown ? 'ChevronUp' : 'ChevronDown'} size="16"></i>
                            </button>

                            {showStatusDropdown && (
                                <div style={{
                                    position: 'absolute',
                                    top: '100%',
                                    left: 0,
                                    right: 0,
                                    marginTop: '4px',
                                    background: 'var(--card-bg)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: '8px',
                                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                    zIndex: 100,
                                    maxHeight: '250px',
                                    overflowY: 'auto'
                                }}>
                                    {/* Opción "Todos" para limpiar */}
                                    <div
                                        style={{
                                            padding: '0.5rem 0.75rem',
                                            cursor: 'pointer',
                                            borderBottom: '1px solid var(--border-color)',
                                            background: filterStatus.length === 0 ? 'var(--primary-bg)' : 'transparent',
                                            fontWeight: filterStatus.length === 0 ? 600 : 400
                                        }}
                                        onClick={() => {
                                            setFilterStatus([]);
                                            setShowStatusDropdown(false);
                                        }}
                                    >
                                        Todos
                                    </div>

                                    {/* Lista de status con checkboxes */}
                                    {statuses.map(s => (
                                        <label
                                            key={s}
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '0.5rem',
                                                padding: '0.5rem 0.75rem',
                                                cursor: 'pointer',
                                                background: filterStatus.includes(s) ? 'var(--primary-bg)' : 'transparent'
                                            }}
                                            onClick={(e) => e.stopPropagation()}
                                        >
                                            <input
                                                type="checkbox"
                                                checked={filterStatus.includes(s)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setFilterStatus([...filterStatus, s]);
                                                    } else {
                                                        setFilterStatus(filterStatus.filter(x => x !== s));
                                                    }
                                                }}
                                                style={{ accentColor: 'var(--primary)' }}
                                            />
                                            <span>{s}</span>
                                        </label>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Contador móvil y badges de filtros activos */}
                    <div className="viajes-mobile-count">
                        <span>{sorted.length} viaje{sorted.length !== 1 ? 's' : ''}</span>
                        {filterStatus.length > 0 && (
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', alignItems: 'center' }}>
                                {filterStatus.map(s => (
                                    <span
                                        key={s}
                                        className="viajes-filter-badge"
                                        onClick={() => setFilterStatus(filterStatus.filter(x => x !== s))}
                                    >
                                        {s} <i data-lucide="X" size="12"></i>
                                    </span>
                                ))}
                                {filterStatus.length > 1 && (
                                    <span
                                        className="viajes-filter-badge"
                                        style={{ background: 'var(--text-muted)', cursor: 'pointer' }}
                                        onClick={() => setFilterStatus([])}
                                    >
                                        Limpiar <i data-lucide="X" size="12"></i>
                                    </span>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Vista móvil - Tarjetas mejoradas */}
                    <div className="mobile-cards">
                        {sorted.map((r, i) => {
                            const docsCount = countUploadedDocs(r.documentos);
                            const statusClass = r.Status === 'cerrado' ? 'cerrado' :
                                               r.Status === 'Altamar' ? 'altamar' :
                                               r.Status === 'Pago 10%' ? 'pago10' :
                                               r.Status === 'Ingresados' ? 'ingresados' : 'programacion';
                            return (
                                <div key={r.tripId || i} className="mobile-card" onClick={() => onEdit(r)}>
                                    {/* Barra de status lateral */}
                                    <div className={`mobile-card-status-bar ${statusClass}`}></div>

                                    <div className="mobile-card-content">
                                        {/* Header con título y badge */}
                                        <div className="mobile-card-header">
                                            <div style={{ flex: 1, minWidth: 0 }}>
                                                <h3 className="mobile-card-title">{r.Nombre || 'Sin nombre'}</h3>
                                                <span className="mobile-card-date">
                                                    <i data-lucide="Calendar" size="12"></i>
                                                    {formatDateSpanish(r.Fecha) || 'Sin fecha'}
                                                </span>
                                            </div>
                                            <span className={`mobile-status-badge ${statusClass}`}>
                                                {r.Status || 'Programación'}
                                            </span>
                                        </div>

                                        {/* Info principal */}
                                        <div className="mobile-card-body">
                                            <div className="mobile-card-row">
                                                <span className="mobile-card-label">Booking</span>
                                                <span className={`mobile-card-value ${!r['Numero de booking'] ? 'empty' : ''}`}>
                                                    {r['Numero de booking'] || '—'}
                                                </span>
                                            </div>
                                            <div className="mobile-card-row">
                                                <span className="mobile-card-label">BL</span>
                                                <span className={`mobile-card-value ${!r['Numero de BL'] ? 'empty' : ''}`}>
                                                    {r['Numero de BL'] || '—'}
                                                </span>
                                            </div>
                                            <div className="mobile-card-row">
                                                <span className="mobile-card-label">Contenedores</span>
                                                <span className={`mobile-card-value ${!r.Contenedores ? 'empty' : ''}`}>
                                                    {r.Contenedores || '—'}
                                                </span>
                                            </div>
                                            <div className="mobile-card-row">
                                                <span className="mobile-card-label">Peso</span>
                                                <span className={`mobile-card-value ${!r.Peso ? 'empty' : ''}`}>
                                                    {r.Peso ? formatNumber(r.Peso) + ' kg' : '—'}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Fechas destacadas */}
                                        <div className="mobile-card-dates">
                                            <div className="mobile-date-item">
                                                <div className="mobile-date-icon embarque">
                                                    <i data-lucide="Ship" size="14"></i>
                                                </div>
                                                <div className="mobile-date-info">
                                                    <span className="mobile-date-label">Embarque</span>
                                                    <span className="mobile-date-value">
                                                        {formatDateSpanish(r['Fecha de embarque']) || '—'}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="mobile-date-item">
                                                <div className="mobile-date-icon arribo">
                                                    <i data-lucide="MapPin" size="14"></i>
                                                </div>
                                                <div className="mobile-date-info">
                                                    <span className="mobile-date-label">Arribo</span>
                                                    <span className="mobile-date-value">
                                                        {formatDateSpanish(r['Fecha de arribo']) || '—'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Footer con documentos y acciones */}
                                        <div className="mobile-card-footer">
                                            <div
                                                className="mobile-docs-indicator"
                                                onClick={(e) => { e.stopPropagation(); onEditDocs(r); }}
                                            >
                                                <div className="mobile-docs-progress">
                                                    {[...Array(6)].map((_, idx) => (
                                                        <div
                                                            key={idx}
                                                            className={`mobile-docs-dot ${idx < docsCount ? 'filled' : ''}`}
                                                        ></div>
                                                    ))}
                                                </div>
                                                <span className={`mobile-docs-text ${docsCount === 6 ? 'complete' : ''}`}>
                                                    {docsCount}/6
                                                </span>
                                            </div>
                                            <div className="mobile-card-actions">
                                                <button
                                                    className="mobile-card-btn mobile-card-btn-danger"
                                                    onClick={(e) => { e.stopPropagation(); onDelete(r); }}
                                                >
                                                    <i data-lucide="Trash2" size="16"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}

                        {/* Estado vacío mejorado */}
                        {sorted.length === 0 && (
                            <div className="mobile-empty">
                                <div className="mobile-empty-icon">
                                    <i data-lucide="Package" size="32"></i>
                                </div>
                                <h3 className="mobile-empty-title">No hay viajes</h3>
                                <p className="mobile-empty-text">
                                    Toca el botón + para crear uno nuevo
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Vista escritorio - Tabla */}
                    <div className="table-card desktop-table">
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ fontSize: '0.75rem' }}>
                                <thead>
                                    <tr>
                                        {columns.map((col, idx) => <SortHeader key={col.key} col={col} index={idx} />)}
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sorted.map((r, i) => {
                                        const docsCount = countUploadedDocs(r.documentos);
                                        return (
                                        <tr key={r.tripId || i}>
                                            <td className="sticky-col-1" style={{ whiteSpace: 'nowrap' }}>{formatDateSpanish(r.Fecha)}</td>
                                            <td className="sticky-col-2" style={{ fontWeight: 500, whiteSpace: 'nowrap' }}>{r.Nombre || '-'}</td>
                                            <td>{r['Numero de booking'] || '-'}</td>
                                            <td>{r['Numero de BL'] || '-'}</td>
                                            <td><span className={`badge ${r.Status === 'cerrado' ? 'bg-green' : r.Status === 'Altamar' ? 'bg-cyan' : r.Status === 'Pago 10%' ? 'bg-purple' : 'bg-blue'}`}>{r.Status || '-'}</span></td>
                                            <td>
                                                <span
                                                    onClick={() => onEditDocs(r)}
                                                    style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '0.25rem',
                                                        padding: '0.25rem 0.5rem',
                                                        borderRadius: '6px',
                                                        fontSize: '0.75rem',
                                                        fontWeight: 600,
                                                        background: docsCount === 8 ? 'rgba(34, 197, 94, 0.1)' : docsCount > 0 ? 'rgba(59, 130, 246, 0.1)' : 'var(--hover-bg)',
                                                        color: getDocsColor(docsCount),
                                                        cursor: 'pointer',
                                                        transition: 'transform 0.1s'
                                                    }}
                                                    title="Ver documentos"
                                                    onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                                    onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                                >
                                                    <i data-lucide="Folder" size="12"></i>
                                                    {docsCount}/6
                                                </span>
                                            </td>
                                            <td>{r.Contenedores || '-'}</td>
                                            <td>{r.Peso ? formatNumber(r.Peso) : '-'}</td>
                                            <td>{r.Analisis ? formatPercent(r.Analisis) : '-'}</td>
                                            <td>{r['Cut off'] === 'Verde' ? <span className="badge bg-green">Verde</span> : r['Cut off'] === 'Rojo' ? <span className="badge bg-red">Rojo</span> : r['Cut off'] ? formatDateSpanish(r['Cut off']) : '-'}</td>
                                            <td style={{ whiteSpace: 'nowrap' }}>{formatDateSpanish(r['Fecha de embarque'])}</td>
                                            <td style={{ whiteSpace: 'nowrap' }}>{formatDateSpanish(r['Fecha de arribo'])}</td>
                                            <td>{r.Flete ? formatUSD(r.Flete) : '-'}</td>
                                            {canSeeFinancials && <td style={{ fontWeight: 600, color: 'var(--success)' }}>{formatUSD(r['$venta'])}</td>}
                                            {canSeeFinancials && <td style={{ color: Number(r['$deben']) > 0 ? 'var(--danger)' : 'var(--text-muted)' }}>{formatUSD(r['$deben'])}</td>}
                                            {canSeeFinancials && <td>{r['10%'] ? formatUSD(r['10%']) : '-'}</td>}
                                            {canSeeFinancials && <td style={{
                                                        color: r.Anticipos ? (r.anticipoPagado ? 'var(--success)' : 'var(--warning)') : 'var(--text-muted)',
                                                        fontWeight: r.Anticipos ? 600 : 400
                                                    }}>
                                                        {r.Anticipos ? (
                                                            <span title={r.anticipoPagado ? 'Pagado' : 'Pendiente'}>
                                                                {r.anticipoPagado ? '✓ ' : ''}{formatUSD(r.Anticipos)}
                                                            </span>
                                                        ) : '-'}
                                                    </td>}
                                            <td style={{ whiteSpace: 'nowrap' }}>{r['Agencia aduanal'] ? formatCurrency(r['Agencia aduanal']) : '-'}</td>
                                            <td>
                                                <div style={{ display: 'flex', gap: '0.375rem' }}>
                                                    <button onClick={() => onEdit(r)} style={{ border: 'none', background: '#f1f5f9', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}><i data-lucide="Edit2" size="14" color="var(--primary)"></i></button>
                                                    <button onClick={() => onDelete(r)} style={{ border: 'none', background: '#fef2f2', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}><i data-lucide="Trash2" size="14" color="#ef4444"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    );})}
                                </tbody>
                            </table>
                            {sorted.length === 0 && <div style={{ padding: '3rem', textAlign: 'center', color: 'var(--text-muted)' }}>No se encontraron viajes</div>}
                        </div>
                    </div>
                </div>
            );
        });

        const CalendarioPage = ({ data, onEdit }) => {
            const [month, setMonth] = useState(new Date());
            const events = useMemo(() => data.map(v => ({
                ...v,
                fecha: robustParseDate(v.Fecha),
                emb: robustParseDate(v['Fecha de embarque']),
                arr: robustParseDate(v['Fecha de arribo'])
            })).filter(v => v.fecha || v.emb || v.arr), [data]);

            const days = useMemo(() => {
                const y = month.getFullYear(), m = month.getMonth();
                const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
                const arr = [];
                for (let i = 0; i < first.getDay(); i++) arr.push(null);
                for (let d = 1; d <= last.getDate(); d++) arr.push(new Date(y, m, d));
                return arr;
            }, [month]);

            const getEvents = (day) => {
                if (!day) return [];
                return events.filter(e =>
                    (e.fecha && e.fecha.toDateString() === day.toDateString()) ||
                    (e.emb && e.emb.toDateString() === day.toDateString()) ||
                    (e.arr && e.arr.toDateString() === day.toDateString())
                );
            };
            useEffect(() => { lucide.createIcons(); }, [month]);

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Calendario</h2>
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <button className="btn-secondary" onClick={() => setMonth(new Date(month.getFullYear(), month.getMonth() - 1))}><i data-lucide="ChevronLeft" size="18"></i></button>
                            <span style={{ fontWeight: 600, minWidth: '150px', textAlign: 'center' }}>{MESES[month.getMonth()]} {month.getFullYear()}</span>
                            <button className="btn-secondary" onClick={() => setMonth(new Date(month.getFullYear(), month.getMonth() + 1))}><i data-lucide="ChevronRight" size="18"></i></button>
                        </div>
                    </div>

                    {/* Leyenda */}
                    <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                            <span>🚛</span>
                            <span style={{ color: 'var(--text-muted)' }}>Pick up</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                            <span>🚢</span>
                            <span style={{ color: 'var(--text-muted)' }}>Salida del barco</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                            <span>📍</span>
                            <span style={{ color: 'var(--text-muted)' }}>Llegada a destino</span>
                        </div>
                    </div>

                    <div className="apple-calendar">
                        <div className="cal-grid">{['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'].map(d => <div key={d} className="cal-day-label">{d}</div>)}</div>
                        <div className="cal-grid">
                            {days.map((day, i) => {
                                const isToday = day && day.toDateString() === new Date().toDateString();
                                const evts = getEvents(day);
                                return (
                                    <div key={i} className="cal-cell">
                                        {day && (
                                            <>
                                                <span className={`cal-num ${isToday ? 'today' : ''}`}>{day.getDate()}</span>
                                                {evts.slice(0, 3).map((e, idx) => {
                                                    const isFecha = e.fecha && e.fecha.toDateString() === day.toDateString();
                                                    const isEmb = e.emb && e.emb.toDateString() === day.toDateString();
                                                    const isArr = e.arr && e.arr.toDateString() === day.toDateString();
                                                    // Prioridad: Fecha > Embarque > Arribo
                                                    let emoji = '🚛';
                                                    let evtClass = 'evt-fecha';
                                                    if (isEmb) { emoji = '🚢'; evtClass = 'evt-embarque'; }
                                                    else if (isArr) { emoji = '📍'; evtClass = 'evt-arribo'; }
                                                    return <div key={idx} className={`evt ${evtClass}`} onClick={() => onEdit(e)}>{emoji} {e.Nombre}</div>;
                                                })}
                                                {evts.length > 3 && <div style={{ fontSize: '0.6rem', color: 'var(--text-muted)' }}>+{evts.length - 3}</div>}
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // PDF EXTRACTION
        // =====================================================
        const extractTotalUSD = (text) => {
            const lines = text.split('\n');
            const cleanPrice = (str) => parseFloat(str.replace(/,/g, ''));
            const isAmount = (str) => /^\d{1,3}(?:,\d{3})*(?:\.\d{2})?$/.test(str);

            // Strategy 1: Windowed Anchor Search
            const anchors = [
                { regex: /Grand\s*Total/i, name: 'Grand Total' },
                { regex: /TOTAL\s*USD/i, name: 'TOTAL USD' },
                { regex: /Total\s*Amount/i, name: 'Total Amount' }
            ];

            for (let anchor of anchors) {
                for (let i = 0; i < lines.length; i++) {
                    if (anchor.regex.test(lines[i])) {
                        for (let j = 0; j <= 6; j++) {
                            if (i + j >= lines.length) break;
                            const line = lines[i + j];
                            const matches = [...line.matchAll(/(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g)];
                            for (let m of matches) {
                                const val = cleanPrice(m[1]);
                                if (!isNaN(val) && val > 0 && !line.toLowerCase().includes('/100')) {
                                    return { value: val, evidence: { rule: anchor.name, snippet: line.trim() } };
                                }
                            }
                        }
                    }
                }
            }

            // Strategy 2: Fallback con sistema de puntuacion
            let bestCandidate = null;
            let bestScore = -Infinity;
            const amountRegex = /(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g;
            const boostKeywords = ['total', 'amount', 'due', 'grand', 'freight', 'charges', 'payable', 'invoice'];
            const badContexts = ['terms', 'notes', 'words', 'say'];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lowerLine = line.toLowerCase();
                let match;
                while ((match = amountRegex.exec(line)) !== null) {
                    const amountStr = match[1];
                    const val = cleanPrice(amountStr);
                    if (isNaN(val) || val === 0) continue;

                    let score = 0;
                    const pre = line.substring(Math.max(0, match.index - 30), match.index).toLowerCase();
                    const post = line.substring(match.index + amountStr.length, Math.min(line.length, match.index + amountStr.length + 30)).toLowerCase();

                    if (pre.includes('/100') || post.includes('/100')) continue;
                    if (pre.includes('hundred and') || post.includes('hundred and')) continue;

                    if (boostKeywords.some(k => lowerLine.includes(k))) score += 10;
                    if (line.includes('USD')) score += 5;
                    if (badContexts.some(c => lowerLine.includes(c))) score -= 15;
                    if (i > 0 && boostKeywords.some(k => lines[i - 1].toLowerCase().includes(k))) score += 5;
                    if (val === 100) score -= 10;

                    if (score > bestScore) {
                        bestScore = score;
                        bestCandidate = { value: val, evidence: { rule: `Scored Fallback (${score})`, snippet: line.trim() } };
                    }
                }
            }

            if (bestCandidate && bestScore > 0) return bestCandidate;
            return { value: null, evidence: { rule: 'No Match', snippet: 'No se encontro monto USD' } };
        };

        const extractTextFromPDF = async (file) => {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            // Solo pagina 1 para booking
            const page = await pdf.getPage(1);
            const content = await page.getTextContent();

            // Agrupar por lineas usando posicion Y
            const items = content.items;
            let lines = [];
            let currentLine = [];
            let lastY = null;

            items.forEach(item => {
                const y = Math.round(item.transform[5]);
                if (lastY !== null && Math.abs(y - lastY) > 5) {
                    if (currentLine.length > 0) {
                        lines.push(currentLine.map(i => i.str).join(' '));
                    }
                    currentLine = [];
                }
                currentLine.push(item);
                lastY = y;
            });

            if (currentLine.length > 0) {
                lines.push(currentLine.map(i => i.str).join(' '));
            }

            return lines.join('\n');
        };

        // =====================================================
        // STATUS PAGE (KANBAN)
        // =====================================================
        const StatusPage = React.memo(({ data, onEdit }) => {
            const STATUS_COLUMNS = [
                { id: 'Programacion', label: 'Programacion', color: '#3b82f6' },
                { id: 'Ingresados', label: 'Ingresados', color: '#f59e0b' },
                { id: 'Altamar', label: 'Altamar', color: '#06b6d4' },
                { id: 'Liberado', label: 'Liberado', color: '#22c55e' },
                { id: 'Pago 10%', label: 'Pago 10%', color: '#8b5cf6' },
                { id: 'cerrado', label: 'Cerrado', color: '#64748b' }
            ];

            const [collapsedColumns, setCollapsedColumns] = useState({});
            const toggleCollapse = (colId) => {
                setCollapsedColumns(prev => ({ ...prev, [colId]: !prev[colId] }));
            };

            const grouped = useMemo(() => {
                const g = {};
                STATUS_COLUMNS.forEach(col => g[col.id] = []);
                data.forEach(v => {
                    const status = v.Status || 'Programacion';
                    const col = STATUS_COLUMNS.find(c => c.id.toLowerCase() === status.toLowerCase());
                    if (col) g[col.id].push(v);
                    else if (g['Programacion']) g['Programacion'].push(v);
                });
                return g;
            }, [data]);

            useEffect(() => { lucide.createIcons(); }, [data, collapsedColumns]);

            return (
                <div>
                    <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1.5rem' }}>Tablero de Estatus</h2>
                    <div className="kanban-board">
                        {STATUS_COLUMNS.map(col => (
                            <div key={col.id} className="kanban-column">
                                <div
                                    className="kanban-header"
                                    onClick={() => toggleCollapse(col.id)}
                                    style={{ cursor: 'pointer', userSelect: 'none' }}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <i data-lucide={collapsedColumns[col.id] ? 'ChevronRight' : 'ChevronDown'} size="16"></i>
                                        <div style={{ width: 10, height: 10, borderRadius: '50%', background: col.color }}></div>
                                        <span className="kanban-title">{col.label}</span>
                                    </div>
                                    <span className="kanban-count">{grouped[col.id]?.length || 0}</span>
                                </div>
                                {!collapsedColumns[col.id] && (
                                    <div className="kanban-cards">
                                        {(grouped[col.id] || []).map((v, i) => (
                                            <div key={v.tripId || i} className="kanban-card" onClick={() => onEdit(v)}>
                                                <div className="kanban-card-title">{v.Nombre || 'Sin nombre'}</div>
                                                <div className="kanban-card-meta">
                                                    <span>Booking: {v['Numero de booking'] || '-'}</span>
                                                    <span>Embarque: {formatDateSpanish(v['Fecha de embarque'])}</span>
                                                    {v['$venta'] && <span style={{ color: 'var(--success)', fontWeight: 600 }}>{formatCurrency(v['$venta'])}</span>}
                                                </div>
                                            </div>
                                        ))}
                                        {(grouped[col.id]?.length || 0) === 0 && (
                                            <div style={{ padding: '1rem', textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.8125rem' }}>Sin viajes</div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        });

        // =====================================================
        // GESTION PAGE (PDF UPLOAD - BOOKING Y BL)
        // =====================================================

        // Extraccion de datos de Booking PDF
        const extractBookingData = (text, fileName) => {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const result = {
                file_name: fileName,
                booking: '',
                contenedores: '',
                Embarque: '', // No viene en booking
                'Cut Off': '',
                fecha: '',
                flete: ''
            };

            // Buscar valor en la misma linea (a la derecha del ancla)
            const findInSameLine = (anchorRegex) => {
                for (let i = 0; i < lines.length; i++) {
                    if (anchorRegex.test(lines[i])) {
                        const dateMatch = lines[i].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (dateMatch) return dateMatch[1];
                    }
                }
                return '';
            };

            // Buscar valor en lineas siguientes (abajo del ancla)
            const findBelow = (anchorRegex, maxLines = 6) => {
                for (let i = 0; i < lines.length; i++) {
                    if (anchorRegex.test(lines[i])) {
                        for (let j = 1; j <= maxLines && (i + j) < lines.length; j++) {
                            const line = lines[i + j];
                            // Buscar fecha
                            const dateMatch = line.match(/^(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})$/);
                            if (dateMatch) return dateMatch[1];
                            // Buscar numero solo
                            const numMatch = line.match(/^(\d+)$/);
                            if (numMatch) return numMatch[1];
                        }
                    }
                }
                return '';
            };

            // A) Booking - buscar EBKG seguido de numeros
            for (let line of lines) {
                const bookingMatch = line.match(/(EBKG\d+)/i);
                if (bookingMatch) {
                    result.booking = bookingMatch[1];
                    break;
                }
            }

            // B) Contenedores - multiples estrategias
            // Estrategia 1: Buscar numero antes de "20S" o "40S" o "20'" o "40'" (tipo de contenedor)
            for (let line of lines) {
                // Patron: "10 20S" o "10 X 20S" o "10 x 20'" etc
                const sizeMatch = line.match(/(\d+)\s*[Xx]?\s*(20|40)\s*[S']/i);
                if (sizeMatch) {
                    result.contenedores = sizeMatch[1];
                    break;
                }
            }
            // Estrategia 2: Buscar "X / X" cerca de TOTAL o palabras clave
            if (!result.contenedores) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const prevLine = lines[i-1] || '';
                    const nextLine = lines[i+1] || '';

                    // Patron "10 / 10" o "10/10"
                    const slashMatch = line.match(/(\d+)\s*\/\s*(\d+)/);
                    if (slashMatch) {
                        // Verificar contexto
                        if (/CONTR|CONTAINER|ASSIGNED|REQUESTED|QTY|QUANTITY|TOTAL/i.test(line) ||
                            /CONTR|CONTAINER|ASSIGNED|REQUESTED|QTY|QUANTITY|TOTAL/i.test(prevLine) ||
                            /CONTR|CONTAINER|ASSIGNED|REQUESTED|QTY|QUANTITY|TOTAL/i.test(nextLine)) {
                            result.contenedores = slashMatch[1];
                            break;
                        }
                    }
                }
            }
            // Estrategia 3: Buscar linea con solo "10 / 10" o "10/10" sin contexto
            if (!result.contenedores) {
                for (let line of lines) {
                    const simpleSlash = line.trim().match(/^(\d+)\s*\/\s*\d+$/);
                    if (simpleSlash) {
                        result.contenedores = simpleSlash[1];
                        break;
                    }
                }
            }
            // Estrategia 4: Buscar despues de ancla especifica
            if (!result.contenedores) {
                for (let i = 0; i < lines.length; i++) {
                    if (/REQUESTED.*ASSIGNED|CONTR.*#|CONTAINER.*QTY/i.test(lines[i])) {
                        for (let j = 1; j <= 8 && (i + j) < lines.length; j++) {
                            const nextLine = lines[i + j].trim();
                            const numMatch = nextLine.match(/^(\d+)(?:\s*\/\s*\d+)?$/);
                            if (numMatch) {
                                result.contenedores = numMatch[1];
                                break;
                            }
                        }
                        if (result.contenedores) break;
                    }
                }
            }
            // Estrategia 5: Buscar "X CONTAINER" o "CONTAINER: X"
            if (!result.contenedores) {
                for (let line of lines) {
                    const match = line.match(/(\d+)\s*[Xx]?\s*(?:CONTAINER|CONTR)/i) ||
                                  line.match(/(?:CONTAINER|CONTR)[:\s]*(\d+)/i);
                    if (match) {
                        result.contenedores = match[1];
                        break;
                    }
                }
            }

            // Embarque - NO viene en booking, dejarlo vacio
            result.Embarque = '';

            // Cut Off (VGM) - a la derecha de "VGM CUTOFF DATE:"
            const cutoffAnchor = /VGM\s*CUTOFF\s*DATE/i;
            result['Cut Off'] = findInSameLine(cutoffAnchor);

            // Fecha - multiples estrategias
            // Estrategia 1: APPOINTMENT DATE
            for (let i = 0; i < lines.length; i++) {
                if (/APPOINTMENT\s*DATE/i.test(lines[i])) {
                    // Buscar en misma linea
                    const sameLine = lines[i].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                    if (sameLine) {
                        result.fecha = sameLine[1];
                        break;
                    }
                    // Buscar en lineas siguientes
                    for (let j = 1; j <= 8 && (i + j) < lines.length; j++) {
                        const dateMatch = lines[i + j].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (dateMatch) {
                            result.fecha = dateMatch[1];
                            break;
                        }
                    }
                    break;
                }
            }
            // Estrategia 2: ETD o ESTIMATED TIME OF DEPARTURE
            if (!result.fecha) {
                for (let i = 0; i < lines.length; i++) {
                    if (/\bETD\b|ESTIMATED\s*TIME.*DEPARTURE|SAILING\s*DATE|DEPARTURE\s*DATE/i.test(lines[i])) {
                        const sameLine = lines[i].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (sameLine) {
                            result.fecha = sameLine[1];
                            break;
                        }
                        for (let j = 1; j <= 5 && (i + j) < lines.length; j++) {
                            const dateMatch = lines[i + j].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                            if (dateMatch) {
                                result.fecha = dateMatch[1];
                                break;
                            }
                        }
                        if (result.fecha) break;
                    }
                }
            }
            // Estrategia 3: Formato de fecha con mes en texto (JAN, FEB, etc.)
            if (!result.fecha) {
                for (let line of lines) {
                    const textDateMatch = line.match(/(\d{1,2})[\/\-\s]*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[\/\-\s]*(\d{2,4})/i);
                    if (textDateMatch) {
                        const months = {JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'};
                        const month = months[textDateMatch[2].toUpperCase()];
                        const year = textDateMatch[3].length === 2 ? '20' + textDateMatch[3] : textDateMatch[3];
                        result.fecha = textDateMatch[1] + '/' + month + '/' + year;
                        break;
                    }
                }
            }

            // G) Flete - buscar monto USD (puede no venir)
            for (let line of lines) {
                const fleteMatch = line.match(/(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)\s*USD/i);
                if (fleteMatch) {
                    const val = parseFloat(fleteMatch[1].replace(/,/g, ''));
                    if (val > 100) { // Ignorar valores muy pequeños
                        result.flete = fleteMatch[1];
                        break;
                    }
                }
            }

            return result;
        };

        // Extraccion de datos de BL PDF
        const extractBLData = (text, fileName) => {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const fullText = text.toUpperCase();
            const result = {
                file_name: fileName,
                bl: '',
                booking: '',
                contenedores: '',
                flete: ''
            };

            // A) Bill of Lading # - patron MEDUXF seguido de numeros (formato MSC)
            // Buscar en todo el texto patron MEDUXF + numeros
            const blPatterns = [
                /MEDU[A-Z]*\d+/gi,           // MEDUXF429237
                /[A-Z]{4}[A-Z0-9]*\d{6,}/g,  // Otros formatos de BL
            ];
            for (const pattern of blPatterns) {
                const matches = text.match(pattern);
                if (matches && matches.length > 0) {
                    result.bl = matches[0].toUpperCase();
                    break;
                }
            }

            // B) Booking Ref - patron EBKG seguido de numeros
            // Buscar EBKG en cualquier parte del texto
            const ebkgMatch = text.match(/EBKG\d+/i);
            if (ebkgMatch) {
                result.booking = ebkgMatch[0].toUpperCase();
            }

            // Si no encontro EBKG, buscar cerca de "BOOKING REF"
            if (!result.booking) {
                for (let i = 0; i < lines.length; i++) {
                    if (/BOOKING\s*REF/i.test(lines[i])) {
                        // Buscar en las siguientes lineas un codigo alfanumerico
                        for (let j = 0; j <= 5 && (i + j) < lines.length; j++) {
                            const searchLine = lines[i + j];
                            // Buscar codigo que empiece con letra y tenga numeros
                            const codeMatch = searchLine.match(/\b([A-Z]{2,}[0-9]{5,})\b/i);
                            if (codeMatch && codeMatch[1].length >= 8) {
                                result.booking = codeMatch[1].toUpperCase();
                                break;
                            }
                        }
                        if (result.booking) break;
                    }
                }
            }

            // C) Contenedores - buscar "XX cntrs" en cualquier parte
            const cntrsMatch = text.match(/(\d+)\s*cntrs?/i);
            if (cntrsMatch) {
                result.contenedores = cntrsMatch[1];
            }

            // Si no, buscar cerca de CARRIER'S RECEIPT
            if (!result.contenedores) {
                for (let i = 0; i < lines.length; i++) {
                    if (/CARRIER.*RECEIPT|No\.\s*of\s*Cntrs/i.test(lines[i])) {
                        for (let j = 1; j <= 15 && (i + j) < lines.length; j++) {
                            const nextLine = lines[i + j];
                            const cntMatch = nextLine.match(/^(\d{1,3})(?:\s|$)/);
                            if (cntMatch && parseInt(cntMatch[1]) <= 100 && parseInt(cntMatch[1]) > 0) {
                                result.contenedores = cntMatch[1];
                                break;
                            }
                        }
                        if (result.contenedores) break;
                    }
                }
            }

            // D) Flete - DOS FORMATOS DE PDF:
            // Formato A (Draft B/L): TOTAL -> lineas despues -> numero solo "22,335.00"
            // Formato B (Freight Invoice): "$18,625.00 USD" en una linea
            let fleteFound = false;

            // ESTRATEGIA 1: Formato B - Buscar "$XX,XXX.XX USD" (Freight Invoice)
            const dollarUsdMatch = text.match(/\$([\d,]+\.\d{2})\s*USD/i);
            if (dollarUsdMatch) {
                const val = parseFloat(dollarUsdMatch[1].replace(/,/g, ''));
                if (val > 100 && val < 100000) {
                    result.flete = dollarUsdMatch[1];
                    fleteFound = true;
                }
            }

            // ESTRATEGIA 2: Formato A - Buscar numero despues de "TOTAL" (Draft B/L)
            if (!fleteFound) {
                for (let i = 0; i < lines.length; i++) {
                    if (/\bTOTAL\b/i.test(lines[i])) {
                        for (let j = 1; j <= 10 && (i + j) < lines.length; j++) {
                            const line = lines[i + j].trim();
                            // Linea que es SOLO un numero (22,335.00)
                            const numMatch = line.match(/^([\d,]+\.\d{2})$/);
                            if (numMatch) {
                                const val = parseFloat(numMatch[1].replace(/,/g, ''));
                                if (val > 100 && val < 50000) {
                                    result.flete = numMatch[1];
                                    fleteFound = true;
                                    break;
                                }
                            }
                        }
                        if (fleteFound) break;
                    }
                }
            }

            // ESTRATEGIA 3: Fallback - numero mas alto entre 100-50,000 que este solo
            if (!fleteFound) {
                let candidates = [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const numMatch = line.match(/^([\d,]+\.\d{2})$/);
                    if (numMatch) {
                        const val = parseFloat(numMatch[1].replace(/,/g, ''));
                        if (val > 100 && val < 50000) {
                            candidates.push({ val, str: numMatch[1], line: i });
                        }
                    }
                }
                if (candidates.length > 0) {
                    candidates.sort((a, b) => b.val - a.val);
                    result.flete = candidates[0].str;
                    fleteFound = true;
                }
            }

            return result;
        };

        const GestionPage = ({ onOpenBookingModal, onEditViaje, onEditViajeWithOriginal, allData, onImport, onExport, onExportFiltered }) => {
            const [activeTab, setActiveTab] = useState('booking');

            // Estado para Booking
            const [bookingFile, setBookingFile] = useState(null);
            const [bookingLoading, setBookingLoading] = useState(false);
            const [bookingResult, setBookingResult] = useState(null);
            const [bookingDragging, setBookingDragging] = useState(false);
            const bookingInputRef = useRef();

            // Estado para valores editables del booking
            const [editedBooking, setEditedBooking] = useState({});

            // Estado para BL
            const [blFile, setBlFile] = useState(null);
            const [blLoading, setBlLoading] = useState(false);
            const [blResult, setBlResult] = useState(null);
            const [blDragging, setBlDragging] = useState(false);
            const blInputRef = useRef();
            const [matchedViaje, setMatchedViaje] = useState(null); // Viaje encontrado por booking
            const [blEdited, setBlEdited] = useState({}); // Valores editados para actualizar

            // Procesar Booking PDF
            const processBookingFile = async (f) => {
                if (!f || !f.name.toLowerCase().endsWith('.pdf')) {
                    setTimeout(() => alert('Por favor selecciona un archivo PDF'), 50);
                    return;
                }
                setBookingFile(f);
                setBookingLoading(true);
                setBookingResult(null);

                try {
                    const text = await extractTextFromPDF(f);
                    const extraction = extractBookingData(text, f.name);
                    setBookingResult(extraction);
                    // Inicializar valores editables con los datos extraidos
                    setEditedBooking({
                        booking: extraction.booking || '',
                        contenedores: extraction.contenedores || '',
                        Embarque: extraction.Embarque || '',
                        'Cut Off': extraction['Cut Off'] || '',
                        fecha: extraction.fecha || '',
                        flete: extraction.flete || ''
                    });
                } catch (err) {
                    setTimeout(() => alert('Error al procesar PDF: ' + err.message), 50);
                }
                setBookingLoading(false);
            };

            // Procesar BL PDF
            const processBLFile = async (f) => {
                if (!f || !f.name.toLowerCase().endsWith('.pdf')) {
                    setTimeout(() => alert('Por favor selecciona un archivo PDF'), 50);
                    return;
                }
                setBlFile(f);
                setBlLoading(true);
                setBlResult(null);
                setMatchedViaje(null);
                setBlEdited({});

                try {
                    const text = await extractTextFromPDF(f);
                    const extraction = extractBLData(text, f.name);
                    setBlResult(extraction);

                    // Buscar viaje por numero de booking
                    if (extraction.booking && allData) {
                        const found = allData.find(v =>
                            v['Numero de booking'] &&
                            v['Numero de booking'].toUpperCase() === extraction.booking.toUpperCase()
                        );
                        if (found) {
                            setMatchedViaje(found);
                            // Inicializar valores editados con datos del BL
                            setBlEdited({
                                bl: extraction.bl || '',
                                booking: extraction.booking || '',
                                contenedores: extraction.contenedores || '',
                                flete: extraction.flete || ''
                            });
                        }
                    }
                } catch (err) {
                    setTimeout(() => alert('Error al procesar PDF: ' + err.message), 50);
                }
                setBlLoading(false);
            };

            // Generar nombre del viaje: ZN + DDMMYY
            const generateViajeName = (fechaStr) => {
                let day = '', month = '', year = '';

                // Intentar parsear diferentes formatos de fecha
                if (fechaStr) {
                    // Formato DD/MM/YYYY o DD-MM-YYYY
                    const match1 = fechaStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                    if (match1) {
                        day = match1[1].padStart(2, '0');
                        month = match1[2].padStart(2, '0');
                        year = match1[3].length === 4 ? match1[3].slice(-2) : match1[3];
                    }
                    // Formato YYYY-MM-DD
                    const match2 = fechaStr.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (!match1 && match2) {
                        day = match2[3].padStart(2, '0');
                        month = match2[2].padStart(2, '0');
                        year = match2[1].slice(-2);
                    }
                }

                // Si no se pudo parsear, usar fecha actual
                if (!day || !month || !year) {
                    const now = new Date();
                    day = String(now.getDate()).padStart(2, '0');
                    month = String(now.getMonth() + 1).padStart(2, '0');
                    year = String(now.getFullYear()).slice(-2);
                }

                return `ZN ${day}-${month}-${year}`;
            };

            // Abrir modal de edicion con datos del booking
            const openBookingInModal = () => {
                if (bookingResult && onOpenBookingModal) {
                    const fecha = editedBooking.fecha || new Date().toISOString().split('T')[0];
                    const nombreViaje = generateViajeName(fecha);

                    const dataToEdit = {
                        Nombre: nombreViaje,
                        'Numero de booking': editedBooking.booking || '',
                        Contenedores: editedBooking.contenedores || '',
                        'Fecha de embarque': editedBooking.Embarque || '',
                        'Cut off': editedBooking['Cut Off'] || '',
                        Fecha: fecha,
                        Flete: parseFloat((editedBooking.flete || '0').replace(/,/g, '')) || 0,
                        Status: 'Programacion',
                        modifiedBy: 'Booking PDF Import',
                        // Adjuntar archivo PDF para guardar en documentos
                        _pendingPdfFile: bookingFile,
                        _pendingPdfType: 'booking'
                    };
                    onOpenBookingModal(dataToEdit);
                    // Limpiar estado local
                    setBookingFile(null);
                    setBookingResult(null);
                    setEditedBooking({});
                }
            };

            // Abrir modal de edicion con viaje actualizado con datos del BL
            const openBLInModal = () => {
                if (blResult && matchedViaje && onEditViajeWithOriginal) {
                    // Crear copia del viaje con los datos actualizados del BL
                    const updatedViaje = { ...matchedViaje };

                    // Actualizar campos con valores del BL (si tienen valor)
                    if (blEdited.bl) {
                        updatedViaje['Numero de BL'] = blEdited.bl;
                    }
                    if (blEdited.contenedores) {
                        updatedViaje['Contenedores'] = blEdited.contenedores;
                    }
                    if (blEdited.flete) {
                        updatedViaje['Flete'] = parseFloat((blEdited.flete || '0').replace(/,/g, '')) || 0;
                    }

                    // Adjuntar archivo PDF para guardar en documentos
                    updatedViaje._pendingPdfFile = blFile;
                    updatedViaje._pendingPdfType = 'bl';

                    // Abrir modal de edicion con el viaje actualizado Y el original para comparar
                    onEditViajeWithOriginal(updatedViaje, matchedViaje);

                    // Limpiar estado
                    setBlResult(null);
                    setBlFile(null);
                    setMatchedViaje(null);
                    setBlEdited({});
                }
            };

            const ResultField = ({ label, value }) => (
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid var(--border)' }}>
                    <span style={{ color: 'var(--text-muted)', fontSize: '0.8125rem' }}>{label}</span>
                    <span style={{ fontWeight: 500, fontSize: '0.8125rem' }}>{value || '-'}</span>
                </div>
            );

            // Componente para comparar valores viaje vs BL
            const CompareField = ({ label, viajeValue, blValue, onChange, readOnly, isNew, highlight, isMoney }) => {
                const viajeStr = viajeValue ? String(viajeValue) : '';
                const blStr = blValue ? String(blValue) : '';
                const viajeDisplay = isMoney && viajeStr ? `$${viajeStr}` : viajeStr;
                const blDisplay = isMoney && blStr ? `$${blStr}` : blStr;

                // Determinar estado
                let status = 'empty'; // No hay valor en ninguno
                if (viajeStr && blStr) {
                    status = viajeStr.toUpperCase() === blStr.toUpperCase() ? 'match' : 'diff';
                } else if (blStr && !viajeStr) {
                    status = 'new';
                } else if (viajeStr && !blStr) {
                    status = 'existing';
                }

                const statusStyles = {
                    match: { bg: 'rgba(34, 197, 94, 0.1)', border: 'var(--success)', icon: '✓', text: 'Confirmado' },
                    new: { bg: 'rgba(59, 130, 246, 0.1)', border: 'var(--info)', icon: '➕', text: 'Nuevo' },
                    diff: { bg: 'rgba(245, 158, 11, 0.1)', border: 'var(--warning)', icon: '⚠️', text: 'Diferente' },
                    existing: { bg: 'var(--bg)', border: 'var(--border)', icon: '📋', text: 'Sin cambio' },
                    empty: { bg: 'var(--bg)', border: 'var(--border)', icon: '-', text: '' }
                };

                const style = statusStyles[status];

                return (
                    <div style={{
                        padding: '0.75rem',
                        marginBottom: '0.5rem',
                        borderRadius: '8px',
                        background: style.bg,
                        border: `1px solid ${style.border}`,
                        ...(highlight && { boxShadow: '0 0 0 2px var(--primary)' })
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                            <span style={{ fontWeight: 600, fontSize: '0.8125rem' }}>{label}</span>
                            {status !== 'empty' && (
                                <span style={{ fontSize: '0.75rem', color: style.border, display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                                    {style.icon} {style.text}
                                </span>
                            )}
                        </div>

                        {status === 'diff' ? (
                            <div style={{ fontSize: '0.8125rem' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                    <span style={{ color: 'var(--text-muted)', minWidth: '50px' }}>Viaje:</span>
                                    <span style={{ textDecoration: 'line-through', opacity: 0.6 }}>{viajeDisplay || '-'}</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ color: 'var(--text-muted)', minWidth: '50px' }}>BL:</span>
                                    <input
                                        type="text"
                                        value={blValue || ''}
                                        onChange={(e) => onChange && onChange(e.target.value)}
                                        disabled={readOnly}
                                        style={{
                                            flex: 1,
                                            padding: '0.3rem 0.5rem',
                                            border: '1px solid var(--warning)',
                                            borderRadius: '4px',
                                            fontSize: '0.8125rem',
                                            fontWeight: 600,
                                            background: 'var(--surface)',
                                            color: 'var(--text)'
                                        }}
                                    />
                                </div>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                {readOnly ? (
                                    <span style={{ fontSize: '0.875rem', fontWeight: 500 }}>{blDisplay || viajeDisplay || '-'}</span>
                                ) : (
                                    <input
                                        type="text"
                                        value={blValue || ''}
                                        onChange={(e) => onChange && onChange(e.target.value)}
                                        placeholder={viajeDisplay || '-'}
                                        style={{
                                            flex: 1,
                                            padding: '0.3rem 0.5rem',
                                            border: `1px solid ${style.border}`,
                                            borderRadius: '4px',
                                            fontSize: '0.8125rem',
                                            fontWeight: 500,
                                            background: 'var(--surface)',
                                            color: 'var(--text)'
                                        }}
                                    />
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            // Campo editable para booking
            const EditableField = ({ label, fieldKey, value, onChange }) => (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid var(--border)', gap: '1rem' }}>
                    <label style={{ color: 'var(--text-muted)', fontSize: '0.8125rem', whiteSpace: 'nowrap', minWidth: '120px' }}>{label}</label>
                    <input
                        type="text"
                        value={value || ''}
                        onChange={(e) => onChange(fieldKey, e.target.value)}
                        style={{
                            flex: 1,
                            padding: '0.4rem 0.6rem',
                            border: '1px solid var(--border)',
                            borderRadius: '6px',
                            fontSize: '0.8125rem',
                            fontWeight: 500,
                            background: 'var(--surface)',
                            color: 'var(--text)',
                            maxWidth: '200px'
                        }}
                        placeholder="-"
                    />
                </div>
            );

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Gestion de Documentos</h2>
                        <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                            <button className="btn-secondary" onClick={onImport}><i data-lucide="Upload" size="16"></i>Importar</button>
                            <button className="btn-secondary" onClick={onExport} title="Descargar TODOS los viajes"><i data-lucide="Download" size="16"></i>Exportar Todo</button>
                            <button className="btn-secondary" onClick={onExportFiltered} title="Solo viajes del rango de fechas seleccionado"><i data-lucide="Download" size="16"></i>Exportar Filtrados</button>
                        </div>
                    </div>

                    {/* Tabs - usando emojis en lugar de lucide */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem' }}>
                        <button
                            className={activeTab === 'booking' ? 'btn-primary' : 'btn-secondary'}
                            onClick={() => setActiveTab('booking')}
                            style={{ flex: 1 }}
                        >
                            📄 Crear Viaje (Booking)
                        </button>
                        <button
                            className={activeTab === 'bl' ? 'btn-primary' : 'btn-secondary'}
                            onClick={() => setActiveTab('bl')}
                            style={{ flex: 1 }}
                        >
                            📝 Actualizar Viaje (BL)
                        </button>
                    </div>

                    {/* Booking Tab */}
                    {activeTab === 'booking' && (
                        <div className="table-card" style={{ padding: '2rem' }}>
                            <div style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ fontWeight: 600, marginBottom: '0.5rem' }}>
                                    📋 Booking Confirmation
                                </h3>
                                <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>
                                    Sube el PDF del Booking Confirmation para crear un nuevo viaje automaticamente.
                                </p>
                            </div>

                            <div
                                className={`pdf-upload-zone ${bookingDragging ? 'dragging' : ''}`}
                                onDragOver={(e) => { e.preventDefault(); setBookingDragging(true); }}
                                onDragLeave={() => setBookingDragging(false)}
                                onDrop={(e) => { e.preventDefault(); setBookingDragging(false); processBookingFile(e.dataTransfer.files[0]); }}
                                onClick={() => bookingInputRef.current?.click()}
                            >
                                <input ref={bookingInputRef} type="file" accept=".pdf" hidden onChange={(e) => processBookingFile(e.target.files[0])} />
                                {bookingLoading ? (
                                    <div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto' }}></div>
                                ) : (
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>📤</div>
                                        <h3 style={{ marginBottom: '0.5rem' }}>Arrastra tu Booking PDF aqui</h3>
                                        <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>o haz clic para seleccionar</p>
                                    </div>
                                )}
                            </div>

                            {bookingResult && (
                                <div className="pdf-result" style={{ marginTop: '1.5rem' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', color: 'var(--success)' }}>
                                        <span style={{ fontSize: '1.25rem' }}>✅</span>
                                        <span style={{ fontWeight: 600 }}>Datos extraidos de: {bookingResult.file_name}</span>
                                    </div>

                                    <div style={{ background: 'var(--bg)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' }}>
                                        <ResultField label="Booking #" value={editedBooking.booking} />
                                        <ResultField label="Contenedores" value={editedBooking.contenedores} />
                                        <ResultField label="Cut Off" value={editedBooking['Cut Off']} />
                                        <ResultField label="Fecha" value={editedBooking.fecha} />
                                        <ResultField label="Flete (USD)" value={editedBooking.flete ? `$${editedBooking.flete}` : '-'} />
                                    </div>

                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <button
                                            className="btn-secondary"
                                            onClick={() => { setBookingResult(null); setBookingFile(null); setEditedBooking({}); }}
                                            style={{ flex: 1 }}
                                        >
                                            ❌ Cancelar
                                        </button>
                                        <button className="btn-primary" onClick={openBookingInModal} style={{ flex: 2 }}>
                                            📝 Editar y Crear Viaje
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* BL Tab */}
                    {activeTab === 'bl' && (
                        <div className="table-card" style={{ padding: '2rem' }}>
                            <div style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ fontWeight: 600, marginBottom: '0.5rem' }}>
                                    📄 Bill of Lading (BL)
                                </h3>
                                <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>
                                    Sube el PDF del BL para actualizar un viaje existente. El viaje se detecta automaticamente por el numero de Booking.
                                </p>
                            </div>

                            <div
                                className={`pdf-upload-zone ${blDragging ? 'dragging' : ''}`}
                                onDragOver={(e) => { e.preventDefault(); setBlDragging(true); }}
                                onDragLeave={() => setBlDragging(false)}
                                onDrop={(e) => { e.preventDefault(); setBlDragging(false); processBLFile(e.dataTransfer.files[0]); }}
                                onClick={() => blInputRef.current?.click()}
                            >
                                <input ref={blInputRef} type="file" accept=".pdf" hidden onChange={(e) => processBLFile(e.target.files[0])} />
                                {blLoading ? (
                                    <div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto' }}></div>
                                ) : (
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>📤</div>
                                        <h3 style={{ marginBottom: '0.5rem' }}>Arrastra tu BL PDF aqui</h3>
                                        <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>o haz clic para seleccionar</p>
                                    </div>
                                )}
                            </div>

                            {/* Resultado del BL */}
                            {blResult && (
                                <div className="pdf-result" style={{ marginTop: '1.5rem' }}>
                                    {/* Viaje encontrado o no */}
                                    {matchedViaje ? (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', padding: '0.75rem', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '8px', border: '1px solid var(--success)' }}>
                                            <span style={{ fontSize: '1.25rem' }}>🚢</span>
                                            <div>
                                                <div style={{ fontWeight: 600, color: 'var(--success)' }}>Viaje encontrado</div>
                                                <div style={{ fontSize: '0.875rem' }}>{matchedViaje.Nombre || 'Sin nombre'} ({matchedViaje['Numero de booking']})</div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', padding: '0.75rem', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '8px', border: '1px solid var(--danger)' }}>
                                            <span style={{ fontSize: '1.25rem' }}>⚠️</span>
                                            <div>
                                                <div style={{ fontWeight: 600, color: 'var(--danger)' }}>Viaje no encontrado</div>
                                                <div style={{ fontSize: '0.875rem' }}>No se encontro viaje con Booking: {blResult.booking || '(no detectado)'}</div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Comparacion de campos */}
                                    {matchedViaje && (
                                        <div style={{ background: 'var(--bg)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' }}>
                                            <h4 style={{ fontSize: '0.875rem', fontWeight: 600, marginBottom: '1rem', color: 'var(--text-muted)' }}>Comparacion de datos</h4>

                                            {/* Booking - solo confirmacion */}
                                            <CompareField
                                                label="Booking"
                                                viajeValue={matchedViaje['Numero de booking']}
                                                blValue={blEdited.booking}
                                                onChange={(v) => setBlEdited(prev => ({...prev, booking: v}))}
                                                readOnly={true}
                                            />

                                            {/* BL - el mas importante */}
                                            <CompareField
                                                label="Numero de BL"
                                                viajeValue={matchedViaje['Numero de BL']}
                                                blValue={blEdited.bl}
                                                onChange={(v) => setBlEdited(prev => ({...prev, bl: v}))}
                                                isNew={!matchedViaje['Numero de BL'] && blEdited.bl}
                                                highlight={true}
                                            />

                                            {/* Contenedores */}
                                            <CompareField
                                                label="Contenedores"
                                                viajeValue={matchedViaje['Contenedores']}
                                                blValue={blEdited.contenedores}
                                                onChange={(v) => setBlEdited(prev => ({...prev, contenedores: v}))}
                                            />

                                            {/* Flete */}
                                            <CompareField
                                                label="Flete (USD)"
                                                viajeValue={matchedViaje['Flete']}
                                                blValue={blEdited.flete}
                                                onChange={(v) => setBlEdited(prev => ({...prev, flete: v}))}
                                                isMoney={true}
                                            />
                                        </div>
                                    )}

                                    {/* Botones */}
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <button
                                            className="btn-secondary"
                                            onClick={() => { setBlResult(null); setBlFile(null); setMatchedViaje(null); setBlEdited({}); }}
                                            style={{ flex: 1 }}
                                        >
                                            ❌ Cancelar
                                        </button>
                                        {matchedViaje && (
                                            <button className="btn-primary" onClick={openBLInModal} style={{ flex: 2 }}>
                                                📝 Editar Viaje
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const AuthPage = ({ onSuccess }) => {
            const [mode, setMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => { lucide.createIcons(); }, [mode]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);

                if (mode === 'register') {
                    const result = await SupabaseAuthService.signUp(email, password);
                    setLoading(false);
                    if (!result.success) {
                        setError(result.error);
                    } else {
                        setSuccess('Cuenta creada. Revisa tu email para confirmar, luego inicia sesion.');
                        setMode('login');
                    }
                } else {
                    const result = await SupabaseAuthService.signIn(email, password);
                    setLoading(false);
                    if (!result.success) {
                        setError(result.error);
                    } else {
                        onSuccess(result.data.user);
                    }
                }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <div className="auth-header">
                            <i data-lucide="Zap" size="40" color="var(--primary)" style={{ marginBottom: '1rem' }}></i>
                            <h1>Antigravity CRM</h1>
                            <p>{mode === 'login' ? 'Inicia sesion' : 'Crear cuenta nueva'}</p>
                        </div>
                        {error && <div className="auth-error">{error}</div>}
                        {success && <div style={{ background: 'var(--success)', color: 'white', padding: '0.75rem 1rem', borderRadius: '8px', marginBottom: '1rem', fontSize: '0.875rem' }}>{success}</div>}
                        <form className="auth-form" onSubmit={handleSubmit}>
                            <div className="auth-input-group">
                                <label>Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} required placeholder="tu@email.com" />
                            </div>
                            <div className="auth-input-group">
                                <label>Contrasena</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} required minLength={6} placeholder="Minimo 6 caracteres" />
                            </div>
                            <button type="submit" className="auth-btn" disabled={loading}>
                                {loading ? 'Cargando...' : (mode === 'login' ? 'Entrar' : 'Crear cuenta')}
                            </button>
                        </form>
                        <div className="auth-switch">
                            {mode === 'login' ? (
                                <>No tienes cuenta? <a onClick={() => { setMode('register'); setError(''); setSuccess(''); }}>Registrate</a></>
                            ) : (
                                <>Ya tienes cuenta? <a onClick={() => { setMode('login'); setError(''); }}>Entra</a></>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // HISTORIAL PAGE - Ver historial de todos los viajes
        // =====================================================
        const HistorialPage = ({ data, onEdit }) => {
            const [filtro, setFiltro] = useState('');

            // Recopilar todos los cambios de todos los viajes
            const todosLosCambios = useMemo(() => {
                const cambios = [];
                data.forEach(viaje => {
                    if (viaje.historial && viaje.historial.length > 0) {
                        viaje.historial.forEach(entry => {
                            cambios.push({
                                ...entry,
                                tripId: viaje.tripId,
                                viajeNombre: viaje.Nombre || viaje['Numero de booking'] || 'Sin nombre',
                                viaje: viaje
                            });
                        });
                    }
                });
                // Ordenar por fecha (más reciente primero)
                cambios.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                return cambios;
            }, [data]);

            // Filtrar por nombre de viaje
            const cambiosFiltrados = useMemo(() => {
                if (!filtro.trim()) return todosLosCambios;
                const f = filtro.toLowerCase();
                return todosLosCambios.filter(c => c.viajeNombre.toLowerCase().includes(f));
            }, [todosLosCambios, filtro]);

            useEffect(() => { lucide.createIcons(); }, [cambiosFiltrados]);

            return (
                <div style={{ animation: 'fadeIn 0.3s' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Historial de Cambios</h2>
                        <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                            <span style={{ fontSize: '0.875rem', color: 'var(--text-muted)' }}>{cambiosFiltrados.length} cambios</span>
                        </div>
                    </div>

                    {/* Buscador */}
                    <div className="table-card" style={{ marginBottom: '1rem', padding: '1rem' }}>
                        <div style={{ position: 'relative' }}>
                            <i data-lucide="Search" size="18" style={{ position: 'absolute', left: '0.75rem', top: '50%', transform: 'translateY(-50%)', color: 'var(--text-muted)' }}></i>
                            <input
                                type="text"
                                placeholder="Buscar por nombre de viaje..."
                                value={filtro}
                                onChange={e => setFiltro(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem 1rem 0.75rem 2.5rem',
                                    border: '1px solid var(--border)',
                                    borderRadius: '8px',
                                    fontSize: '0.875rem'
                                }}
                            />
                        </div>
                    </div>

                    {/* Lista de cambios */}
                    <div className="table-card" style={{ padding: '1rem' }}>
                        {cambiosFiltrados.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' }}>
                                <i data-lucide="History" size="48" style={{ opacity: 0.3, marginBottom: '1rem' }}></i>
                                <p style={{ margin: 0 }}>No hay cambios registrados todavia.</p>
                                <p style={{ margin: '0.5rem 0 0', fontSize: '0.8125rem' }}>Los cambios se registraran cuando modifiques viajes.</p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                {cambiosFiltrados.map((entry, idx) => {
                                    const { fecha, hora } = formatHistorialDate(entry.fecha);
                                    const numCambios = Object.keys(entry.cambios || {}).length;
                                    return (
                                        <div key={entry.id || idx} style={{
                                            background: 'var(--bg-secondary)',
                                            border: '1px solid var(--border)',
                                            borderRadius: '10px',
                                            padding: '1rem',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s'
                                        }}
                                        onClick={() => onEdit(entry.viaje)}
                                        onMouseOver={e => e.currentTarget.style.borderColor = 'var(--primary)'}
                                        onMouseOut={e => e.currentTarget.style.borderColor = 'var(--border)'}
                                        >
                                            {/* Header */}
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.75rem' }}>
                                                <div>
                                                    <div style={{ fontWeight: 600, fontSize: '0.9375rem', marginBottom: '0.25rem' }}>
                                                        {entry.viajeNombre}
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <span style={{
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            gap: '0.375rem',
                                                            padding: '0.125rem 0.5rem',
                                                            background: entry.accion === 'Creado' ? '#dcfce7' : entry.accion === 'Documento subido' ? '#dbeafe' : entry.accion === 'Documento eliminado' ? '#fee2e2' : '#fef3c7',
                                                            color: entry.accion === 'Creado' ? '#166534' : entry.accion === 'Documento subido' ? '#1e40af' : entry.accion === 'Documento eliminado' ? '#dc2626' : '#92400e',
                                                            borderRadius: '9999px',
                                                            fontSize: '0.6875rem',
                                                            fontWeight: 600
                                                        }}>
                                                            <i data-lucide={entry.accion === 'Creado' ? 'Plus' : entry.accion === 'Documento subido' ? 'Upload' : entry.accion === 'Documento eliminado' ? 'Trash2' : 'Edit2'} size="10"></i>
                                                            {entry.accion}
                                                        </span>
                                                        <span style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                                            por {entry.usuario || 'Usuario'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style={{ textAlign: 'right', fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                                    <div style={{ fontWeight: 500 }}>{fecha}</div>
                                                    <div>{hora}</div>
                                                </div>
                                            </div>

                                            {/* Lista de campos modificados */}
                                            {numCambios > 0 && (
                                                <div style={{
                                                    background: 'white',
                                                    borderRadius: '6px',
                                                    padding: '0.75rem',
                                                    fontSize: '0.8125rem'
                                                }}>
                                                    {Object.entries(entry.cambios).slice(0, 3).map(([campo, valores]) => (
                                                        <div key={campo} style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            padding: '0.25rem 0',
                                                            borderBottom: '1px solid var(--border)'
                                                        }}>
                                                            <span style={{ fontWeight: 600, minWidth: '100px', color: 'var(--text)' }}>
                                                                {FIELD_LABELS[campo] || campo}:
                                                            </span>
                                                            <div style={{ flex: 1, marginLeft: '0.5rem' }}>
                                                                {valores.antes && (
                                                                    <span style={{ textDecoration: 'line-through', color: '#dc2626', marginRight: '0.5rem' }}>
                                                                        {formatChangeValue(campo, valores.antes)}
                                                                    </span>
                                                                )}
                                                                <span style={{ color: '#16a34a' }}>{formatChangeValue(campo, valores.despues)}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {Object.keys(entry.cambios).length > 3 && (
                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem' }}>
                                                            +{Object.keys(entry.cambios).length - 3} campos mas...
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // =====================================================
        // MAIN APP
        // =====================================================
        const App = () => {
            // Entrar directo sin contraseña
            const [appState, setAppState] = useState('loading');
            const [user, setUser] = useState(null);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState('dashboard');
            const [syncing, setSyncing] = useState(false);
            const [syncMsg, setSyncMsg] = useState('');
            const [editing, setEditing] = useState(null);
            const [isNew, setIsNew] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [theme, setTheme] = useState(() => localStorage.getItem('antigravity_theme') || 'light');
            // Estado para migración de datos a Supabase
            const [migrating, setMigrating] = useState(false);
            // Referencia para evitar migraciones concurrentes de PDFs
            const migratingRef = useRef(false);
            // Inicializar con el mes en curso
            const [startDate, setStartDate] = useState(() => {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), 1);
            });
            const [endDate, setEndDate] = useState(() => {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth() + 1, 0);
            });

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('antigravity_theme', theme);
            }, [theme]);

            const handleDateChange = (start, end) => { setStartDate(start); setEndDate(end); };

            const filteredData = useMemo(() => {
                if (!startDate || !endDate) return data;
                return data.filter(v => {
                    const fecha = robustParseDate(v.Fecha);
                    if (!fecha) return true;
                    return fecha >= startDate && fecha <= endDate;
                });
            }, [data, startDate, endDate]);

            const notifications = useMemo(() => NotificationService.generate(filteredData), [filteredData]);
            const summary = useMemo(() => NotificationService.getSummary(filteredData), [filteredData]);

            useEffect(() => {
                const init = async () => {
                    try {
                        // Esperar a que Supabase esté listo antes de cargar datos
                        const supabaseReady = await waitForSupabase();
                        if (supabaseReady) {
                            setSupabaseConnected(true);

                            // Verificar si hay sesión activa
                            const currentUser = await SupabaseAuthService.getCurrentUser();
                            if (currentUser) {
                                // Cargar perfil del usuario
                                const profile = await ProfileService.getProfile(currentUser.id);
                                setUser({ ...currentUser, profile });

                                // Cargar datos (con skeleton)
                                await loadData(true);
                                setAppState('app');
                            } else {
                                setAppState('auth');
                            }
                        } else {
                            console.warn('⚠️ Supabase no disponible, mostrando login');
                            setSupabaseConnected(false);
                            setAppState('auth');
                        }
                    } catch (error) {
                        console.error('Error durante inicialización:', error);
                        setAppState('auth');
                    }
                };

                init();
            }, []);

            const loadData = async (showLoading = false) => {
                // Mostrar skeleton solo en carga inicial, no en polling
                if (showLoading) setLoading(true);
                try {
                    // Cargar datos (Supabase primero, localStorage como respaldo)
                    const d = await DatabaseService.getViajes();
                    const viajes = d.map(v => ({ ...v, tripId: v.tripId || generateUUID() }));
                    setData(viajes);
                    // Migración automática de PDFs base64 a Storage (silenciosa, una sola vez)
                    if (!migratingRef.current) {
                        const pendingDocs = await DatabaseService.countDocsToMigrate();
                        if (pendingDocs > 0) {
                            migratingRef.current = true;
                            DatabaseService.migrateBase64ToStorage().then(result => {
                                migratingRef.current = false;
                                if (result.success) {
                                    loadData(); // Recargar datos después de migrar
                                }
                            }).catch(err => {
                                migratingRef.current = false;
                                console.error('Error en migración automática de PDFs:', err);
                            });
                        }
                    }
                } finally {
                    if (showLoading) setLoading(false);
                }
            };

            // Polling de respaldo: sincronizar periódicamente por si Realtime falla
            useEffect(() => {
                if (appState !== 'app') return;

                const interval = setInterval(() => loadData(), CONFIG.DELAYS.SYNC_INTERVAL);

                return () => clearInterval(interval);
            }, [appState]);

            // Migrar datos de localStorage a Supabase
            const handleMigrate = async () => {
                if (migrating) return;

                const confirmMigrate = confirm(
                    '¿Migrar todos los datos de localStorage a Supabase?\n\n' +
                    'Esto subirá todos los viajes guardados localmente a la nube.\n' +
                    'Una vez migrados, todos los usuarios verán los mismos datos.'
                );

                if (!confirmMigrate) return;

                setMigrating(true);
                try {
                    const result = await DatabaseService.migrateToSupabase();
                    if (result.success) {
                        alert(`✅ Migración completada: ${result.count} viajes subidos a Supabase`);
                        // Recargar datos desde Supabase
                        await loadData();
                    } else {
                        alert('❌ Error en migración: ' + result.error);
                    }
                } catch (err) {
                    alert('❌ Error: ' + err.message);
                }
                setMigrating(false);
            };


            const handleSave = async (viaje) => {
                setSyncing(true); setSyncMsg('Guardando...');
                try {
                    const tripId = viaje.tripId || generateUUID();
                    const usuario = user?.email || 'local';
                    const toSave = { ...viaje, tripId, lastModified: new Date().toISOString(), modifiedBy: usuario, user_id: user?.id || null };

                    // =====================================================
                    // HISTORIAL DE CAMBIOS
                    // =====================================================
                    const originalViaje = data.find(v => v.tripId === tripId);
                    const esNuevo = !originalViaje;

                    // Inicializar historial si no existe
                    if (!toSave.historial) {
                        toSave.historial = [];
                    }

                    if (esNuevo) {
                        // Viaje nuevo: registrar creación
                        toSave.historial.push(createHistorialEntry('Creado', {}, usuario));
                    } else {
                        // Viaje existente: detectar cambios
                        const cambios = detectChanges(originalViaje, toSave);
                        if (Object.keys(cambios).length > 0) {
                            toSave.historial.push(createHistorialEntry('Modificado', cambios, usuario));
                        }
                    }

                    // Si hay un PDF pendiente de Gestión, subirlo a documentos
                    if (toSave._pendingPdfFile && toSave._pendingPdfType) {
                        const file = toSave._pendingPdfFile;
                        const docType = toSave._pendingPdfType; // 'booking' o 'bl'

                        try {
                            setSyncMsg('Subiendo documento...');
                            if (getSupabase()) {
                                const result = await StorageService.uploadFile(file, toSave.tripId, docType);
                                const docs = toSave.documentos || createEmptyDocumentos();
                                docs[docType] = {
                                    uploaded: true,
                                    fileName: file.name,
                                    uploadDate: new Date().toISOString(),
                                    storagePath: result.path,
                                    storageUrl: result.url
                                };
                                toSave.documentos = docs;
                                // Registrar subida de documento en historial
                                const docLabel = DOCUMENT_TYPES.find(d => d.id === docType)?.label || docType;
                                toSave.historial.push(createHistorialEntry('Documento subido', { [docLabel]: { antes: '', despues: file.name } }, usuario));
                            }
                        } catch (err) {
                            console.error('Error subiendo PDF a documentos:', err);
                        }

                        // Limpiar propiedades temporales
                        delete toSave._pendingPdfFile;
                        delete toSave._pendingPdfType;
                    }

                    setData(prev => { const idx = prev.findIndex(v => v.tripId === toSave.tripId); if (idx >= 0) { const upd = [...prev]; upd[idx] = toSave; return upd; } return [toSave, ...prev]; });
                    await DatabaseService.saveViaje(toSave);
                    setEditing(null); setIsNew(false);
                } catch (err) {
                    console.error('Error guardando viaje:', err);
                    alert('❌ Error al guardar: ' + err.message + '\n\nEl viaje no se guardó correctamente.');
                } finally {
                    setSyncing(false);
                }
            };

            const handleDelete = async (viaje) => {
                if (!confirm(`Eliminar "${viaje.Nombre || viaje['Numero de booking']}"?`)) return;
                setSyncing(true); setSyncMsg('Eliminando...');
                try {
                    setData(prev => prev.filter(v => v.tripId !== viaje.tripId));
                    await DatabaseService.deleteViaje(viaje.tripId);
                    setEditing(null);
                } catch (err) {
                    console.error('Error eliminando viaje:', err);
                    alert('❌ Error al eliminar: ' + err.message);
                } finally {
                    setSyncing(false);
                }
            };

            const handleImport = async (newData) => {
                setSyncing(true); setSyncMsg('Importando...');
                try {
                    setData(newData);
                    await DatabaseService.saveViajesBatch(newData);
                    alert(`✅ Importación completada: ${newData.length} viajes`);
                } catch (err) {
                    console.error('Error importando:', err);
                    alert('❌ Error al importar: ' + err.message);
                } finally {
                    setSyncing(false);
                }
            };

            // Exportar TODOS los viajes (backup completo)
            const handleExport = () => ExcelService.export(data, 'Antigravity_Viajes_COMPLETO');

            // Exportar solo los viajes filtrados por fecha
            const handleExportFiltered = () => ExcelService.export(filteredData, 'Antigravity_Viajes_Filtrado');

            const [originalViaje, setOriginalViaje] = useState(null);

            // Estado de conexión
            const [lastAutoBackup, setLastAutoBackup] = useState(() => localStorage.getItem('antigravity_last_auto_backup') || null);
            const [realtimeConnected, setRealtimeConnected] = useState(false);
            const [supabaseConnected, setSupabaseConnected] = useState(false);

            // =====================================================
            // BACKUP DIARIO - DESACTIVADO
            // Los datos ya se sincronizan a Supabase Database automáticamente
            // No es necesario un backup adicional a Storage
            // =====================================================

            const [initialTab, setInitialTab] = useState('general');
            const openNew = () => { setInitialTab('general'); setEditing({ tripId: generateUUID(), Fecha: new Date().toISOString().split('T')[0], Status: 'Programacion', documentos: createEmptyDocumentos() }); setIsNew(true); setOriginalViaje(null); };
            const openEdit = (v) => { setInitialTab('general'); setEditing({ ...v, documentos: v.documentos || createEmptyDocumentos() }); setIsNew(false); setOriginalViaje(null); };
            const openEditDocs = (v) => { setInitialTab('documentos'); setEditing({ ...v, documentos: v.documentos || createEmptyDocumentos() }); setIsNew(false); setOriginalViaje(null); };
            // Abrir modal con viaje modificado pero mostrando valores originales
            const openEditWithOriginal = (modifiedViaje, original) => { setInitialTab('general'); setEditing({ ...modifiedViaje, documentos: modifiedViaje.documentos || createEmptyDocumentos() }); setIsNew(false); setOriginalViaje(original); };

            // Funcion para abrir modal de edicion con datos del Booking PDF
            const handleOpenBookingModal = (pdfData) => {
                const newViaje = {
                    tripId: generateUUID(),
                    Fecha: pdfData.Fecha || new Date().toISOString().split('T')[0],
                    Status: 'Programacion',
                    documentos: createEmptyDocumentos(),
                    ...pdfData,
                };
                setEditing(newViaje);
                setIsNew(true);
            };

            // Funcion para actualizar viaje desde BL
            const handleUpdateViaje = async (tripId, updates) => {
                const viaje = data.find(v => v.tripId === tripId);
                if (viaje) {
                    const updated = { ...viaje, ...updates, lastModified: new Date().toISOString() };
                    await handleSave(updated);
                }
            };

            useEffect(() => { lucide.createIcons(); }, [page, appState]);

            if (appState === 'loading') return (
                <div style={{
                    position: 'fixed',
                    inset: 0,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'var(--bg)',
                    zIndex: 9999
                }}>
                    <div style={{ textAlign: 'center' }}>
                        <div style={{
                            width: 48,
                            height: 48,
                            border: '4px solid var(--border)',
                            borderTopColor: 'var(--primary)',
                            borderRadius: '50%',
                            animation: 'spin 0.8s linear infinite',
                            margin: '0 auto 1.5rem'
                        }}></div>
                        <p style={{
                            color: 'var(--text-main)',
                            fontSize: '1rem',
                            fontWeight: 500,
                            margin: 0
                        }}>Cargando...</p>
                        <p style={{
                            color: 'var(--text-muted)',
                            fontSize: '0.75rem',
                            marginTop: '0.5rem'
                        }}>Conectando con la nube</p>
                    </div>
                </div>
            );

            // Pantalla de autenticación
            if (appState === 'auth') return (
                <AuthPage
                    onSuccess={async (userData) => {
                        // Cargar perfil del usuario
                        const profile = await ProfileService.getProfile(userData.id);
                        setUser({ ...userData, profile });
                        setSupabaseConnected(true);
                        await loadData(true);
                        setAppState('app');
                    }}
                />
            );

            const titles = { dashboard: 'Inicio', viajes: 'Viajes', status: 'Estatus', calendario: 'Calendario', gestion: 'Documentos', historial: 'Historial' };

            return (
                <>
                    <Sidebar activePage={page} setPage={setPage} user={user} onLogout={async () => { await SupabaseAuthService.signOut(); setUser(null); setData([]); setAppState('auth'); }} isOnline={supabaseConnected} />
                    <div className="main-container">
                        <Header title={titles[page]} data={filteredData} notifications={notifications} onSearch={openEdit} onNotification={openEdit} theme={theme} setTheme={setTheme} startDate={startDate} endDate={endDate} onDateChange={handleDateChange} lastAutoBackup={lastAutoBackup} supabaseConnected={supabaseConnected} />
                        <div className="content-scroll">
                            {page === 'dashboard' && <DashboardPage data={filteredData} allData={data} onAdd={openNew} onEdit={openEdit} summary={summary} user={user} loading={loading} />}
                            {page === 'viajes' && <ViajesPage data={data} onEdit={openEdit} onEditDocs={openEditDocs} onDelete={handleDelete} onAdd={openNew} onExport={handleExport} onImport={() => setShowImport(true)} user={user} loading={loading} />}
                            {page === 'status' && <StatusPage data={data} onEdit={openEdit} />}
                            {page === 'calendario' && <CalendarioPage data={data} onEdit={openEdit} />}
                            {page === 'gestion' && <GestionPage onOpenBookingModal={handleOpenBookingModal} onEditViaje={openEdit} onEditViajeWithOriginal={openEditWithOriginal} allData={data} onImport={() => setShowImport(true)} onExport={handleExport} onExportFiltered={handleExportFiltered} />}
                            {page === 'historial' && <HistorialPage data={data} onEdit={openEdit} />}
                        </div>
                    </div>
                    {editing && <EditViajeModal viaje={editing} onClose={() => { setEditing(null); setIsNew(false); setOriginalViaje(null); setInitialTab('general'); }} onSave={handleSave} onDelete={handleDelete} isNew={isNew} originalViaje={originalViaje} initialTab={initialTab} user={user} />}
                    {showImport && <ImportModal onClose={() => setShowImport(false)} onImport={handleImport} existingData={data} />}
                    {syncing && <SyncIndicator message={syncMsg} />}
                    {/* Botón flotante para agregar en móvil */}
                    <button className="mobile-fab" onClick={openNew} title="Nuevo viaje">
                        <i data-lucide="Plus" size="24"></i>
                    </button>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
