<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Export CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --bg: #f8fafc;
            --sidebar-bg: #0f172a;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --text: #1e293b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --sidebar-width: 240px;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            --info: #3b82f6;
            --input-bg: #ffffff;
            --surface: #ffffff;
            --hover-bg: #f8fafc;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --sidebar-bg: #020617;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --text: #f1f5f9;
            --border: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            --input-bg: #1e293b;
            --surface: #1e293b;
            --hover-bg: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            overflow: hidden;
        }

        #root { display: flex; height: 100vh; width: 100vw; }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover, .nav-item.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: 70px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            flex-shrink: 0;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .global-search {
            position: relative;
            width: 350px;
        }

        .global-search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.875rem;
            background: #f8fafc;
            transition: all 0.2s;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .global-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .global-search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
        }

        .search-result-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .search-result-item:hover { background: #f8fafc; }
        .search-result-item:last-child { border-bottom: none; }

        .search-result-title { font-weight: 600; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .search-result-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 0.75rem; }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f8fafc;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notification-bell:hover { background: white; border-color: var(--primary); }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .notification-panel {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 380px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border);
            z-index: 1000;
            overflow: hidden;
        }

        .notification-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-list { max-height: 400px; overflow-y: auto; }

        .notification-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            gap: 0.875rem;
        }

        .notification-item:hover { background: #f8fafc; }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon.danger { background: #fef2f2; color: var(--danger); }
        .notification-icon.warning { background: #fffbeb; color: var(--warning); }
        .notification-icon.info { background: #eff6ff; color: var(--info); }

        .notification-content { flex: 1; }
        .notification-title { font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.25rem; }
        .notification-message { font-size: 0.75rem; color: var(--text-muted); }

        .notification-empty { padding: 3rem 1.5rem; text-align: center; color: var(--text-muted); }

        .content-scroll { flex: 1; overflow-y: auto; padding: 2rem; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .kpi-card:hover { box-shadow: var(--shadow); transform: translateY(-4px); border-color: var(--primary); }
        .kpi-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 500; margin-bottom: 0.5rem; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; }

        .alert-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .alert-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            border-left: 4px solid;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
        }

        .alert-card:hover { box-shadow: var(--shadow); }
        .alert-card.danger { border-left-color: var(--danger); }
        .alert-card.warning { border-left-color: var(--warning); }
        .alert-card.info { border-left-color: var(--info); }

        .alert-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .alert-card-count { font-size: 1.5rem; font-weight: 800; }
        .alert-card.danger .alert-card-count { color: var(--danger); }
        .alert-card.warning .alert-card-count { color: var(--warning); }
        .alert-card.info .alert-card-count { color: var(--info); }
        .alert-card-title { font-weight: 600; font-size: 0.8125rem; }
        .alert-card-subtitle { font-size: 0.7rem; color: var(--text-muted); }

        .alert-banner {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .alert-banner.danger {
            background: linear-gradient(90deg, #fef2f2 0%, #fee2e2 100%);
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .table-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        th { background: #f8fafc; padding: 0.875rem 1rem; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap; }
        td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }

        .badge { padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.6875rem; font-weight: 600; white-space: nowrap; }
        .bg-blue { background: #dbeafe; color: #1e40af; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-orange { background: #ffedd5; color: #9a3412; }
        .bg-red { background: #fef2f2; color: #dc2626; }
        .bg-gray { background: #f1f5f9; color: #475569; }
        .bg-purple { background: #f3e8ff; color: #7c3aed; }
        .bg-cyan { background: #ecfeff; color: #0e7490; }

        .btn-primary { background: var(--primary); color: white; padding: 0.625rem 1.25rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: var(--hover-bg); color: var(--text-main); padding: 0.625rem 1.25rem; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-secondary:hover { background: var(--card-bg); border-color: var(--primary); transform: translateY(-1px); }
        .btn-danger { background: #fef2f2; color: #dc2626; padding: 0.625rem 1.25rem; border-radius: 8px; border: 1px solid #fecaca; font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-danger:hover { background: #fee2e2; transform: translateY(-1px); }
        .btn-success { background: var(--success); color: white; padding: 0.625rem 1.25rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-success:hover { background: #16a34a; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            animation: fadeInOverlay 0.2s ease;
        }

        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }

        .modal-card {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUpModal 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUpModal { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 { font-size: 1.125rem; font-weight: 700; }
        .modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background: #fafafa;
        }

        /* Form */
        .form-section { margin-bottom: 2rem; }
        .form-section-title {
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .form-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.375rem; }
        .form-group.span-2 { grid-column: span 2; }
        .form-group.span-3 { grid-column: span 3; }
        .form-group label { font-size: 0.6875rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea {
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--input-bg);
            color: var(--text-main);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-group textarea { resize: vertical; min-height: 80px; }

        /* Estilos para campos con error */
        .form-group.has-error input, .form-group.has-error select {
            border-color: #dc2626;
            background: #fef2f2;
        }
        .form-group.has-error input:focus, .form-group.has-error select:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        .form-error {
            font-size: 0.6875rem;
            color: #dc2626;
            margin-top: 0.25rem;
        }
        .form-hint {
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .verde-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background: #dcfce7;
            color: #166534;
            padding: 0.5rem 0.875rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .pending-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem 0.875rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        /* Import Modal */
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .import-zone:hover { border-color: var(--primary); background: #faf5ff; }
        .import-zone.dragging { border-color: var(--primary); background: #f0f9ff; }

        .import-preview { margin-top: 1.5rem; }
        .import-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .import-stat { background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center; }
        .import-stat-value { font-size: 1.5rem; font-weight: 800; }
        .import-stat-label { font-size: 0.75rem; color: var(--text-muted); }

        /* Calendar */
        .apple-calendar { background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .cal-day-label { padding: 0.75rem; text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); background: #f8fafc; border-bottom: 1px solid var(--border); }
        .cal-cell { min-height: 100px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0.5rem; }
        .cal-cell:nth-child(7n) { border-right: none; }
        .cal-num { font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.375rem; display: inline-flex; width: 24px; height: 24px; align-items: center; justify-content: center; border-radius: 50%; }
        .cal-num.today { background: var(--primary); color: white; }
        .evt { padding: 0.15rem 0.35rem; border-radius: 4px; font-size: 0.6rem; font-weight: 600; margin-bottom: 0.125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .evt-fecha { background: #f0fdf4; color: #16a34a; border-left: 2px solid #16a34a; }
        .evt-embarque { background: #eff6ff; color: #3b82f6; border-left: 2px solid #3b82f6; }
        .evt-arribo { background: #fff7ed; color: #f97316; border-left: 2px solid #f97316; }

        /* Connection */
        .connection-badge { display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .connection-badge.online { background: #dcfce7; color: #166534; }
        .connection-badge.offline { background: #fef3c7; color: #92400e; }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .connection-badge.online .connection-dot { background: #22c55e; }
        .connection-badge.offline .connection-dot { background: #f59e0b; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .sync-indicator { position: fixed; bottom: 20px; right: 20px; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 0.75rem; z-index: 9999; }
        .sync-spinner { width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--hover-bg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--card-bg); border-color: var(--primary); }

        /* Dark mode table */
        [data-theme="dark"] th { background: #1e293b; }
        [data-theme="dark"] tr:hover { background-color: #334155; }
        [data-theme="dark"] .global-search-input { background: #1e293b; color: var(--text-main); }
        [data-theme="dark"] .global-search-input:focus { background: #1e293b; }
        [data-theme="dark"] .modal-footer { background: #0f172a; }
        [data-theme="dark"] .flatpickr-calendar { background: #1e293b; border-color: #334155; }
        [data-theme="dark"] .flatpickr-day { color: #f1f5f9; }
        [data-theme="dark"] .flatpickr-day:hover { background: #334155; }

        /* Date Range Picker */
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--hover-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .date-range-picker:hover { border-color: var(--primary); background: var(--card-bg); }
        .date-range-text { font-size: 0.8125rem; font-weight: 500; color: var(--text-main); }

        /* Kanban Board */
        .kanban-board { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .kanban-column {
            min-width: 280px;
            max-width: 320px;
            background: var(--hover-bg);
            border-radius: var(--radius);
            padding: 1rem;
            flex-shrink: 0;
        }
        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        .kanban-title { font-weight: 700; font-size: 0.875rem; }
        .kanban-count {
            background: var(--card-bg);
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .kanban-cards { display: flex; flex-direction: column; gap: 0.75rem; }
        .kanban-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .kanban-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); border-color: var(--primary); }
        .kanban-card-title { font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .kanban-card-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 0.25rem; }

        /* PDF Upload */
        .pdf-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--hover-bg);
        }
        .pdf-upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .pdf-upload-zone.dragging { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .pdf-result { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1.5rem; margin-top: 1rem; }
        .pdf-result-value { font-size: 2rem; font-weight: 800; color: var(--success); }

        /* Document Checklist */
        .doc-card {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s;
            background: var(--card-bg);
        }
        .doc-card.uploaded {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }
        .doc-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        .doc-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .doc-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--hover-bg);
        }
        .doc-card.uploaded .doc-card-icon {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }
        .doc-card-title {
            font-weight: 600;
            font-size: 0.8125rem;
            flex: 1;
        }
        .doc-card-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .doc-card.uploaded .doc-card-status {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .doc-upload-mini {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: all 0.2s;
            min-height: 60px;
        }
        .doc-upload-mini:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .doc-file-info {
            background: var(--hover-bg);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }
        .doc-file-name {
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        .doc-file-date {
            color: var(--text-muted);
            font-size: 0.6875rem;
        }
        .doc-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        .doc-action-btn {
            padding: 0.375rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .doc-action-btn.view { background: #eff6ff; color: var(--info); }
        .doc-action-btn.view:hover { background: #dbeafe; }
        .doc-action-btn.download { background: #f0fdf4; color: var(--success); }
        .doc-action-btn.download:hover { background: #dcfce7; }
        .doc-action-btn.delete { background: #fef2f2; color: var(--danger); }
        .doc-action-btn.delete:hover { background: #fee2e2; }
        .docs-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .docs-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .docs-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Auth */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .auth-card { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 400px; }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h1 { font-family: 'Outfit'; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .auth-header p { color: var(--text-muted); font-size: 0.875rem; }
        .auth-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-input-group { display: flex; flex-direction: column; gap: 0.375rem; }
        .auth-input-group label { font-size: 0.75rem; font-weight: 600; }
        .auth-input-group input { padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 10px; font-size: 0.875rem; }
        .auth-btn { background: var(--primary); color: white; padding: 0.875rem; border: none; border-radius: 10px; font-size: 0.9375rem; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
        .auth-btn:hover { background: var(--primary-light); }
        .auth-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .auth-switch { text-align: center; margin-top: 1.5rem; font-size: 0.8125rem; color: var(--text-muted); }
        .auth-switch a { color: var(--primary); font-weight: 600; cursor: pointer; }
        .auth-error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem; border-radius: 8px; font-size: 0.8125rem; text-align: center; margin-bottom: 1rem; }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .sidebar { width: 70px; padding: 1rem 0.5rem; }
            .sidebar .logo span, .sidebar .nav-item span, .sidebar .connection-badge span { display: none; }
            .sidebar .logo, .sidebar .nav-item { justify-content: center; }
            .global-search { width: 250px; }
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            .form-group.span-3 { grid-column: span 2; }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            /* Layout principal */
            .app-layout { flex-direction: column; }

            /* Sidebar como barra inferior */
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: 100%;
                height: 60px;
                flex-direction: row;
                padding: 0;
                border-right: none;
                border-top: 1px solid var(--border);
                z-index: 1000;
                justify-content: space-around;
            }
            .sidebar .logo { display: none; }
            .sidebar nav {
                display: flex;
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
                padding: 0;
                gap: 0;
            }
            .sidebar .nav-item {
                flex-direction: column;
                padding: 0.5rem;
                gap: 0.25rem;
                font-size: 0.625rem;
                border-radius: 0;
                flex: 1;
                justify-content: center;
            }
            .sidebar .nav-item span { display: block; font-size: 0.5625rem; }
            .sidebar .nav-item i { width: 20px; height: 20px; }
            .sidebar .connection-badge { display: none; }

            /* Main content */
            .main-content {
                margin-left: 0;
                padding-bottom: 70px; /* Espacio para barra inferior */
            }

            /* Header */
            .header {
                padding: 0.75rem 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .header h1 { font-size: 1.125rem; }
            .global-search { display: none; }
            .header-actions {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            .header-actions .btn-primary,
            .header-actions .btn-secondary {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            .header-actions .btn-primary span,
            .header-actions .btn-secondary span { display: none; }

            /* Content scroll */
            .content-scroll { padding: 1rem; }

            /* Dashboard */
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .kpi-card { padding: 1rem; }
            .kpi-value { font-size: 1.25rem; }
            .kpi-label { font-size: 0.6875rem; }
            .alert-cards-grid { grid-template-columns: 1fr; }

            /* Tablas */
            .table-container {
                overflow-x: auto;
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            table { min-width: 600px; font-size: 0.75rem; }
            th, td { padding: 0.5rem 0.75rem; }

            /* Forms */
            .form-grid, .form-grid-2 { grid-template-columns: 1fr; }
            .form-group.span-2, .form-group.span-3 { grid-column: span 1; }

            /* Modal */
            .modal-overlay { padding: 0; align-items: flex-end; }
            .modal-card {
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }
            .modal-header { padding: 1rem; }
            .modal-header h3 { font-size: 1rem; }
            .modal-body { padding: 1rem; }
            .modal-footer {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }
            .modal-footer > div {
                width: 100%;
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }

            /* Tabs del modal */
            .modal-card > div:nth-child(2) {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .modal-card > div:nth-child(2) button {
                padding: 0.75rem 1rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            /* Documentos grid */
            .docs-grid { grid-template-columns: 1fr !important; }
            .doc-card { padding: 0.75rem; }

            /* Notifications */
            .notification-panel {
                width: calc(100vw - 2rem);
                right: -1rem;
                max-height: 60vh;
            }

            /* Import stats */
            .import-stats { grid-template-columns: 1fr; }

            /* Kanban */
            .kanban-board {
                flex-direction: column;
                gap: 1rem;
            }
            .kanban-column {
                min-width: 100%;
                max-height: 300px;
            }

            /* Calendar */
            .fc { font-size: 0.75rem; }
            .fc-toolbar { flex-direction: column; gap: 0.5rem; }
            .fc-toolbar-title { font-size: 1rem !important; }
        }

        /* Extra small phones */
        @media (max-width: 480px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .kpi-card { padding: 0.875rem; }
            .header h1 { font-size: 1rem; }
            .header-actions .btn-primary,
            .header-actions .btn-secondary {
                padding: 0.4rem 0.6rem;
            }
            table { min-width: 500px; font-size: 0.6875rem; }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =====================================================
        // AUTHENTICATION SYSTEM
        // =====================================================
        // Hash simple para ofuscar la contrase√±a (no es criptogr√°ficamente seguro, pero dificulta el acceso casual)
        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        };

        // CAMBIA ESTE VALOR PARA ESTABLECER TU CONTRASE√ëA
        // Para generar un nuevo hash, abre la consola del navegador y ejecuta: simpleHash("tuContrase√±a")
        const AUTH_PASSWORD_HASH = '-d2jfvz';  // Hash de "antigravity2024"
        const AUTH_SESSION_KEY = 'antigravity_auth_session';
        const AUTH_SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 horas en milisegundos

        const AuthService = {
            // Verificar si hay sesi√≥n v√°lida
            isAuthenticated() {
                try {
                    const session = localStorage.getItem(AUTH_SESSION_KEY);
                    if (!session) return false;
                    const { timestamp } = JSON.parse(session);
                    const now = Date.now();
                    // Sesi√≥n v√°lida por 24 horas
                    if (now - timestamp > AUTH_SESSION_DURATION) {
                        this.logout();
                        return false;
                    }
                    return true;
                } catch {
                    return false;
                }
            },

            // Intentar login
            login(password) {
                const inputHash = simpleHash(password);
                if (inputHash === AUTH_PASSWORD_HASH) {
                    localStorage.setItem(AUTH_SESSION_KEY, JSON.stringify({
                        timestamp: Date.now()
                    }));
                    return true;
                }
                return false;
            },

            // Cerrar sesi√≥n
            logout() {
                localStorage.removeItem(AUTH_SESSION_KEY);
            }
        };

        // Componente de Login
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                // Peque√±o delay para efecto visual
                setTimeout(() => {
                    if (AuthService.login(password)) {
                        onLogin();
                    } else {
                        setError('Contrase√±a incorrecta');
                        setPassword('');
                    }
                    setLoading(false);
                }, 500);
            };

            return (
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%)',
                    padding: '1rem'
                }}>
                    <div style={{
                        background: 'white',
                        borderRadius: '20px',
                        padding: '2.5rem',
                        width: '100%',
                        maxWidth: '400px',
                        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.4)'
                    }}>
                        <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                            <div style={{
                                fontSize: '3rem',
                                marginBottom: '0.5rem'
                            }}>üöÄ</div>
                            <h1 style={{
                                fontSize: '1.5rem',
                                fontWeight: '700',
                                color: '#1e1b4b',
                                marginBottom: '0.5rem'
                            }}>Antigravity CRM</h1>
                            <p style={{ color: '#64748b', fontSize: '0.875rem' }}>
                                Ingresa la contrase√±a para continuar
                            </p>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{ marginBottom: '1.5rem' }}>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Contrase√±a"
                                    style={{
                                        width: '100%',
                                        padding: '0.875rem 1rem',
                                        fontSize: '1rem',
                                        border: error ? '2px solid #ef4444' : '2px solid #e2e8f0',
                                        borderRadius: '10px',
                                        outline: 'none',
                                        transition: 'border-color 0.2s',
                                        boxSizing: 'border-box'
                                    }}
                                    onFocus={(e) => e.target.style.borderColor = '#6366f1'}
                                    onBlur={(e) => e.target.style.borderColor = error ? '#ef4444' : '#e2e8f0'}
                                    autoFocus
                                    disabled={loading}
                                />
                                {error && (
                                    <p style={{
                                        color: '#ef4444',
                                        fontSize: '0.875rem',
                                        marginTop: '0.5rem',
                                        textAlign: 'center'
                                    }}>{error}</p>
                                )}
                            </div>

                            <button
                                type="submit"
                                disabled={loading || !password}
                                style={{
                                    width: '100%',
                                    padding: '0.875rem',
                                    fontSize: '1rem',
                                    fontWeight: '600',
                                    color: 'white',
                                    background: loading || !password ? '#94a3b8' : 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: loading || !password ? 'not-allowed' : 'pointer',
                                    transition: 'transform 0.1s, box-shadow 0.2s',
                                    boxShadow: '0 4px 14px rgba(99, 102, 241, 0.4)'
                                }}
                                onMouseOver={(e) => { if (!loading && password) e.target.style.transform = 'translateY(-1px)'; }}
                                onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                            >
                                {loading ? 'Verificando...' : 'Entrar'}
                            </button>
                        </form>

                        <p style={{
                            textAlign: 'center',
                            color: '#94a3b8',
                            fontSize: '0.75rem',
                            marginTop: '2rem'
                        }}>
                            Sistema protegido ‚Ä¢ Solo personal autorizado
                        </p>
                    </div>
                </div>
            );
        };

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://cteczvfjnkhipbvbwlmx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZWN6dmZqbmtoaXBidmJ3bG14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODk1NDQsImV4cCI6MjA4NDY2NTU0NH0.sWGm3uRwQv3eioPZFPtkb2GaTvHoRBsZFx44OYzIIrY';
        const isSupabaseConfigured = SUPABASE_URL !== 'TU_SUPABASE_URL_AQUI' && SUPABASE_ANON_KEY !== 'TU_SUPABASE_ANON_KEY_AQUI';

        // Google Sheets API
        const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbx1aUh14E_nJyBMX-I-rKnl7tXbMW3STh1zoJ8SeXgacUal403bIYUwR9CpyEW23DcM/exec';

        // Cliente de Supabase - se inicializa bajo demanda
        let _supabaseClient = null;

        // Funci√≥n getter que SIEMPRE devuelve el cliente actualizado
        const getSupabase = () => {
            // Si ya existe, devolverlo
            if (_supabaseClient) return _supabaseClient;

            // Verificar configuraci√≥n
            if (!isSupabaseConfigured) {
                console.log('‚ö†Ô∏è Supabase: URLs no configuradas');
                return null;
            }

            // Verificar si la librer√≠a est√° cargada
            if (!window.supabase) {
                console.log('‚ö†Ô∏è Supabase: Librer√≠a no cargada todav√≠a');
                return null;
            }

            // Crear el cliente
            try {
                _supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase cliente creado correctamente');
                return _supabaseClient;
            } catch (err) {
                console.error('‚ùå Error creando cliente Supabase:', err);
                return null;
            }
        };

        // Alias para compatibilidad (getter din√°mico)
        Object.defineProperty(window, 'supabaseClient', { get: getSupabase });

        // =====================================================
        // GOOGLE SHEETS SERVICE (con manejo de CORS para Google Apps Script)
        // =====================================================
        // Callback global para JSONP
        window.sheetsCallback = null;

        const GoogleSheetsService = {
            isConfigured: Boolean(GOOGLE_SHEETS_API && GOOGLE_SHEETS_API.includes('script.google.com')),

            // Hacer fetch con JSONP (puede recibir datos desde file://)
            fetchJSONP(url) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'sheetsCallback_' + Date.now();
                    const timeout = setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('Timeout'));
                    }, 15000);

                    window[callbackName] = (data) => {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        if (script.parentNode) script.parentNode.removeChild(script);
                        resolve(data);
                    };

                    const script = document.createElement('script');
                    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                    script.onerror = () => {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        reject(new Error('Error de red'));
                    };
                    document.body.appendChild(script);
                });
            },

            // Hacer fetch silencioso para enviar datos (sin esperar respuesta)
            async fetchGAS(url) {
                // Usar iframe oculto para enviar sin problemas de CORS
                return new Promise((resolve) => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = url;
                    document.body.appendChild(iframe);

                    // Limpiar despu√©s de 4 segundos (m√°s tiempo para Google)
                    setTimeout(() => {
                        if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
                        resolve({ success: true });
                    }, 4000);
                });
            },

            // Enviar datos por POST usando fetch (m√©todo que funcion√≥ para 54 viajes)
            async postToGAS(action, data) {
                try {
                    await fetch(GOOGLE_SHEETS_API, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, data })
                    });
                    // Esperar a que Google procese
                    await new Promise(r => setTimeout(r, 5000));
                    return { success: true };
                } catch (err) {
                    console.error('POST error:', err);
                    return { success: false, error: err.message };
                }
            },

            // Leer datos usando JSONP (funciona desde file://)
            async getViajesJSONP() {
                if (!this.isConfigured) return null;
                try {
                    const result = await this.fetchJSONP(GOOGLE_SHEETS_API + '?action=get&t=' + Date.now());
                    if (result.success) {
                        console.log('‚úÖ Sheets JSONP: Cargados', result.data?.length || 0, 'viajes');
                        return result.data || [];
                    }
                    console.error('‚ùå Sheets JSONP error:', result.error);
                    return null;
                } catch (err) {
                    console.error('‚ùå Sheets JSONP error:', err.message);
                    return null;
                }
            },

            // Probar conexi√≥n con Google Sheets
            async testConnection() {
                if (!this.isConfigured) {
                    return { success: false, error: 'Google Sheets API no configurada' };
                }
                try {
                    const result = await this.fetchGAS(GOOGLE_SHEETS_API + '?action=get&t=' + Date.now());
                    return result;
                } catch (err) {
                    return { success: false, error: err.message };
                }
            },

            // Leer todos los viajes de Google Sheets
            async getViajes() {
                if (!this.isConfigured) return null;
                try {
                    const result = await this.fetchGAS(GOOGLE_SHEETS_API + '?action=get&t=' + Date.now());
                    if (result.success) {
                        console.log('‚úÖ Sheets: Cargados', result.data?.length || 0, 'viajes');
                        return result.data || [];
                    }
                    console.error('‚ùå Sheets error:', result.error);
                    return null;
                } catch (err) {
                    console.error('‚ùå Sheets conexi√≥n:', err.message);
                    return null;
                }
            },

            // Campos que son fechas
            DATE_FIELDS: ['Fecha', 'Fecha de embarque', 'Fecha de arribo', 'SI', 'Cut off'],

            // Convertir fecha ISO (YYYY-MM-DD) a texto DD/MM/YYYY para evitar auto-conversi√≥n de Google Sheets
            formatDateForSheets(dateValue) {
                if (!dateValue || dateValue === 'Verde') return dateValue;

                const str = String(dateValue);
                // Detectar formato ISO: YYYY-MM-DD
                const isoMatch = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (isoMatch) {
                    const [, year, month, day] = isoMatch;
                    // Retornar como DD/MM/YYYY (formato texto que Sheets no auto-convierte)
                    return `${day}/${month}/${year}`;
                }
                // Si ya est√° en otro formato, retornar tal cual
                return str;
            },

            // Limpiar viaje para enviar (sin base64, sin funciones, campos truncados)
            cleanViajeForSheets(viaje) {
                const clean = {};
                EXPORT_COLUMNS.forEach(field => {
                    if (viaje[field] !== undefined && viaje[field] !== null && viaje[field] !== '') {
                        let value = String(viaje[field]);

                        // Formatear fechas para evitar problemas de timezone en Google Sheets
                        if (this.DATE_FIELDS.includes(field)) {
                            value = this.formatDateForSheets(value);
                        }

                        // Truncar campos muy largos para evitar URL demasiado larga
                        if (value.length > 500) {
                            value = value.substring(0, 500) + '...';
                        }
                        clean[field] = value;
                    }
                });
                return clean;
            },

            // Guardar un viaje en Google Sheets usando GET con par√°metros
            async saveViaje(viaje) {
                if (!this.isConfigured) return false;
                try {
                    const cleanViaje = this.cleanViajeForSheets(viaje);
                    const dataParam = encodeURIComponent(JSON.stringify(cleanViaje));
                    const url = GOOGLE_SHEETS_API + '?action=save&data=' + dataParam + '&t=' + Date.now();

                    // Verificar si la URL es demasiado larga (l√≠mite ~8000 caracteres)
                    if (url.length > 7500) {
                        console.error('‚ö†Ô∏è URL muy larga para:', cleanViaje.Nombre, '- Longitud:', url.length);
                        // Intentar con datos m√≠nimos
                        const minViaje = { tripId: cleanViaje.tripId, Nombre: cleanViaje.Nombre, Status: cleanViaje.Status };
                        const minUrl = GOOGLE_SHEETS_API + '?action=save&data=' + encodeURIComponent(JSON.stringify(minViaje)) + '&t=' + Date.now();
                        await this.fetchGAS(minUrl);
                        return true;
                    }

                    await this.fetchGAS(url);
                    console.log('‚úÖ Sheets guardado:', cleanViaje.Nombre || cleanViaje.tripId);
                    return true;
                } catch (err) {
                    console.error('‚ùå Sheets save error:', err.message, viaje.Nombre);
                    return false;
                }
            },

            // Eliminar un viaje de Google Sheets
            async deleteViaje(tripId) {
                if (!this.isConfigured) return false;
                try {
                    const url = GOOGLE_SHEETS_API + '?action=delete&tripId=' + encodeURIComponent(tripId) + '&t=' + Date.now();
                    const result = await this.fetchGAS(url);

                    if (result.success) {
                        console.log('‚úÖ Sheets eliminado:', tripId);
                        return true;
                    } else {
                        console.error('‚ùå Sheets delete error:', result.error);
                        return false;
                    }
                } catch (err) {
                    console.error('‚ùå Sheets delete error:', err.message);
                    return false;
                }
            },

            // Sincronizar todos los viajes a Google Sheets usando POST
            async syncAll(viajes) {
                if (!this.isConfigured) {
                    return { success: false, error: 'Google Sheets no configurado' };
                }
                try {
                    console.log('üì§ Sincronizando', viajes.length, 'viajes a Sheets...');

                    // Limpiar todos los viajes para enviar (con fechas formateadas)
                    const cleanViajes = viajes.map(v => this.cleanViajeForSheets(v));

                    console.log('üì¶ Enviando todos los viajes por POST...');

                    // Enviar todos los viajes de una vez por POST
                    await this.postToGAS('sync', cleanViajes);

                    console.log('‚úÖ Sheets sync completado:', cleanViajes.length, 'viajes');
                    return { success: true, count: cleanViajes.length };
                } catch (err) {
                    console.error('‚ùå Sheets sync error:', err.message);
                    return { success: false, error: err.message };
                }
            },

            // Actualizar viajes SIN limpiar la hoja (para backup incremental)
            // Ideal para actualizar solo viajes activos sin borrar los cerrados
            async updateViajes(viajes) {
                if (!this.isConfigured) {
                    return { success: false, error: 'Google Sheets no configurado' };
                }
                try {
                    console.log('üì§ Actualizando', viajes.length, 'viajes en Sheets (sin borrar existentes)...');

                    // Enviar cada viaje individualmente (actualiza o crea)
                    let saved = 0;
                    for (const viaje of viajes) {
                        const success = await this.saveViaje(viaje);
                        if (success) saved++;
                        // Peque√±a pausa para no saturar la API
                        await new Promise(r => setTimeout(r, 100));
                    }

                    console.log('‚úÖ Sheets update:', saved, 'de', viajes.length, 'viajes');
                    return { success: true, count: saved };
                } catch (err) {
                    console.error('‚ùå Sheets update error:', err.message);
                    return { success: false, error: err.message };
                }
            }
        };

        // =====================================================
        // DATABASE SERVICE - SUPABASE PRIMERO, LOCALSTORAGE COMO RESPALDO
        // =====================================================
        const DatabaseService = {
            // Obtener viajes - Supabase es la fuente principal
            async getViajes() {
                const sb = getSupabase();

                // Si no hay Supabase, usar localStorage
                if (!sb) {
                    console.log('üì¶ Cargando desde localStorage (Supabase no disponible)');
                    const saved = localStorage.getItem('antigravity_crm_data');
                    return saved ? JSON.parse(saved) : [];
                }

                try {
                    console.log('‚òÅÔ∏è Cargando desde Supabase...');
                    const { data, error } = await sb.from('viajes').select('*').order('created_at', { ascending: false });
                    if (error) throw error;

                    // Guardar copia local como respaldo
                    if (data && data.length > 0) {
                        localStorage.setItem('antigravity_crm_data', JSON.stringify(data));
                        console.log('‚úÖ Supabase: Cargados', data.length, 'viajes');
                    }
                    return data || [];
                } catch (err) {
                    console.error('‚ùå Error Supabase, usando localStorage:', err.message);
                    const saved = localStorage.getItem('antigravity_crm_data');
                    return saved ? JSON.parse(saved) : [];
                }
            },

            // Guardar viaje - Guarda en Supabase primero, luego localStorage
            async saveViaje(viaje) {
                const sb = getSupabase();

                // Preparar documento para guardar (sin base64 grandes)
                const viajeParaGuardar = { ...viaje };
                if (viajeParaGuardar.documentos) {
                    const docsClean = {};
                    Object.keys(viajeParaGuardar.documentos).forEach(key => {
                        const doc = viajeParaGuardar.documentos[key];
                        docsClean[key] = {
                            uploaded: doc.uploaded || false,
                            fileName: doc.fileName || '',
                            uploadDate: doc.uploadDate || '',
                            storagePath: doc.storagePath || '',
                            storageUrl: doc.storageUrl || ''
                            // No incluir base64 - archivos est√°n en Supabase Storage
                        };
                    });
                    viajeParaGuardar.documentos = docsClean;
                }

                // Si hay Supabase, guardar ah√≠ primero
                if (sb) {
                    try {
                        const { error } = await sb.from('viajes').upsert(viajeParaGuardar, { onConflict: 'tripId' });
                        if (error) throw error;
                        console.log('‚úÖ Guardado en Supabase:', viajeParaGuardar.Nombre || viajeParaGuardar.tripId);
                    } catch (err) {
                        console.error('‚ùå Error guardando en Supabase:', err.message);
                        // Continuar para guardar en localStorage como respaldo
                    }
                }

                // Guardar tambi√©n en localStorage como respaldo
                try {
                    const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                    const idx = localData.findIndex(v => v.tripId === viajeParaGuardar.tripId);
                    if (idx >= 0) localData[idx] = viajeParaGuardar;
                    else localData.unshift(viajeParaGuardar);
                    localStorage.setItem('antigravity_crm_data', JSON.stringify(localData));
                } catch (storageErr) {
                    console.error('Error en localStorage:', storageErr);
                }

                return { success: true };
            },

            // Guardar m√∫ltiples viajes
            async saveViajesBatch(viajes) {
                const sb = getSupabase();

                // Limpiar documentos base64 para Supabase
                const viajesClean = viajes.map(v => {
                    const viaje = { ...v };
                    if (viaje.documentos) {
                        const docsClean = {};
                        Object.keys(viaje.documentos).forEach(key => {
                            const doc = viaje.documentos[key];
                            docsClean[key] = {
                                uploaded: doc.uploaded || false,
                                fileName: doc.fileName || '',
                                uploadDate: doc.uploadDate || '',
                                storagePath: doc.storagePath || '',
                                storageUrl: doc.storageUrl || ''
                            };
                        });
                        viaje.documentos = docsClean;
                    }
                    return viaje;
                });

                if (sb) {
                    try {
                        const { error } = await sb.from('viajes').upsert(viajesClean, { onConflict: 'tripId' });
                        if (error) throw error;
                        console.log('‚úÖ Batch guardado en Supabase:', viajesClean.length, 'viajes');
                    } catch (err) {
                        console.error('‚ùå Error batch Supabase:', err.message);
                    }
                }

                localStorage.setItem('antigravity_crm_data', JSON.stringify(viajesClean));
                return { success: true };
            },

            // Eliminar viaje
            async deleteViaje(tripId) {
                const sb = getSupabase();

                if (sb) {
                    try {
                        const { error } = await sb.from('viajes').delete().eq('tripId', tripId);
                        if (error) throw error;
                        console.log('‚úÖ Eliminado de Supabase:', tripId);
                    } catch (err) {
                        console.error('‚ùå Error eliminando de Supabase:', err.message);
                    }
                }

                const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                localStorage.setItem('antigravity_crm_data', JSON.stringify(localData.filter(v => v.tripId !== tripId)));
                return { success: true };
            },

            // Migrar datos de localStorage a Supabase
            async migrateToSupabase() {
                const sb = getSupabase();

                if (!sb) {
                    return { success: false, error: 'Supabase no disponible. Verifica tu conexi√≥n a internet y recarga la p√°gina.' };
                }

                const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                if (localData.length === 0) {
                    return { success: true, count: 0, message: 'No hay datos para migrar' };
                }

                console.log('üîÑ Migrando', localData.length, 'viajes a Supabase...');

                // Limpiar documentos base64
                const viajesClean = localData.map(v => {
                    const viaje = { ...v };
                    if (viaje.documentos) {
                        const docsClean = {};
                        Object.keys(viaje.documentos).forEach(key => {
                            const doc = viaje.documentos[key];
                            docsClean[key] = {
                                uploaded: doc.uploaded || false,
                                fileName: doc.fileName || '',
                                uploadDate: doc.uploadDate || '',
                                storagePath: doc.storagePath || '',
                                storageUrl: doc.storageUrl || ''
                            };
                        });
                        viaje.documentos = docsClean;
                    }
                    return viaje;
                });

                try {
                    const { error } = await sb.from('viajes').upsert(viajesClean, { onConflict: 'tripId' });
                    if (error) throw error;
                    console.log('‚úÖ Migraci√≥n completada:', viajesClean.length, 'viajes');
                    return { success: true, count: viajesClean.length };
                } catch (err) {
                    console.error('‚ùå Error en migraci√≥n:', err.message);
                    return { success: false, error: err.message };
                }
            }
        };

        // =====================================================
        // BACKUP SERVICE - Backup autom√°tico a Supabase Storage
        // =====================================================
        const BackupService = {
            BUCKET: 'backups',
            FOLDER: 'viajes',
            MAX_BACKUPS: 7,

            // Generar nombre de archivo con fecha
            getBackupFileName: () => {
                const date = new Date().toISOString().split('T')[0];
                return `backup_${date}.json`;
            },

            // Subir backup a Supabase Storage
            uploadBackup: async (viajes) => {
                const fileName = BackupService.getBackupFileName();
                const filePath = `${BackupService.FOLDER}/${fileName}`;
                const jsonData = JSON.stringify(viajes, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });

                const response = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/${BackupService.BUCKET}/${filePath}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'x-upsert': 'true'
                        },
                        body: blob
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error subiendo backup: ${errorText}`);
                }
                return { success: true, fileName };
            },

            // Listar backups existentes
            listBackups: async () => {
                const response = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/list/${BackupService.BUCKET}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prefix: BackupService.FOLDER })
                    }
                );

                if (!response.ok) return [];
                const files = await response.json();
                return files.sort((a, b) => b.name.localeCompare(a.name));
            },

            // Descargar un backup espec√≠fico
            downloadBackup: async (fileName) => {
                const filePath = `${BackupService.FOLDER}/${fileName}`;
                const response = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/public/${BackupService.BUCKET}/${filePath}`
                );

                if (!response.ok) throw new Error('Error descargando backup');
                return await response.json();
            },

            // Limpiar backups antiguos (mantener solo √∫ltimos 7)
            cleanOldBackups: async () => {
                try {
                    const backups = await BackupService.listBackups();
                    if (backups.length <= BackupService.MAX_BACKUPS) return;

                    const toDelete = backups.slice(BackupService.MAX_BACKUPS);
                    for (const file of toDelete) {
                        await fetch(
                            `${SUPABASE_URL}/storage/v1/object/${BackupService.BUCKET}/${BackupService.FOLDER}/${file.name}`,
                            {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                            }
                        );
                    }
                    console.log(`üóëÔ∏è Eliminados ${toDelete.length} backups antiguos`);
                } catch (err) {
                    console.warn('No se pudieron limpiar backups antiguos:', err);
                }
            },

            // Verificar si necesita backup (m√°s de 24 horas)
            needsBackup: () => {
                const lastBackup = localStorage.getItem('antigravity_last_auto_backup');
                if (!lastBackup) return true;

                const lastDate = new Date(lastBackup);
                const now = new Date();
                const hoursDiff = (now - lastDate) / (1000 * 60 * 60);
                return hoursDiff >= 24;
            }
        };

        // =====================================================
        // REALTIME SERVICE - Actualizaciones en tiempo real
        // =====================================================
        const RealtimeService = {
            subscription: null,

            // Iniciar escucha de cambios en tiempo real
            subscribe(onDataChange) {
                const sb = getSupabase();

                if (!sb) {
                    console.log('‚ö†Ô∏è Realtime no disponible (Supabase no conectado)');
                    return false;
                }

                console.log('üî¥ Conectando a Realtime...');

                this.subscription = sb
                    .channel('viajes-changes')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'viajes' },
                        (payload) => {
                            console.log('üì° Cambio detectado:', payload.eventType);

                            // Notificar al componente que hay cambios
                            if (onDataChange) {
                                onDataChange(payload);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Realtime conectado - Recibir√°s cambios en tiempo real');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('‚ùå Error conectando a Realtime');
                        }
                    });

                return true;
            },

            // Detener escucha
            unsubscribe() {
                const sb = getSupabase();
                if (this.subscription && sb) {
                    sb.removeChannel(this.subscription);
                    this.subscription = null;
                    console.log('üî¥ Realtime desconectado');
                }
            }
        };

        // =====================================================
        // SUPABASE AUTH SERVICE (no usado actualmente)
        // =====================================================
        const SupabaseAuthService = {
            async getCurrentUser() {
                const sb = getSupabase();
                if (!sb) return null;
                try { const { data: { user } } = await sb.auth.getUser(); return user; }
                catch { return null; }
            },
            async signIn(email, password) {
                const sb = getSupabase();
                if (!sb) return { success: false, error: 'No configurado' };
                try {
                    const { data, error } = await sb.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    return { success: true, data };
                } catch (err) { return { success: false, error: err.message }; }
            },
            async signUp(email, password) {
                const sb = getSupabase();
                if (!sb) return { success: false, error: 'No configurado' };
                try {
                    const { data, error } = await sb.auth.signUp({ email, password });
                    if (error) throw error;
                    return { success: true, data };
                } catch (err) { return { success: false, error: err.message }; }
            },
            async signOut() {
                const sb = getSupabase();
                if (!sb) return { success: true };
                await sb.auth.signOut();
                return { success: true };
            },
            onAuthStateChange(callback) {
                const sb = getSupabase();
                if (!sb) return () => {};
                const { data: { subscription } } = sb.auth.onAuthStateChange(callback);
                return () => subscription.unsubscribe();
            }
        };

        // =====================================================
        // HELPERS
        // =====================================================
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val || 0);
        const formatNumber = (val) => new Intl.NumberFormat('es-MX').format(val || 0);
        const formatUSD = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
        const formatPercent = (val) => ((Number(val) || 0) * 100).toFixed(2) + '%';
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // =====================================================
        // DOCUMENT TYPES - Checklist de documentos por viaje
        // =====================================================
        const DOCUMENT_TYPES = [
            { id: 'booking', label: 'Booking', icon: 'FileText' },
            { id: 'bl', label: 'BL', icon: 'Ship' },
            { id: 'analisis', label: 'An√°lisis', icon: 'FileSearch' },
            { id: 'packing', label: 'Packing List', icon: 'Package' },
            { id: 'anticipo', label: 'Comprobante de Anticipo', icon: 'Receipt' },
            { id: 'analisisCliente', label: 'An√°lisis Cliente', icon: 'ClipboardCheck' },
            { id: 'factura', label: 'Factura', icon: 'FileText' },
            { id: 'facturaPreliminar', label: 'Factura Preliminar', icon: 'FileClock' }
        ];

        const createEmptyDocumentos = () => {
            const docs = {};
            DOCUMENT_TYPES.forEach(dt => {
                docs[dt.id] = { uploaded: false, fileName: '', uploadDate: '', storagePath: '', storageUrl: '' };
            });
            return docs;
        };

        const countUploadedDocs = (documentos) => {
            if (!documentos) return 0;
            return Object.values(documentos).filter(d => d && d.uploaded).length;
        };

        const getDocsColor = (count) => {
            if (count === 0) return 'var(--text-muted)';
            if (count <= 3) return 'var(--danger)';
            if (count <= 5) return 'var(--warning)';
            if (count <= 7) return 'var(--info)';
            return 'var(--success)'; // 8 = completo
        };

        // =====================================================
        // SUPABASE STORAGE - Usando fetch directo (funciona sin librer√≠a)
        // =====================================================
        const StorageService = {
            bucketName: 'documentos',

            // Subir archivo a Supabase Storage usando fetch directo
            // customFileName es opcional - si se proporciona, se usa en lugar del nombre original
            async uploadFile(file, tripId, docTypeId, customFileName = null) {
                const timestamp = Date.now();
                const safeName = customFileName
                    ? customFileName.replace(/[^a-zA-Z0-9.-]/g, '_')
                    : file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const path = `${tripId}/${docTypeId}_${timestamp}_${safeName}`;

                const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${this.bucketName}/${path}`;

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': file.type || 'application/pdf',
                        'x-upsert': 'true'
                    },
                    body: file
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Error ${response.status} al subir archivo`);
                }

                // URL p√∫blica del archivo
                const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${this.bucketName}/${path}`;

                return {
                    path: path,
                    url: publicUrl
                };
            },

            // Eliminar archivo de Storage
            async deleteFile(path) {
                if (!path) return;

                try {
                    const deleteUrl = `${SUPABASE_URL}/storage/v1/object/${this.bucketName}/${path}`;
                    await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'apikey': SUPABASE_ANON_KEY
                        }
                    });
                } catch (err) {
                    console.error('Error eliminando archivo:', err);
                }
            },

            // Obtener URL p√∫blica de un archivo
            getPublicUrl(path) {
                if (!path) return null;
                return `${SUPABASE_URL}/storage/v1/object/public/${this.bucketName}/${path}`;
            }
        };

        // Funciones para manejo de PDFs (compatibles con Storage y Base64)
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB con Supabase Storage

        // Extraer solo la primera p√°gina de un PDF usando pdf-lib
        const extractFirstPage = async (file) => {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pageCount = pdfDoc.getPageCount();

                // Si solo tiene una p√°gina, retornar el archivo original
                if (pageCount === 1) {
                    return file;
                }

                // Crear nuevo PDF con solo la primera p√°gina
                const newPdf = await PDFLib.PDFDocument.create();
                const [firstPage] = await newPdf.copyPages(pdfDoc, [0]);
                newPdf.addPage(firstPage);

                // Convertir a Blob
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });

                console.log(`PDF procesado: ${pageCount} p√°ginas ‚Üí 1 p√°gina`);
                return blob;
            } catch (err) {
                console.error('Error extrayendo primera p√°gina:', err);
                // Si falla, retornar el archivo original
                return file;
            }
        };

        const downloadPdf = (doc) => {
            const url = doc.storageUrl || doc.base64;
            if (!url) return;

            const link = document.createElement('a');
            link.href = url;
            link.download = doc.fileName || 'documento.pdf';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const viewPdfInNewTab = (doc) => {
            // Soporta tanto el nuevo formato (objeto) como el viejo (string base64)
            const url = typeof doc === 'string' ? doc : (doc.storageUrl || doc.base64);
            if (!url) {
                alert('No se encontr√≥ el archivo');
                return;
            }

            // Si es URL de Supabase Storage, abrir directo
            if (url.startsWith('http')) {
                // Crear ventana con visor de PDF
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${doc.fileName || 'Documento PDF'}</title>
                            <style>
                                body { margin: 0; padding: 0; background: #525659; }
                                iframe { width: 100%; height: 100vh; border: none; }
                            </style>
                        </head>
                        <body>
                            <iframe src="${url}" type="application/pdf"></iframe>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                } else {
                    // Si el navegador bloquea popups, abrir directo
                    window.location.href = url;
                }
            } else {
                // Es base64, abrir en nueva ventana
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${doc.fileName || 'Documento PDF'}</title>
                            <style>
                                body { margin: 0; padding: 0; }
                                iframe { width: 100%; height: 100vh; border: none; }
                            </style>
                        </head>
                        <body>
                            <iframe src="${url}"></iframe>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                }
            }
        };

        const robustParseDate = (val) => {
            if (!val) return null;
            if (val instanceof Date) return isNaN(val.getTime()) ? null : new Date(val.getFullYear(), val.getMonth(), val.getDate());
            if (typeof val === 'number') {
                const d = XLSX.SSF.parse_date_code(val);
                return new Date(d.y, d.m - 1, d.d);
            }
            const str = val.toString().trim();
            if (!str || str.toLowerCase() === 'verde') return null;

            // Soporte para fechas en espa√±ol: "21 Noviembre 2025" / "21 de Noviembre de 2025"
            const cleaned = str.toLowerCase().replace(/\s+/g, ' ').replace(/\bde\b/g, '').trim();
            const spanishMatch = cleaned.match(/^(\d{1,2})\s+([a-z√°√©√≠√≥√∫√±]+)\s+(\d{4})$/i);
            if (spanishMatch) {
                const d = Number(spanishMatch[1]);
                const monName = spanishMatch[2].normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                const y = Number(spanishMatch[3]);
                const months = {
                    enero: 0, febrero: 1, marzo: 2, abril: 3, mayo: 4, junio: 5,
                    julio: 6, agosto: 7, septiembre: 8, setiembre: 8, octubre: 9, noviembre: 10, diciembre: 11
                };
                if (months[monName] !== undefined) return new Date(y, months[monName], d);
            }

            // ISO format: 2024-01-20, 2024-01-20T00:00:00, 2024-01-20T00:00:00.000Z
            // IMPORTANTE: Buscar YYYY-MM-DD en cualquier parte del string para evitar problemas de timezone
            const isoMatch = str.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (isoMatch) {
                return new Date(Number(isoMatch[1]), Number(isoMatch[2]) - 1, Number(isoMatch[3]));
            }

            // Otros formatos: YYYY/MM/DD o DD/MM/YYYY o DD-MM-YYYY
            const formats = [/^(\d{4})[\/](\d{1,2})[\/](\d{1,2})$/, /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/];
            for (let fmt of formats) {
                const m = str.match(fmt);
                if (m) {
                    if (fmt === formats[0]) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
                    let [_, d, mo, y] = m.map(Number);
                    if (mo > 12) [d, mo] = [mo, d];
                    return new Date(y, mo - 1, d);
                }
            }

            // √öltimo recurso - parsear y extraer solo a√±o/mes/d√≠a para evitar timezone
            const parsed = new Date(str);
            if (!isNaN(parsed.getTime())) {
                // IMPORTANTE: Usar getUTCFullYear/Month/Date si parece ser UTC, sino usar local
                // Si el string contiene Z o +/- timezone, es UTC
                if (str.includes('Z') || /[+-]\d{2}:\d{2}$/.test(str)) {
                    return new Date(parsed.getUTCFullYear(), parsed.getUTCMonth(), parsed.getUTCDate());
                }
                return new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
            }
            return null;
        };

        const formatDateSpanish = (val) => {
            if (val === 'Verde') return null; // No mostrar fecha para Verde
            const d = robustParseDate(val);
            if (!d) return '-';
            return `${d.getDate()} ${MESES[d.getMonth()]} ${d.getFullYear()}`;
        };

        const formatDateForInput = (val) => {
            if (!val || val === 'Verde') return '';
            const d = robustParseDate(val);
            if (!d) return '';
            // IMPORTANTE: No usar toISOString() porque convierte a UTC y puede cambiar el d√≠a
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const generateUUID = () => {
            if (crypto?.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        };

        const getDaysUntil = (val) => {
            if (val === 'Verde') return null; // Verde = completado
            const d = robustParseDate(val);
            if (!d) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return Math.ceil((d - today) / (1000 * 60 * 60 * 24));
        };

        // =====================================================
        // EXCEL EXPORT/IMPORT SERVICE
        // =====================================================
        // Columnas para Excel y Google Sheets (deben coincidir)
        // IMPORTANTE: Incluye TODOS los campos del formulario
        const EXPORT_COLUMNS = [
            'tripId', 'Nombre', 'Numero de booking', 'Numero de BL', 'Fecha',
            'Fecha de embarque', 'Fecha de arribo', 'Status', 'SI', 'Cut off',
            'Contenedores', 'Peso', 'Analisis', 'Flete', 'Costo agencia',
            '$venta', '$deben', '10%', 'Anticipos', 'Agencia aduanal',
            'Origen', 'Destino', 'Cliente', 'Proveedor', 'Producto', 'Notas'
        ];

        // Formatear fecha a DD/MM/YYYY para Excel
        // IMPORTANTE: Sumamos 1 d√≠a para compensar el offset de timezone de XLSX
        const formatDateExport = (dateValue) => {
            if (!dateValue) return '';
            // Si es "Verde", no formatear
            if (dateValue === 'Verde') return 'Verde';

            // Si ya es string
            if (typeof dateValue === 'string') {
                // Formato ISO: 2024-01-08 o 2024-01-08T...
                const isoMatch = dateValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (isoMatch) {
                    const [, year, month, day] = isoMatch;
                    // Crear fecha local y sumar 1 d√≠a para compensar offset de XLSX
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    date.setDate(date.getDate() + 1);
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}/${m}/${y}`;
                }
                // Formato DD/MM/YYYY ya existente - tambi√©n sumar 1 d√≠a
                const ddmmMatch = dateValue.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (ddmmMatch) {
                    const [, day, month, year] = ddmmMatch;
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    date.setDate(date.getDate() + 1);
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}/${m}/${y}`;
                }
                // Cualquier otro formato, devolver sin modificar
                return dateValue;
            }

            // Solo para objetos Date reales
            if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
                const date = new Date(dateValue.getTime());
                date.setDate(date.getDate() + 1);
                const d = String(date.getDate()).padStart(2, '0');
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const y = date.getFullYear();
                return `${d}/${m}/${y}`;
            }

            return dateValue;
        };

        const ExcelService = {
            export(data, filename = 'Antigravity_Export') {
                if (!data || data.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Exportar solo las columnas definidas, en orden
                const cleanData = data.map(row => {
                    const clean = {};
                    EXPORT_COLUMNS.forEach(col => {
                        let value = row[col] !== undefined ? row[col] : '';
                        // Formatear fechas
                        if (['Fecha', 'Fecha de embarque', 'Fecha de arribo', 'SI', 'Cut off'].includes(col) && value && value !== 'Verde') {
                            value = formatDateExport(value);
                        }
                        clean[col] = value;
                    });
                    return clean;
                });

                // raw: true evita que XLSX auto-convierta fechas a n√∫meros seriales de Excel
                const ws = XLSX.utils.json_to_sheet(cleanData, { header: EXPORT_COLUMNS, raw: true });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Viajes');

                // Ajustar ancho de columnas
                const colWidths = EXPORT_COLUMNS.map(key => ({
                    wch: Math.max(key.length, 15)
                }));
                ws['!cols'] = colWidths;

                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `${filename}_${date}.xlsx`);
            },

            async import(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
                            const sheetName = wb.SheetNames[0];
                            if (!sheetName) throw new Error('Excel sin hojas');

                            const data = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                            resolve(data);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });
            },

            processImport(incoming, existing) {
                const results = { nuevos: 0, actualizados: 0, omitidos: 0, errores: 0, data: [...existing] };

                // Crear mapas para busqueda rapida por multiples campos
                const blMap = new Map();
                const bookingMap = new Map();
                const nombreMap = new Map();
                const nombreFechaMap = new Map(); // Combinacion Nombre + Fecha para mayor precision

                existing.forEach((v, idx) => {
                    if (v['Numero de BL']) blMap.set(v['Numero de BL'].toLowerCase().trim(), idx);
                    if (v['Numero de booking']) bookingMap.set(v['Numero de booking'].toLowerCase().trim(), idx);
                    if (v.Nombre) nombreMap.set(v.Nombre.toLowerCase().trim(), idx);
                    // Clave compuesta: Nombre + Fecha
                    if (v.Nombre && v.Fecha) {
                        const fechaStr = robustParseDate(v.Fecha)?.toISOString().split('T')[0] || '';
                        nombreFechaMap.set(v.Nombre.toLowerCase().trim() + '|' + fechaStr, idx);
                    }
                });

                // Set para rastrear indices ya procesados en esta importacion (evitar duplicados dentro del mismo Excel)
                const processedIncoming = new Set();

                incoming.forEach((row, rowIdx) => {
                    // Validar que tenga al menos Nombre o Booking
                    if (!row.Nombre && !row['Numero de booking']) {
                        results.errores++;
                        return;
                    }

                    // Normalizar valores para busqueda
                    const bl = (row['Numero de BL'] || '').toString().toLowerCase().trim();
                    const booking = (row['Numero de booking'] || '').toString().toLowerCase().trim();
                    const nombre = (row.Nombre || '').toString().toLowerCase().trim();
                    const fechaRow = robustParseDate(row.Fecha);
                    const fechaStr = fechaRow?.toISOString().split('T')[0] || '';
                    const nombreFechaKey = nombre + '|' + fechaStr;

                    // Crear clave unica para detectar duplicados dentro del mismo Excel
                    const incomingKey = bl || booking || nombreFechaKey || nombre;
                    if (processedIncoming.has(incomingKey)) {
                        results.omitidos++;
                        return; // Ya procesamos este registro en esta importacion
                    }
                    processedIncoming.add(incomingKey);

                    let matchIdx = -1;

                    // Buscar por BL (prioridad maxima - es unico)
                    if (bl && blMap.has(bl)) {
                        matchIdx = blMap.get(bl);
                    }
                    // Buscar por Booking (segunda prioridad)
                    else if (booking && bookingMap.has(booking)) {
                        matchIdx = bookingMap.get(booking);
                    }
                    // Buscar por Nombre + Fecha (tercera prioridad - muy probable que sea el mismo viaje)
                    else if (nombre && fechaStr && nombreFechaMap.has(nombreFechaKey)) {
                        matchIdx = nombreFechaMap.get(nombreFechaKey);
                    }
                    // Buscar solo por Nombre (ultima opcion - puede haber falsos positivos)
                    else if (nombre && nombreMap.has(nombre)) {
                        matchIdx = nombreMap.get(nombre);
                    }

                    // Procesar fecha
                    const fecha = robustParseDate(row.Fecha);

                    const viaje = {
                        ...row,
                        'Numero de BL': row['Numero de BL'] || '',
                        Fecha: fecha ? fecha.toISOString() : row.Fecha,
                        tripId: matchIdx >= 0 ? results.data[matchIdx].tripId : generateUUID(),
                        lastModified: new Date().toISOString(),
                        modifiedBy: 'Excel Import'
                    };

                    if (matchIdx >= 0) {
                        // Actualizar existente - preservar documentos si existen
                        const existingDocs = results.data[matchIdx].documentos;
                        results.data[matchIdx] = { ...results.data[matchIdx], ...viaje };
                        if (existingDocs) {
                            results.data[matchIdx].documentos = existingDocs;
                        }
                        results.actualizados++;
                    } else {
                        // Nuevo registro
                        viaje.documentos = createEmptyDocumentos();
                        results.data.unshift(viaje);
                        results.nuevos++;

                        // Actualizar mapas para detectar duplicados en filas siguientes del mismo Excel
                        const newIdx = 0; // Se inserto al inicio
                        if (bl) blMap.set(bl, newIdx);
                        if (booking) bookingMap.set(booking, newIdx);
                        if (nombre) nombreMap.set(nombre, newIdx);
                        if (nombre && fechaStr) nombreFechaMap.set(nombreFechaKey, newIdx);
                    }
                });

                return results;
            }
        };

        // =====================================================
        // NOTIFICATION SERVICE
        // =====================================================
        const NotificationService = {
            generate(viajes) {
                const notifications = [];
                viajes.forEach(v => {
                    if ((v.Status || '').toLowerCase() === 'cerrado') return;

                    const daysEmb = getDaysUntil(v['Fecha de embarque']);
                    if (daysEmb !== null && daysEmb >= 0 && daysEmb <= 7) {
                        notifications.push({
                            id: `emb-${v.tripId}`, type: daysEmb <= 2 ? 'danger' : 'warning',
                            title: daysEmb === 0 ? 'Embarque HOY' : `Embarque en ${daysEmb} dias`,
                            message: `${v.Nombre} - ${v['Numero de booking'] || 'Sin booking'}`,
                            viaje: v, priority: daysEmb <= 2 ? 1 : 2
                        });
                    }

                    const daysArr = getDaysUntil(v['Fecha de arribo']);
                    if (daysArr !== null && daysArr >= 0 && daysArr <= 7) {
                        notifications.push({
                            id: `arr-${v.tripId}`, type: daysArr <= 2 ? 'warning' : 'info',
                            title: daysArr === 0 ? 'Arribo HOY' : `Arribo en ${daysArr} dias`,
                            message: `${v.Nombre}`, viaje: v, priority: daysArr <= 2 ? 2 : 3
                        });
                    }

                    const saldo = Number(v['$deben']) || 0;
                    if (saldo > 50000) {
                        notifications.push({
                            id: `saldo-${v.tripId}`, type: 'warning',
                            title: 'Saldo pendiente alto', message: `${v.Nombre} - ${formatCurrency(saldo)}`,
                            viaje: v, priority: 2
                        });
                    }
                });
                return notifications.sort((a, b) => a.priority - b.priority);
            },

            getSummary(viajes) {
                let urgentes = 0, proximos = 0, saldos = 0, totalSaldo = 0;
                const vUrgentes = [], vProximos = [], vSaldos = [];

                viajes.forEach(v => {
                    if ((v.Status || '').toLowerCase() === 'cerrado') return;

                    const daysEmb = getDaysUntil(v['Fecha de embarque']);
                    if (daysEmb !== null && daysEmb >= 0 && daysEmb <= 2) { urgentes++; vUrgentes.push(v); }
                    if ((daysEmb !== null && daysEmb >= 0 && daysEmb <= 7) || (getDaysUntil(v['Fecha de arribo']) !== null && getDaysUntil(v['Fecha de arribo']) >= 0 && getDaysUntil(v['Fecha de arribo']) <= 7)) {
                        proximos++;
                        if (!vUrgentes.includes(v)) vProximos.push(v);
                    }

                    const s = Number(v['$deben']) || 0;
                    if (s > 0) { saldos++; totalSaldo += s; vSaldos.push(v); }
                });

                return { urgentes, proximos, saldos, totalSaldo, vUrgentes, vProximos, vSaldos };
            }
        };

        // =====================================================
        // ERROR BOUNDARY MEJORADO
        // =====================================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error('ErrorBoundary caught:', error, errorInfo);
                this.setState({ errorInfo });
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', background: '#f8fafc', flexDirection: 'column', padding: '2rem', textAlign: 'center' }}>
                            <div style={{ background: 'white', padding: '3rem', borderRadius: '16px', boxShadow: '0 10px 25px rgba(0,0,0,0.1)', maxWidth: '500px' }}>
                                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>‚ö†Ô∏è</div>
                                <h1 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem', color: '#1e293b' }}>Ocurrio un error</h1>
                                <p style={{ color: '#64748b', marginBottom: '1.5rem' }}>Algo salio mal. Por favor recarga la pagina.</p>
                                <button onClick={() => window.location.reload()} style={{ background: '#6366f1', color: 'white', border: 'none', padding: '0.75rem 1.5rem', borderRadius: '8px', fontWeight: 600, cursor: 'pointer', fontSize: '1rem' }}>
                                    Recargar
                                </button>
                                {this.state.error && (
                                    <details style={{ marginTop: '1.5rem', textAlign: 'left', background: '#fef2f2', padding: '1rem', borderRadius: '8px', fontSize: '0.75rem', color: '#991b1b' }}>
                                        <summary style={{ cursor: 'pointer', fontWeight: 600 }}>Detalles del error (debug)</summary>
                                        <pre style={{ marginTop: '0.5rem', whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>{this.state.error.toString()}</pre>
                                        {this.state.errorInfo && <pre style={{ marginTop: '0.5rem', whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>{this.state.errorInfo.componentStack}</pre>}
                                    </details>
                                )}
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Global error handlers para logging
        window.onerror = function (message, source, lineno, colno, error) {
            console.error('Global Error:', { message, source, lineno, colno, error });
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled Promise Rejection:', event.reason);
        });

        // Componente para mostrar evidencia de extraccion
        const EvidenceIcon = ({ field, trip, evidence }) => {
            const ev = evidence || (trip?.evidence && trip?.evidence[field]);
            if (!ev) return null;
            const title = `Fuente: ${ev.rule}\n"${ev.snippet}"`;
            return (
                <span title={title} style={{ marginLeft: '4px', cursor: 'help', color: '#64748b', display: 'inline-block' }}>
                    <i data-lucide="info" style={{ width: '14px', height: '14px', verticalAlign: 'middle' }}></i>
                </span>
            );
        };

        const GlobalSearch = ({ data, onSelect }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef();

            useEffect(() => {
                if (query.length < 2) { setResults([]); return; }
                const q = query.toLowerCase();
                setResults(data.filter(v => (v.Nombre || '').toLowerCase().includes(q) || (v['Numero de booking'] || '').toLowerCase().includes(q) || (v['Numero de BL'] || '').toLowerCase().includes(q)).slice(0, 6));
                setIsOpen(true);
            }, [query, data]);

            useEffect(() => {
                const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handler);
                return () => document.removeEventListener('mousedown', handler);
            }, []);

            useEffect(() => { lucide.createIcons(); }, [results]);

            return (
                <div className="global-search" ref={ref}>
                    <i data-lucide="Search" size="18" className="global-search-icon"></i>
                    <input className="global-search-input" placeholder="Buscar viajes..." value={query} onChange={(e) => setQuery(e.target.value)} onFocus={() => results.length > 0 && setIsOpen(true)} />
                    {isOpen && results.length > 0 && (
                        <div className="global-search-results">
                            {results.map((v, i) => (
                                <div key={v.tripId || i} className="search-result-item" onClick={() => { onSelect(v); setQuery(''); setIsOpen(false); }}>
                                    <div className="search-result-title">{v.Nombre || 'Sin nombre'}</div>
                                    <div className="search-result-meta">
                                        <span>Booking: {v['Numero de booking'] || '-'}</span>
                                        <span>{v.Status || 'Pendiente'}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const NotificationCenter = ({ notifications, onClick }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef();

            useEffect(() => {
                const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handler);
                return () => document.removeEventListener('mousedown', handler);
            }, []);

            useEffect(() => { lucide.createIcons(); }, [isOpen]);

            const getIcon = (t) => t === 'danger' ? 'AlertTriangle' : t === 'warning' ? 'Clock' : 'Ship';

            return (
                <div style={{ position: 'relative' }} ref={ref}>
                    <div className="notification-bell" onClick={() => setIsOpen(!isOpen)}>
                        <i data-lucide="Bell" size="20" color="var(--text-muted)"></i>
                        {notifications.length > 0 && <div className="notification-badge">{notifications.length > 9 ? '9+' : notifications.length}</div>}
                    </div>
                    {isOpen && (
                        <div className="notification-panel">
                            <div className="notification-header">
                                <h3 style={{ fontSize: '1rem', fontWeight: 700 }}>Notificaciones</h3>
                                <span className="badge bg-purple">{notifications.length}</span>
                            </div>
                            <div className="notification-list">
                                {notifications.length === 0 ? (
                                    <div className="notification-empty"><p>Todo en orden</p></div>
                                ) : notifications.slice(0, 8).map((n, i) => (
                                    <div key={n.id || i} className="notification-item" onClick={() => { onClick(n.viaje); setIsOpen(false); }}>
                                        <div className={`notification-icon ${n.type}`}><i data-lucide={getIcon(n.type)} size="18"></i></div>
                                        <div className="notification-content">
                                            <div className="notification-title">{n.title}</div>
                                            <div className="notification-message">{n.message}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ConnectionStatus = ({ isOnline }) => (
            <div className={`connection-badge ${isOnline ? 'online' : 'offline'}`}>
                <div className="connection-dot"></div>
                <span>{isOnline ? 'Conectado' : 'Local'}</span>
            </div>
        );

        const SyncIndicator = ({ message }) => (
            <div className="sync-indicator">
                <div className="sync-spinner"></div>
                <span style={{ fontSize: '0.875rem' }}>{message}</span>
            </div>
        );

        const Sidebar = ({ activePage, setPage, user, onLogout, isOnline }) => {
            const items = [
                { id: 'dashboard', label: 'Inicio', icon: 'LayoutDashboard' },
                { id: 'status', label: 'Estatus', icon: 'Activity' },
                { id: 'calendario', label: 'Calendario', icon: 'Calendar' },
                { id: 'viajes', label: 'Viajes', icon: 'Ship' },
                { id: 'gestion', label: 'Documentos', icon: 'FileText' },
                { id: 'historial', label: 'Historial', icon: 'History' },
            ];
            useEffect(() => { lucide.createIcons(); }, [activePage]);

            return (
                <div className="sidebar">
                    <div className="logo"><i data-lucide="Zap" style={{ color: '#6366f1' }}></i><span>Antigravity</span></div>
                    <ConnectionStatus isOnline={isOnline} />
                    <div style={{ marginTop: '1.5rem' }}>
                        {items.map(item => (
                            <div key={item.id} className={`nav-item ${activePage === item.id ? 'active' : ''}`} onClick={() => setPage(item.id)}>
                                <i data-lucide={item.icon} size="18"></i>
                                <span style={{ fontSize: '0.875rem', fontWeight: 500 }}>{item.label}</span>
                            </div>
                        ))}
                    </div>
                    <div style={{ marginTop: 'auto', paddingTop: '1rem', borderTop: '1px solid rgba(255,255,255,0.1)' }}>
                        {user && (
                            <div style={{ marginBottom: '1rem', padding: '0.75rem', background: 'rgba(255,255,255,0.05)', borderRadius: '8px' }}>
                                <div style={{ fontSize: '0.7rem', color: '#94a3b8' }}>Conectado como</div>
                                <div style={{ fontSize: '0.8125rem', fontWeight: 500, color: 'white', overflow: 'hidden', textOverflow: 'ellipsis' }}>{user.email}</div>
                            </div>
                        )}
                        <div className="nav-item" onClick={onLogout} title="Cerrar sesi√≥n">
                            <i data-lucide="LogOut" size="18"></i><span style={{ fontSize: '0.875rem' }}>Salir</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ThemeToggle = ({ theme, setTheme }) => {
            useEffect(() => { lucide.createIcons(); }, [theme]);
            return (
                <button className="theme-toggle" onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} title={theme === 'light' ? 'Modo oscuro' : 'Modo claro'}>
                    <i data-lucide={theme === 'light' ? 'Moon' : 'Sun'} size="20" color="var(--text-muted)"></i>
                </button>
            );
        };

        const DateRangePicker = ({ startDate, endDate, onChange }) => {
            const pickerRef = useRef(null);
            const fpInstance = useRef(null);

            useEffect(() => {
                if (!pickerRef.current || typeof flatpickr === 'undefined') return;
                fpInstance.current = flatpickr(pickerRef.current, {
                    mode: 'range',
                    dateFormat: 'd M Y',
                    locale: 'es',
                    defaultDate: startDate && endDate ? [startDate, endDate] : null,
                    onChange: (dates) => {
                        if (dates.length === 2) onChange(dates[0], dates[1]);
                    }
                });
                return () => { if (fpInstance.current) fpInstance.current.destroy(); };
            }, []);

            useEffect(() => { lucide.createIcons(); }, []);

            const formatRange = () => {
                if (!startDate || !endDate) return 'Todas las fechas';
                const fmt = (d) => `${d.getDate()} ${MESES[d.getMonth()].substring(0, 3)}`;
                return `${fmt(startDate)} - ${fmt(endDate)}`;
            };

            const clear = (e) => { e.stopPropagation(); onChange(null, null); if (fpInstance.current) fpInstance.current.clear(); };

            return (
                <div className="date-range-picker" onClick={() => fpInstance.current?.open()}>
                    <i data-lucide="Calendar" size="16" color="var(--text-muted)"></i>
                    <span className="date-range-text">{formatRange()}</span>
                    {startDate && <button onClick={clear} style={{ border: 'none', background: 'none', cursor: 'pointer', padding: '0.125rem' }}><i data-lucide="X" size="14" color="var(--text-muted)"></i></button>}
                    <input ref={pickerRef} type="text" style={{ position: 'absolute', opacity: 0, pointerEvents: 'none' }} />
                </div>
            );
        };

        const Header = ({ title, data, notifications, onSearch, onNotification, theme, setTheme, startDate, endDate, onDateChange, onSyncFromSheets, syncingFromSheets, onBackup, backingUp, lastBackup, lastAutoBackup }) => {
            useEffect(() => { lucide.createIcons(); }, [syncingFromSheets, backingUp]);

            const formatLastBackup = (iso) => {
                if (!iso) return null;
                const d = new Date(iso);
                const now = new Date();
                const diffMs = now - d;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                if (diffMins < 1) return 'hace un momento';
                if (diffMins < 60) return `hace ${diffMins} min`;
                if (diffHours < 24) return `hace ${diffHours}h`;
                return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
            };

            return (
                <div className="header">
                    <h1 style={{ fontSize: '1.25rem', fontWeight: 700 }}>{title}</h1>
                    <div className="header-right">
                        <DateRangePicker startDate={startDate} endDate={endDate} onChange={onDateChange} />
                        <GlobalSearch data={data} onSelect={onSearch} />

                        {/* Bot√≥n Descargar desde Google Sheets */}
                        <button
                            onClick={onSyncFromSheets}
                            disabled={syncingFromSheets}
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem',
                                padding: '0.5rem 0.75rem',
                                border: '1px solid var(--border)',
                                borderRadius: '8px',
                                background: syncingFromSheets ? 'var(--primary)' : 'var(--card-bg)',
                                color: syncingFromSheets ? 'white' : 'var(--text-main)',
                                cursor: syncingFromSheets ? 'wait' : 'pointer',
                                fontSize: '0.8125rem',
                                fontWeight: 500
                            }}
                            title="Descargar viajes activos desde Google Sheets (los cerrados se mantienen locales)"
                        >
                            <i data-lucide={syncingFromSheets ? "Loader2" : "Download"} size="14" className={syncingFromSheets ? 'spin' : ''}></i>
                            <span>{syncingFromSheets ? 'Descargando...' : 'Descargar'}</span>
                        </button>

                        {/* Bot√≥n Backup a Google Sheets */}
                        <button
                            onClick={onBackup}
                            disabled={backingUp}
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem',
                                padding: '0.5rem 0.75rem',
                                border: '1px solid var(--border)',
                                borderRadius: '8px',
                                background: backingUp ? '#22c55e' : 'var(--card-bg)',
                                color: backingUp ? 'white' : 'var(--text-main)',
                                cursor: backingUp ? 'wait' : 'pointer',
                                fontSize: '0.8125rem',
                                fontWeight: 500
                            }}
                            title={lastBackup ? `√öltimo backup: ${new Date(lastBackup).toLocaleString('es-MX')}` : 'Subir viajes activos a Google Sheets'}
                        >
                            <i data-lucide={backingUp ? "Loader2" : "Upload"} size="14" className={backingUp ? 'spin' : ''}></i>
                            <span>{backingUp ? 'Subiendo...' : 'Backup'}</span>
                            {lastBackup && !backingUp && (
                                <span style={{ fontSize: '0.65rem', opacity: 0.7 }}>({formatLastBackup(lastBackup)})</span>
                            )}
                        </button>

                        {/* Indicador de backup autom√°tico a Supabase */}
                        <div
                            title={lastAutoBackup
                                ? `Backup en nube: ${new Date(lastAutoBackup).toLocaleString('es-MX')}`
                                : 'Backup autom√°tico diario pendiente'
                            }
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.35rem',
                                padding: '0.4rem 0.6rem',
                                borderRadius: '6px',
                                fontSize: '0.75rem',
                                color: lastAutoBackup ? '#22c55e' : 'var(--text-muted)',
                                background: lastAutoBackup ? 'rgba(34, 197, 94, 0.1)' : 'transparent',
                                cursor: 'default'
                            }}
                        >
                            <i data-lucide="Cloud" size="14"></i>
                            <span>{lastAutoBackup ? 'Sync' : 'Pendiente'}</span>
                        </div>

                        <ThemeToggle theme={theme} setTheme={setTheme} />
                        <NotificationCenter notifications={notifications} onClick={onNotification} />
                    </div>
                </div>
            );
        };

        const KPICard = ({ label, value, icon, onClick, clickable = false, color = null }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="kpi-card" onClick={onClick} style={{ cursor: clickable ? 'pointer' : 'default' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                        <span className="kpi-label">{label}</span>
                        <i data-lucide={icon} size="16" color={color || "#94a3b8"}></i>
                    </div>
                    <span className="kpi-value" style={color ? { color } : {}}>{value}</span>
                    {clickable && <div style={{ fontSize: '0.65rem', color: 'var(--primary)', marginTop: '0.5rem' }}>Click para ver detalle</div>}
                </div>
            );
        };

        // Modal para mostrar viajes de un KPI
        const KPIDetailModal = ({ title, viajes, onClose, onEdit }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-card" style={{ maxWidth: '800px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{title} ({viajes.length})</h3>
                            <button onClick={onClose} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                                <i data-lucide="X" size="20"></i>
                            </button>
                        </div>
                        <div className="modal-body" style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                            {viajes.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' }}>No hay viajes en esta categoria</div>
                            ) : (
                                <table>
                                    <thead>
                                        <tr><th>Nombre</th><th>Booking</th><th>Contenedores</th><th>Peso</th><th>Analisis</th><th>Venta</th><th></th></tr>
                                    </thead>
                                    <tbody>
                                        {viajes.map((v, i) => (
                                            <tr key={v.tripId || i}>
                                                <td style={{ fontWeight: 500 }}>{v.Nombre || '-'}</td>
                                                <td>{v['Numero de booking'] || '-'}</td>
                                                <td>{v.Contenedores || '-'}</td>
                                                <td>{v.Peso ? formatNumber(v.Peso) : '-'}</td>
                                                <td>{v.Analisis ? formatPercent(v.Analisis) : '-'}</td>
                                                <td style={{ fontWeight: 600, color: 'var(--success)' }}>{formatCurrency(v['$venta'])}</td>
                                                <td>
                                                    <button onClick={() => { onEdit(v); onClose(); }} style={{ border: 'none', background: '#f1f5f9', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}>
                                                        <i data-lucide="Edit2" size="14" color="var(--primary)"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div className="modal-footer">
                            <div></div>
                            <button className="btn-secondary" onClick={onClose}>Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SalesChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || data.length === 0) return;

                const monthlyData = {};
                data.forEach(v => {
                    const fecha = robustParseDate(v.Fecha);
                    if (fecha) {
                        const key = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[key]) monthlyData[key] = { venta: 0, viajes: 0 };
                        monthlyData[key].venta += Number(v['$venta']) || 0;
                        monthlyData[key].viajes += 1;
                    }
                });

                const sortedKeys = Object.keys(monthlyData).sort().slice(-6);
                const labels = sortedKeys.map(k => {
                    const [y, m] = k.split('-');
                    return `${MESES[parseInt(m) - 1].substring(0, 3)} ${y.substring(2)}`;
                });
                const ventaData = sortedKeys.map(k => monthlyData[k].venta);
                const viajesData = sortedKeys.map(k => monthlyData[k].viajes);

                if (chartInstance.current) chartInstance.current.destroy();

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Ventas (MXN)', data: ventaData, backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6, yAxisID: 'y' },
                            { label: 'Viajes', data: viajesData, backgroundColor: 'rgba(34, 197, 94, 0.8)', borderRadius: 6, yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } } },
                        scales: {
                            y: { type: 'linear', position: 'left', ticks: { callback: v => '$' + (v / 1000).toFixed(0) + 'k' }, grid: { color: '#f1f5f9' } },
                            y1: { type: 'linear', position: 'right', grid: { display: false }, ticks: { stepSize: 1 } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <canvas ref={chartRef}></canvas>;
        };

        // Grafico de pastel para distribucion de Status
        const StatusPieChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Colores m√°s vivos y coloridos
            const STATUS_COLORS = {
                'Programacion': '#6366f1',  // Indigo vibrante
                'Altamar': '#0ea5e9',       // Azul cielo brillante
                'Ingresado': '#f97316',     // Naranja vibrante
                'Ingresados': '#fb923c',    // Naranja claro
                'Pago 10%': '#a855f7',      // P√∫rpura brillante
                'Liberado': '#10b981',      // Verde esmeralda
                'Sin Status': '#ec4899',    // Rosa fucsia
            };

            useEffect(() => {
                if (!chartRef.current || data.length === 0) return;

                // Filtrar viajes que NO estan cerrados (ignorando fechas - usa allData)
                const filteredData = data.filter(v => {
                    const status = (v.Status || '').toLowerCase();
                    return status !== 'cerrado';
                });

                const statusCount = {};
                filteredData.forEach(v => {
                    const status = v.Status || 'Sin Status';
                    statusCount[status] = (statusCount[status] || 0) + 1;
                });

                const labels = Object.keys(statusCount);
                const counts = Object.values(statusCount);
                const colors = labels.map(s => STATUS_COLORS[s] || '#94a3b8');

                if (chartInstance.current) chartInstance.current.destroy();

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const total = counts.reduce((a, b) => a + b, 0);
                                        const pct = ((ctx.raw / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${ctx.raw} viajes (${pct}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <canvas ref={chartRef}></canvas>;
        };

        const AlertCards = ({ summary, onClick }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return (
                <div className="alert-cards-grid">
                    <div className="alert-card danger" onClick={() => summary.vUrgentes[0] && onClick(summary.vUrgentes[0])}>
                        <div className="alert-card-header">
                            <div className="alert-card-count">{summary.urgentes}</div>
                            <i data-lucide="AlertTriangle" size="24" color="#ef4444"></i>
                        </div>
                        <div className="alert-card-title">Embarques Urgentes</div>
                        <div className="alert-card-subtitle">Proximas 48 horas</div>
                    </div>
                    <div className="alert-card warning" onClick={() => summary.vProximos[0] && onClick(summary.vProximos[0])}>
                        <div className="alert-card-header">
                            <div className="alert-card-count">{summary.proximos}</div>
                            <i data-lucide="Calendar" size="24" color="#f59e0b"></i>
                        </div>
                        <div className="alert-card-title">Proximos 7 Dias</div>
                        <div className="alert-card-subtitle">Embarques y arribos</div>
                    </div>
                    <div className="alert-card info" onClick={() => summary.vSaldos[0] && onClick(summary.vSaldos[0])}>
                        <div className="alert-card-header">
                            <div className="alert-card-count">{summary.saldos}</div>
                            <i data-lucide="DollarSign" size="24" color="#3b82f6"></i>
                        </div>
                        <div className="alert-card-title">Saldos Pendientes</div>
                        <div className="alert-card-subtitle">{formatCurrency(summary.totalSaldo)}</div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // IMPORT MODAL
        // =====================================================
        const ImportModal = ({ onClose, onImport, existingData }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [loading, setLoading] = useState(false);
            const [dragging, setDragging] = useState(false);
            const fileInputRef = useRef();

            useEffect(() => { lucide.createIcons(); }, [preview]);

            const handleFile = async (f) => {
                if (!f || !f.name.match(/\.(xlsx|xls)$/i)) {
                    alert('Por favor selecciona un archivo Excel (.xlsx o .xls)');
                    return;
                }
                setFile(f);
                setLoading(true);

                try {
                    const data = await ExcelService.import(f);
                    const results = ExcelService.processImport(data, existingData);
                    setPreview(results);
                } catch (err) {
                    alert('Error al leer el archivo: ' + err.message);
                }
                setLoading(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragging(false);
                const f = e.dataTransfer.files[0];
                handleFile(f);
            };

            const confirmImport = () => {
                if (preview) {
                    onImport(preview.data);
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-card" style={{ maxWidth: '600px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Importar desde Excel</h3>
                            <button onClick={onClose} style={{ border: 'none', background: 'none', cursor: 'pointer' }}>
                                <i data-lucide="X" size="20"></i>
                            </button>
                        </div>

                        <div className="modal-body">
                            {!preview ? (
                                <>
                                    <div
                                        className={`import-zone ${dragging ? 'dragging' : ''}`}
                                        onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
                                        onDragLeave={() => setDragging(false)}
                                        onDrop={handleDrop}
                                        onClick={() => fileInputRef.current?.click()}
                                    >
                                        <input ref={fileInputRef} type="file" accept=".xlsx,.xls" hidden onChange={(e) => handleFile(e.target.files[0])} />
                                        {loading ? (
                                            <div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto' }}></div>
                                        ) : (
                                            <>
                                                <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üì§</div>
                                                <h3 style={{ marginBottom: '0.5rem' }}>Arrastra tu archivo Excel aqui</h3>
                                                <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>o haz clic para seleccionar</p>
                                                <p style={{ color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: '1rem' }}>Formatos: .xlsx, .xls</p>
                                            </>
                                        )}
                                    </div>

                                    <div style={{ marginTop: '1.5rem', padding: '1rem', background: '#f8fafc', borderRadius: '8px', fontSize: '0.8125rem' }}>
                                        <strong>Columnas esperadas:</strong>
                                        <p style={{ color: 'var(--text-muted)', marginTop: '0.5rem' }}>
                                            Nombre, Fecha, Numero de booking, Numero de BL, Status, Contenedores, Peso, Flete, $venta, $deben, Fecha de embarque, Fecha de arribo, SI, Cut off
                                        </p>
                                    </div>
                                </>
                            ) : (
                                <div className="import-preview">
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.5rem' }}>
                                        <span style={{ fontSize: '1.5rem' }}>‚úÖ</span>
                                        <div>
                                            <h3 style={{ fontSize: '1rem' }}>{file?.name}</h3>
                                            <p style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>Archivo procesado correctamente</p>
                                        </div>
                                    </div>

                                    <div className="import-stats">
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--success)' }}>{preview.nuevos}</div>
                                            <div className="import-stat-label">Nuevos</div>
                                        </div>
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--info)' }}>{preview.actualizados}</div>
                                            <div className="import-stat-label">Actualizados</div>
                                        </div>
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--warning)' }}>{preview.omitidos || 0}</div>
                                            <div className="import-stat-label">Duplicados</div>
                                        </div>
                                        <div className="import-stat">
                                            <div className="import-stat-value" style={{ color: 'var(--danger)' }}>{preview.errores}</div>
                                            <div className="import-stat-label">Errores</div>
                                        </div>
                                    </div>

                                    <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', borderRadius: '8px', padding: '1rem', fontSize: '0.8125rem', color: '#166534' }}>
                                        <strong>Listo para importar</strong>
                                        <p style={{ marginTop: '0.25rem' }}>
                                            Se agregaran {preview.nuevos} viajes nuevos y se actualizaran {preview.actualizados} existentes.
                                            {preview.omitidos > 0 && ` (${preview.omitidos} duplicados omitidos)`}
                                        </p>
                                    </div>

                                    {preview.omitidos > 0 && (
                                        <div style={{ background: '#fffbeb', border: '1px solid #fcd34d', borderRadius: '8px', padding: '1rem', fontSize: '0.8125rem', color: '#92400e', marginTop: '0.75rem' }}>
                                            <strong>Duplicados detectados</strong>
                                            <p style={{ marginTop: '0.25rem' }}>Se omitieron {preview.omitidos} filas duplicadas dentro del mismo archivo Excel.</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="modal-footer">
                            <button className="btn-secondary" onClick={onClose}>Cancelar</button>
                            {preview && (
                                <button className="btn-success" onClick={confirmImport}>
                                    <i data-lucide="Check" size="16"></i>
                                    Confirmar Importacion
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // DOCUMENT CARD COMPONENT (para poder usar hooks)
        // =====================================================
        const DocumentCard = ({ docType, doc, tripId, tripName, documentos, onUpdate }) => {
            const [uploading, setUploading] = useState(false);
            const [localDoc, setLocalDoc] = useState(doc);
            const inputRef = useRef(null);
            const cardRef = useRef(null);

            // Sincronizar con prop externa
            useEffect(() => {
                setLocalDoc(doc);
            }, [doc]);

            // Inicializar iconos cuando el componente monta o cuando cambia el estado uploaded
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (cardRef.current) {
                        lucide.createIcons({ nodes: [cardRef.current] });
                    }
                }, 50);
                return () => clearTimeout(timer);
            }, [localDoc.uploaded]);

            const handleUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                // Verificar tipo de archivo (PDF o PNG)
                const isPdf = file.type.includes('pdf') || file.name.toLowerCase().endsWith('.pdf');
                const isPng = file.type.includes('png') || file.name.toLowerCase().endsWith('.png');

                if (!isPdf && !isPng) {
                    alert('Solo se permiten archivos PDF o PNG');
                    if (inputRef.current) inputRef.current.value = '';
                    return;
                }
                if (file.size > MAX_FILE_SIZE) {
                    alert('El archivo excede 50MB. Por favor usa un archivo mas peque√±o.');
                    if (inputRef.current) inputRef.current.value = '';
                    return;
                }

                setUploading(true);
                try {
                    // Solo extraer primera p√°gina si es PDF
                    const processedFile = isPdf ? await extractFirstPage(file) : file;

                    // Generar nombre personalizado con la extensi√≥n correcta
                    const extension = isPdf ? 'pdf' : 'png';
                    const customFileName = `${tripName || 'Viaje'} - ${docType.id}.${extension}`;

                    // Subir con el nombre personalizado
                    const result = await StorageService.uploadFile(processedFile, tripId, docType.id, customFileName);
                    const newDocData = {
                        uploaded: true,
                        fileName: customFileName,
                        uploadDate: new Date().toISOString(),
                        storagePath: result.path,
                        storageUrl: result.url
                    };

                    // Actualizar estado local primero
                    setLocalDoc(newDocData);
                    setUploading(false);
                    if (inputRef.current) inputRef.current.value = '';

                    // Luego actualizar el padre (con info para historial)
                    const newDocs = { ...(documentos || createEmptyDocumentos()) };
                    newDocs[docType.id] = newDocData;
                    onUpdate(newDocs, docType.id, 'upload', finalFileName);

                    alert('Documento subido correctamente');
                } catch (err) {
                    console.error('Error subiendo archivo:', err);
                    setUploading(false);
                    if (inputRef.current) inputRef.current.value = '';
                    alert('Error al subir: ' + err.message);
                }
            };

            const handleDelete = async () => {
                if (!confirm(`Eliminar ${docType.label}?`)) return;
                const deletedFileName = localDoc.fileName;
                if (localDoc.storagePath) {
                    await StorageService.deleteFile(localDoc.storagePath);
                }
                const emptyDoc = { uploaded: false, fileName: '', uploadDate: '', storagePath: '', storageUrl: '' };
                setLocalDoc(emptyDoc);
                const newDocs = { ...(documentos || createEmptyDocumentos()) };
                newDocs[docType.id] = emptyDoc;
                onUpdate(newDocs, docType.id, 'delete', deletedFileName);
            };

            // Estructura fija - NO usar condicionales con iconos de Lucide
            // Los iconos se renderizan una vez y se controlan con CSS
            return (
                <div ref={cardRef} className={`doc-card ${localDoc.uploaded ? 'uploaded' : ''}`}>
                    <div className="doc-card-header">
                        <div className="doc-card-icon">
                            <i data-lucide={docType.icon} size="16"></i>
                        </div>
                        <span className="doc-card-title">{docType.label}</span>
                        <div className="doc-card-status" style={{ opacity: localDoc.uploaded ? 1 : 0 }}>
                            <span style={{ color: 'var(--success)', fontWeight: 'bold' }}>‚úì</span>
                        </div>
                    </div>

                    {/* Secci√≥n de archivo subido */}
                    <div style={{ display: localDoc.uploaded ? 'block' : 'none' }}>
                        <div className="doc-file-info">
                            <div className="doc-file-name" title={localDoc.fileName}>{localDoc.fileName}</div>
                            <div className="doc-file-date">
                                {localDoc.uploadDate ? new Date(localDoc.uploadDate).toLocaleDateString('es-MX') : ''}
                            </div>
                        </div>
                        <div className="doc-actions">
                            <button type="button" className="doc-action-btn view" onClick={() => viewPdfInNewTab(localDoc)} title="Ver PDF">
                                <i data-lucide="Eye" size="14"></i>
                            </button>
                            <button type="button" className="doc-action-btn download" onClick={() => downloadPdf(localDoc)} title="Descargar">
                                <i data-lucide="Download" size="14"></i>
                            </button>
                            <button type="button" className="doc-action-btn delete" onClick={handleDelete} title="Eliminar">
                                <i data-lucide="Trash2" size="14"></i>
                            </button>
                        </div>
                    </div>

                    {/* Secci√≥n de subida - SIN iconos de Lucide para evitar conflicto */}
                    <div style={{ display: localDoc.uploaded ? 'none' : 'block' }}>
                        <input
                            ref={inputRef}
                            type="file"
                            accept=".pdf,.png,application/pdf,image/png"
                            style={{ display: 'none' }}
                            onChange={handleUpload}
                            disabled={uploading}
                        />
                        <div
                            onClick={() => !uploading && inputRef.current?.click()}
                            className="doc-upload-mini"
                            style={{ cursor: uploading ? 'wait' : 'pointer', opacity: uploading ? 0.6 : 1 }}
                        >
                            {uploading ? (
                                <>
                                    <div className="sync-spinner" style={{ width: 16, height: 16, marginBottom: '0.25rem' }}></div>
                                    <div>Subiendo...</div>
                                </>
                            ) : (
                                <>
                                    <span style={{ fontSize: '18px', marginBottom: '0.25rem' }}>üìÑ</span>
                                    <div>PDF / PNG</div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // HISTORIAL DE CAMBIOS
        // =====================================================
        // Campos que se rastrean en el historial (excluyendo metadata)
        const TRACKED_FIELDS = [
            'Nombre', 'Numero de booking', 'Numero de BL', 'Fecha',
            'Fecha de embarque', 'Fecha de arribo', 'Status', 'SI', 'Cut off',
            'Contenedores', 'Peso', 'Analisis', 'Flete', 'Costo agencia',
            '$venta', '$deben', '10%', 'Anticipos', 'anticipoPagado', 'Agencia aduanal',
            'Origen', 'Destino', 'Cliente', 'Proveedor', 'Producto', 'Notas'
        ];

        // Labels legibles para los campos
        const FIELD_LABELS = {
            'Nombre': 'Nombre',
            'Numero de booking': 'Booking',
            'Numero de BL': 'BL',
            'Fecha': 'Fecha',
            'Fecha de embarque': 'Embarque',
            'Fecha de arribo': 'Arribo',
            'Status': 'Status',
            'SI': 'SI',
            'Cut off': 'Cut Off',
            'Contenedores': 'Contenedores',
            'Peso': 'Peso',
            'Analisis': 'An√°lisis',
            'Flete': 'Flete',
            '$venta': 'Venta',
            '$deben': 'Deben',
            '10%': '10%',
            'Anticipos': 'Anticipos',
            'anticipoPagado': 'Anticipo Pagado',
            'Costo agencia': 'Costo Agencia',
            'Agencia aduanal': 'Agencia Aduanal',
            'Origen': 'Origen',
            'Destino': 'Destino',
            'Cliente': 'Cliente',
            'Proveedor': 'Proveedor',
            'Producto': 'Producto',
            'Notas': 'Notas'
        };

        // =====================================================
        // VALIDACION DE CAMPOS NUMERICOS
        // =====================================================
        // Campos que deben ser num√©ricos (enteros o decimales)
        const NUMERIC_FIELDS = [
            'Contenedores',  // Entero
            'Peso',          // Decimal (toneladas)
            'Analisis',      // Decimal (porcentaje)
            'Flete',         // Decimal (dinero)
            'Costo agencia', // Decimal (dinero)
            '$venta',        // Decimal (dinero)
            '$deben',        // Decimal (dinero)
            '10%',           // Decimal (dinero)
            'Anticipos'      // Decimal (dinero)
        ];

        // Campos que solo aceptan enteros
        const INTEGER_FIELDS = ['Contenedores'];

        // Validar si un valor es num√©rico v√°lido
        const isValidNumeric = (value, isInteger = false) => {
            if (value === '' || value === null || value === undefined) return true; // Vac√≠o es v√°lido
            const str = String(value).trim();
            if (str === '') return true;

            // Permitir n√∫meros con comas como separador de miles (ej: 1,234.56)
            const cleanValue = str.replace(/,/g, '');

            if (isInteger) {
                return /^-?\d+$/.test(cleanValue);
            }
            return /^-?\d*\.?\d*$/.test(cleanValue) && cleanValue !== '.' && cleanValue !== '-';
        };

        // Limpiar valor num√©rico (remover caracteres no v√°lidos)
        const cleanNumericValue = (value, isInteger = false) => {
            if (value === '' || value === null || value === undefined) return '';
            let str = String(value).trim();

            // Remover todo excepto d√≠gitos, punto, coma y signo negativo
            str = str.replace(/[^\d.,-]/g, '');

            // Reemplazar comas por nada (asumimos formato US)
            str = str.replace(/,/g, '');

            // Si es entero, remover punto decimal
            if (isInteger) {
                str = str.replace(/\./g, '');
            }

            // Asegurar solo un punto decimal
            const parts = str.split('.');
            if (parts.length > 2) {
                str = parts[0] + '.' + parts.slice(1).join('');
            }

            return str;
        };

        // Verificar si un campo es num√©rico
        const isNumericField = (fieldName) => NUMERIC_FIELDS.includes(fieldName);
        const isIntegerField = (fieldName) => INTEGER_FIELDS.includes(fieldName);

        // Detectar cambios entre viaje original y modificado
        const detectChanges = (original, modified) => {
            const cambios = {};
            TRACKED_FIELDS.forEach(field => {
                const valorAntes = original[field] ?? '';
                const valorDespues = modified[field] ?? '';
                // Convertir a string para comparar
                const antes = String(valorAntes).trim();
                const despues = String(valorDespues).trim();
                if (antes !== despues) {
                    cambios[field] = { antes, despues };
                }
            });
            return cambios;
        };

        // Crear entrada de historial
        const createHistorialEntry = (accion, cambios = {}, usuario = 'local') => ({
            id: generateUUID(),
            fecha: new Date().toISOString(),
            usuario,
            accion,
            cambios
        });

        // Formatear fecha para mostrar en historial
        const formatHistorialDate = (isoDate) => {
            const d = new Date(isoDate);
            const fecha = d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
            const hora = d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
            return { fecha, hora };
        };

        // Formatear valores de cambios para mostrar en historial
        const formatChangeValue = (campo, valor) => {
            if (campo === 'anticipoPagado') {
                return valor === 'true' ? 'Pagado' : valor === 'false' ? 'Pendiente' : valor || '(vacio)';
            }
            return valor || '(vacio)';
        };

        // Componente para mostrar campo con indicador de cambio (FUERA del modal para evitar re-renders)
        const FieldWithChange = ({ label, field, children, originalField, isNew, original, form, errors }) => {
            const fieldToCheck = originalField || field;
            const origValue = original?.[fieldToCheck];
            const newValue = form?.[fieldToCheck];
            const changed = !isNew && origValue !== undefined && String(origValue || '') !== String(newValue || '');
            const hasError = errors?.[field];

            return (
                <div className={`form-group ${hasError ? 'has-error' : ''}`} style={{ position: 'relative' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                        {label}
                        {changed && <span style={{ fontSize: '0.7rem', background: 'var(--warning)', color: 'white', padding: '0.1rem 0.4rem', borderRadius: '4px' }}>Modificado</span>}
                    </label>
                    {children}
                    {hasError && <div className="form-error">{hasError}</div>}
                    {changed && origValue && !hasError && (
                        <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                            Anterior: <span style={{ textDecoration: 'line-through' }}>{origValue}</span>
                        </div>
                    )}
                </div>
            );
        };

        // =====================================================
        // EDIT VIAJE MODAL
        // =====================================================
        const EditViajeModal = ({ viaje, onClose, onSave, onDelete, isNew, originalViaje, initialTab = 'general' }) => {
            const [form, setForm] = useState({ ...viaje });
            const [activeTab, setActiveTab] = useState(initialTab);
            const [errors, setErrors] = useState({}); // Estado para errores de validaci√≥n
            // Guardar valores originales para comparar (si viene de BL update)
            const original = originalViaje || viaje;

            useEffect(() => { lucide.createIcons(); }, [activeTab]);

            // Setter con validaci√≥n para campos num√©ricos
            const set = (field, value) => {
                // Validar campos num√©ricos (solo mostrar error, no modificar valor)
                if (isNumericField(field)) {
                    const isInteger = isIntegerField(field);

                    // Validar y mostrar error si hay caracteres no num√©ricos
                    if (value !== '' && !isValidNumeric(value, isInteger)) {
                        setErrors(prev => ({ ...prev, [field]: isInteger ? 'Solo numeros enteros' : 'Solo numeros' }));
                    } else {
                        setErrors(prev => {
                            const newErrors = { ...prev };
                            delete newErrors[field];
                            return newErrors;
                        });
                    }
                }
                // Guardar el valor tal como est√° (sin limpiar)
                setForm(prev => ({ ...prev, [field]: value }));
            };

            // Props comunes para FieldWithChange (para evitar repetir)
            const fieldProps = { isNew, original, form, errors };

            // Detectar si hay cambios sin guardar
            const hasUnsavedChanges = () => {
                // Campos importantes a comparar (excluir metadata y documentos)
                const fieldsToCompare = [
                    'Nombre', 'Numero de booking', 'Numero de BL', 'Fecha',
                    'Fecha de embarque', 'Fecha de arribo', 'Status', 'SI', 'Cut off',
                    'Contenedores', 'Peso', 'Analisis', 'Flete', 'Costo agencia',
                    '$venta', '$deben', '10%', 'Anticipos', 'anticipoPagado', 'Agencia aduanal',
                    'Origen', 'Destino', 'Cliente', 'Proveedor', 'Producto', 'Notas'
                ];

                for (const field of fieldsToCompare) {
                    const originalVal = String(viaje[field] || '').trim();
                    const currentVal = String(form[field] || '').trim();
                    if (originalVal !== currentVal) {
                        return true;
                    }
                }
                return false;
            };

            // Cerrar modal con confirmaci√≥n si hay cambios
            const handleClose = () => {
                if (hasUnsavedChanges()) {
                    if (confirm('¬øDescartar cambios sin guardar?')) {
                        onClose();
                    }
                } else {
                    onClose();
                }
            };

            // Tecla ESC cierra el modal
            useEffect(() => {
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        handleClose();
                    }
                };
                document.addEventListener('keydown', handleEsc);
                return () => document.removeEventListener('keydown', handleEsc);
            }, [form, viaje]); // Dependencias para que handleClose tenga los valores actuales

            const handleSubmit = (e) => {
                e.preventDefault();
                // Verificar si hay errores de validaci√≥n
                if (Object.keys(errors).length > 0) {
                    const errorFields = Object.keys(errors).map(f => FIELD_LABELS[f] || f).join(', ');
                    alert('Por favor corrige los errores en: ' + errorFields);
                    return;
                }
                // Limpiar valores num√©ricos antes de guardar
                const cleanedForm = { ...form };
                NUMERIC_FIELDS.forEach(field => {
                    if (cleanedForm[field]) {
                        cleanedForm[field] = cleanNumericValue(cleanedForm[field], isIntegerField(field));
                    }
                });
                onSave(cleanedForm);
            };

            const STATUS_OPTIONS = [
                { value: '', label: 'Seleccionar...' },
                { value: 'Programacion', label: 'Programacion' },
                { value: 'Ingresados', label: 'Ingresados' },
                { value: 'Altamar', label: 'Altamar' },
                { value: 'Liberado', label: 'Liberado' },
                { value: 'Pago 10%', label: 'Pago 10%' },
                { value: 'cerrado', label: 'Cerrado' },
            ];

            // Logica para SI y Cut off:
            // "Verde" = completado exitosamente (la fecha ya paso y todo bien)
            // Fecha = fecha limite pendiente
            // Vacio = no establecido
            const getSIStatus = () => {
                if (form.SI === 'Verde') return 'verde';
                if (form.SI && form.SI !== 'Verde') return 'fecha';
                return 'pendiente';
            };

            const getCutoffStatus = () => {
                if (form['Cut off'] === 'Verde') return 'verde';
                if (form['Cut off'] && form['Cut off'] !== 'Verde') return 'fecha';
                return 'pendiente';
            };

            return (
                <div className="modal-overlay" onClick={handleClose}>
                    <div className="modal-card" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{isNew ? 'Nuevo Viaje' : `Editar: ${form.Nombre || 'Viaje'}`}</h3>
                            <button onClick={handleClose} style={{ border: 'none', background: 'none', cursor: 'pointer', padding: '0.5rem' }}>
                                <i data-lucide="X" size="20"></i>
                            </button>
                        </div>

                        <div style={{ display: 'flex', gap: '0.25rem', padding: '0 1.5rem', background: '#f8fafc', borderBottom: '1px solid var(--border)' }}>
                            {[
                                { id: 'general', label: 'General', icon: 'FileText' },
                                { id: 'logistica', label: 'Logistica', icon: 'Ship' },
                                { id: 'finanzas', label: 'Finanzas', icon: 'DollarSign' },
                                { id: 'documentos', label: 'Documentos', icon: 'Folder' },
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{
                                    padding: '0.875rem 1.25rem', border: 'none',
                                    background: activeTab === tab.id ? 'white' : 'transparent',
                                    borderBottom: activeTab === tab.id ? '2px solid var(--primary)' : '2px solid transparent',
                                    cursor: 'pointer', fontWeight: activeTab === tab.id ? 600 : 500,
                                    color: activeTab === tab.id ? 'var(--primary)' : 'var(--text-muted)',
                                    display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.8125rem', marginBottom: '-1px'
                                }}>
                                    <i data-lucide={tab.icon} size="16"></i>{tab.label}
                                </button>
                            ))}
                        </div>

                        <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, overflow: 'hidden' }}>
                            <div className="modal-body" style={{ flex: 1, minHeight: 0, overflowY: 'auto' }}>
                                {activeTab === 'general' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="User" size="16"></i>Informacion Basica</div>
                                            <div className="form-grid">
                                                <div className="form-group span-2">
                                                    <label>Nombre / Cliente *</label>
                                                    <input type="text" value={form.Nombre || ''} onChange={e => set('Nombre', e.target.value)} required placeholder="Ej: Exportadora ABC" />
                                                </div>
                                                <div className="form-group">
                                                    <label>Fecha</label>
                                                    <input type="date" value={formatDateForInput(form.Fecha)} onChange={e => set('Fecha', e.target.value)} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Status</label>
                                                    <select value={form.Status || ''} onChange={e => set('Status', e.target.value)}>
                                                        {STATUS_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                                    </select>
                                                </div>
                                                <div className="form-group">
                                                    <label>Numero de Booking</label>
                                                    <input type="text" value={form['Numero de booking'] || ''} onChange={e => set('Numero de booking', e.target.value)} placeholder="EBKG..." />
                                                </div>
                                                <FieldWithChange label="Numero de BL" field="Numero de BL" {...fieldProps}>
                                                    <input type="text" value={form['Numero de BL'] || ''} onChange={e => set('Numero de BL', e.target.value)} placeholder="MEDU..." />
                                                </FieldWithChange>
                                            </div>
                                        </div>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Box" size="16"></i>Carga</div>
                                            <div className="form-grid">
                                                <FieldWithChange label="Contenedores" field="Contenedores" {...fieldProps}>
                                                    <input type="text" inputMode="numeric" value={form.Contenedores || ''} onChange={e => set('Contenedores', e.target.value)} placeholder="Ej: 2" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Peso (toneladas)" field="Peso" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Peso || ''} onChange={e => set('Peso', e.target.value)} placeholder="Ej: 25.5" />
                                                </FieldWithChange>
                                                <FieldWithChange label="An√°lisis (%)" field="Analisis" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Analisis || ''} onChange={e => set('Analisis', e.target.value)} placeholder="Ej: 15.5" />
                                                </FieldWithChange>
                                            </div>
                                        </div>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="FileText" size="16"></i>Notas</div>
                                            <div className="form-group">
                                                <label>Observaciones</label>
                                                <textarea value={form.Notas || ''} onChange={e => set('Notas', e.target.value)} placeholder="Notas adicionales sobre el viaje..." />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'logistica' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Calendar" size="16"></i>Fechas de Transito</div>
                                            <div className="form-grid-2">
                                                <div className="form-group">
                                                    <label>Fecha de Embarque (ETD)</label>
                                                    <input type="date" value={formatDateForInput(form['Fecha de embarque'])} onChange={e => set('Fecha de embarque', e.target.value)} />
                                                </div>
                                                <div className="form-group">
                                                    <label>Fecha de Arribo (ETA)</label>
                                                    <input type="date" value={formatDateForInput(form['Fecha de arribo'])} onChange={e => set('Fecha de arribo', e.target.value)} />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Clock" size="16"></i>Cutoffs y Deadlines</div>
                                            <div className="form-grid-2">
                                                <div className="form-group">
                                                    <label>SI (Shipping Instructions)</label>
                                                    <select value={getSIStatus()} onChange={e => {
                                                        if (e.target.value === 'verde') set('SI', 'Verde');
                                                        else if (e.target.value === 'pendiente') set('SI', '');
                                                        else set('SI', form.SI === 'Verde' ? '' : form.SI);
                                                    }} style={{ marginBottom: '0.5rem' }}>
                                                        <option value="pendiente">Pendiente</option>
                                                        <option value="fecha">Con fecha limite</option>
                                                        <option value="verde">Verde (Completado)</option>
                                                    </select>
                                                    {getSIStatus() === 'fecha' && (
                                                        <input type="date" value={formatDateForInput(form.SI)} onChange={e => set('SI', e.target.value)} />
                                                    )}
                                                    {getSIStatus() === 'verde' && <div className="verde-badge"><i data-lucide="CheckCircle" size="16"></i>Completado exitosamente</div>}
                                                    {getSIStatus() === 'pendiente' && <div className="pending-badge"><i data-lucide="Clock" size="16"></i>Sin establecer</div>}
                                                </div>

                                                <div className="form-group">
                                                    <label>Cut Off (VGM)</label>
                                                    <select value={getCutoffStatus()} onChange={e => {
                                                        if (e.target.value === 'verde') set('Cut off', 'Verde');
                                                        else if (e.target.value === 'pendiente') set('Cut off', '');
                                                        else set('Cut off', form['Cut off'] === 'Verde' ? '' : form['Cut off']);
                                                    }} style={{ marginBottom: '0.5rem' }}>
                                                        <option value="pendiente">Pendiente</option>
                                                        <option value="fecha">Con fecha limite</option>
                                                        <option value="verde">Verde (Completado)</option>
                                                    </select>
                                                    {getCutoffStatus() === 'fecha' && (
                                                        <input type="date" value={formatDateForInput(form['Cut off'])} onChange={e => set('Cut off', e.target.value)} />
                                                    )}
                                                    {getCutoffStatus() === 'verde' && <div className="verde-badge"><i data-lucide="CheckCircle" size="16"></i>Completado exitosamente</div>}
                                                    {getCutoffStatus() === 'pendiente' && <div className="pending-badge"><i data-lucide="Clock" size="16"></i>Sin establecer</div>}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="Building" size="16"></i>Agencia</div>
                                            <div className="form-group">
                                                <label>Agencia Aduanal</label>
                                                <input type="text" value={form['Agencia aduanal'] || ''} onChange={e => set('Agencia aduanal', e.target.value)} />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'finanzas' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="CreditCard" size="16"></i>Costos de Transporte</div>
                                            <div className="form-grid-2">
                                                <FieldWithChange label="Flete (USD)" field="Flete" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Flete || ''} onChange={e => set('Flete', e.target.value)} placeholder="Ej: 5000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Costo Agencia (MXN)" field="Costo agencia" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['Costo agencia'] || ''} onChange={e => set('Costo agencia', e.target.value)} placeholder="Ej: 15000" />
                                                </FieldWithChange>
                                            </div>
                                        </div>
                                        <div className="form-section">
                                            <div className="form-section-title"><i data-lucide="TrendingUp" size="16"></i>Venta y Cobranza</div>
                                            <div className="form-grid">
                                                <FieldWithChange label="Venta Total (USD)" field="$venta" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['$venta'] || ''} onChange={e => set('$venta', e.target.value)} placeholder="Ej: 50000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Saldo Pendiente (USD)" field="$deben" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['$deben'] || ''} onChange={e => set('$deben', e.target.value)} placeholder="Ej: 10000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="10% Retencion" field="10%" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form['10%'] || ''} onChange={e => set('10%', e.target.value)} placeholder="Ej: 5000" />
                                                </FieldWithChange>
                                                <FieldWithChange label="Anticipos" field="Anticipos" {...fieldProps}>
                                                    <input type="text" inputMode="decimal" value={form.Anticipos || ''} onChange={e => set('Anticipos', e.target.value)} placeholder="Ej: 20000" />
                                                </FieldWithChange>
                                                <div className="form-group">
                                                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                                                        <input
                                                            type="checkbox"
                                                            checked={form.anticipoPagado || false}
                                                            onChange={e => set('anticipoPagado', e.target.checked)}
                                                            style={{ width: '18px', height: '18px', accentColor: 'var(--success)' }}
                                                        />
                                                        <span style={{
                                                            color: form.anticipoPagado ? 'var(--success)' : 'var(--text-muted)',
                                                            fontWeight: form.anticipoPagado ? 600 : 400
                                                        }}>
                                                            {form.anticipoPagado ? 'Anticipo Pagado' : 'Anticipo Pendiente'}
                                                        </span>
                                                    </label>
                                                </div>
                                                <div className="form-group">
                                                    <label>Agencia Aduanal</label>
                                                    <input type="text" value={form['Agencia aduanal'] || ''} onChange={e => set('Agencia aduanal', e.target.value)} />
                                                </div>
                                            </div>
                                        </div>
                                        <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '1.25rem' }}>
                                            <div style={{ fontSize: '0.75rem', fontWeight: 700, color: 'var(--text-muted)', marginBottom: '1rem', textTransform: 'uppercase' }}>Resumen</div>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem' }}>
                                                <div><div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>Venta (USD)</div><div style={{ fontSize: '1.125rem', fontWeight: 700, color: 'var(--success)' }}>{formatUSD(form['$venta'] || 0)}</div></div>
                                                <div><div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>Por Cobrar (USD)</div><div style={{ fontSize: '1.125rem', fontWeight: 700, color: Number(form['$deben']) > 0 ? 'var(--danger)' : 'var(--text-main)' }}>{formatUSD(form['$deben'] || 0)}</div></div>
                                                <div><div style={{ fontSize: '0.6875rem', color: 'var(--text-muted)' }}>Flete (USD)</div><div style={{ fontSize: '1.125rem', fontWeight: 700, color: 'var(--info)' }}>{formatUSD(form.Flete || 0)}</div></div>
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'documentos' && (
                                    <>
                                        <div className="form-section">
                                            <div className="form-section-title" style={{ display: 'flex', alignItems: 'center' }}>
                                                <i data-lucide="Folder" size="16"></i>
                                                <span style={{ marginLeft: '0.5rem' }}>Documentos del Viaje</span>
                                                <span className="badge" style={{
                                                    marginLeft: 'auto',
                                                    background: getDocsColor(countUploadedDocs(form.documentos)),
                                                    color: 'white'
                                                }}>
                                                    {countUploadedDocs(form.documentos)}/8
                                                </span>
                                            </div>

                                            {/* Barra de progreso */}
                                            <div className="docs-progress" style={{ marginBottom: '1.5rem' }}>
                                                <div className="docs-progress-bar">
                                                    <div
                                                        className="docs-progress-fill"
                                                        style={{
                                                            width: `${(countUploadedDocs(form.documentos) / 8) * 100}%`,
                                                            background: getDocsColor(countUploadedDocs(form.documentos))
                                                        }}
                                                    ></div>
                                                </div>
                                                <span style={{ color: 'var(--text-muted)' }}>
                                                    {countUploadedDocs(form.documentos) === 8 ? 'Completo' : `${8 - countUploadedDocs(form.documentos)} pendientes`}
                                                </span>
                                            </div>

                                            {/* Grid de documentos */}
                                            <div className="docs-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' }}>
                                                {DOCUMENT_TYPES.map(docType => (
                                                    <DocumentCard
                                                        key={docType.id}
                                                        docType={docType}
                                                        doc={form.documentos?.[docType.id] || { uploaded: false }}
                                                        tripId={form.tripId}
                                                        tripName={form.Nombre}
                                                        documentos={form.documentos}
                                                        onUpdate={(newDocs, docTypeId, action, fileName) => {
                                                            // Actualizar estado local
                                                            const updatedForm = { ...form, documentos: newDocs };

                                                            // Agregar al historial si se subio o elimino un documento
                                                            if (docTypeId && action) {
                                                                const docLabel = DOCUMENT_TYPES.find(d => d.id === docTypeId)?.label || docTypeId;
                                                                const historial = updatedForm.historial || [];
                                                                const usuario = 'local'; // Se actualizara en handleSave
                                                                if (action === 'upload') {
                                                                    historial.push(createHistorialEntry('Documento subido', { [docLabel]: { antes: '', despues: fileName || 'archivo' } }, usuario));
                                                                } else if (action === 'delete') {
                                                                    historial.push(createHistorialEntry('Documento eliminado', { [docLabel]: { antes: fileName || 'archivo', despues: '' } }, usuario));
                                                                }
                                                                updatedForm.historial = historial;
                                                            }

                                                            setForm(updatedForm);
                                                            // Guardar autom√°ticamente el viaje
                                                            onSave(updatedForm);
                                                        }}
                                                    />
                                                ))}
                                            </div>
                                        </div>

                                        <div style={{ background: '#d1fae5', border: '1px solid #6ee7b7', borderRadius: '8px', padding: '1rem', marginTop: '1rem' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#065f46', fontSize: '0.8125rem' }}>
                                                <i data-lucide="Cloud" size="16"></i>
                                                <span><strong>Supabase Storage:</strong> Acepta PDF y PNG. Maximo 50MB por archivo.</span>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="modal-footer">
                                <div>
                                    {!isNew && onDelete && <button type="button" className="btn-danger" onClick={() => onDelete(form)}><i data-lucide="Trash2" size="14"></i>Eliminar</button>}
                                    {form.lastModified && <span style={{ fontSize: '0.6875rem', color: 'var(--text-muted)', marginLeft: '1rem' }}>Modificado: {new Date(form.lastModified).toLocaleString()}</span>}
                                </div>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <button type="button" className="btn-secondary" onClick={handleClose}>Cancelar</button>
                                    <button type="submit" className="btn-primary">{isNew ? 'Crear Viaje' : 'Guardar'}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // =====================================================
        // PAGES
        // =====================================================
        const DashboardPage = ({ data, allData, onAdd, onEdit, onExport, onExportFiltered, onImport, summary }) => {
            const [kpiModal, setKpiModal] = useState(null);

            // Stats filtrados por fecha (data) excepto saldo, 10% y anticipos que usan allData
            const stats = useMemo(() => {
                const analisisValues = data.map(r => Number(r.Analisis) || 0).filter(v => v > 0);
                // 10% Cobrable: solo viajes con Status "Pago 10%"
                const diezPorciento = allData.filter(r => r.Status === 'Pago 10%').reduce((s, r) => s + (Number(r['10%']) || 0), 0);
                // Anticipos: Total de todos los viajes
                const anticiposTotal = allData.reduce((s, r) => s + (Number(r.Anticipos) || 0), 0);
                // Anticipos Pendientes: Solo los que NO estan pagados
                const anticiposPendientes = allData.filter(r => !r.anticipoPagado).reduce((s, r) => s + (Number(r.Anticipos) || 0), 0);
                // Anticipos Pagados
                const anticiposPagados = allData.filter(r => r.anticipoPagado).reduce((s, r) => s + (Number(r.Anticipos) || 0), 0);
                // Saldo Pendiente = Anticipos NO PAGADOS + 10% Cobrable
                const saldo = anticiposPendientes + diezPorciento;

                return {
                    viajes: data.length,
                    conts: data.reduce((s, r) => s + (Number(r.Contenedores) || 0), 0),
                    peso: data.reduce((s, r) => s + (Number(r.Peso) || 0), 0),
                    promedioAnalisis: analisisValues.length > 0 ? analisisValues.reduce((a, b) => a + b, 0) / analisisValues.length : 0,
                    venta: data.reduce((s, r) => s + (Number(r['$venta']) || 0), 0),
                    // Estos usan TODOS los datos (sin filtro de fecha)
                    saldo,
                    diezPorciento,
                    anticiposTotal,
                    anticiposPendientes,
                    anticiposPagados,
                };
            }, [data, allData]);

            // Filtros para cada KPI (saldo, 10% y anticipos usan allData)
            const kpiFilters = useMemo(() => ({
                viajes: { title: 'Todos los Viajes (en rango)', viajes: data },
                contenedores: { title: 'Viajes con Contenedores', viajes: data.filter(v => Number(v.Contenedores) > 0) },
                peso: { title: 'Viajes con Peso Registrado', viajes: data.filter(v => Number(v.Peso) > 0) },
                analisis: { title: 'Viajes con An√°lisis', viajes: data.filter(v => Number(v.Analisis) > 0) },
                venta: { title: 'Viajes con Venta', viajes: data.filter(v => Number(v['$venta']) > 0) },
                // Estos muestran TODOS los viajes (sin filtro de fecha)
                saldo: { title: 'Saldo Pendiente (Anticipos Pendientes + 10%)', viajes: allData.filter(v => (!v.anticipoPagado && Number(v.Anticipos) > 0) || (v.Status === 'Pago 10%' && Number(v['10%']) > 0)) },
                diezPorciento: { title: 'Viajes con Status Pago 10%', viajes: allData.filter(v => v.Status === 'Pago 10%') },
                anticiposPendientes: { title: 'Anticipos Pendientes', viajes: allData.filter(v => Number(v.Anticipos) > 0 && !v.anticipoPagado) },
                anticiposPagados: { title: 'Anticipos Pagados', viajes: allData.filter(v => Number(v.Anticipos) > 0 && v.anticipoPagado) },
            }), [data, allData]);

            useEffect(() => { lucide.createIcons(); }, [data, kpiModal]);

            const openKpiModal = (key) => setKpiModal(kpiFilters[key]);

            return (
                <div style={{ animation: 'fadeIn 0.3s' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Dashboard</h2>
                        <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                            <button className="btn-secondary" onClick={onImport}><i data-lucide="Upload" size="16"></i>Importar</button>
                            <button className="btn-secondary" onClick={onExport} title="Descargar TODOS los viajes"><i data-lucide="Download" size="16"></i>Exportar Todo</button>
                            <button className="btn-outline" onClick={onExportFiltered} title="Solo viajes del rango de fechas seleccionado"><i data-lucide="Filter" size="16"></i>Solo Filtrados</button>
                            <button className="btn-primary" onClick={onAdd}><i data-lucide="Plus" size="16"></i>Nuevo Viaje</button>
                        </div>
                    </div>

                    <div className="dashboard-grid">
                        <KPICard label="Viajes en Rango" value={stats.viajes} icon="Ship" clickable onClick={() => openKpiModal('viajes')} />
                        <KPICard label="Contenedores" value={formatNumber(stats.conts)} icon="Box" clickable onClick={() => openKpiModal('contenedores')} />
                        <KPICard label="Peso Total (t)" value={formatNumber(stats.peso)} icon="Scale" clickable onClick={() => openKpiModal('peso')} />
                        <KPICard label="Promedio Analisis" value={formatPercent(stats.promedioAnalisis)} icon="BarChart3" clickable onClick={() => openKpiModal('analisis')} />
                        <KPICard label="Venta Total" value={formatCurrency(stats.venta)} icon="TrendingUp" clickable onClick={() => openKpiModal('venta')} />
                        <KPICard label="Saldo Pendiente" value={formatCurrency(stats.saldo)} icon="Clock" clickable onClick={() => openKpiModal('saldo')} />
                        <KPICard label="10% Cobrable" value={formatCurrency(stats.diezPorciento)} icon="Percent" clickable onClick={() => openKpiModal('diezPorciento')} />
                        <KPICard label="Anticipos Pendientes" value={formatCurrency(stats.anticiposPendientes)} icon="Wallet" color="var(--warning)" clickable onClick={() => openKpiModal('anticiposPendientes')} />
                        <KPICard label="Anticipos Pagados" value={formatCurrency(stats.anticiposPagados)} icon="CircleCheck" color="var(--success)" clickable onClick={() => openKpiModal('anticiposPagados')} />
                    </div>

                    {data.length > 0 && (
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '1.5rem', marginBottom: '1.5rem' }}>
                            <div className="table-card" style={{ padding: '1.5rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <span style={{ fontWeight: 600 }}>Ventas por Mes</span>
                                    <span className="badge bg-purple">Ultimos 6 meses</span>
                                </div>
                                <div style={{ height: '280px' }}>
                                    <SalesChart data={data} />
                                </div>
                            </div>
                            <div className="table-card" style={{ padding: '1.5rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <span style={{ fontWeight: 600 }}>Distribucion por Status</span>
                                    <span className="badge bg-cyan">{allData.filter(v => (v.Status || '').toLowerCase() !== 'cerrado').length} activos</span>
                                </div>
                                <div style={{ height: '280px' }}>
                                    <StatusPieChart data={allData} />
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="table-card">
                        <div style={{ padding: '1rem 1.25rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ fontWeight: 600 }}>Ultimos Viajes</span>
                        </div>
                        <div style={{ overflowX: 'auto' }}>
                            <table>
                                <thead><tr><th>Nombre</th><th>Booking</th><th>Contenedores</th><th>Peso</th><th>Analisis</th><th>Venta Total</th><th>Anticipo</th><th></th></tr></thead>
                                <tbody>
                                    {data.slice(0, 8).map((r, i) => (
                                        <tr key={r.tripId || i}>
                                            <td style={{ fontWeight: 500 }}>{r.Nombre || '-'}</td>
                                            <td>{r['Numero de booking'] || '-'}</td>
                                            <td>{r.Contenedores || '-'}</td>
                                            <td>{r.Peso ? formatNumber(r.Peso) : '-'}</td>
                                            <td>{r.Analisis ? formatPercent(r.Analisis) : '-'}</td>
                                            <td style={{ fontWeight: 600, color: 'var(--success)' }}>{formatCurrency(r['$venta'])}</td>
                                            <td style={{ fontWeight: 500, color: 'var(--warning)' }}>{r.Anticipos ? formatCurrency(r.Anticipos) : '-'}</td>
                                            <td><button onClick={() => onEdit(r)} style={{ border: 'none', background: '#f1f5f9', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}><i data-lucide="Edit2" size="14" color="var(--primary)"></i></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {data.length === 0 && <div style={{ padding: '3rem', textAlign: 'center', color: 'var(--text-muted)' }}>No hay viajes. Importa un Excel o crea uno nuevo.</div>}
                        </div>
                    </div>

                    {kpiModal && (
                        <KPIDetailModal
                            title={kpiModal.title}
                            viajes={kpiModal.viajes}
                            onClose={() => setKpiModal(null)}
                            onEdit={onEdit}
                        />
                    )}
                </div>
            );
        };

        const ViajesPage = ({ data, onEdit, onEditDocs, onDelete, onAdd, onExport, onImport }) => {
            const [searchInput, setSearchInput] = useState(''); // Valor inmediato del input
            const [search, setSearch] = useState(''); // Valor con debounce para filtrar
            const [filterStatus, setFilterStatus] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'Fecha', direction: 'desc' });

            // Debounce: actualizar b√∫squeda 300ms despu√©s de dejar de escribir
            useEffect(() => {
                const timer = setTimeout(() => {
                    setSearch(searchInput);
                }, 300);
                return () => clearTimeout(timer);
            }, [searchInput]);

            const columns = [
                { key: 'Fecha', label: 'Fecha', type: 'date' },
                { key: 'Nombre', label: 'Nombre', type: 'string' },
                { key: 'Numero de booking', label: 'Booking', type: 'string' },
                { key: 'Numero de BL', label: 'BL', type: 'string' },
                { key: 'Status', label: 'Status', type: 'string' },
                { key: 'Docs', label: 'Docs', type: 'docs' },
                { key: 'Contenedores', label: 'Conts', type: 'number' },
                { key: 'Peso', label: 'Peso', type: 'number' },
                { key: 'Analisis', label: 'Analisis', type: 'number' },
                { key: 'SI', label: 'SI', type: 'date' },
                { key: 'Cut off', label: 'Cut Off', type: 'date' },
                { key: 'Fecha de embarque', label: 'Embarque', type: 'date' },
                { key: 'Fecha de arribo', label: 'Arribo', type: 'date' },
                { key: 'Flete', label: 'Flete USD', type: 'number' },
                { key: '$venta', label: 'Venta', type: 'number' },
                { key: '$deben', label: 'Saldo', type: 'number' },
                { key: '10%', label: '10%', type: 'number' },
                { key: 'Anticipos', label: 'Anticipos', type: 'number' },
                { key: 'Agencia aduanal', label: 'Agencia', type: 'string' },
            ];

            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
                }));
            };

            const sorted = useMemo(() => {
                const filtered = data.filter(v => {
                    const matchSearch = !search || (v.Nombre || '').toLowerCase().includes(search.toLowerCase()) || (v['Numero de booking'] || '').toLowerCase().includes(search.toLowerCase()) || (v['Numero de BL'] || '').toLowerCase().includes(search.toLowerCase());
                    const matchStatus = !filterStatus || v.Status === filterStatus;
                    return matchSearch && matchStatus;
                });

                return [...filtered].sort((a, b) => {
                    const col = columns.find(c => c.key === sortConfig.key);
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];

                    if (col?.type === 'date') {
                        aVal = robustParseDate(aVal)?.getTime() || 0;
                        bVal = robustParseDate(bVal)?.getTime() || 0;
                    } else if (col?.type === 'number') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }

                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [data, search, filterStatus, sortConfig]);

            const statuses = useMemo(() => [...new Set(data.map(v => v.Status).filter(Boolean))], [data]);
            useEffect(() => { lucide.createIcons(); }, [sorted, sortConfig]);

            const SortHeader = ({ col }) => (
                <th onClick={() => handleSort(col.key)} style={{ cursor: 'pointer', userSelect: 'none', whiteSpace: 'nowrap' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                        {col.label}
                        {sortConfig.key === col.key ? (
                            <i data-lucide={sortConfig.direction === 'asc' ? 'ChevronUp' : 'ChevronDown'} size="14" color="var(--primary)"></i>
                        ) : (
                            <i data-lucide="ChevronsUpDown" size="14" color="#cbd5e1"></i>
                        )}
                    </div>
                </th>
            );

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Todos los Viajes ({sorted.length})</h2>
                        <div style={{ display: 'flex', gap: '0.75rem' }}>
                            <button className="btn-secondary" onClick={onImport}><i data-lucide="Upload" size="16"></i>Importar</button>
                            <button className="btn-secondary" onClick={onExport} title="Descargar TODOS los viajes"><i data-lucide="Download" size="16"></i>Exportar Todo</button>
                            <button className="btn-primary" onClick={onAdd}><i data-lucide="Plus" size="16"></i>Nuevo</button>
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                        <div style={{ position: 'relative', flex: 1, minWidth: '200px' }}>
                            <i data-lucide="Search" size="18" style={{ position: 'absolute', left: '0.75rem', top: '50%', transform: 'translateY(-50%)', color: 'var(--text-muted)' }}></i>
                            <input type="text" placeholder="Buscar..." value={searchInput} onChange={(e) => setSearchInput(e.target.value)} style={{ width: '100%', padding: '0.625rem 1rem 0.625rem 2.5rem', border: '1px solid var(--border)', borderRadius: '8px', fontSize: '0.875rem' }} />
                        </div>
                        <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} style={{ padding: '0.625rem 1rem', borderRadius: '8px', border: '1px solid var(--border)' }}>
                            <option value="">Todos los Status</option>
                            {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                    </div>

                    <div className="table-card">
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ fontSize: '0.75rem' }}>
                                <thead>
                                    <tr>
                                        {columns.map(col => <SortHeader key={col.key} col={col} />)}
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sorted.map((r, i) => {
                                        const docsCount = countUploadedDocs(r.documentos);
                                        return (
                                        <tr key={r.tripId || i}>
                                            <td style={{ whiteSpace: 'nowrap' }}>{formatDateSpanish(r.Fecha)}</td>
                                            <td style={{ fontWeight: 500, whiteSpace: 'nowrap' }}>{r.Nombre || '-'}</td>
                                            <td>{r['Numero de booking'] || '-'}</td>
                                            <td>{r['Numero de BL'] || '-'}</td>
                                            <td><span className={`badge ${r.Status === 'cerrado' ? 'bg-green' : r.Status === 'Altamar' ? 'bg-cyan' : r.Status === 'Pago 10%' ? 'bg-purple' : 'bg-blue'}`}>{r.Status || '-'}</span></td>
                                            <td>
                                                <span
                                                    onClick={() => onEditDocs(r)}
                                                    style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '0.25rem',
                                                        padding: '0.25rem 0.5rem',
                                                        borderRadius: '6px',
                                                        fontSize: '0.75rem',
                                                        fontWeight: 600,
                                                        background: docsCount === 8 ? 'rgba(34, 197, 94, 0.1)' : docsCount > 0 ? 'rgba(59, 130, 246, 0.1)' : 'var(--hover-bg)',
                                                        color: getDocsColor(docsCount),
                                                        cursor: 'pointer',
                                                        transition: 'transform 0.1s'
                                                    }}
                                                    title="Ver documentos"
                                                    onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                                    onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                                >
                                                    <i data-lucide="Folder" size="12"></i>
                                                    {docsCount}/6
                                                </span>
                                            </td>
                                            <td>{r.Contenedores || '-'}</td>
                                            <td>{r.Peso ? formatNumber(r.Peso) : '-'}</td>
                                            <td>{r.Analisis ? formatPercent(r.Analisis) : '-'}</td>
                                            <td>{r.SI === 'Verde' ? <span className="badge bg-green">Verde</span> : r.SI ? formatDateSpanish(r.SI) : '-'}</td>
                                            <td>{r['Cut off'] === 'Verde' ? <span className="badge bg-green">Verde</span> : r['Cut off'] ? formatDateSpanish(r['Cut off']) : '-'}</td>
                                            <td style={{ whiteSpace: 'nowrap' }}>{formatDateSpanish(r['Fecha de embarque'])}</td>
                                            <td style={{ whiteSpace: 'nowrap' }}>{formatDateSpanish(r['Fecha de arribo'])}</td>
                                            <td>{r.Flete ? formatUSD(r.Flete) : '-'}</td>
                                            <td style={{ fontWeight: 600, color: 'var(--success)' }}>{formatCurrency(r['$venta'])}</td>
                                            <td style={{ color: Number(r['$deben']) > 0 ? 'var(--danger)' : 'var(--text-muted)' }}>{formatCurrency(r['$deben'])}</td>
                                            <td>{r['10%'] ? formatCurrency(r['10%']) : '-'}</td>
                                            <td style={{
                                                        color: r.Anticipos ? (r.anticipoPagado ? 'var(--success)' : 'var(--warning)') : 'var(--text-muted)',
                                                        fontWeight: r.Anticipos ? 600 : 400
                                                    }}>
                                                        {r.Anticipos ? (
                                                            <span title={r.anticipoPagado ? 'Pagado' : 'Pendiente'}>
                                                                {r.anticipoPagado ? '‚úì ' : ''}{formatCurrency(r.Anticipos)}
                                                            </span>
                                                        ) : '-'}
                                                    </td>
                                            <td style={{ whiteSpace: 'nowrap' }}>{r['Agencia aduanal'] || '-'}</td>
                                            <td>
                                                <div style={{ display: 'flex', gap: '0.375rem' }}>
                                                    <button onClick={() => onEdit(r)} style={{ border: 'none', background: '#f1f5f9', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}><i data-lucide="Edit2" size="14" color="var(--primary)"></i></button>
                                                    <button onClick={() => onDelete(r)} style={{ border: 'none', background: '#fef2f2', padding: '0.375rem', borderRadius: '6px', cursor: 'pointer' }}><i data-lucide="Trash2" size="14" color="#ef4444"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    );})}
                                </tbody>
                            </table>
                            {sorted.length === 0 && <div style={{ padding: '3rem', textAlign: 'center', color: 'var(--text-muted)' }}>No se encontraron viajes</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const CalendarioPage = ({ data, onEdit }) => {
            const [month, setMonth] = useState(new Date());
            const events = useMemo(() => data.map(v => ({
                ...v,
                fecha: robustParseDate(v.Fecha),
                emb: robustParseDate(v['Fecha de embarque']),
                arr: robustParseDate(v['Fecha de arribo'])
            })).filter(v => v.fecha || v.emb || v.arr), [data]);

            const days = useMemo(() => {
                const y = month.getFullYear(), m = month.getMonth();
                const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
                const arr = [];
                for (let i = 0; i < first.getDay(); i++) arr.push(null);
                for (let d = 1; d <= last.getDate(); d++) arr.push(new Date(y, m, d));
                return arr;
            }, [month]);

            const getEvents = (day) => {
                if (!day) return [];
                return events.filter(e =>
                    (e.fecha && e.fecha.toDateString() === day.toDateString()) ||
                    (e.emb && e.emb.toDateString() === day.toDateString()) ||
                    (e.arr && e.arr.toDateString() === day.toDateString())
                );
            };
            useEffect(() => { lucide.createIcons(); }, [month]);

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Calendario</h2>
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <button className="btn-secondary" onClick={() => setMonth(new Date(month.getFullYear(), month.getMonth() - 1))}><i data-lucide="ChevronLeft" size="18"></i></button>
                            <span style={{ fontWeight: 600, minWidth: '150px', textAlign: 'center' }}>{MESES[month.getMonth()]} {month.getFullYear()}</span>
                            <button className="btn-secondary" onClick={() => setMonth(new Date(month.getFullYear(), month.getMonth() + 1))}><i data-lucide="ChevronRight" size="18"></i></button>
                        </div>
                    </div>

                    {/* Leyenda */}
                    <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                            <span>üöõ</span>
                            <span style={{ color: 'var(--text-muted)' }}>Pick up</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                            <span>üö¢</span>
                            <span style={{ color: 'var(--text-muted)' }}>Salida del barco</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.375rem' }}>
                            <span>üìç</span>
                            <span style={{ color: 'var(--text-muted)' }}>Llegada a destino</span>
                        </div>
                    </div>

                    <div className="apple-calendar">
                        <div className="cal-grid">{['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'].map(d => <div key={d} className="cal-day-label">{d}</div>)}</div>
                        <div className="cal-grid">
                            {days.map((day, i) => {
                                const isToday = day && day.toDateString() === new Date().toDateString();
                                const evts = getEvents(day);
                                return (
                                    <div key={i} className="cal-cell">
                                        {day && (
                                            <>
                                                <span className={`cal-num ${isToday ? 'today' : ''}`}>{day.getDate()}</span>
                                                {evts.slice(0, 3).map((e, idx) => {
                                                    const isFecha = e.fecha && e.fecha.toDateString() === day.toDateString();
                                                    const isEmb = e.emb && e.emb.toDateString() === day.toDateString();
                                                    const isArr = e.arr && e.arr.toDateString() === day.toDateString();
                                                    // Prioridad: Fecha > Embarque > Arribo
                                                    let emoji = 'üöõ';
                                                    let evtClass = 'evt-fecha';
                                                    if (isEmb) { emoji = 'üö¢'; evtClass = 'evt-embarque'; }
                                                    else if (isArr) { emoji = 'üìç'; evtClass = 'evt-arribo'; }
                                                    return <div key={idx} className={`evt ${evtClass}`} onClick={() => onEdit(e)}>{emoji} {e.Nombre}</div>;
                                                })}
                                                {evts.length > 3 && <div style={{ fontSize: '0.6rem', color: 'var(--text-muted)' }}>+{evts.length - 3}</div>}
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // PDF EXTRACTION
        // =====================================================
        const extractTotalUSD = (text) => {
            const lines = text.split('\n');
            const cleanPrice = (str) => parseFloat(str.replace(/,/g, ''));
            const isAmount = (str) => /^\d{1,3}(?:,\d{3})*(?:\.\d{2})?$/.test(str);

            // Strategy 1: Windowed Anchor Search
            const anchors = [
                { regex: /Grand\s*Total/i, name: 'Grand Total' },
                { regex: /TOTAL\s*USD/i, name: 'TOTAL USD' },
                { regex: /Total\s*Amount/i, name: 'Total Amount' }
            ];

            for (let anchor of anchors) {
                for (let i = 0; i < lines.length; i++) {
                    if (anchor.regex.test(lines[i])) {
                        for (let j = 0; j <= 6; j++) {
                            if (i + j >= lines.length) break;
                            const line = lines[i + j];
                            const matches = [...line.matchAll(/(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g)];
                            for (let m of matches) {
                                const val = cleanPrice(m[1]);
                                if (!isNaN(val) && val > 0 && !line.toLowerCase().includes('/100')) {
                                    return { value: val, evidence: { rule: anchor.name, snippet: line.trim() } };
                                }
                            }
                        }
                    }
                }
            }

            // Strategy 2: Fallback con sistema de puntuacion
            let bestCandidate = null;
            let bestScore = -Infinity;
            const amountRegex = /(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g;
            const boostKeywords = ['total', 'amount', 'due', 'grand', 'freight', 'charges', 'payable', 'invoice'];
            const badContexts = ['terms', 'notes', 'words', 'say'];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lowerLine = line.toLowerCase();
                let match;
                while ((match = amountRegex.exec(line)) !== null) {
                    const amountStr = match[1];
                    const val = cleanPrice(amountStr);
                    if (isNaN(val) || val === 0) continue;

                    let score = 0;
                    const pre = line.substring(Math.max(0, match.index - 30), match.index).toLowerCase();
                    const post = line.substring(match.index + amountStr.length, Math.min(line.length, match.index + amountStr.length + 30)).toLowerCase();

                    if (pre.includes('/100') || post.includes('/100')) continue;
                    if (pre.includes('hundred and') || post.includes('hundred and')) continue;

                    if (boostKeywords.some(k => lowerLine.includes(k))) score += 10;
                    if (line.includes('USD')) score += 5;
                    if (badContexts.some(c => lowerLine.includes(c))) score -= 15;
                    if (i > 0 && boostKeywords.some(k => lines[i - 1].toLowerCase().includes(k))) score += 5;
                    if (val === 100) score -= 10;

                    if (score > bestScore) {
                        bestScore = score;
                        bestCandidate = { value: val, evidence: { rule: `Scored Fallback (${score})`, snippet: line.trim() } };
                    }
                }
            }

            if (bestCandidate && bestScore > 0) return bestCandidate;
            return { value: null, evidence: { rule: 'No Match', snippet: 'No se encontro monto USD' } };
        };

        const extractTextFromPDF = async (file) => {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            // Solo pagina 1 para booking
            const page = await pdf.getPage(1);
            const content = await page.getTextContent();

            // Agrupar por lineas usando posicion Y
            const items = content.items;
            let lines = [];
            let currentLine = [];
            let lastY = null;

            items.forEach(item => {
                const y = Math.round(item.transform[5]);
                if (lastY !== null && Math.abs(y - lastY) > 5) {
                    if (currentLine.length > 0) {
                        lines.push(currentLine.map(i => i.str).join(' '));
                    }
                    currentLine = [];
                }
                currentLine.push(item);
                lastY = y;
            });

            if (currentLine.length > 0) {
                lines.push(currentLine.map(i => i.str).join(' '));
            }

            // Debug: mostrar en consola
            console.log('=== PDF TEXT EXTRACTED ===');
            lines.forEach((l, i) => console.log(i + ': ' + l));

            return lines.join('\n');
        };

        // =====================================================
        // STATUS PAGE (KANBAN)
        // =====================================================
        const StatusPage = ({ data, onEdit }) => {
            const STATUS_COLUMNS = [
                { id: 'Programacion', label: 'Programacion', color: '#3b82f6' },
                { id: 'Ingresados', label: 'Ingresados', color: '#f59e0b' },
                { id: 'Altamar', label: 'Altamar', color: '#06b6d4' },
                { id: 'Liberado', label: 'Liberado', color: '#22c55e' },
                { id: 'Pago 10%', label: 'Pago 10%', color: '#8b5cf6' },
                { id: 'cerrado', label: 'Cerrado', color: '#64748b' }
            ];

            const [collapsedColumns, setCollapsedColumns] = useState({});
            const toggleCollapse = (colId) => {
                setCollapsedColumns(prev => ({ ...prev, [colId]: !prev[colId] }));
            };

            const grouped = useMemo(() => {
                const g = {};
                STATUS_COLUMNS.forEach(col => g[col.id] = []);
                data.forEach(v => {
                    const status = v.Status || 'Programacion';
                    const col = STATUS_COLUMNS.find(c => c.id.toLowerCase() === status.toLowerCase());
                    if (col) g[col.id].push(v);
                    else if (g['Programacion']) g['Programacion'].push(v);
                });
                return g;
            }, [data]);

            useEffect(() => { lucide.createIcons(); }, [data, collapsedColumns]);

            return (
                <div>
                    <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1.5rem' }}>Tablero de Estatus</h2>
                    <div className="kanban-board">
                        {STATUS_COLUMNS.map(col => (
                            <div key={col.id} className="kanban-column">
                                <div
                                    className="kanban-header"
                                    onClick={() => toggleCollapse(col.id)}
                                    style={{ cursor: 'pointer', userSelect: 'none' }}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <i data-lucide={collapsedColumns[col.id] ? 'ChevronRight' : 'ChevronDown'} size="16"></i>
                                        <div style={{ width: 10, height: 10, borderRadius: '50%', background: col.color }}></div>
                                        <span className="kanban-title">{col.label}</span>
                                    </div>
                                    <span className="kanban-count">{grouped[col.id]?.length || 0}</span>
                                </div>
                                {!collapsedColumns[col.id] && (
                                    <div className="kanban-cards">
                                        {(grouped[col.id] || []).map((v, i) => (
                                            <div key={v.tripId || i} className="kanban-card" onClick={() => onEdit(v)}>
                                                <div className="kanban-card-title">{v.Nombre || 'Sin nombre'}</div>
                                                <div className="kanban-card-meta">
                                                    <span>Booking: {v['Numero de booking'] || '-'}</span>
                                                    <span>Embarque: {formatDateSpanish(v['Fecha de embarque'])}</span>
                                                    {v['$venta'] && <span style={{ color: 'var(--success)', fontWeight: 600 }}>{formatCurrency(v['$venta'])}</span>}
                                                </div>
                                            </div>
                                        ))}
                                        {(grouped[col.id]?.length || 0) === 0 && (
                                            <div style={{ padding: '1rem', textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.8125rem' }}>Sin viajes</div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // =====================================================
        // GESTION PAGE (PDF UPLOAD - BOOKING Y BL)
        // =====================================================

        // Extraccion de datos de Booking PDF
        const extractBookingData = (text, fileName) => {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const result = {
                file_name: fileName,
                booking: '',
                contenedores: '',
                SI: '',
                Embarque: '', // No viene en booking
                'Cut Off': '',
                fecha: '',
                flete: ''
            };

            // Buscar valor en la misma linea (a la derecha del ancla)
            const findInSameLine = (anchorRegex) => {
                for (let i = 0; i < lines.length; i++) {
                    if (anchorRegex.test(lines[i])) {
                        const dateMatch = lines[i].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (dateMatch) return dateMatch[1];
                    }
                }
                return '';
            };

            // Buscar valor en lineas siguientes (abajo del ancla)
            const findBelow = (anchorRegex, maxLines = 6) => {
                for (let i = 0; i < lines.length; i++) {
                    if (anchorRegex.test(lines[i])) {
                        for (let j = 1; j <= maxLines && (i + j) < lines.length; j++) {
                            const line = lines[i + j];
                            // Buscar fecha
                            const dateMatch = line.match(/^(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})$/);
                            if (dateMatch) return dateMatch[1];
                            // Buscar numero solo
                            const numMatch = line.match(/^(\d+)$/);
                            if (numMatch) return numMatch[1];
                        }
                    }
                }
                return '';
            };

            // A) Booking - buscar EBKG seguido de numeros
            for (let line of lines) {
                const bookingMatch = line.match(/(EBKG\d+)/i);
                if (bookingMatch) {
                    result.booking = bookingMatch[1];
                    break;
                }
            }

            // B) Contenedores - multiples estrategias
            // Estrategia 1: Buscar numero antes de "20S" o "40S" o "20'" o "40'" (tipo de contenedor)
            for (let line of lines) {
                // Patron: "10 20S" o "10 X 20S" o "10 x 20'" etc
                const sizeMatch = line.match(/(\d+)\s*[Xx]?\s*(20|40)\s*[S']/i);
                if (sizeMatch) {
                    result.contenedores = sizeMatch[1];
                    console.log('Contenedores encontrado (cerca de 20S/40S):', sizeMatch[1]);
                    break;
                }
            }
            // Estrategia 2: Buscar "X / X" cerca de TOTAL o palabras clave
            if (!result.contenedores) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const prevLine = lines[i-1] || '';
                    const nextLine = lines[i+1] || '';

                    // Patron "10 / 10" o "10/10"
                    const slashMatch = line.match(/(\d+)\s*\/\s*(\d+)/);
                    if (slashMatch) {
                        // Verificar contexto
                        if (/CONTR|CONTAINER|ASSIGNED|REQUESTED|QTY|QUANTITY|TOTAL/i.test(line) ||
                            /CONTR|CONTAINER|ASSIGNED|REQUESTED|QTY|QUANTITY|TOTAL/i.test(prevLine) ||
                            /CONTR|CONTAINER|ASSIGNED|REQUESTED|QTY|QUANTITY|TOTAL/i.test(nextLine)) {
                            result.contenedores = slashMatch[1];
                            console.log('Contenedores encontrado (patron X/X):', slashMatch[1]);
                            break;
                        }
                    }
                }
            }
            // Estrategia 3: Buscar linea con solo "10 / 10" o "10/10" sin contexto
            if (!result.contenedores) {
                for (let line of lines) {
                    const simpleSlash = line.trim().match(/^(\d+)\s*\/\s*\d+$/);
                    if (simpleSlash) {
                        result.contenedores = simpleSlash[1];
                        console.log('Contenedores encontrado (linea simple X/X):', simpleSlash[1]);
                        break;
                    }
                }
            }
            // Estrategia 4: Buscar despues de ancla especifica
            if (!result.contenedores) {
                for (let i = 0; i < lines.length; i++) {
                    if (/REQUESTED.*ASSIGNED|CONTR.*#|CONTAINER.*QTY/i.test(lines[i])) {
                        for (let j = 1; j <= 8 && (i + j) < lines.length; j++) {
                            const nextLine = lines[i + j].trim();
                            const numMatch = nextLine.match(/^(\d+)(?:\s*\/\s*\d+)?$/);
                            if (numMatch) {
                                result.contenedores = numMatch[1];
                                console.log('Contenedores encontrado (despues de ancla):', numMatch[1]);
                                break;
                            }
                        }
                        if (result.contenedores) break;
                    }
                }
            }
            // Estrategia 5: Buscar "X CONTAINER" o "CONTAINER: X"
            if (!result.contenedores) {
                for (let line of lines) {
                    const match = line.match(/(\d+)\s*[Xx]?\s*(?:CONTAINER|CONTR)/i) ||
                                  line.match(/(?:CONTAINER|CONTR)[:\s]*(\d+)/i);
                    if (match) {
                        result.contenedores = match[1];
                        console.log('Contenedores encontrado (CONTAINER X):', match[1]);
                        break;
                    }
                }
            }

            // C) SI - a la derecha de "SHIPPING INSTRUCTIONS SUBMISSION CUTOFF DATE:"
            const siAnchor = /SHIPPING\s*INSTRUCTIONS\s*SUBMISSION\s*CUTOFF\s*DATE/i;
            result.SI = findInSameLine(siAnchor);

            // D) Embarque - NO viene en booking, dejarlo vacio
            result.Embarque = '';

            // E) Cut Off (VGM) - a la derecha de "VGM CUTOFF DATE:"
            const cutoffAnchor = /VGM\s*CUTOFF\s*DATE/i;
            result['Cut Off'] = findInSameLine(cutoffAnchor);

            // F) Fecha - multiples estrategias
            // Estrategia 1: APPOINTMENT DATE
            for (let i = 0; i < lines.length; i++) {
                if (/APPOINTMENT\s*DATE/i.test(lines[i])) {
                    // Buscar en misma linea
                    const sameLine = lines[i].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                    if (sameLine) {
                        result.fecha = sameLine[1];
                        break;
                    }
                    // Buscar en lineas siguientes
                    for (let j = 1; j <= 8 && (i + j) < lines.length; j++) {
                        const dateMatch = lines[i + j].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (dateMatch) {
                            result.fecha = dateMatch[1];
                            break;
                        }
                    }
                    break;
                }
            }
            // Estrategia 2: ETD o ESTIMATED TIME OF DEPARTURE
            if (!result.fecha) {
                for (let i = 0; i < lines.length; i++) {
                    if (/\bETD\b|ESTIMATED\s*TIME.*DEPARTURE|SAILING\s*DATE|DEPARTURE\s*DATE/i.test(lines[i])) {
                        const sameLine = lines[i].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (sameLine) {
                            result.fecha = sameLine[1];
                            break;
                        }
                        for (let j = 1; j <= 5 && (i + j) < lines.length; j++) {
                            const dateMatch = lines[i + j].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                            if (dateMatch) {
                                result.fecha = dateMatch[1];
                                break;
                            }
                        }
                        if (result.fecha) break;
                    }
                }
            }
            // Estrategia 3: Formato de fecha con mes en texto (JAN, FEB, etc.)
            if (!result.fecha) {
                for (let line of lines) {
                    const textDateMatch = line.match(/(\d{1,2})[\/\-\s]*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)[\/\-\s]*(\d{2,4})/i);
                    if (textDateMatch) {
                        const months = {JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'};
                        const month = months[textDateMatch[2].toUpperCase()];
                        const year = textDateMatch[3].length === 2 ? '20' + textDateMatch[3] : textDateMatch[3];
                        result.fecha = textDateMatch[1] + '/' + month + '/' + year;
                        break;
                    }
                }
            }

            // G) Flete - buscar monto USD (puede no venir)
            for (let line of lines) {
                const fleteMatch = line.match(/(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)\s*USD/i);
                if (fleteMatch) {
                    const val = parseFloat(fleteMatch[1].replace(/,/g, ''));
                    if (val > 100) { // Ignorar valores muy peque√±os
                        result.flete = fleteMatch[1];
                        break;
                    }
                }
            }

            return result;
        };

        // Extraccion de datos de BL PDF
        const extractBLData = (text, fileName) => {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const fullText = text.toUpperCase();
            const result = {
                file_name: fileName,
                bl: '',
                booking: '',
                contenedores: '',
                flete: ''
            };

            console.log('=== EXTRACCION BL ===');
            lines.forEach((l, i) => console.log(i + ': ' + l));

            // A) Bill of Lading # - patron MEDUXF seguido de numeros (formato MSC)
            // Buscar en todo el texto patron MEDUXF + numeros
            const blPatterns = [
                /MEDU[A-Z]*\d+/gi,           // MEDUXF429237
                /[A-Z]{4}[A-Z0-9]*\d{6,}/g,  // Otros formatos de BL
            ];
            for (const pattern of blPatterns) {
                const matches = text.match(pattern);
                if (matches && matches.length > 0) {
                    result.bl = matches[0].toUpperCase();
                    console.log('BL encontrado:', result.bl);
                    break;
                }
            }

            // B) Booking Ref - patron EBKG seguido de numeros
            // Buscar EBKG en cualquier parte del texto
            const ebkgMatch = text.match(/EBKG\d+/i);
            if (ebkgMatch) {
                result.booking = ebkgMatch[0].toUpperCase();
                console.log('Booking EBKG encontrado:', result.booking);
            }

            // Si no encontro EBKG, buscar cerca de "BOOKING REF"
            if (!result.booking) {
                for (let i = 0; i < lines.length; i++) {
                    if (/BOOKING\s*REF/i.test(lines[i])) {
                        // Buscar en las siguientes lineas un codigo alfanumerico
                        for (let j = 0; j <= 5 && (i + j) < lines.length; j++) {
                            const searchLine = lines[i + j];
                            // Buscar codigo que empiece con letra y tenga numeros
                            const codeMatch = searchLine.match(/\b([A-Z]{2,}[0-9]{5,})\b/i);
                            if (codeMatch && codeMatch[1].length >= 8) {
                                result.booking = codeMatch[1].toUpperCase();
                                console.log('Booking encontrado cerca de BOOKING REF:', result.booking);
                                break;
                            }
                        }
                        if (result.booking) break;
                    }
                }
            }

            // C) Contenedores - buscar "XX cntrs" en cualquier parte
            const cntrsMatch = text.match(/(\d+)\s*cntrs?/i);
            if (cntrsMatch) {
                result.contenedores = cntrsMatch[1];
                console.log('Contenedores encontrado (X cntrs):', result.contenedores);
            }

            // Si no, buscar cerca de CARRIER'S RECEIPT
            if (!result.contenedores) {
                for (let i = 0; i < lines.length; i++) {
                    if (/CARRIER.*RECEIPT|No\.\s*of\s*Cntrs/i.test(lines[i])) {
                        for (let j = 1; j <= 15 && (i + j) < lines.length; j++) {
                            const nextLine = lines[i + j];
                            const cntMatch = nextLine.match(/^(\d{1,3})(?:\s|$)/);
                            if (cntMatch && parseInt(cntMatch[1]) <= 100 && parseInt(cntMatch[1]) > 0) {
                                result.contenedores = cntMatch[1];
                                console.log('Contenedores encontrado (cerca de CARRIER):', result.contenedores);
                                break;
                            }
                        }
                        if (result.contenedores) break;
                    }
                }
            }

            // D) Flete - DOS FORMATOS DE PDF:
            // Formato A (Draft B/L): TOTAL -> lineas despues -> numero solo "22,335.00"
            // Formato B (Freight Invoice): "$18,625.00 USD" en una linea

            console.log('=== BUSCANDO FLETE ===');
            let fleteFound = false;

            // ESTRATEGIA 1: Formato B - Buscar "$XX,XXX.XX USD" (Freight Invoice)
            const dollarUsdMatch = text.match(/\$([\d,]+\.\d{2})\s*USD/i);
            if (dollarUsdMatch) {
                const val = parseFloat(dollarUsdMatch[1].replace(/,/g, ''));
                if (val > 100 && val < 100000) {
                    result.flete = dollarUsdMatch[1];
                    console.log('Flete ($USD):', result.flete);
                    fleteFound = true;
                }
            }

            // ESTRATEGIA 2: Formato A - Buscar numero despues de "TOTAL" (Draft B/L)
            if (!fleteFound) {
                for (let i = 0; i < lines.length; i++) {
                    if (/\bTOTAL\b/i.test(lines[i])) {
                        console.log('TOTAL encontrado en linea', i);
                        for (let j = 1; j <= 10 && (i + j) < lines.length; j++) {
                            const line = lines[i + j].trim();
                            // Linea que es SOLO un numero (22,335.00)
                            const numMatch = line.match(/^([\d,]+\.\d{2})$/);
                            if (numMatch) {
                                const val = parseFloat(numMatch[1].replace(/,/g, ''));
                                if (val > 100 && val < 50000) {
                                    result.flete = numMatch[1];
                                    console.log('Flete (despues de TOTAL):', result.flete);
                                    fleteFound = true;
                                    break;
                                }
                            }
                        }
                        if (fleteFound) break;
                    }
                }
            }

            // ESTRATEGIA 3: Fallback - numero mas alto entre 100-50,000 que este solo
            if (!fleteFound) {
                let candidates = [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const numMatch = line.match(/^([\d,]+\.\d{2})$/);
                    if (numMatch) {
                        const val = parseFloat(numMatch[1].replace(/,/g, ''));
                        if (val > 100 && val < 50000) {
                            candidates.push({ val, str: numMatch[1], line: i });
                        }
                    }
                }
                if (candidates.length > 0) {
                    candidates.sort((a, b) => b.val - a.val);
                    result.flete = candidates[0].str;
                    console.log('Flete (fallback):', result.flete);
                    fleteFound = true;
                }
            }

            if (!fleteFound) {
                console.log('No se encontro flete');
            }

            return result;
        };

        const GestionPage = ({ onOpenBookingModal, onEditViaje, onEditViajeWithOriginal, allData }) => {
            const [activeTab, setActiveTab] = useState('booking');

            // Estado para Booking
            const [bookingFile, setBookingFile] = useState(null);
            const [bookingLoading, setBookingLoading] = useState(false);
            const [bookingResult, setBookingResult] = useState(null);
            const [bookingDragging, setBookingDragging] = useState(false);
            const bookingInputRef = useRef();

            // Estado para valores editables del booking
            const [editedBooking, setEditedBooking] = useState({});

            // Estado para BL
            const [blFile, setBlFile] = useState(null);
            const [blLoading, setBlLoading] = useState(false);
            const [blResult, setBlResult] = useState(null);
            const [blDragging, setBlDragging] = useState(false);
            const blInputRef = useRef();
            const [matchedViaje, setMatchedViaje] = useState(null); // Viaje encontrado por booking
            const [blEdited, setBlEdited] = useState({}); // Valores editados para actualizar

            // Procesar Booking PDF
            const processBookingFile = async (f) => {
                if (!f || !f.name.toLowerCase().endsWith('.pdf')) {
                    setTimeout(() => alert('Por favor selecciona un archivo PDF'), 50);
                    return;
                }
                setBookingFile(f);
                setBookingLoading(true);
                setBookingResult(null);

                try {
                    const text = await extractTextFromPDF(f);
                    const extraction = extractBookingData(text, f.name);
                    setBookingResult(extraction);
                    // Inicializar valores editables con los datos extraidos
                    setEditedBooking({
                        booking: extraction.booking || '',
                        contenedores: extraction.contenedores || '',
                        SI: extraction.SI || '',
                        Embarque: extraction.Embarque || '',
                        'Cut Off': extraction['Cut Off'] || '',
                        fecha: extraction.fecha || '',
                        flete: extraction.flete || ''
                    });
                } catch (err) {
                    setTimeout(() => alert('Error al procesar PDF: ' + err.message), 50);
                }
                setBookingLoading(false);
            };

            // Procesar BL PDF
            const processBLFile = async (f) => {
                if (!f || !f.name.toLowerCase().endsWith('.pdf')) {
                    setTimeout(() => alert('Por favor selecciona un archivo PDF'), 50);
                    return;
                }
                setBlFile(f);
                setBlLoading(true);
                setBlResult(null);
                setMatchedViaje(null);
                setBlEdited({});

                try {
                    const text = await extractTextFromPDF(f);
                    const extraction = extractBLData(text, f.name);
                    setBlResult(extraction);

                    // Buscar viaje por numero de booking
                    if (extraction.booking && allData) {
                        const found = allData.find(v =>
                            v['Numero de booking'] &&
                            v['Numero de booking'].toUpperCase() === extraction.booking.toUpperCase()
                        );
                        if (found) {
                            setMatchedViaje(found);
                            // Inicializar valores editados con datos del BL
                            setBlEdited({
                                bl: extraction.bl || '',
                                booking: extraction.booking || '',
                                contenedores: extraction.contenedores || '',
                                flete: extraction.flete || ''
                            });
                        }
                    }
                } catch (err) {
                    setTimeout(() => alert('Error al procesar PDF: ' + err.message), 50);
                }
                setBlLoading(false);
            };

            // Generar nombre del viaje: ZN + DDMMYY
            const generateViajeName = (fechaStr) => {
                let day = '', month = '', year = '';

                // Intentar parsear diferentes formatos de fecha
                if (fechaStr) {
                    // Formato DD/MM/YYYY o DD-MM-YYYY
                    const match1 = fechaStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                    if (match1) {
                        day = match1[1].padStart(2, '0');
                        month = match1[2].padStart(2, '0');
                        year = match1[3].length === 4 ? match1[3].slice(-2) : match1[3];
                    }
                    // Formato YYYY-MM-DD
                    const match2 = fechaStr.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
                    if (!match1 && match2) {
                        day = match2[3].padStart(2, '0');
                        month = match2[2].padStart(2, '0');
                        year = match2[1].slice(-2);
                    }
                }

                // Si no se pudo parsear, usar fecha actual
                if (!day || !month || !year) {
                    const now = new Date();
                    day = String(now.getDate()).padStart(2, '0');
                    month = String(now.getMonth() + 1).padStart(2, '0');
                    year = String(now.getFullYear()).slice(-2);
                }

                return `ZN ${day}-${month}-${year}`;
            };

            // Abrir modal de edicion con datos del booking
            const openBookingInModal = () => {
                if (bookingResult && onOpenBookingModal) {
                    const fecha = editedBooking.fecha || new Date().toISOString().split('T')[0];
                    const nombreViaje = generateViajeName(fecha);

                    const dataToEdit = {
                        Nombre: nombreViaje,
                        'Numero de booking': editedBooking.booking || '',
                        Contenedores: editedBooking.contenedores || '',
                        SI: editedBooking.SI || '',
                        'Fecha de embarque': editedBooking.Embarque || '',
                        'Cut off': editedBooking['Cut Off'] || '',
                        Fecha: fecha,
                        Flete: parseFloat((editedBooking.flete || '0').replace(/,/g, '')) || 0,
                        Status: 'Programacion',
                        modifiedBy: 'Booking PDF Import',
                        // Adjuntar archivo PDF para guardar en documentos
                        _pendingPdfFile: bookingFile,
                        _pendingPdfType: 'booking'
                    };
                    onOpenBookingModal(dataToEdit);
                    // Limpiar estado local
                    setBookingFile(null);
                    setBookingResult(null);
                    setEditedBooking({});
                }
            };

            // Abrir modal de edicion con viaje actualizado con datos del BL
            const openBLInModal = () => {
                if (blResult && matchedViaje && onEditViajeWithOriginal) {
                    // Crear copia del viaje con los datos actualizados del BL
                    const updatedViaje = { ...matchedViaje };

                    // Actualizar campos con valores del BL (si tienen valor)
                    if (blEdited.bl) {
                        updatedViaje['Numero de BL'] = blEdited.bl;
                    }
                    if (blEdited.contenedores) {
                        updatedViaje['Contenedores'] = blEdited.contenedores;
                    }
                    if (blEdited.flete) {
                        updatedViaje['Flete'] = parseFloat((blEdited.flete || '0').replace(/,/g, '')) || 0;
                    }

                    // Adjuntar archivo PDF para guardar en documentos
                    updatedViaje._pendingPdfFile = blFile;
                    updatedViaje._pendingPdfType = 'bl';

                    // Abrir modal de edicion con el viaje actualizado Y el original para comparar
                    onEditViajeWithOriginal(updatedViaje, matchedViaje);

                    // Limpiar estado
                    setBlResult(null);
                    setBlFile(null);
                    setMatchedViaje(null);
                    setBlEdited({});
                }
            };

            const ResultField = ({ label, value }) => (
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid var(--border)' }}>
                    <span style={{ color: 'var(--text-muted)', fontSize: '0.8125rem' }}>{label}</span>
                    <span style={{ fontWeight: 500, fontSize: '0.8125rem' }}>{value || '-'}</span>
                </div>
            );

            // Componente para comparar valores viaje vs BL
            const CompareField = ({ label, viajeValue, blValue, onChange, readOnly, isNew, highlight, isMoney }) => {
                const viajeStr = viajeValue ? String(viajeValue) : '';
                const blStr = blValue ? String(blValue) : '';
                const viajeDisplay = isMoney && viajeStr ? `$${viajeStr}` : viajeStr;
                const blDisplay = isMoney && blStr ? `$${blStr}` : blStr;

                // Determinar estado
                let status = 'empty'; // No hay valor en ninguno
                if (viajeStr && blStr) {
                    status = viajeStr.toUpperCase() === blStr.toUpperCase() ? 'match' : 'diff';
                } else if (blStr && !viajeStr) {
                    status = 'new';
                } else if (viajeStr && !blStr) {
                    status = 'existing';
                }

                const statusStyles = {
                    match: { bg: 'rgba(34, 197, 94, 0.1)', border: 'var(--success)', icon: '‚úì', text: 'Confirmado' },
                    new: { bg: 'rgba(59, 130, 246, 0.1)', border: 'var(--info)', icon: '‚ûï', text: 'Nuevo' },
                    diff: { bg: 'rgba(245, 158, 11, 0.1)', border: 'var(--warning)', icon: '‚ö†Ô∏è', text: 'Diferente' },
                    existing: { bg: 'var(--bg)', border: 'var(--border)', icon: 'üìã', text: 'Sin cambio' },
                    empty: { bg: 'var(--bg)', border: 'var(--border)', icon: '-', text: '' }
                };

                const style = statusStyles[status];

                return (
                    <div style={{
                        padding: '0.75rem',
                        marginBottom: '0.5rem',
                        borderRadius: '8px',
                        background: style.bg,
                        border: `1px solid ${style.border}`,
                        ...(highlight && { boxShadow: '0 0 0 2px var(--primary)' })
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                            <span style={{ fontWeight: 600, fontSize: '0.8125rem' }}>{label}</span>
                            {status !== 'empty' && (
                                <span style={{ fontSize: '0.75rem', color: style.border, display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                                    {style.icon} {style.text}
                                </span>
                            )}
                        </div>

                        {status === 'diff' ? (
                            <div style={{ fontSize: '0.8125rem' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                                    <span style={{ color: 'var(--text-muted)', minWidth: '50px' }}>Viaje:</span>
                                    <span style={{ textDecoration: 'line-through', opacity: 0.6 }}>{viajeDisplay || '-'}</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <span style={{ color: 'var(--text-muted)', minWidth: '50px' }}>BL:</span>
                                    <input
                                        type="text"
                                        value={blValue || ''}
                                        onChange={(e) => onChange && onChange(e.target.value)}
                                        disabled={readOnly}
                                        style={{
                                            flex: 1,
                                            padding: '0.3rem 0.5rem',
                                            border: '1px solid var(--warning)',
                                            borderRadius: '4px',
                                            fontSize: '0.8125rem',
                                            fontWeight: 600,
                                            background: 'var(--surface)',
                                            color: 'var(--text)'
                                        }}
                                    />
                                </div>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                {readOnly ? (
                                    <span style={{ fontSize: '0.875rem', fontWeight: 500 }}>{blDisplay || viajeDisplay || '-'}</span>
                                ) : (
                                    <input
                                        type="text"
                                        value={blValue || ''}
                                        onChange={(e) => onChange && onChange(e.target.value)}
                                        placeholder={viajeDisplay || '-'}
                                        style={{
                                            flex: 1,
                                            padding: '0.3rem 0.5rem',
                                            border: `1px solid ${style.border}`,
                                            borderRadius: '4px',
                                            fontSize: '0.8125rem',
                                            fontWeight: 500,
                                            background: 'var(--surface)',
                                            color: 'var(--text)'
                                        }}
                                    />
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            // Campo editable para booking
            const EditableField = ({ label, fieldKey, value, onChange }) => (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid var(--border)', gap: '1rem' }}>
                    <label style={{ color: 'var(--text-muted)', fontSize: '0.8125rem', whiteSpace: 'nowrap', minWidth: '120px' }}>{label}</label>
                    <input
                        type="text"
                        value={value || ''}
                        onChange={(e) => onChange(fieldKey, e.target.value)}
                        style={{
                            flex: 1,
                            padding: '0.4rem 0.6rem',
                            border: '1px solid var(--border)',
                            borderRadius: '6px',
                            fontSize: '0.8125rem',
                            fontWeight: 500,
                            background: 'var(--surface)',
                            color: 'var(--text)',
                            maxWidth: '200px'
                        }}
                        placeholder="-"
                    />
                </div>
            );

            return (
                <div>
                    <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1.5rem' }}>Gestion de Documentos</h2>

                    {/* Tabs - usando emojis en lugar de lucide */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem' }}>
                        <button
                            className={activeTab === 'booking' ? 'btn-primary' : 'btn-secondary'}
                            onClick={() => setActiveTab('booking')}
                            style={{ flex: 1 }}
                        >
                            üìÑ Crear Viaje (Booking)
                        </button>
                        <button
                            className={activeTab === 'bl' ? 'btn-primary' : 'btn-secondary'}
                            onClick={() => setActiveTab('bl')}
                            style={{ flex: 1 }}
                        >
                            üìù Actualizar Viaje (BL)
                        </button>
                    </div>

                    {/* Booking Tab */}
                    {activeTab === 'booking' && (
                        <div className="table-card" style={{ padding: '2rem' }}>
                            <div style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ fontWeight: 600, marginBottom: '0.5rem' }}>
                                    üìã Booking Confirmation
                                </h3>
                                <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>
                                    Sube el PDF del Booking Confirmation para crear un nuevo viaje automaticamente.
                                </p>
                            </div>

                            <div
                                className={`pdf-upload-zone ${bookingDragging ? 'dragging' : ''}`}
                                onDragOver={(e) => { e.preventDefault(); setBookingDragging(true); }}
                                onDragLeave={() => setBookingDragging(false)}
                                onDrop={(e) => { e.preventDefault(); setBookingDragging(false); processBookingFile(e.dataTransfer.files[0]); }}
                                onClick={() => bookingInputRef.current?.click()}
                            >
                                <input ref={bookingInputRef} type="file" accept=".pdf" hidden onChange={(e) => processBookingFile(e.target.files[0])} />
                                {bookingLoading ? (
                                    <div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto' }}></div>
                                ) : (
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üì§</div>
                                        <h3 style={{ marginBottom: '0.5rem' }}>Arrastra tu Booking PDF aqui</h3>
                                        <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>o haz clic para seleccionar</p>
                                    </div>
                                )}
                            </div>

                            {bookingResult && (
                                <div className="pdf-result" style={{ marginTop: '1.5rem' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', color: 'var(--success)' }}>
                                        <span style={{ fontSize: '1.25rem' }}>‚úÖ</span>
                                        <span style={{ fontWeight: 600 }}>Datos extraidos de: {bookingResult.file_name}</span>
                                    </div>

                                    <div style={{ background: 'var(--bg)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' }}>
                                        <ResultField label="Booking #" value={editedBooking.booking} />
                                        <ResultField label="Contenedores" value={editedBooking.contenedores} />
                                        <ResultField label="SI" value={editedBooking.SI} />
                                        <ResultField label="Cut Off" value={editedBooking['Cut Off']} />
                                        <ResultField label="Fecha" value={editedBooking.fecha} />
                                        <ResultField label="Flete (USD)" value={editedBooking.flete ? `$${editedBooking.flete}` : '-'} />
                                    </div>

                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <button
                                            className="btn-secondary"
                                            onClick={() => { setBookingResult(null); setBookingFile(null); setEditedBooking({}); }}
                                            style={{ flex: 1 }}
                                        >
                                            ‚ùå Cancelar
                                        </button>
                                        <button className="btn-primary" onClick={openBookingInModal} style={{ flex: 2 }}>
                                            üìù Editar y Crear Viaje
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* BL Tab */}
                    {activeTab === 'bl' && (
                        <div className="table-card" style={{ padding: '2rem' }}>
                            <div style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ fontWeight: 600, marginBottom: '0.5rem' }}>
                                    üìÑ Bill of Lading (BL)
                                </h3>
                                <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>
                                    Sube el PDF del BL para actualizar un viaje existente. El viaje se detecta automaticamente por el numero de Booking.
                                </p>
                            </div>

                            <div
                                className={`pdf-upload-zone ${blDragging ? 'dragging' : ''}`}
                                onDragOver={(e) => { e.preventDefault(); setBlDragging(true); }}
                                onDragLeave={() => setBlDragging(false)}
                                onDrop={(e) => { e.preventDefault(); setBlDragging(false); processBLFile(e.dataTransfer.files[0]); }}
                                onClick={() => blInputRef.current?.click()}
                            >
                                <input ref={blInputRef} type="file" accept=".pdf" hidden onChange={(e) => processBLFile(e.target.files[0])} />
                                {blLoading ? (
                                    <div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto' }}></div>
                                ) : (
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üì§</div>
                                        <h3 style={{ marginBottom: '0.5rem' }}>Arrastra tu BL PDF aqui</h3>
                                        <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>o haz clic para seleccionar</p>
                                    </div>
                                )}
                            </div>

                            {/* Resultado del BL */}
                            {blResult && (
                                <div className="pdf-result" style={{ marginTop: '1.5rem' }}>
                                    {/* Viaje encontrado o no */}
                                    {matchedViaje ? (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', padding: '0.75rem', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '8px', border: '1px solid var(--success)' }}>
                                            <span style={{ fontSize: '1.25rem' }}>üö¢</span>
                                            <div>
                                                <div style={{ fontWeight: 600, color: 'var(--success)' }}>Viaje encontrado</div>
                                                <div style={{ fontSize: '0.875rem' }}>{matchedViaje.Nombre || 'Sin nombre'} ({matchedViaje['Numero de booking']})</div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', padding: '0.75rem', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '8px', border: '1px solid var(--danger)' }}>
                                            <span style={{ fontSize: '1.25rem' }}>‚ö†Ô∏è</span>
                                            <div>
                                                <div style={{ fontWeight: 600, color: 'var(--danger)' }}>Viaje no encontrado</div>
                                                <div style={{ fontSize: '0.875rem' }}>No se encontro viaje con Booking: {blResult.booking || '(no detectado)'}</div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Comparacion de campos */}
                                    {matchedViaje && (
                                        <div style={{ background: 'var(--bg)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' }}>
                                            <h4 style={{ fontSize: '0.875rem', fontWeight: 600, marginBottom: '1rem', color: 'var(--text-muted)' }}>Comparacion de datos</h4>

                                            {/* Booking - solo confirmacion */}
                                            <CompareField
                                                label="Booking"
                                                viajeValue={matchedViaje['Numero de booking']}
                                                blValue={blEdited.booking}
                                                onChange={(v) => setBlEdited(prev => ({...prev, booking: v}))}
                                                readOnly={true}
                                            />

                                            {/* BL - el mas importante */}
                                            <CompareField
                                                label="Numero de BL"
                                                viajeValue={matchedViaje['Numero de BL']}
                                                blValue={blEdited.bl}
                                                onChange={(v) => setBlEdited(prev => ({...prev, bl: v}))}
                                                isNew={!matchedViaje['Numero de BL'] && blEdited.bl}
                                                highlight={true}
                                            />

                                            {/* Contenedores */}
                                            <CompareField
                                                label="Contenedores"
                                                viajeValue={matchedViaje['Contenedores']}
                                                blValue={blEdited.contenedores}
                                                onChange={(v) => setBlEdited(prev => ({...prev, contenedores: v}))}
                                            />

                                            {/* Flete */}
                                            <CompareField
                                                label="Flete (USD)"
                                                viajeValue={matchedViaje['Flete']}
                                                blValue={blEdited.flete}
                                                onChange={(v) => setBlEdited(prev => ({...prev, flete: v}))}
                                                isMoney={true}
                                            />
                                        </div>
                                    )}

                                    {/* Botones */}
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <button
                                            className="btn-secondary"
                                            onClick={() => { setBlResult(null); setBlFile(null); setMatchedViaje(null); setBlEdited({}); }}
                                            style={{ flex: 1 }}
                                        >
                                            ‚ùå Cancelar
                                        </button>
                                        {matchedViaje && (
                                            <button className="btn-primary" onClick={openBLInModal} style={{ flex: 2 }}>
                                                üìù Editar Viaje
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const AlertasPage = ({ notifications, onClick }) => {
            useEffect(() => { lucide.createIcons(); }, [notifications]);
            const grouped = useMemo(() => { const g = { danger: [], warning: [], info: [] }; notifications.forEach(n => g[n.type]?.push(n)); return g; }, [notifications]);
            const getIcon = (t) => t === 'danger' ? 'AlertTriangle' : t === 'warning' ? 'Clock' : 'Ship';

            return (
                <div>
                    <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1.5rem' }}>Centro de Alertas</h2>
                    {notifications.length === 0 ? (
                        <div className="table-card" style={{ padding: '4rem', textAlign: 'center' }}><i data-lucide="CheckCircle" size="60" color="#22c55e"></i><h3 style={{ marginTop: '1.5rem' }}>Todo en orden</h3><p style={{ color: 'var(--text-muted)' }}>No hay alertas</p></div>
                    ) : (
                        ['danger', 'warning', 'info'].map(type => grouped[type].length > 0 && (
                            <div key={type} style={{ marginBottom: '2rem' }}>
                                <h3 style={{ fontSize: '1rem', fontWeight: 600, marginBottom: '1rem', color: type === 'danger' ? '#dc2626' : type === 'warning' ? '#f59e0b' : '#3b82f6', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><i data-lucide={getIcon(type)} size="18"></i>{type === 'danger' ? 'Urgente' : type === 'warning' ? 'Atencion' : 'Info'} ({grouped[type].length})</h3>
                                <div className="table-card">
                                    {grouped[type].map((n, i) => (
                                        <div key={n.id || i} className="notification-item" onClick={() => onClick(n.viaje)}>
                                            <div className={`notification-icon ${n.type}`}><i data-lucide={getIcon(n.type)} size="18"></i></div>
                                            <div className="notification-content"><div className="notification-title">{n.title}</div><div className="notification-message">{n.message}</div></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))
                    )}
                </div>
            );
        };

        const AuthPage = ({ onSuccess, onSkip }) => {
            const [mode, setMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => { lucide.createIcons(); }, []);

            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                const result = mode === 'register' ? await SupabaseAuthService.signUp(email, password) : await SupabaseAuthService.signIn(email, password);
                setLoading(false);
                if (!result.success) setError(result.error);
                else if (mode === 'login') onSuccess(result.data.user);
                else setError(''); // Registration success
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <div className="auth-header"><i data-lucide="Zap" size="40" color="var(--primary)" style={{ marginBottom: '1rem' }}></i><h1>Antigravity CRM</h1><p>{mode === 'login' ? 'Inicia sesion' : 'Registrate'}</p></div>
                        {error && <div className="auth-error">{error}</div>}
                        <form className="auth-form" onSubmit={handleSubmit}>
                            <div className="auth-input-group"><label>Email</label><input type="email" value={email} onChange={e => setEmail(e.target.value)} required /></div>
                            <div className="auth-input-group"><label>Contrasena</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} required minLength={6} /></div>
                            <button type="submit" className="auth-btn" disabled={loading}>{loading ? 'Cargando...' : (mode === 'login' ? 'Entrar' : 'Crear cuenta')}</button>
                        </form>
                        <div className="auth-switch">{mode === 'login' ? <>No tienes cuenta? <a onClick={() => setMode('register')}>Registrate</a></> : <>Ya tienes cuenta? <a onClick={() => setMode('login')}>Entra</a></>}</div>
                        <div style={{ textAlign: 'center', marginTop: '1.5rem' }}><button onClick={onSkip} style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8125rem' }}>Continuar sin cuenta</button></div>
                    </div>
                </div>
            );
        };

        // =====================================================
        // HISTORIAL PAGE - Ver historial de todos los viajes
        // =====================================================
        const HistorialPage = ({ data, onEdit }) => {
            const [filtro, setFiltro] = useState('');

            // Recopilar todos los cambios de todos los viajes
            const todosLosCambios = useMemo(() => {
                const cambios = [];
                data.forEach(viaje => {
                    if (viaje.historial && viaje.historial.length > 0) {
                        viaje.historial.forEach(entry => {
                            cambios.push({
                                ...entry,
                                tripId: viaje.tripId,
                                viajeNombre: viaje.Nombre || viaje['Numero de booking'] || 'Sin nombre',
                                viaje: viaje
                            });
                        });
                    }
                });
                // Ordenar por fecha (m√°s reciente primero)
                cambios.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                return cambios;
            }, [data]);

            // Filtrar por nombre de viaje
            const cambiosFiltrados = useMemo(() => {
                if (!filtro.trim()) return todosLosCambios;
                const f = filtro.toLowerCase();
                return todosLosCambios.filter(c => c.viajeNombre.toLowerCase().includes(f));
            }, [todosLosCambios, filtro]);

            useEffect(() => { lucide.createIcons(); }, [cambiosFiltrados]);

            return (
                <div style={{ animation: 'fadeIn 0.3s' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700 }}>Historial de Cambios</h2>
                        <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                            <span style={{ fontSize: '0.875rem', color: 'var(--text-muted)' }}>{cambiosFiltrados.length} cambios</span>
                        </div>
                    </div>

                    {/* Buscador */}
                    <div className="table-card" style={{ marginBottom: '1rem', padding: '1rem' }}>
                        <div style={{ position: 'relative' }}>
                            <i data-lucide="Search" size="18" style={{ position: 'absolute', left: '0.75rem', top: '50%', transform: 'translateY(-50%)', color: 'var(--text-muted)' }}></i>
                            <input
                                type="text"
                                placeholder="Buscar por nombre de viaje..."
                                value={filtro}
                                onChange={e => setFiltro(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem 1rem 0.75rem 2.5rem',
                                    border: '1px solid var(--border)',
                                    borderRadius: '8px',
                                    fontSize: '0.875rem'
                                }}
                            />
                        </div>
                    </div>

                    {/* Lista de cambios */}
                    <div className="table-card" style={{ padding: '1rem' }}>
                        {cambiosFiltrados.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' }}>
                                <i data-lucide="History" size="48" style={{ opacity: 0.3, marginBottom: '1rem' }}></i>
                                <p style={{ margin: 0 }}>No hay cambios registrados todavia.</p>
                                <p style={{ margin: '0.5rem 0 0', fontSize: '0.8125rem' }}>Los cambios se registraran cuando modifiques viajes.</p>
                            </div>
                        ) : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                {cambiosFiltrados.map((entry, idx) => {
                                    const { fecha, hora } = formatHistorialDate(entry.fecha);
                                    const numCambios = Object.keys(entry.cambios || {}).length;
                                    return (
                                        <div key={entry.id || idx} style={{
                                            background: 'var(--bg-secondary)',
                                            border: '1px solid var(--border)',
                                            borderRadius: '10px',
                                            padding: '1rem',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s'
                                        }}
                                        onClick={() => onEdit(entry.viaje)}
                                        onMouseOver={e => e.currentTarget.style.borderColor = 'var(--primary)'}
                                        onMouseOut={e => e.currentTarget.style.borderColor = 'var(--border)'}
                                        >
                                            {/* Header */}
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.75rem' }}>
                                                <div>
                                                    <div style={{ fontWeight: 600, fontSize: '0.9375rem', marginBottom: '0.25rem' }}>
                                                        {entry.viajeNombre}
                                                    </div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <span style={{
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            gap: '0.375rem',
                                                            padding: '0.125rem 0.5rem',
                                                            background: entry.accion === 'Creado' ? '#dcfce7' : entry.accion === 'Documento subido' ? '#dbeafe' : entry.accion === 'Documento eliminado' ? '#fee2e2' : '#fef3c7',
                                                            color: entry.accion === 'Creado' ? '#166534' : entry.accion === 'Documento subido' ? '#1e40af' : entry.accion === 'Documento eliminado' ? '#dc2626' : '#92400e',
                                                            borderRadius: '9999px',
                                                            fontSize: '0.6875rem',
                                                            fontWeight: 600
                                                        }}>
                                                            <i data-lucide={entry.accion === 'Creado' ? 'Plus' : entry.accion === 'Documento subido' ? 'Upload' : entry.accion === 'Documento eliminado' ? 'Trash2' : 'Edit2'} size="10"></i>
                                                            {entry.accion}
                                                        </span>
                                                        <span style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                                            por {entry.usuario || 'Usuario'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style={{ textAlign: 'right', fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                                    <div style={{ fontWeight: 500 }}>{fecha}</div>
                                                    <div>{hora}</div>
                                                </div>
                                            </div>

                                            {/* Lista de campos modificados */}
                                            {numCambios > 0 && (
                                                <div style={{
                                                    background: 'white',
                                                    borderRadius: '6px',
                                                    padding: '0.75rem',
                                                    fontSize: '0.8125rem'
                                                }}>
                                                    {Object.entries(entry.cambios).slice(0, 3).map(([campo, valores]) => (
                                                        <div key={campo} style={{
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            padding: '0.25rem 0',
                                                            borderBottom: '1px solid var(--border)'
                                                        }}>
                                                            <span style={{ fontWeight: 600, minWidth: '100px', color: 'var(--text)' }}>
                                                                {FIELD_LABELS[campo] || campo}:
                                                            </span>
                                                            <div style={{ flex: 1, marginLeft: '0.5rem' }}>
                                                                {valores.antes && (
                                                                    <span style={{ textDecoration: 'line-through', color: '#dc2626', marginRight: '0.5rem' }}>
                                                                        {formatChangeValue(campo, valores.antes)}
                                                                    </span>
                                                                )}
                                                                <span style={{ color: '#16a34a' }}>{formatChangeValue(campo, valores.despues)}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {Object.keys(entry.cambios).length > 3 && (
                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem' }}>
                                                            +{Object.keys(entry.cambios).length - 3} campos mas...
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // =====================================================
        // MAIN APP
        // =====================================================
        const App = () => {
            // Entrar directo sin contrase√±a
            const [appState, setAppState] = useState('loading');
            const [user, setUser] = useState(null);
            const [data, setData] = useState([]);
            const [page, setPage] = useState('dashboard');
            const [syncing, setSyncing] = useState(false);
            const [syncMsg, setSyncMsg] = useState('');
            const [editing, setEditing] = useState(null);
            const [isNew, setIsNew] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [theme, setTheme] = useState(() => localStorage.getItem('antigravity_theme') || 'light');
            // Inicializar con el mes en curso
            const [startDate, setStartDate] = useState(() => {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), 1);
            });
            const [endDate, setEndDate] = useState(() => {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth() + 1, 0);
            });

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('antigravity_theme', theme);
            }, [theme]);

            const handleDateChange = (start, end) => { setStartDate(start); setEndDate(end); };

            const filteredData = useMemo(() => {
                if (!startDate || !endDate) return data;
                return data.filter(v => {
                    const fecha = robustParseDate(v.Fecha);
                    if (!fecha) return true;
                    return fecha >= startDate && fecha <= endDate;
                });
            }, [data, startDate, endDate]);

            const notifications = useMemo(() => NotificationService.generate(filteredData), [filteredData]);
            const summary = useMemo(() => NotificationService.getSummary(filteredData), [filteredData]);

            useEffect(() => {
                const init = async () => {
                    // Cargar datos directamente (sin contrase√±a)
                    await loadData();
                    setAppState('app');

                    // Conectar a Realtime para actualizaciones en tiempo real
                    if (getSupabase()) {
                        const connected = RealtimeService.subscribe((payload) => {
                            // Cuando hay un cambio, recargar datos
                            console.log('üì° Recargando datos por cambio en tiempo real...');
                            loadData();
                        });
                        setRealtimeConnected(connected);
                    }
                };
                init();

                // Cleanup: desconectar Realtime al desmontar
                return () => {
                    RealtimeService.unsubscribe();
                };
            }, []);

            const loadData = async () => {
                // Cargar datos (Supabase primero, localStorage como respaldo)
                const d = await DatabaseService.getViajes();
                const viajes = d.map(v => ({ ...v, tripId: v.tripId || generateUUID() }));
                setData(viajes);
            };

            // Migrar datos de localStorage a Supabase
            const handleMigrate = async () => {
                if (migrating) return;

                const confirmMigrate = confirm(
                    '¬øMigrar todos los datos de localStorage a Supabase?\n\n' +
                    'Esto subir√° todos los viajes guardados localmente a la nube.\n' +
                    'Una vez migrados, todos los usuarios ver√°n los mismos datos.'
                );

                if (!confirmMigrate) return;

                setMigrating(true);
                try {
                    const result = await DatabaseService.migrateToSupabase();
                    if (result.success) {
                        alert(`‚úÖ Migraci√≥n completada: ${result.count} viajes subidos a Supabase`);
                        // Recargar datos desde Supabase
                        await loadData();
                    } else {
                        alert('‚ùå Error en migraci√≥n: ' + result.error);
                    }
                } catch (err) {
                    alert('‚ùå Error: ' + err.message);
                }
                setMigrating(false);
            };

            // Funci√≥n de backup autom√°tico (no bloqueante)
            // Solo sincroniza viajes que NO est√°n cerrados (los cerrados ya no cambian)
            // Usa updateViajes() que NO borra la hoja, solo actualiza/agrega
            const performAutoBackup = async (viajes) => {
                // Filtrar: solo viajes activos (no cerrados)
                const viajesActivos = viajes.filter(v => {
                    const status = (v.Status || '').toLowerCase();
                    return status !== 'cerrado';
                });

                if (viajesActivos.length === 0) {
                    console.log('‚ÑπÔ∏è No hay viajes activos para sincronizar (todos est√°n cerrados)');
                    return;
                }

                setBackingUp(true);
                console.log(`üîÑ Backup autom√°tico: ${viajesActivos.length} viajes activos (${viajes.length - viajesActivos.length} cerrados omitidos)`);
                try {
                    // Usar updateViajes (no borra la hoja, solo actualiza)
                    const result = await GoogleSheetsService.updateViajes(viajesActivos);
                    if (result.success) {
                        const timestamp = new Date().toISOString();
                        setLastBackup(timestamp);
                        localStorage.setItem('antigravity_last_backup', timestamp);
                        console.log('‚úÖ Backup autom√°tico completado:', result.count, 'viajes activos');
                    } else {
                        console.error('‚ùå Backup autom√°tico fall√≥:', result.error);
                    }
                } catch (err) {
                    console.error('‚ùå Error en backup autom√°tico:', err.message);
                }
                setBackingUp(false);
            };

            // Funci√≥n para backup manual
            // Sincroniza TODOS los viajes (limpia la hoja y guarda todo)
            const handleBackupToSheets = async () => {
                if (backingUp || data.length === 0) return;

                if (!confirm(`¬øSincronizar ${data.length} viajes a Google Sheets?\n\nEsto reemplazar√° todos los datos en la hoja.`)) {
                    return;
                }

                setBackingUp(true);
                try {
                    // Usar syncAll que limpia la hoja y guarda todo
                    const result = await GoogleSheetsService.syncAll(data);
                    if (result.success) {
                        const timestamp = new Date().toISOString();
                        setLastBackup(timestamp);
                        localStorage.setItem('antigravity_last_backup', timestamp);
                        alert(`‚úÖ Backup completado: ${result.count} de ${data.length} viajes sincronizados`);
                    } else {
                        alert('‚ùå Error en backup: ' + result.error);
                    }
                } catch (err) {
                    alert('‚ùå Error: ' + err.message);
                }
                setBackingUp(false);
            };

            const handleSave = async (viaje) => {
                setSyncing(true); setSyncMsg('Guardando...');
                try {
                    const tripId = viaje.tripId || generateUUID();
                    const usuario = user?.email || 'local';
                    const toSave = { ...viaje, tripId, lastModified: new Date().toISOString(), modifiedBy: usuario, user_id: user?.id || null };

                    // =====================================================
                    // HISTORIAL DE CAMBIOS
                    // =====================================================
                    const originalViaje = data.find(v => v.tripId === tripId);
                    const esNuevo = !originalViaje;

                    // Inicializar historial si no existe
                    if (!toSave.historial) {
                        toSave.historial = [];
                    }

                    if (esNuevo) {
                        // Viaje nuevo: registrar creaci√≥n
                        toSave.historial.push(createHistorialEntry('Creado', {}, usuario));
                    } else {
                        // Viaje existente: detectar cambios
                        const cambios = detectChanges(originalViaje, toSave);
                        if (Object.keys(cambios).length > 0) {
                            toSave.historial.push(createHistorialEntry('Modificado', cambios, usuario));
                        }
                    }

                    // Si hay un PDF pendiente de Gesti√≥n, subirlo a documentos
                    if (toSave._pendingPdfFile && toSave._pendingPdfType) {
                        const file = toSave._pendingPdfFile;
                        const docType = toSave._pendingPdfType; // 'booking' o 'bl'

                        try {
                            setSyncMsg('Subiendo documento...');
                            if (getSupabase()) {
                                const result = await StorageService.uploadFile(file, toSave.tripId, docType);
                                const docs = toSave.documentos || createEmptyDocumentos();
                                docs[docType] = {
                                    uploaded: true,
                                    fileName: file.name,
                                    uploadDate: new Date().toISOString(),
                                    storagePath: result.path,
                                    storageUrl: result.url
                                };
                                toSave.documentos = docs;
                                // Registrar subida de documento en historial
                                const docLabel = DOCUMENT_TYPES.find(d => d.id === docType)?.label || docType;
                                toSave.historial.push(createHistorialEntry('Documento subido', { [docLabel]: { antes: '', despues: file.name } }, usuario));
                            }
                        } catch (err) {
                            console.error('Error subiendo PDF a documentos:', err);
                        }

                        // Limpiar propiedades temporales
                        delete toSave._pendingPdfFile;
                        delete toSave._pendingPdfType;
                    }

                    setData(prev => { const idx = prev.findIndex(v => v.tripId === toSave.tripId); if (idx >= 0) { const upd = [...prev]; upd[idx] = toSave; return upd; } return [toSave, ...prev]; });
                    await DatabaseService.saveViaje(toSave);

                    // Sincronizar con Google Sheets (no bloquear si falla)
                    setSyncMsg('Sincronizando con Sheets...');
                    try {
                        await GoogleSheetsService.saveViaje(toSave);
                    } catch (sheetsErr) {
                        console.error('Error sincronizando con Sheets:', sheetsErr);
                        // No mostrar error - el viaje ya se guard√≥ localmente
                    }

                    setEditing(null); setIsNew(false);
                } catch (err) {
                    console.error('Error guardando viaje:', err);
                    alert('‚ùå Error al guardar: ' + err.message + '\n\nEl viaje no se guard√≥ correctamente.');
                } finally {
                    setSyncing(false);
                }
            };

            const handleDelete = async (viaje) => {
                if (!confirm(`Eliminar "${viaje.Nombre || viaje['Numero de booking']}"?`)) return;
                setSyncing(true); setSyncMsg('Eliminando...');
                try {
                    setData(prev => prev.filter(v => v.tripId !== viaje.tripId));
                    await DatabaseService.deleteViaje(viaje.tripId);

                    // Eliminar de Google Sheets (no bloquear si falla)
                    try {
                        await GoogleSheetsService.deleteViaje(viaje.tripId);
                    } catch (sheetsErr) {
                        console.error('Error eliminando de Sheets:', sheetsErr);
                    }

                    setEditing(null);
                } catch (err) {
                    console.error('Error eliminando viaje:', err);
                    alert('‚ùå Error al eliminar: ' + err.message);
                } finally {
                    setSyncing(false);
                }
            };

            const handleImport = async (newData) => {
                setSyncing(true); setSyncMsg('Importando...');
                try {
                    setData(newData);
                    await DatabaseService.saveViajesBatch(newData);

                    // Sincronizar con Google Sheets (no bloquear si falla)
                    setSyncMsg('Sincronizando con Sheets...');
                    try {
                        await GoogleSheetsService.syncAll(newData);
                    } catch (sheetsErr) {
                        console.error('Error sincronizando con Sheets:', sheetsErr);
                        alert(`‚ö†Ô∏è Importaci√≥n local completada (${newData.length} viajes)\n\nPero hubo un error al sincronizar con Google Sheets.`);
                        return;
                    }

                    alert(`‚úÖ Importaci√≥n completada: ${newData.length} viajes`);
                } catch (err) {
                    console.error('Error importando:', err);
                    alert('‚ùå Error al importar: ' + err.message);
                } finally {
                    setSyncing(false);
                }
            };

            // Exportar TODOS los viajes (backup completo)
            const handleExport = () => ExcelService.export(data, 'Antigravity_Viajes_COMPLETO');

            // Exportar solo los viajes filtrados por fecha
            const handleExportFiltered = () => ExcelService.export(filteredData, 'Antigravity_Viajes_Filtrado');

            // Sincronizar con Google Sheets
            const handleSyncSheets = async () => {
                if (!GoogleSheetsService.isConfigured) {
                    alert('Google Sheets no est√° configurado.');
                    return;
                }

                if (data.length === 0) {
                    alert('No hay viajes para sincronizar.');
                    return;
                }

                setSyncingSheets(true);

                // Mostrar aviso si estamos en file://
                if (GoogleSheetsService.isFileProtocol) {
                    alert('Se abrir√° una ventana para sincronizar.\nEspera a que se cierre autom√°ticamente.');
                }

                try {
                    // Sincronizar todos los viajes
                    const result = await GoogleSheetsService.syncAll(data);
                    if (result.success) {
                        alert('‚úÖ Sincronizado con Google Sheets\n\n' + (result.count || data.length) + ' viajes exportados correctamente.');
                    } else {
                        alert('‚ùå Error al sincronizar.\n\n' + (result.error || 'Error desconocido'));
                    }
                } catch (err) {
                    console.error('Error sincronizando:', err);
                    alert('‚ùå Error al sincronizar:\n\n' + err.message);
                }
                setSyncingSheets(false);
            };

            const [originalViaje, setOriginalViaje] = useState(null);

            // Sincronizar desde Google Sheets (autom√°tico con JSONP)
            const [syncingFromSheets, setSyncingFromSheets] = useState(false);
            const [backingUp, setBackingUp] = useState(false);
            const [lastBackup, setLastBackup] = useState(() => localStorage.getItem('antigravity_last_backup') || null);
            const [lastAutoBackup, setLastAutoBackup] = useState(() => localStorage.getItem('antigravity_last_auto_backup') || null);
            const [realtimeConnected, setRealtimeConnected] = useState(false);
            const [migrating, setMigrating] = useState(false);

            // =====================================================
            // BACKUP DIARIO AUTOM√ÅTICO A SUPABASE STORAGE
            // =====================================================
            const performDailyBackup = async () => {
                if (!BackupService.needsBackup()) {
                    console.log('‚òÅÔ∏è Backup diario no necesario (menos de 24h desde el √∫ltimo)');
                    return;
                }

                if (data.length === 0) {
                    console.log('‚òÅÔ∏è No hay viajes para backup');
                    return;
                }

                try {
                    console.log('‚òÅÔ∏è Iniciando backup diario a Supabase Storage...');
                    const result = await BackupService.uploadBackup(data);

                    const timestamp = new Date().toISOString();
                    setLastAutoBackup(timestamp);
                    localStorage.setItem('antigravity_last_auto_backup', timestamp);

                    // Limpiar backups antiguos (mantener solo 7 d√≠as)
                    await BackupService.cleanOldBackups();

                    console.log(`‚úÖ Backup diario completado: ${result.fileName}`);
                    addNotification({
                        type: 'success',
                        title: 'Backup Autom√°tico',
                        message: `Copia de seguridad guardada en la nube (${data.length} viajes)`
                    });
                } catch (error) {
                    console.error('‚ùå Error en backup diario:', error);
                    // No mostrar error al usuario para no interrumpir
                }
            };

            // Ejecutar backup diario cuando se cargan los viajes
            useEffect(() => {
                if (data.length > 0 && !loading) {
                    const timer = setTimeout(() => {
                        performDailyBackup();
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [data.length, loading]);

            const handleSyncFromSheets = async () => {
                if (!GoogleSheetsService.isConfigured) {
                    alert('Google Sheets no est√° configurado');
                    return;
                }

                setSyncingFromSheets(true);
                try {
                    const viajesFromSheets = await GoogleSheetsService.getViajesJSONP();

                    if (viajesFromSheets === null) {
                        alert('‚ùå No se pudo conectar con Google Sheets.\n\nAseg√∫rate de haber actualizado el c√≥digo de Apps Script con la nueva versi√≥n.');
                        setSyncingFromSheets(false);
                        return;
                    }

                    if (viajesFromSheets.length === 0) {
                        alert('No hay viajes en Google Sheets');
                        setSyncingFromSheets(false);
                        return;
                    }

                    // Traer TODOS los viajes de Google Sheets
                    const localData = JSON.parse(localStorage.getItem('antigravity_crm_data') || '[]');
                    const localMap = new Map(localData.map(v => [v.tripId, v]));

                    // Procesar todos los viajes de Sheets
                    const viajesActualizados = viajesFromSheets.map(sheetsViaje => {
                        const tripId = sheetsViaje.tripId || generateUUID();
                        const localViaje = localMap.get(tripId);

                        return {
                            ...sheetsViaje,
                            tripId: tripId,
                            // Mantener documentos locales si existen
                            documentos: localViaje?.documentos || createEmptyDocumentos()
                        };
                    });

                    setData(viajesActualizados);
                    localStorage.setItem('antigravity_crm_data', JSON.stringify(viajesActualizados));
                    alert(`‚úÖ Sincronizado: ${viajesActualizados.length} viajes desde Google Sheets`);
                } catch (err) {
                    console.error('Error sync:', err);
                    alert('‚ùå Error al sincronizar: ' + err.message);
                }
                setSyncingFromSheets(false);
            };

            const [initialTab, setInitialTab] = useState('general');
            const openNew = () => { setInitialTab('general'); setEditing({ tripId: generateUUID(), Fecha: new Date().toISOString().split('T')[0], Status: 'Programacion', documentos: createEmptyDocumentos() }); setIsNew(true); setOriginalViaje(null); };
            const openEdit = (v) => { setInitialTab('general'); setEditing({ ...v, documentos: v.documentos || createEmptyDocumentos() }); setIsNew(false); setOriginalViaje(null); };
            const openEditDocs = (v) => { setInitialTab('documentos'); setEditing({ ...v, documentos: v.documentos || createEmptyDocumentos() }); setIsNew(false); setOriginalViaje(null); };
            // Abrir modal con viaje modificado pero mostrando valores originales
            const openEditWithOriginal = (modifiedViaje, original) => { setInitialTab('general'); setEditing({ ...modifiedViaje, documentos: modifiedViaje.documentos || createEmptyDocumentos() }); setIsNew(false); setOriginalViaje(original); };

            // Funcion para abrir modal de edicion con datos del Booking PDF
            const handleOpenBookingModal = (pdfData) => {
                const newViaje = {
                    tripId: generateUUID(),
                    Fecha: pdfData.Fecha || new Date().toISOString().split('T')[0],
                    Status: 'Programacion',
                    documentos: createEmptyDocumentos(),
                    ...pdfData,
                };
                setEditing(newViaje);
                setIsNew(true);
            };

            // Funcion para actualizar viaje desde BL
            const handleUpdateViaje = async (tripId, updates) => {
                const viaje = data.find(v => v.tripId === tripId);
                if (viaje) {
                    const updated = { ...viaje, ...updates, lastModified: new Date().toISOString() };
                    await handleSave(updated);
                }
            };

            useEffect(() => { lucide.createIcons(); }, [page, appState]);

            if (appState === 'loading') return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', background: 'var(--bg)' }}><div style={{ textAlign: 'center' }}><div className="sync-spinner" style={{ width: 40, height: 40, margin: '0 auto 1rem' }}></div><p>Cargando...</p></div></div>;

            const titles = { dashboard: 'Inicio', viajes: 'Viajes', status: 'Estatus', calendario: 'Calendario', gestion: 'Documentos', historial: 'Historial' };

            return (
                <>
                    <Sidebar activePage={page} setPage={setPage} user={user} onLogout={() => { AuthService.logout(); setUser(null); setData([]); setAppState('login'); }} isOnline={isSupabaseConfigured && user} />
                    <div className="main-container">
                        <Header title={titles[page]} data={filteredData} notifications={notifications} onSearch={openEdit} onNotification={openEdit} theme={theme} setTheme={setTheme} startDate={startDate} endDate={endDate} onDateChange={handleDateChange} onSyncFromSheets={handleSyncFromSheets} syncingFromSheets={syncingFromSheets} onBackup={handleBackupToSheets} backingUp={backingUp} lastBackup={lastBackup} lastAutoBackup={lastAutoBackup} />
                        <div className="content-scroll">
                            {page === 'dashboard' && <DashboardPage data={filteredData} allData={data} onAdd={openNew} onEdit={openEdit} onExport={handleExport} onExportFiltered={handleExportFiltered} onImport={() => setShowImport(true)} summary={summary} />}
                            {page === 'viajes' && <ViajesPage data={data} onEdit={openEdit} onEditDocs={openEditDocs} onDelete={handleDelete} onAdd={openNew} onExport={handleExport} onImport={() => setShowImport(true)} />}
                            {page === 'status' && <StatusPage data={data} onEdit={openEdit} />}
                            {page === 'calendario' && <CalendarioPage data={data} onEdit={openEdit} />}
                            {page === 'gestion' && <GestionPage onOpenBookingModal={handleOpenBookingModal} onEditViaje={openEdit} onEditViajeWithOriginal={openEditWithOriginal} allData={data} />}
                            {page === 'historial' && <HistorialPage data={data} onEdit={openEdit} />}
                        </div>
                    </div>
                    {editing && <EditViajeModal viaje={editing} onClose={() => { setEditing(null); setIsNew(false); setOriginalViaje(null); setInitialTab('general'); }} onSave={handleSave} onDelete={handleDelete} isNew={isNew} originalViaje={originalViaje} initialTab={initialTab} />}
                    {showImport && <ImportModal onClose={() => setShowImport(false)} onImport={handleImport} existingData={data} />}
                    {syncing && <SyncIndicator message={syncMsg} />}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
