<!DOCTYPE html>
<html>
<head>
    <title>Diagnóstico Supabase</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .test { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .pending { background: #f0f0f0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
        h1 { color: #333; }
    </style>
</head>
<body>
    <h1>Diagnóstico Supabase</h1>

    <div id="test1" class="test pending">1. Verificando librería Supabase...</div>
    <div id="test2" class="test pending">2. Creando cliente Supabase...</div>
    <div id="test3" class="test pending">3. Leyendo viajes de Supabase...</div>
    <div id="test4" class="test pending">4. Guardando viaje de prueba...</div>
    <div id="test5" class="test pending">5. Verificando viaje guardado...</div>
    <div id="test6" class="test pending">6. Eliminando viaje de prueba...</div>

    <button onclick="runTests()">Ejecutar Diagnóstico</button>

    <div id="resultado" style="margin-top: 20px;"></div>

    <script>
        const SUPABASE_URL = 'https://cteczvfjnkhipbvbwlmx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZWN6dmZqbmtoaXBidmJ3bG14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODk1NDQsImV4cCI6MjA4NDY2NTU0NH0.sWGm3uRwQv3eioPZFPtkb2GaTvHoRBsZFx44OYzIIrY';

        let supabaseClient = null;
        let testTripId = 'test-' + Date.now();

        function setStatus(id, success, message) {
            const el = document.getElementById(id);
            el.className = 'test ' + (success ? 'success' : 'error');
            el.innerHTML = message;
        }

        async function runTests() {
            document.getElementById('resultado').innerHTML = '<p>Ejecutando pruebas...</p>';

            // Test 1: Verificar librería
            if (window.supabase) {
                setStatus('test1', true, '1. ✅ Librería Supabase cargada correctamente');
            } else {
                setStatus('test1', false, '1. ❌ Librería Supabase NO está disponible (window.supabase es undefined)');
                document.getElementById('resultado').innerHTML = '<h2 style="color:red;">PROBLEMA: La librería Supabase no se cargó</h2>';
                return;
            }

            // Test 2: Crear cliente
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                setStatus('test2', true, '2. ✅ Cliente Supabase creado');
            } catch (err) {
                setStatus('test2', false, '2. ❌ Error creando cliente: ' + err.message);
                document.getElementById('resultado').innerHTML = '<h2 style="color:red;">PROBLEMA: No se pudo crear el cliente Supabase</h2>';
                return;
            }

            // Test 3: Leer viajes
            try {
                const { data, error } = await supabaseClient.from('viajes').select('tripId, Nombre').limit(5);
                if (error) throw error;
                setStatus('test3', true, '3. ✅ Lectura exitosa: ' + data.length + ' viajes encontrados<pre>' + JSON.stringify(data.map(v => v.Nombre), null, 2) + '</pre>');
            } catch (err) {
                setStatus('test3', false, '3. ❌ Error leyendo: ' + err.message);
                document.getElementById('resultado').innerHTML = '<h2 style="color:red;">PROBLEMA: No se puede leer de Supabase - Revisar políticas RLS</h2>';
                return;
            }

            // Test 4: Guardar viaje
            try {
                const viajePrueba = {
                    tripId: testTripId,
                    Nombre: 'DIAGNOSTICO-' + new Date().toLocaleTimeString(),
                    Status: 'Programacion'
                };
                const { data, error } = await supabaseClient.from('viajes').upsert(viajePrueba, { onConflict: 'tripId' });
                if (error) throw error;
                setStatus('test4', true, '4. ✅ Viaje guardado con tripId: ' + testTripId);
            } catch (err) {
                setStatus('test4', false, '4. ❌ Error guardando: ' + err.message + '<pre>' + JSON.stringify(err, null, 2) + '</pre>');
                document.getElementById('resultado').innerHTML = '<h2 style="color:red;">PROBLEMA: No se puede ESCRIBIR en Supabase - Revisar políticas RLS</h2><p>Error: ' + err.message + '</p>';
                return;
            }

            // Test 5: Verificar que se guardó
            try {
                const { data, error } = await supabaseClient.from('viajes').select('*').eq('tripId', testTripId);
                if (error) throw error;
                if (data.length > 0) {
                    setStatus('test5', true, '5. ✅ Viaje verificado en Supabase<pre>' + JSON.stringify(data[0], null, 2) + '</pre>');
                } else {
                    throw new Error('Viaje no encontrado después de guardar');
                }
            } catch (err) {
                setStatus('test5', false, '5. ❌ Error verificando: ' + err.message);
                return;
            }

            // Test 6: Eliminar viaje de prueba
            try {
                const { error } = await supabaseClient.from('viajes').delete().eq('tripId', testTripId);
                if (error) throw error;
                setStatus('test6', true, '6. ✅ Viaje de prueba eliminado');
            } catch (err) {
                setStatus('test6', false, '6. ❌ Error eliminando: ' + err.message);
            }

            document.getElementById('resultado').innerHTML = '<h2 style="color:green;">✅ TODAS LAS PRUEBAS PASARON</h2><p>Supabase funciona correctamente. El problema debe estar en otra parte del código.</p>';
        }
    </script>
</body>
</html>
